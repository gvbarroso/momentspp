---
title: "Causal models of diversity"
author: "Gustavo V. Barroso"
date: "`r Sys.Date()`"
output:
  pdf_document:
  toc: true
number_sections: true
toc_depth: 1
---

```{r setup, include=F, message=F, warning=F}

knitr::opts_chunk$set(echo=TRUE)

library(data.table)
library(tidyverse)
library(cowplot)
library(scales)
library(GenomicRanges)

library(MASS)
library(lmtest)
library(nlme)
library(car)
library(interactions)
library(ppcor)
library(Hmisc)
library(MVN)
library(heplots)

library(survcomp) # for fisher's C test, combine.test()
library(piecewiseSEM)
library(semTools)
library(graph)
library(ggm)
library(lavaan)
library(DiagrammeR)
library(DiagrammeRsvg)
library(dagitty)
library(ggdag)
library(magrittr)
library(rsvg)
library(xml2)

library(reticulate)
use_python("/usr/bin/python3")

scale.4d <- function(x) sprintf("%.4f", x) # for adjusting precision in plots

knitr::opts_knit$set(root.dir="~/Desktop/sim_data")
#knitr::opts_knit$set(root.dir="~/Data/bgs_lmr/sim_data")
```

# Building chromosome models

We write a table with parameters shaping genomic landscapes
(mutation, recombination, functional elements)

Later, we will assume a single DFE for all elements.
Thus |s| can be seen as "constant" (see DAGs below).

```{r, build-chr-models, include=F, message=F, warning=F}

# Gamma dist params
shapes_rate_u <- c(5, 10, 30, 100)
shapes_rate_r <- c(1, 3, 10)
mean_r <- 1e-8
mean_u <- 1.25e-8

# Geom dist params
avg_rec_spans <- c(1e+3, 1e+4, 1e+5)
avg_mut_spans <- c(1e+3, 1e+4, 1e+5)
exon_lengths <- 1000
num_exons <- c(5000, 10000, 25000)
L <- 1e+8
mult_r_u <- c(0, 0.05, 0.1, 0.25) # non-mutagenic recomb. is a special case

p_stay <- 0.25 # related to auto-correlation in the distribution of elements
# note since average length of intergenic > exon_lengths, p_stay > 0 => AR > 0

models <- setDT(crossing(L, p_stay, num_exons, exon_lengths, mult_r_u,
                         mean_r, mean_u, shapes_rate_u, shapes_rate_r,
                         avg_rec_spans, avg_mut_spans))
models$model <- 1:nrow(models)

Sys.setenv(num_models=nrow(models))
Sys.setenv(num_reps=10)

fwrite(models, "models.csv")
models <- fread("models.csv")
```

```{bash, mk-dirs, engine.opts='-i', include=T, eval=T, results=F, warning=F}

source ~/.bashrc

for ((m=1; m <= $num_models; m++))
do
  mkdir model_$m
  cd model_$m
  for ((r=1; r <= $num_reps; r++))
  do
    mkdir rep_$r
  done
  cd ..
done
```

We use the models to assemble the genomic maps

```{r, build-chr-maps, include=F, message=F, warning=F}

for(m in 1:num_models) {
  print(paste(m, Sys.Date(), Sys.time()), sep="\t")
  bin_size <- 1e+3 # "basal" scale, larger windows are built after
  L <- models$L[m]
  V <- L - models$num_exons[m] * models$exon_lengths[m]
  mult <- models$mult_r_u[m]
    
  for(rep in 1:num_reps) {
    # constrained elements, call them genes or exons 
    intergenic_lengths <- rgeom(n=models$num_exons[m], prob=models$num_exons[m]/V) 
    
    while(sum(intergenic_lengths) < V) {
      intergenic_lengths <- c(intergenic_lengths, 
                              rgeom(n=1, prob=models$num_exons[m]/V))
    }
    if(sum(intergenic_lengths) > V) {
      intergenic_lengths <- intergenic_lengths[cumsum(intergenic_lengths) < V]
      intergenic_lengths <- c(intergenic_lengths, V - sum(intergenic_lengths))
    }
    intergenic_lengths <- intergenic_lengths[intergenic_lengths>0]
    
    chr_elements <- c(rbind(intergenic_lengths, 
                        rep(models$exon_lengths[m],
                            models$num_exons[m])))

    # Introducing clusters of exonic and integenic sites (for "realism" ++)
    # this function avoids problems with sample from vector with length == 1
    resample <- function(x) x[sample.int(length(x))][1] 
    p_stay <- models$p_stay[m] # symmetric auto-correlation
    is_exonic <- chr_elements[1] == models$exon_lengths[m]
    
    new_elements <- numeric(length=length(chr_elements)) # init
    new_elements[1] <- chr_elements[1]
    chr_elements <- chr_elements[-1]
    
    for(i in 2:length(new_elements)) {
      if(!is_exonic) {
        if(any(chr_elements != models$exon_lengths[m])) {
          val <- resample(chr_elements[chr_elements!=models$exon_lengths[m]])
          idx <- which(chr_elements==val)[1] # first occurrence of val in elems
          
          new_elements[i] <- val
          chr_elements <- chr_elements[-idx] # removes sampled item
        } else { # we ran out of intergenic regions
          is_exonic <- T
          p_stay <- 1
          
          val <- resample(chr_elements[chr_elements==models$exon_lengths[m]]) 
          idx <- which(chr_elements==val)[1] # first occurrence of val in elems
          
          new_elements[i] <- val
          chr_elements <- chr_elements[-idx] # removes sampled item
        }
      }
      else {
        if(any(chr_elements == models$exon_lengths[m])) {
          val <- resample(chr_elements[chr_elements==models$exon_lengths[m]])
          idx <- which(chr_elements==val)[1] # first occurrence of val in elems
          
          new_elements[i] <- val
          chr_elements <- chr_elements[-idx] # removes sampled item
        } else { # we ran out of exons
          is_exonic <- F
          p_stay <- 1
          
          val <- resample(chr_elements[chr_elements!=models$exon_lengths[m]])
          idx <- which(chr_elements==val)[1] # first occurrence of val in elems
          
          new_elements[i] <- val
          chr_elements <- chr_elements[-idx] # removes sampled item
        }
      }
    
      if(runif(1, 0, 1) > p_stay) { # switch from/to exonic/intergenic
        is_exonic <- !is_exonic
      }
    }
    
    elements <- setDT(bind_cols(chr="chr1",
    		              dplyr::lag(cumsum(new_elements), n=1, default=0),
    		              dplyr::lag(cumsum(new_elements), n=0, default=0)))
    names(elements) <- c("chr", "start", "end")
    elements <- filter(elements, start < L)
    elements$end[nrow(elements)] <- L
    elements$selected <- as.integer(elements$end - 
elements$start == models$exon_lengths[m])
    
    # recombination map
    rec_spans <- rgeom(n=ceiling(L/models$avg_rec_spans[m]), 
                       prob=1/models$avg_rec_spans[m])
    while(sum(rec_spans) < L) {
      rec_spans <- c(rec_spans, rgeom(n=1, prob=1/models$avg_rec_spans[m]))
    }
    if(sum(rec_spans) > L) {
      rec_spans <- rec_spans[cumsum(rec_spans) < L]
      rec_spans <- c(rec_spans, L - sum(rec_spans))
    }
    rec_spans <- rec_spans[rec_spans>0]
    
    rmap <- suppressMessages(setDT(bind_cols(chr="chr1",
            		  dplyr::lag(cumsum(rec_spans), n=1, default=0),
    		          dplyr::lag(cumsum(rec_spans), n=0, default=0))))  
    names(rmap) <- c("chr", "start", "end")
    rs <- rgamma(n=nrow(rmap),
                 shape=models$shapes_rate_r[m],
                 rate=models$shapes_rate_r[m])
    rmap$r <- rs * models$mean_r[m]
    fwrite(rmap, paste("model_", m, "/rep_", rep, "/rec_map.csv.gz", sep=""))

    # mutation map
    mut_spans <- rgeom(n=ceiling(L/models$avg_mut_spans[m]), 
                       prob=1/models$avg_mut_spans[m])
    while(sum(mut_spans) < L) {
      mut_spans <- c(mut_spans, rgeom(n=1, prob=1/models$avg_mut_spans[m]))
    }
    if(sum(mut_spans) > L) {
      mut_spans <- mut_spans[cumsum(mut_spans) < L]
      mut_spans <- c(mut_spans, L - sum(mut_spans))
    }
    mut_spans <- mut_spans[mut_spans>0]
    
    mmap <- suppressMessages(setDT(bind_cols(chr="chr1",
             		  dplyr::lag(cumsum(mut_spans), n=1, default=0),
    		          dplyr::lag(cumsum(mut_spans), n=0, default=0))))
    names(mmap) <- c("chr", "start", "end")
    mus <- rgamma(n=nrow(mmap),
                	shape=models$shapes_rate_u[m],
                	rate=models$shapes_rate_u[m])
    mmap$u <- mus * models$mean_u[m]
    
    # binning
    bins <- rep(bin_size, floor(L / bin_size))
    bins <- suppressMessages(bind_cols(chr="chr1",
                      dplyr::lag(cumsum(bins), n=1, default=0),
                      dplyr::lag(cumsum(bins), n=0, default=0)))
    names(bins) <- c("chr", "start", "end")
    bins$start <- bins$start + 1 # so that GRanges understands the intervals
    gr_bins <- makeGRangesFromDataFrame(bins)
    
    rmap2 <- rmap
    rmap2$start <- rmap2$start + 1 # so that GRanges understands the intervals
    rec_gr <- makeGRangesFromDataFrame(rmap2, keep.extra.columns=T)
    hits <- findOverlaps(query=gr_bins, subject=rec_gr) 
    hit_list <- as.data.frame(hits)
    names(hit_list) <- c("bins", "rec_bins")
    rmap2$rec_bins <- 1:nrow(rmap2)
    rec_bins <- merge(rmap2, hit_list) %>%
                group_by(bins) %>%
                mutate(avg_rec=weighted.mean(r, end-start))
    rec_bins <- rec_bins %>% distinct(bins, .keep_all=T) 
    
    mmap2 <- mmap 
    mmap2$start <- mmap2$start + 1 # so that GRanges understands the intervals
    mut_gr <- makeGRangesFromDataFrame(mmap2, keep.extra.columns=T)
    
    # transform mut map with rec map
    mmap2$mut_bins <- 1:nrow(mmap2)
    hits <- findOverlaps(query=rec_gr, subject=mut_gr) 
    hit_list <- as.data.frame(hits)
    names(hit_list) <- c("rec_bins", "mut_bins")
    mmap3 <- merge(mmap2, hit_list) 
    mmap3 <- dplyr::select(rmap2, -c("chr", "start", "end")) %>% 
             merge(., mmap3, by="rec_bins")
    mmap3$u <- mmap3$u + mmap3$r * mult
    mmap3 <- mmap3 %>% 
      distinct(mut_bins, .keep_all=T) %>% 
      dplyr::select(names(mmap))
    mmap3$u <- unique(models$mean_u) * (mmap3$u / mean(mmap3$u)) # re-center
    mmap2 <- mmap3
    mmap2$start <- mmap2$start - 1
    fwrite(mmap2, paste("model_", m, "/rep_", rep, "/mut_map.csv.gz", sep=""))
    
    # binning mut
    mut_gr <- makeGRangesFromDataFrame(mmap3, keep.extra.columns=T) # over-write
    hits <- findOverlaps(query=gr_bins, subject=mut_gr) 
    hit_list <- as.data.frame(hits)
    names(hit_list) <- c("bins", "mut_bins")
    mmap3$mut_bins <- 1:nrow(mmap3)
    mut_bins <- merge(mmap3, hit_list, by="mut_bins") %>%
                group_by(bins) %>%
                mutate(avg_mut=weighted.mean(u, end-start))
    mut_bins <- mut_bins %>% distinct(bins, .keep_all=T) 
    
    # avg mut rate within each element
    elements2 <- elements 
    elements2$start <- elements2$start + 1 # so GRanges understands intervals
    elem_gr <- makeGRangesFromDataFrame(elements2, keep.extra.columns=T)
    hits <- findOverlaps(query=elem_gr, subject=mut_gr) 
    hit_list <- as.data.frame(hits)
    names(hit_list) <- c("elems", "mut_bins")
    x <- merge(hit_list, mmap3) 
    y <- x %>% group_by(elems) %>% mutate(avg_mut=weighted.mean(u, end-start)) 
    x <- distinct(y, elems, .keep_all=T)
    elements$u <- x$avg_mut
    
    fwrite(elements, paste("model_", m, "/rep_", rep, "/elements.csv.gz", sep=""))
    
    # binning exons (number of exonic sites per 1kb window)
    bins$bins_1kb <- 1:nrow(bins)
    elem_gr <- makeGRangesFromDataFrame(dplyr::select(elements, -u), 
                                        keep.extra.columns=T) 
    hits <- findOverlaps(query=elem_gr, subject=gr_bins) 
    hit_list <- as.data.frame(hits)
    names(hit_list) <- c("elem_bins", "bins_1kb")
    elements2$elem_bins <- 1:nrow(elements2)
    elem_bins <- merge(elements2, hit_list, by="elem_bins")
    elem_bins <- merge(dplyr::select(elem_bins, -chr), bins, by="bins_1kb") 
    names(elem_bins) <- c("bins_1kb", "elem_bins", "start_elem", "end_elem",
                          "selected", "chr", "start_1kb", "end_1kb")
    
    # find 1st, last, and middle occurrences of selected elems within 1 kb bins
    elem_bins <- elem_bins %>% mutate(isFirst=as.integer(selected==1 &
(is.na(dplyr::lag(selected)) | dplyr::lag(selected)!=1)))
    elem_bins <- elem_bins %>% mutate(isLast=as.integer(selected==1 &
(is.na(dplyr::lag(selected)) | dplyr::lead(selected)!=1)))
    elem_bins <- elem_bins %>% mutate(isMiddle=as.integer(selected==1 &
(dplyr::lag(selected)==1) & dplyr::lead(selected)==1))
    
    # cleaning corners
    elem_bins$isFirst[is.na(elem_bins$isFirst)] <- 0
    elem_bins$isMiddle[is.na(elem_bins$isMiddle)] <- 0
    elem_bins$isLast[is.na(elem_bins$isLast)] <- 0
    
    # assigns exonic counts to each 1kb bin
    elem_bins$leftCount <- elem_bins$isFirst * 
(elem_bins$end_1kb - elem_bins$start_elem + 1)
    elem_bins$rightCount <- elem_bins$isLast * 
(elem_bins$end_elem - elem_bins$start_1kb + 1)
    elem_bins$midCount <- elem_bins$isMiddle * models$exon_lengths[m] 
    elem_bins$elemCount <- elem_bins$leftCount + 
                           elem_bins$rightCount +
                           elem_bins$midCount
    
    elem_bins_2 <- elem_bins %>%
                   group_by(bins_1kb) %>% 
                   mutate(exonic_sites=sum(elemCount)) %>% 
                   distinct(bins_1kb, .keep_all=T) %>%
                   dplyr::select(chr, start_1kb, end_1kb, exonic_sites)
    
    # corrects the double counting of middle elements assigned to 2 1kb bins
    elem_bins_2[elem_bins_2$exonic_sites==2*models$exon_lengths[m],]$exonic_sites <-
      models$exon_lengths[m]

    maps_1kb <- bind_cols(bins,
                          rec_bins["avg_rec"],
                          mut_bins["avg_mut"],
                          elem_bins_2["exonic_sites"])
    
    maps_1kb$start <- maps_1kb$start - 1 # back
    maps_1kb$bin_10kb <- (maps_1kb$bins_1kb - 1) %/% 10
    maps_1kb$bin_100kb <- (maps_1kb$bins_1kb - 1) %/% 100
    maps_1kb$bin_1Mb <- (maps_1kb$bins_1kb - 1) %/% 1000
    maps_10kb <- maps_1kb %>% group_by(bin_10kb) %>% 
                 summarise_at(c("avg_mut", "avg_rec", "exonic_sites"), mean)
    maps_100kb <- maps_1kb %>% group_by(bin_100kb) %>% 
                  summarise_at(c("avg_mut", "avg_rec", "exonic_sites"), mean)
    maps_1Mb <- maps_1kb %>% group_by(bin_1Mb) %>% 
                summarise_at(c("avg_mut", "avg_rec", "exonic_sites"), mean)
    
    # for number of exonic sites we want their sum in each bin
    maps_10kb$exonic_sites <- maps_10kb$exonic_sites * 10
    maps_100kb$exonic_sites <- maps_100kb$exonic_sites * 100
    maps_1Mb$exonic_sites <- maps_1Mb$exonic_sites * 1000
    
    bins_1kb <- rep(1e+3, floor(L / 1e+3))
    bins_1kb <- suppressMessages(bind_cols(chr="chr1",
      dplyr::lag(cumsum(bins_1kb), n=1, default=0),
      dplyr::lag(cumsum(bins_1kb), n=0, default=0)))
    names(bins_1kb) <- c("chr", "start", "end")
    
    bins_10kb <- rep(1e+4, floor(L / 1e+4))
    bins_10kb <- suppressMessages(bind_cols(chr="chr1",
      dplyr::lag(cumsum(bins_10kb), n=1, default=0),
      dplyr::lag(cumsum(bins_10kb), n=0, default=0)))
    names(bins_10kb) <- c("chr", "start", "end")
    
    bins_100kb <- rep(1e+5, floor(L / 1e+5))
    bins_100kb <- suppressMessages(bind_cols(chr="chr1",
      dplyr::lag(cumsum(bins_100kb), n=1, default=0),
      dplyr::lag(cumsum(bins_100kb), n=0, default=0)))
    names(bins_100kb) <- c("chr", "start", "end")
    
    bins_1Mb <- rep(1e+6, floor(L / 1e+6))
    bins_1Mb <- suppressMessages(bind_cols(chr="chr1",
      dplyr::lag(cumsum(bins_1Mb), n=1, default=0),
      dplyr::lag(cumsum(bins_1Mb), n=0, default=0)))
    names(bins_1Mb) <- c("chr", "start", "end")
    
    maps_1kb <- cbind.data.frame(bins_1kb, dplyr::select(maps_1kb,
                                                         avg_rec, 
                                                         avg_mut,
                                                         exonic_sites))
    maps_10kb <- cbind.data.frame(bins_10kb, dplyr::select(maps_10kb,
                                                           avg_rec, 
                                                           avg_mut,
                                                           exonic_sites))
    maps_100kb <- cbind.data.frame(bins_100kb, dplyr::select(maps_100kb,
                                                             avg_rec, 
                                                             avg_mut,
                                                             exonic_sites))
    maps_1Mb <- cbind.data.frame(bins_1Mb, dplyr::select(maps_1Mb,
                                                         avg_rec,
                                                         avg_mut,
                                                         exonic_sites))
    
    fwrite(maps_1kb, paste("model_", m,
                           "/rep_", rep,
                           "/maps_1kb.csv.gz", sep=""))
    fwrite(maps_10kb, paste("model_", m,
                            "/rep_", rep,
                            "/maps_10kb.csv.gz", sep=""))
    fwrite(maps_100kb, paste("model_", m,
                             "/rep_", rep,
                             "/maps_100kb.csv.gz", sep=""))
    fwrite(maps_1Mb, paste("model_", m,
                           "/rep_", rep,
                           "/maps_1Mb.csv.gz", sep=""))
  }
}
```

This chunk has the python code use to predict B and pi
Script named 'build_tbl.py'

```{python, build-tbl}
#!/usr/bin/env python
# coding: utf-8

import sys
import bgshr
import scipy.stats
import numpy as np
import pandas

models_file = "models.csv"
chr_models = pandas.read_csv(models_file, sep=",")

# load the lookup table
table_file = "lookup_tbl_equilibrium.csv.gz"
df = bgshr.Util.load_lookup_table(table_file)
df_sub = bgshr.Util.subset_lookup_table(df)
df_sub = df_sub[df_sub["s"] > -0.005]

# extend the lookup table with classic BGS predictions
smin = np.min(np.sort(list(set(df_sub["s"]))))
s_extend = -np.concatenate(([0], np.logspace(-6, 0, 46))) 
s_extend = s_extend[s_extend < smin]
df_sub = bgshr.ClassicBGS.extend_lookup_table(df_sub, s_extend)

# interpolate between recombination values in the lookup table
u_vals, s_vals, splines = bgshr.Util.generate_cubic_splines(df_sub)
max_r = max(df_sub["r"])

ss = np.sort(list(set(df_sub["s"])))

L = np.unique(chr_models["L"])[0]
rec_file = "rec_map.csv.gz"
rmap = bgshr.Util.load_bedgraph(rec_file, L=L)

efile = "elements.csv.gz"
regions = pandas.read_csv(efile, sep=",")

mus_exons = regions[regions["selected"] == 1]["u"] # avg u per exon
elements = bgshr.Util.get_elements(regions, L=L)

u_avg = float(np.unique(chr_models["mean_u"])[0]) # only 1 mean u in models.csv
u_nonsyn = (2.31) / (2.31 + 1) * u_avg
u_fac = u_nonsyn / u_avg

# DFE, from Kim et al (2017)
shape = 0.215
Ne = int(df_sub["Ns"][0]) # equilibrium model
scale = 562.1 / 2 / Ne

weights = bgshr.Util.weights_gamma_dfe(s_vals, shape, scale)
weights[len(weights)-1] = 1 - sum(weights[0:len(weights)-2])

spacing = 1000 # evaluate B's every 1 kb
xs = np.arange(500, L, spacing) # xs may not contemplate fine-scale LMRs
Bs = bgshr.Predict.Bvals(xs, s_vals[:-1], splines, L=L, u=mus_exons, rmap=rmap, 
                         elements=elements, max_r=0.5)

B = bgshr.Util.integrate_with_weights(Bs, weights[:-1], u_fac=u_fac)
# NOTE: no interference correction here
# we want a DAG without feedback loops
bmap = scipy.interpolate.CubicSpline(xs, B, bc_type="natural")

ns_fac = mus_exons * u_fac / u_avg
syn_fac = (1 - u_fac) * mus_exons / u_avg

hls = []
for s in s_vals:
    hls.append(bgshr.ClassicBGS._get_Hl(s, Ne, u_avg))

pi0_ns = np.sum([h * w * ns_fac for h, w in zip(hls, weights)], axis=0) # pi_del
pi0_syn = 2 * Ne * u_avg * syn_fac

pi0_exons = np.array(pi0_ns + pi0_syn)

# 1kb
file_1kb = "maps_1kb.csv.gz"
maps_1kb = pandas.read_csv(file_1kb, sep=",")
bins_1kb = np.array(maps_1kb["end"])

# getting sum of pi del. in each 1kb window
fac_1kb = maps_1kb["avg_mut"] * u_fac / u_avg
pi_del_1kb = np.sum([h * w * fac_1kb for h, w in zip(hls, weights)], axis=0) 
pi_del = B * np.array(maps_1kb["exonic_sites"]) * pi_del_1kb / 1e3

jumps = 250 # a finer grid than the xs, to capture exonic vs intergenic pi0's
ys = np.arange(0, L, jumps) 
pi0z = np.asarray(maps_1kb["avg_mut"])[np.digitize(ys, bins_1kb)] * 2 * Ne 
pi_neu_exp = B * np.mean(pi0z.reshape(-1, int(1000/jumps)), axis=1)

for i in range(0, len(ys)):
    for j in range(0, len(elements)):
        if ys[i] >= elements[j][0] and ys[i] < elements[j][1]:
            pi0z[i] = pi0_exons[j] # replace
            
pi0_1kb = np.mean(pi0z.reshape(-1, int(1000/jumps)), axis=1) 
pi_1kb = B * pi0_1kb # B is evaluated every 'spacing' bp (1 kb)

# with mutational variance
# later on we can incorporate genealogical noise (directly on the "final" table)
pi_1kb_sim = np.zeros(len(pi_1kb))
pi_neu_sim = np.zeros(len(pi_1kb))
S = 100 # diploid sample size
for i in range(0, S): 
    pi_1kb_sim += np.random.binomial(n=1000, size=len(pi_1kb), p=pi_1kb) / 1000
    pi_neu_sim += np.random.binomial(n=1000, size=len(pi_neu_exp), p=pi_neu_exp) / 1000
    
pi_mu_1kb = pi_mu_1kb / S
pi_neu_sim = pi_neu_sim / S

maps_1kb.insert(len(maps_1kb.columns), "B", B)
maps_1kb.insert(len(maps_1kb.columns), "pi_neu_exp", pi_neu_exp)
maps_1kb.insert(len(maps_1kb.columns), "pi_neu_sim", pi_neu_sim)
maps_1kb.insert(len(maps_1kb.columns), "pi_del_exp", pi_del)
maps_1kb.insert(len(maps_1kb.columns), "pi_exp", pi_1kb)
maps_1kb.insert(len(maps_1kb.columns), "sim_pi", pi_1kb_sim)

fout = "tbl_1kb.csv.gz"
maps_1kb.to_csv(fout, index=False)
```

```{bash, run-python, engine.opts='-i', include=T, eval=T, results=F, warning=F}

source ~/.bashrc

conda activate bgs
for ((m=1; m<=$num_models; m++))
do
  cd model_$m
  for ((r=1; r<=$num_reps; r++))
  do
    cd rep_$r
    python build_tbl.py
    cd ..
  done
  cd ..
done

```

# Specifying causal models

Visualization

```{r dags-viz, include=F, message=F, warning=F}

DAG1 <- dagify(
  pi ~ D,
  pi ~ B,
  pi ~ u,
  B ~ S,
  B ~ u,
  B ~ r,
  u ~ r
)

DD1p <- DAG1 %>% 
  tidy_dagitty(layout="auto") %>%
  arrange(name) %>% 
  ggplot(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_dag_node() +
  geom_dag_edges() +
  theme_dag() + 
  geom_dag_text(parse=TRUE, 
                label = c("B", "D", "S", expression(pi), "r", expression(mu)))
  
save_plot("DAG_1.svg", DD1p)
save_plot("DAG_1.png", DD1p)

DAG2 <- dagify(
  pi_s ~ B,
  pi_s ~ u,
  B ~ pi_n,
  B ~ r,
  B ~ S,
  u ~ r,
  pi_n ~ u,
  pi_n ~ S
)

DD2p <- DAG2 %>% 
  tidy_dagitty(layout="fr") %>%
  arrange(name) %>% 
  ggplot(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_dag_node() +
  geom_dag_edges() +
  theme_dag() + 
  geom_dag_text(parse=TRUE, 
                label = c("B", "S", 
                          expression(pi[N]), expression(pi[S]), 
                          "r", expression(mu)))
  
save_plot("DAG_2.svg", DD2p)
save_plot("DAG_2.png", DD2p)

DAG3 <- dagify(
  pi_s ~ B,
  pi_s ~ u,
  B ~ pi_n,
  B ~ LD,
  LD ~ S,
  LD ~ r,
  pi_n ~ S,
  u ~ r,
  pi_n ~ u
)

DD3p <- DAG3 %>% 
  tidy_dagitty(layout="auto") %>%
  arrange(name) %>% 
  ggplot(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_dag_node() +
  geom_dag_edges() +
  theme_dag() + 
  geom_dag_text(parse=TRUE, 
                label = c("B", "LD", "S", 
                          expression(pi[N]), 
                          expression(pi[S]), "r", expression(mu)))

save_plot("DAG_3.svg", DD3p)
save_plot("DAG_3.png", DD3p)

# with interference
DAG4 <- dagify(
  pi_s ~ B,
  pi_s ~ u,
  B ~ pi_n,
  B ~ LD,
  Ne ~ B,
  LD ~ Ne,
  pi_n ~ Ne,
  S ~ Ne,
  pi_s ~ Ne,
  LD ~ S,
  LD ~ r,
  pi_n ~ S,
  u ~ r,
  pi_n ~ u
)

DD4p <- DAG4 %>% 
  tidy_dagitty(layout="auto") %>%
  arrange(name) %>% 
  ggplot(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_dag_node() +
  geom_dag_edges() +
  theme_dag() + 
  geom_dag_text(parse=TRUE, 
                label = c("B", "LD", "Ne", "S",
                          expression(pi[N]), 
                          expression(pi[S]), "r", expression(mu)))

save_plot("DAG_4.svg", DD4p)
save_plot("DAG_4.png", DD4p)

DAG5 <- dagify(
  pi_s ~ B,
  pi_s ~ u,
  B ~ pi_n,
  B ~ r,
  pi_n ~ E,
  u ~ r,
  pi_n ~ u,
  pi ~ pi_s,
  pi ~ pi_n
)

# assuming the strength of selection is constant across functional elements
# the problem is that B and piN cannot affect each other directly
DD5p <- DAG5 %>% 
  tidy_dagitty(layout="auto") %>%
  arrange(name) %>% 
  ggplot(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_dag_node() +
  geom_dag_edges() +
  theme_dag() + 
  geom_dag_text(parse=TRUE, 
                label = c("B", "E", expression(pi),
                          expression(pi[N]), 
                          expression(pi[S]),
                          "r", expression(mu)))

save_plot("DAG_5.svg", DD5p)
save_plot("DAG_5.png", DD5p)

DAG6 <- dagify(
  pi ~ B,
  pi ~ u,
  B ~ E,
  B ~ r,
  B ~ u,
  u ~ r
)

# simplifying pi
DD6p <- DAG6 %>% 
  tidy_dagitty(layout="auto") %>%
  arrange(name) %>% 
  ggplot(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_dag_node() +
  geom_dag_edges() +
  theme_dag() + 
  geom_dag_text(parse=TRUE, 
                label = c("B", "E", expression(pi),
                          "r", expression(mu)))

save_plot("DAG_6.svg", DD6p)
save_plot("DAG_6.png", DD6p)

# non-mutagenic rec
DAG7 <- dagify(
  pi ~ B,
  pi ~ u,
  B ~ E,
  B ~ r,
  B ~ u
)

# simplifying pi
DD7p <- DAG7 %>% 
  tidy_dagitty(layout="auto") %>%
  arrange(name) %>% 
  ggplot(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_dag_node() +
  geom_dag_edges() +
  theme_dag() + 
  geom_dag_text(parse=TRUE, 
                label = c("B", "E", expression(pi),
                          "r", expression(mu)))

save_plot("DAG_7.svg", DD7p)
save_plot("DAG_7.png", DD7p)
```

The DAGs that we will test with the data via d-sep (based on DD6p and DD7p).
NOTE: '~' operator means 'is a affected by'
Selection is constant across exons.
We set variable names to match column names in the output of the python chunk.

```{r dags-models, include=F, message=F, warning=F}

D1g <- DAG(
  B~avg_rec,
  B~exonic_sites,
  B~avg_mut,
  pi_exp~B,
  pi_exp~avg_mut
)

D2g <- DAG(
  avg_mut~avg_rec,
  B~avg_rec,
  B~exonic_sites,
  B~avg_mut,
  pi_exp~B,
  pi_exp~avg_mut
)

D3g <- DAG(
  B~avg_rec,
  B~exonic_sites,
  B~avg_mut,
  sim_pi~B,
  sim_pi~avg_mut
)

D4g <- DAG(
  avg_mut~avg_rec,
  B~avg_rec,
  B~exonic_sites,
  B~avg_mut,
  sim_pi~B,
  sim_pi~avg_mut
)

bs1 <- basiSet(D1g)
bs2 <- basiSet(D2g)
bs3 <- basiSet(D3g)
bs4 <- basiSet(D4g)
```

# Simulated data

These simulations are based purely on (naive) moments++ predictions using 
artificially constructed maps.

Therefore, there is no interference in these data.

First we evaluate the goodness of fit of models 1-4 via d-separation.
Unlike the SEM approach from later chunks, these tests include the number of
exonic sites in the DAG, because they are more flexible (Spearman pcors).

```{r d-sep-DAG1, include=F, message=F, warning=F}

basis_set <- bs1
weights <- rep(1, length=length(basis_set))
    
dsep_c_1kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_10kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_100kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_1Mb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))

# NOTE: interpreting Fisher's C test is tricky because of auto-correlation
# within each of the genomic maps. Looking at larger scales is more informative
names(dsep_c_1kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_10kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_100kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_1Mb) <- paste("rep_", 1:num_reps, sep="")

pb <- txtProgressBar(min=0, max=num_models, style=3)  
for(m in 1:num_models) {
  setTxtProgressBar(pb, m)
  for(rep in 1:num_reps) {
    
    maps_1kb <- fread(paste("model_", m, "/rep_", rep, 
                            "/tbl_1kb.csv.gz", sep=""))
    data_cols <- names(maps_1kb)[4:ncol(maps_1kb)]
    
    maps_1kb$bin_10kb <- (1:nrow(maps_1kb) - 1) %/% 10
    maps_1kb$bin_100kb <- (1:nrow(maps_1kb) - 1) %/% 100
    maps_1kb$bin_1Mb <- (1:nrow(maps_1kb) - 1) %/% 1000
    
    maps_10kb <- maps_1kb %>%
                 group_by(bin_10kb) %>% 
                 summarise_at(data_cols, mean) %>%
                 dplyr::select(., -bin_10kb) %>% as.data.table()
    
    maps_100kb <- maps_1kb %>%
                  group_by(bin_100kb) %>% 
                  summarise_at(data_cols, mean) %>%
                  dplyr::select(., -bin_100kb) %>% as.data.table()
    
    maps_1Mb <- maps_1kb %>%
                group_by(bin_1Mb) %>% 
                summarise_at(data_cols, mean) %>%
                dplyr::select(., -bin_1Mb) %>% as.data.table()
    
    maps_1kb <- dplyr::select(maps_1kb, data_cols)
    # this filtering step is to remove auto-correlation at smaller scales
    maps_1kb <- dplyr::filter(maps_1kb, row_number() %% 1000 == 0) 
    maps_10kb <- dplyr::filter(maps_10kb, row_number() %% 100 == 0) 
    
    pvals_1kb <- numeric(length=length(basis_set))
    pvals_10kb <- numeric(length=length(basis_set))
    pvals_100kb <- numeric(length=length(basis_set))
    pvals_1Mb <- numeric(length=length(basis_set))
    
    for(i in 1:length(basis_set)) {
      
      var1 <- basis_set[[i]][1]
      var2 <- basis_set[[i]][2]
      
      cond <- NULL
      if(length(basis_set[[i]]) > 2) {
        cond <- basis_set[[i]][3:length(basis_set[[i]])]
      }
      
      dSep(D1g, var1, var2, cond)
      
      if(length(basis_set[[i]]) > 2) {
         pvals_1kb[i] <- ppcor::pcor.test(maps_1kb[, ..var1], 
                                          maps_1kb[, ..var2], 
                                          maps_1kb[, ..cond],
                                          method="spearman")$p.value
         
         pvals_10kb[i] <- ppcor::pcor.test(maps_10kb[, ..var1], 
                                           maps_10kb[, ..var2], 
                                           maps_10kb[, ..cond],
                                           method="spearman")$p.value
         
         pvals_100kb[i] <- ppcor::pcor.test(maps_100kb[, ..var1], 
                                            maps_100kb[, ..var2], 
                                            maps_100kb[, ..cond],
                                            method="spearman")$p.value
         
         pvals_1Mb[i] <- ppcor::pcor.test(maps_1Mb[, ..var1], 
                                          maps_1Mb[, ..var2], 
                                          maps_1Mb[, ..cond],
                                          method="spearman")$p.value
         
      } else {
        pvals_1kb[i] <- cor.test(maps_1kb[, ..var1][[1]],
                                 maps_1kb[, ..var2][[1]],
                                 method="spearman")$p.value
        
        pvals_10kb[i] <- cor.test(maps_10kb[, ..var1][[1]],
                                  maps_10kb[, ..var2][[1]],
                                  method="spearman")$p.value
        
        pvals_100kb[i] <- cor.test(maps_100kb[, ..var1][[1]],
                                   maps_100kb[, ..var2][[1]],
                                   method="spearman")$p.value
        
        pvals_1Mb[i] <- cor.test(maps_1Mb[, ..var1][[1]],
                                 maps_1Mb[, ..var2][[1]],
                                 method="spearman")$p.value
      }
    }

    dsep_c_1kb[m, rep] <- combine.test(pvals_1kb, weights, "fisher")
    dsep_c_10kb[m, rep] <- combine.test(pvals_10kb, weights, "fisher")
    dsep_c_100kb[m, rep] <- combine.test(pvals_100kb, weights, "fisher")
    dsep_c_1Mb[m, rep] <- combine.test(pvals_1Mb, weights, "fisher")
  }
}
close(pb)

pval_dsep <- rbind.data.frame(dsep_c_1kb,
                              dsep_c_10kb,
                              dsep_c_100kb,
                              dsep_c_1Mb)
pval_dsep$DAG <- 1
pval_dsep$scale <- c(rep(1e+3, num_models),
                     rep(1e+4, num_models),
                     rep(1e+5, num_models),
                     rep(1e+6, num_models))

fwrite(pval_dsep, "pval_dsep1.csv")
```

```{r d-sep-DAG2, include=F, message=F, warning=F}

basis_set <- bs2
weights <- rep(1, length=length(basis_set))
    
dsep_c_1kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_10kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_100kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_1Mb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))

# NOTE: interpreting Fisher's C test is tricky because of auto-correlation
# within each of the genomic maps. Looking at larger scales is more informative
names(dsep_c_1kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_10kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_100kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_1Mb) <- paste("rep_", 1:num_reps, sep="")

pb <- txtProgressBar(min=0, max=num_models, style=3)  
for(m in 1:num_models) {
  setTxtProgressBar(pb, m)
  for(rep in 1:num_reps) {
    
    maps_1kb <- fread(paste("model_", m, "/rep_", rep, 
                            "/tbl_1kb.csv.gz", sep=""))
    data_cols <- names(maps_1kb)[4:ncol(maps_1kb)]
    
    maps_1kb$bin_10kb <- (1:nrow(maps_1kb) - 1) %/% 10
    maps_1kb$bin_100kb <- (1:nrow(maps_1kb) - 1) %/% 100
    maps_1kb$bin_1Mb <- (1:nrow(maps_1kb) - 1) %/% 1000
    
    maps_10kb <- maps_1kb %>%
                 group_by(bin_10kb) %>% 
                 summarise_at(data_cols, mean) %>%
                 dplyr::select(., -bin_10kb) %>% as.data.table()
    
    maps_100kb <- maps_1kb %>%
                  group_by(bin_100kb) %>% 
                  summarise_at(data_cols, mean) %>%
                  dplyr::select(., -bin_100kb) %>% as.data.table()
    
    maps_1Mb <- maps_1kb %>%
                group_by(bin_1Mb) %>% 
                summarise_at(data_cols, mean) %>%
                dplyr::select(., -bin_1Mb) %>% as.data.table()
    
    maps_1kb <- dplyr::select(maps_1kb, data_cols)
    # this filtering step is to remove auto-correlation at smaller scales
    maps_1kb <- dplyr::filter(maps_1kb, row_number() %% 1000 == 0) 
    maps_10kb <- dplyr::filter(maps_10kb, row_number() %% 100 == 0) 
    
    pvals_1kb <- numeric(length=length(basis_set))
    pvals_10kb <- numeric(length=length(basis_set))
    pvals_100kb <- numeric(length=length(basis_set))
    pvals_1Mb <- numeric(length=length(basis_set))
    
    for(i in 1:length(basis_set)) {
      
      var1 <- basis_set[[i]][1]
      var2 <- basis_set[[i]][2]
      
      cond <- NULL
      if(length(basis_set[[i]]) > 2) {
        cond <- basis_set[[i]][3:length(basis_set[[i]])]
      }
      
      dSep(D1g, var1, var2, cond)
      
      if(length(basis_set[[i]]) > 2) {
         pvals_1kb[i] <- ppcor::pcor.test(maps_1kb[, ..var1], 
                                          maps_1kb[, ..var2], 
                                          maps_1kb[, ..cond],
                                          method="spearman")$p.value
         
         pvals_10kb[i] <- ppcor::pcor.test(maps_10kb[, ..var1], 
                                           maps_10kb[, ..var2], 
                                           maps_10kb[, ..cond],
                                           method="spearman")$p.value
         
         pvals_100kb[i] <- ppcor::pcor.test(maps_100kb[, ..var1], 
                                            maps_100kb[, ..var2], 
                                            maps_100kb[, ..cond],
                                            method="spearman")$p.value
         
         pvals_1Mb[i] <- ppcor::pcor.test(maps_1Mb[, ..var1], 
                                          maps_1Mb[, ..var2], 
                                          maps_1Mb[, ..cond],
                                          method="spearman")$p.value
         
      } else {
        pvals_1kb[i] <- cor.test(maps_1kb[, ..var1][[1]],
                                 maps_1kb[, ..var2][[1]],
                                 method="spearman")$p.value
        
        pvals_10kb[i] <- cor.test(maps_10kb[, ..var1][[1]],
                                  maps_10kb[, ..var2][[1]],
                                  method="spearman")$p.value
        
        pvals_100kb[i] <- cor.test(maps_100kb[, ..var1][[1]],
                                   maps_100kb[, ..var2][[1]],
                                   method="spearman")$p.value
        
        pvals_1Mb[i] <- cor.test(maps_1Mb[, ..var1][[1]],
                                 maps_1Mb[, ..var2][[1]],
                                 method="spearman")$p.value
      }
    }

    dsep_c_1kb[m, rep] <- combine.test(pvals_1kb, weights, "fisher")
    dsep_c_10kb[m, rep] <- combine.test(pvals_10kb, weights, "fisher")
    dsep_c_100kb[m, rep] <- combine.test(pvals_100kb, weights, "fisher")
    dsep_c_1Mb[m, rep] <- combine.test(pvals_1Mb, weights, "fisher")
  }
}
close(pb)

pval_dsep <- rbind.data.frame(dsep_c_1kb,
                              dsep_c_10kb,
                              dsep_c_100kb,
                              dsep_c_1Mb)
pval_dsep$DAG <- 2
pval_dsep$scale <- c(rep(1e+3, num_models),
                     rep(1e+4, num_models),
                     rep(1e+5, num_models),
                     rep(1e+6, num_models))

fwrite(pval_dsep, "pval_dsep2.csv")
```

```{r d-sep-DAG3, include=F, message=F, warning=F}

basis_set <- bs3
weights <- rep(1, length=length(basis_set))
    
dsep_c_1kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_10kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_100kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_1Mb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))

# NOTE: interpreting Fisher's C test is tricky because of auto-correlation
# within each of the genomic maps. Looking at larger scales is more informative
names(dsep_c_1kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_10kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_100kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_1Mb) <- paste("rep_", 1:num_reps, sep="")

pb <- txtProgressBar(min=0, max=num_models, style=3)  
for(m in 1:num_models) {
  setTxtProgressBar(pb, m)
  for(rep in 1:num_reps) {
    
    maps_1kb <- fread(paste("model_", m, "/rep_", rep, 
                            "/tbl_1kb.csv.gz", sep=""))
    data_cols <- names(maps_1kb)[4:ncol(maps_1kb)]
    
    maps_1kb$bin_10kb <- (1:nrow(maps_1kb) - 1) %/% 10
    maps_1kb$bin_100kb <- (1:nrow(maps_1kb) - 1) %/% 100
    maps_1kb$bin_1Mb <- (1:nrow(maps_1kb) - 1) %/% 1000
    
    maps_10kb <- maps_1kb %>%
                 group_by(bin_10kb) %>% 
                 summarise_at(data_cols, mean) %>%
                 dplyr::select(., -bin_10kb) %>% as.data.table()
    
    maps_100kb <- maps_1kb %>%
                  group_by(bin_100kb) %>% 
                  summarise_at(data_cols, mean) %>%
                  dplyr::select(., -bin_100kb) %>% as.data.table()
    
    maps_1Mb <- maps_1kb %>%
                group_by(bin_1Mb) %>% 
                summarise_at(data_cols, mean) %>%
                dplyr::select(., -bin_1Mb) %>% as.data.table()
    
    maps_1kb <- dplyr::select(maps_1kb, data_cols)
    # this filtering step is to remove auto-correlation at smaller scales
    maps_1kb <- dplyr::filter(maps_1kb, row_number() %% 1000 == 0) 
    maps_10kb <- dplyr::filter(maps_10kb, row_number() %% 100 == 0) 
    
    pvals_1kb <- numeric(length=length(basis_set))
    pvals_10kb <- numeric(length=length(basis_set))
    pvals_100kb <- numeric(length=length(basis_set))
    pvals_1Mb <- numeric(length=length(basis_set))
    
    for(i in 1:length(basis_set)) {
      
      var1 <- basis_set[[i]][1]
      var2 <- basis_set[[i]][2]
      
      cond <- NULL
      if(length(basis_set[[i]]) > 2) {
        cond <- basis_set[[i]][3:length(basis_set[[i]])]
      }
      
      dSep(D3g, var1, var2, cond)
      
      if(length(basis_set[[i]]) > 2) {
         pvals_1kb[i] <- ppcor::pcor.test(maps_1kb[, ..var1], 
                                          maps_1kb[, ..var2], 
                                          maps_1kb[, ..cond],
                                          method="spearman")$p.value
         
         pvals_10kb[i] <- ppcor::pcor.test(maps_10kb[, ..var1], 
                                           maps_10kb[, ..var2], 
                                           maps_10kb[, ..cond],
                                           method="spearman")$p.value
         
         pvals_100kb[i] <- ppcor::pcor.test(maps_100kb[, ..var1], 
                                            maps_100kb[, ..var2], 
                                            maps_100kb[, ..cond],
                                            method="spearman")$p.value
         
         pvals_1Mb[i] <- ppcor::pcor.test(maps_1Mb[, ..var1], 
                                          maps_1Mb[, ..var2], 
                                          maps_1Mb[, ..cond],
                                          method="spearman")$p.value
         
      } else {
        pvals_1kb[i] <- cor.test(maps_1kb[, ..var1][[1]],
                                 maps_1kb[, ..var2][[1]],
                                 method="spearman")$p.value
        
        pvals_10kb[i] <- cor.test(maps_10kb[, ..var1][[1]],
                                  maps_10kb[, ..var2][[1]],
                                  method="spearman")$p.value
        
        pvals_100kb[i] <- cor.test(maps_100kb[, ..var1][[1]],
                                   maps_100kb[, ..var2][[1]],
                                   method="spearman")$p.value
        
        pvals_1Mb[i] <- cor.test(maps_1Mb[, ..var1][[1]],
                                 maps_1Mb[, ..var2][[1]],
                                 method="spearman")$p.value
      }
    }

    dsep_c_1kb[m, rep] <- combine.test(pvals_1kb, weights, "fisher")
    dsep_c_10kb[m, rep] <- combine.test(pvals_10kb, weights, "fisher")
    dsep_c_100kb[m, rep] <- combine.test(pvals_100kb, weights, "fisher")
    dsep_c_1Mb[m, rep] <- combine.test(pvals_1Mb, weights, "fisher")
  }
}
close(pb)

pval_dsep <- rbind.data.frame(dsep_c_1kb,
                              dsep_c_10kb,
                              dsep_c_100kb,
                              dsep_c_1Mb)
pval_dsep$DAG <- 3
pval_dsep$scale <- c(rep(1e+3, num_models),
                     rep(1e+4, num_models),
                     rep(1e+5, num_models),
                     rep(1e+6, num_models))

fwrite(pval_dsep, "pval_dsep3.csv")
```

```{r d-sep-DAG4, include=F, message=F, warning=F}

basis_set <- bs4
weights <- rep(1, length=length(basis_set))
    
dsep_c_1kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_10kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_100kb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))
dsep_c_1Mb <- as.data.frame(matrix(nrow=num_models, ncol=num_reps))

# NOTE: interpreting Fisher's C test is tricky because of auto-correlation
# within each of the genomic maps. Looking at larger scales is more informative
names(dsep_c_1kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_10kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_100kb) <- paste("rep_", 1:num_reps, sep="")
names(dsep_c_1Mb) <- paste("rep_", 1:num_reps, sep="")

pb <- txtProgressBar(min=0, max=num_models, style=3)  
for(m in 1:num_models) {
  setTxtProgressBar(pb, m)
  for(rep in 1:num_reps) {
    
    maps_1kb <- fread(paste("model_", m, "/rep_", rep, 
                            "/tbl_1kb.csv.gz", sep=""))
    data_cols <- names(maps_1kb)[4:ncol(maps_1kb)]
    
    maps_1kb$bin_10kb <- (1:nrow(maps_1kb) - 1) %/% 10
    maps_1kb$bin_100kb <- (1:nrow(maps_1kb) - 1) %/% 100
    maps_1kb$bin_1Mb <- (1:nrow(maps_1kb) - 1) %/% 1000
    
    maps_10kb <- maps_1kb %>%
                 group_by(bin_10kb) %>% 
                 summarise_at(data_cols, mean) %>%
                 dplyr::select(., -bin_10kb) %>% as.data.table()
    
    maps_100kb <- maps_1kb %>%
                  group_by(bin_100kb) %>% 
                  summarise_at(data_cols, mean) %>%
                  dplyr::select(., -bin_100kb) %>% as.data.table()
    
    maps_1Mb <- maps_1kb %>%
                group_by(bin_1Mb) %>% 
                summarise_at(data_cols, mean) %>%
                dplyr::select(., -bin_1Mb) %>% as.data.table()
    
    maps_1kb <- dplyr::select(maps_1kb, data_cols)
    # this filtering step is to remove auto-correlation at smaller scales
    maps_1kb <- dplyr::filter(maps_1kb, row_number() %% 1000 == 0) 
    maps_10kb <- dplyr::filter(maps_10kb, row_number() %% 100 == 0) 
    
    pvals_1kb <- numeric(length=length(basis_set))
    pvals_10kb <- numeric(length=length(basis_set))
    pvals_100kb <- numeric(length=length(basis_set))
    pvals_1Mb <- numeric(length=length(basis_set))
    
    for(i in 1:length(basis_set)) {
      
      var1 <- basis_set[[i]][1]
      var2 <- basis_set[[i]][2]
      
      cond <- NULL
      if(length(basis_set[[i]]) > 2) {
        cond <- basis_set[[i]][3:length(basis_set[[i]])]
      }
      
      dSep(D4g, var1, var2, cond)
      
      if(length(basis_set[[i]]) > 2) {
         pvals_1kb[i] <- ppcor::pcor.test(maps_1kb[, ..var1], 
                                          maps_1kb[, ..var2], 
                                          maps_1kb[, ..cond],
                                          method="spearman")$p.value
         
         pvals_10kb[i] <- ppcor::pcor.test(maps_10kb[, ..var1], 
                                           maps_10kb[, ..var2], 
                                           maps_10kb[, ..cond],
                                           method="spearman")$p.value
         
         pvals_100kb[i] <- ppcor::pcor.test(maps_100kb[, ..var1], 
                                            maps_100kb[, ..var2], 
                                            maps_100kb[, ..cond],
                                            method="spearman")$p.value
         
         pvals_1Mb[i] <- ppcor::pcor.test(maps_1Mb[, ..var1], 
                                          maps_1Mb[, ..var2], 
                                          maps_1Mb[, ..cond],
                                          method="spearman")$p.value
         
      } else {
        pvals_1kb[i] <- cor.test(maps_1kb[, ..var1][[1]],
                                 maps_1kb[, ..var2][[1]],
                                 method="spearman")$p.value
        
        pvals_10kb[i] <- cor.test(maps_10kb[, ..var1][[1]],
                                  maps_10kb[, ..var2][[1]],
                                  method="spearman")$p.value
        
        pvals_100kb[i] <- cor.test(maps_100kb[, ..var1][[1]],
                                   maps_100kb[, ..var2][[1]],
                                   method="spearman")$p.value
        
        pvals_1Mb[i] <- cor.test(maps_1Mb[, ..var1][[1]],
                                 maps_1Mb[, ..var2][[1]],
                                 method="spearman")$p.value
      }
    }

    dsep_c_1kb[m, rep] <- combine.test(pvals_1kb, weights, "fisher")
    dsep_c_10kb[m, rep] <- combine.test(pvals_10kb, weights, "fisher")
    dsep_c_100kb[m, rep] <- combine.test(pvals_100kb, weights, "fisher")
    dsep_c_1Mb[m, rep] <- combine.test(pvals_1Mb, weights, "fisher")
  }
}
close(pb)

pval_dsep <- rbind.data.frame(dsep_c_1kb,
                              dsep_c_10kb,
                              dsep_c_100kb,
                              dsep_c_1Mb)
pval_dsep$DAG <- 4
pval_dsep$scale <- c(rep(1e+3, num_models),
                     rep(1e+4, num_models),
                     rep(1e+5, num_models),
                     rep(1e+6, num_models))

fwrite(pval_dsep, "pval_dsep4.csv")
```

Combine table with results from previous chunks.

```{r d-sep-tbl, include=F, message=F, warning=F}

pval_dsep1 <- fread("pval_dsep1.csv")
pval_dsep2 <- fread("pval_dsep2.csv")
pval_dsep3 <- fread("pval_dsep3.csv")
pval_dsep4 <- fread("pval_dsep4.csv")

```

Correlations and linear models.
TODO: Explain why we do this.

```{r lms, include=F, message=F, warning=F}

for(m in 1:num_models) {
  print(paste(m, Sys.Date(), Sys.time()), sep="\t")
  for(rep in 1:num_reps) {
    
    maps_1kb <- fread(paste("model_", m, "/rep_", rep, 
                            "/tbl_1kb.csv.gz", sep=""))
    data_cols <- names(maps_1kb)[4:ncol(maps_1kb)]
    
    maps_1kb$bin_10kb <- (1:nrow(maps_1kb) - 1) %/% 10
    maps_1kb$bin_100kb <- (1:nrow(maps_1kb) - 1) %/% 100
    maps_1kb$bin_1Mb <- (1:nrow(maps_1kb) - 1) %/% 1000
    
    maps_10kb <- maps_1kb %>%
                 group_by(bin_10kb) %>% 
                 summarise_at(data_cols, mean) %>%
                 dplyr::select(., -bin_10kb)
    
    maps_100kb <- maps_1kb %>%
                  group_by(bin_100kb) %>% 
                  summarise_at(data_cols, mean) %>%
                  dplyr::select(., -bin_100kb)
    
    maps_1Mb <- maps_1kb %>%
                group_by(bin_1Mb) %>% 
                summarise_at(data_cols, mean) %>%
                dplyr::select(., -bin_1Mb)
    
    maps_1kb <- dplyr::select(maps_1kb, data_cols)

    mat=Hmisc::rcorr(as.matrix(filter(maps_1kb, row_number() %% 1000 == 0)),
                     type="spearman") # to remove auto-correlation
    tbl_1kb <- mat$r
    tbl_1kb[upper.tri(tbl_1kb)] <- mat$P[upper.tri(mat$P)]
    suppressMessages(fwrite(tbl_1kb, paste("model_", m, "/rep_", rep, 
                                           "/pval_upper_spearman_lower_1kb.csv", 
                                           sep="")))

    mat=Hmisc::rcorr(as.matrix(filter(maps_1kb, row_number() %% 100 == 0)),
                     type="spearman") # to remove auto-correlation
    tbl_10kb <- mat$r
    tbl_10kb[upper.tri(tbl_10kb)] <- mat$P[upper.tri(mat$P)]
    suppressMessages(fwrite(tbl_10kb, paste("model_", m, "/rep_", rep, 
                                            "/pval_upper_spearman_lower_10kb.csv", 
                                            sep="")))

    mat=Hmisc::rcorr(as.matrix(maps_100kb), type="spearman")
    tbl_100kb <- mat$r
    tbl_100kb[upper.tri(tbl_100kb)] <- mat$P[upper.tri(mat$P)]
    suppressMessages(fwrite(tbl_100kb, paste("model_", m, "/rep_", rep, 
                                             "/pval_upper_spearman_lower_100kb.csv", 
                                             sep="")))

    mat=Hmisc::rcorr(as.matrix(maps_1Mb), type="spearman")
    tbl_1Mb <- mat$r
    tbl_1Mb[upper.tri(tbl_1Mb)] <- mat$P[upper.tri(mat$P)]
    suppressMessages(fwrite(tbl_1Mb, paste("model_", m, "/rep_", rep, 
                                           "/pval_upper_spearman_lower_1Mb.csv", 
                                           sep="")))
    
    # table for storing partitioned R^2 values from type II ANOVA 
    r2_tbl <- as.data.frame(matrix(ncol=3, nrow=4))
    names(r2_tbl) <- c("u", "B", "B:u")
    r2_tbl$scale <- c(1e+3, 1e+4, 1e+5, 1e+6) # rows are bin sizes
    
    # table for storing total R^2 values straight from the lm function ()
    r2_raw <- as.data.frame(matrix(ncol=1, nrow=4))
    names(r2_raw) <- "r2_typeI"
    r2_raw$scale <- c(1e+3, 1e+4, 1e+5, 1e+6) # rows are bin sizes
    
    # tables for storing correlations with simulated pi (E[pi] + mut. var)
    corr_tbl <- as.data.frame(matrix(ncol=3, nrow=4))
    names(corr_tbl) <- c("u", "B", "Predicted")
    corr_tbl$scale <- c(1e+3, 1e+4, 1e+5, 1e+6) # rows are bin sizes
    
    # table for storing p-values of tests related to lm assumptions
    tests_tbl <- as.data.frame(matrix(ncol=3, nrow=4))
    names(tests_tbl) <- c("DW_test_p", "HMC_test_p", "Shapiro_test_p")
    tests_tbl$scale <- c(1e+3, 1e+4, 1e+5, 1e+6) # rows are bin sizes
    
    corr_tbl$Predicted[1] <- cor.test(maps_1kb$sim_pi, 
                                      maps_1kb$pi_exp, 
                                      method="pearson")$estimate 
    corr_tbl$Predicted[2] <- cor.test(maps_10kb$sim_pi, 
                                      maps_10kb$pi_exp, 
                                      method="pearson")$estimate 
    corr_tbl$Predicted[3] <- cor.test(maps_100kb$sim_pi, 
                                      maps_100kb$pi_exp,
                                      method="pearson")$estimate  
    corr_tbl$Predicted[4] <- cor.test(maps_1Mb$sim_pi,
                                      maps_1Mb$pi_exp, 
                                      method="pearson")$estimate 
    
    corr_tbl$B[1] <- cor.test(maps_1kb$B, 
                              maps_1kb$sim_pi,
                              method="pearson")$estimate 
    corr_tbl$B[2] <- cor.test(maps_10kb$B, 
                              maps_10kb$sim_pi, 
                              method="pearson")$estimate 
    corr_tbl$B[3] <- cor.test(maps_100kb$B,
                              maps_100kb$sim_pi,
                              method="pearson")$estimate  
    corr_tbl$B[4] <- cor.test(maps_1Mb$B,
                              maps_1Mb$sim_pi, 
                              method="pearson")$estimate 
    
    corr_tbl$u[1] <- cor.test(maps_1kb$avg_mut, 
                              maps_1kb$sim_pi, 
                              method="pearson")$estimate 
    corr_tbl$u[2] <- cor.test(maps_10kb$avg_mut, 
                              maps_10kb$sim_pi,
                              method="pearson")$estimate 
    corr_tbl$u[3] <- cor.test(maps_100kb$avg_mut,
                              maps_100kb$sim_pi, 
                              method="pearson")$estimate  
    corr_tbl$u[4] <- cor.test(maps_1Mb$avg_mut,
                              maps_1Mb$sim_pi,
                              method="pearson")$estimate 
    
    fwrite(corr_tbl, paste("model_", m, "/rep_", rep, 
                           "/pearson_sim_pi_tbl.csv", sep=""))
    
    # tables for storing estimates from linear models (rows are bin sizes)
    coeff_tbl <- as.data.frame(matrix(ncol=3, nrow=4))
    pval_tbl <- as.data.frame(matrix(ncol=3, nrow=4))
    names(coeff_tbl) <- c("u", "B", "B:u")
    names(pval_tbl) <- c("u", "B", "B:u")
    coeff_tbl$scale <- c(1e+3, 1e+4, 1e+5, 1e+6)
    pval_tbl$scale <- c(1e+3, 1e+4, 1e+5, 1e+6)
    
    # VIFs
    vif_tbl <- as.data.frame(matrix(ncol=2, nrow=4))
    names(vif_tbl) <- c("u", "B")
    vif_tbl$scale <- c(1e+3, 1e+4, 1e+5, 1e+6)
    
    # standardizing variables to help interpretation of linear coefficients
    std_1kb <- as.data.frame(apply(maps_1kb, 2,
                                   function(x) (x-mean(x)) / sd(x)))
    std_1kb$bin <- 1:nrow(std_1kb)
    
    std_10kb <- as.data.frame(apply(maps_10kb, 2,
                                    function(x) (x-mean(x)) / sd(x)))
    std_10kb$bin <- 1:nrow(std_10kb)
    
    std_100kb <- as.data.frame(apply(maps_100kb, 2,
                                     function(x) (x-mean(x)) / sd(x)))
    std_100kb$bin <- 1:nrow(std_100kb)
    
    std_1Mb <- as.data.frame(apply(maps_1Mb, 2,
                                   function(x) (x-mean(x)) / sd(x)))
    std_1Mb$bin <- 1:nrow(std_1Mb)
    
    # 1 kb (NOTE: GLS on 1kb windows is too expensive)
    # filtering to remove auto-correlation
    m_1kb <- lm(sim_pi ~ (B + avg_mut) ^ 2, 
                data=filter(std_1kb, row_number() %% 200 == 0))
    summary(m_1kb)
    r2_raw$r2_typeI[1] <- summary(m_1kb)$r.squared * 100
    
    v1kb <- suppressMessages(vif(m_1kb, type='predictor'))
    vif_tbl$B[1] <- v1kb$GVIF[1]
    vif_tbl$u[1] <- v1kb$GVIF[2]
    
    dw_1kb <- dwtest(m_1kb)
    hmc_1kb <- hmctest(m_1kb)
    
    shapiro_1kb <- shapiro.test(resid(m_1kb)) 
    tests_tbl$DW_test_p[1] <- dw_1kb$p.value
    tests_tbl$HMC_test_p[1] <- hmc_1kb$p.value
    tests_tbl$Shapiro_test_p[1] <- shapiro_1kb$p.value
    
    coeff_tbl$u[1] <- m_1kb$coefficients[3]
    coeff_tbl$B[1] <- m_1kb$coefficients[2]
    coeff_tbl$`B:u`[1] <- m_1kb$coefficients[4]
    
    pval_tbl$u[1] <- summary(m_1kb)$coefficients[3,4]
    pval_tbl$B[1] <- summary(m_1kb)$coefficients[2,4]
    pval_tbl$`B:u`[1] <- summary(m_1kb)$coefficients[4,4]
    
    anova.pi <- Anova(m_1kb)
    apiss <- anova.pi$"Sum Sq"
    anova.pi$VarExp <- apiss / sum(apiss)
    
    r2_tbl$`B:u`[1] <- anova.pi$VarExp[3] * 100
    r2_tbl$u[1] <- anova.pi$VarExp[2] * 100
    r2_tbl$B[1] <- anova.pi$VarExp[1] * 100
    
    # 10 kb 
    # filtering to remove auto-correlation
    m_10kb <- lm(sim_pi ~ (B + avg_mut) ^ 2,
                 data=filter(std_10kb, row_number() %% 10 == 0))
    summary(m_10kb)
    r2_raw$r2_typeI[2] <- summary(m_10kb)$r.squared * 100
    
    v10kb <- suppressMessages(vif(m_10kb, type='predictor'))
    vif_tbl$B[2] <- v10kb$GVIF[1]
    vif_tbl$u[2] <- v10kb$GVIF[2]
    
    dw_10kb <- dwtest(m_10kb)
    hmc_10kb <- hmctest(m_10kb)
    shapiro_10kb <- shapiro.test(resid(m_10kb)) 
    tests_tbl$DW_test_p[2] <- dw_10kb$p.value
    tests_tbl$HMC_test_p[2] <- hmc_10kb$p.value
    tests_tbl$Shapiro_test_p[2] <- shapiro_10kb$p.value
    
    coeff_tbl$u[2] <- m_10kb$coefficients[3]
    coeff_tbl$B[2] <- m_10kb$coefficients[2]
    coeff_tbl$`B:u`[2] <- m_10kb$coefficients[4]
    
    pval_tbl$u[2] <- summary(m_10kb)$coefficients[3,4]
    pval_tbl$B[2] <- summary(m_10kb)$coefficients[2,4]
    pval_tbl$`B:u`[2] <- summary(m_10kb)$coefficients[4,4]
    
    anova.pi <- Anova(m_10kb)
    apiss <- anova.pi$"Sum Sq"
    anova.pi$VarExp <- apiss / sum(apiss)
    
    r2_tbl$`B:u`[2] <- anova.pi$VarExp[3] * 100
    r2_tbl$u[2] <- anova.pi$VarExp[2] * 100
    r2_tbl$B[2] <- anova.pi$VarExp[1] * 100
    
    # 100 kb
    m_100kb <- lm(sim_pi ~ (B + avg_mut) ^ 2, std_100kb)
    summary(m_100kb)
    r2_raw$r2_typeI[3] <- summary(m_100kb)$r.squared * 100
    
    v100kb <- suppressMessages(vif(m_100kb, type = 'predictor'))
    vif_tbl$B[3] <- v100kb$GVIF[1]
    vif_tbl$u[3] <- v100kb$GVIF[2]
    
    dw_100kb <- dwtest(m_100kb)
    hmc_100kb <- hmctest(m_100kb)
    shapiro_100kb <- shapiro.test(resid(m_100kb))
    tests_tbl$DW_test_p[3] <- dw_100kb$p.value
    tests_tbl$HMC_test_p[3] <- hmc_100kb$p.value
    tests_tbl$Shapiro_test_p[3] <- shapiro_100kb$p.value
    
    coeff_tbl$u[3] <- m_100kb$coefficients[3]
    coeff_tbl$B[3] <- m_100kb$coefficients[2]
    coeff_tbl$`B:u`[3] <- m_100kb$coefficients[4]
    
    pval_tbl$u[3] <- summary(m_100kb)$coefficients[3,4]
    pval_tbl$B[3] <- summary(m_100kb)$coefficients[2,4]
    pval_tbl$`B:u`[3] <- summary(m_100kb)$coefficients[4,4]
    
    anova.pi <- Anova(m_100kb)
    apiss <- anova.pi$"Sum Sq"
    anova.pi$VarExp <- apiss / sum(apiss)
    
    r2_tbl$`B:u`[3] <- anova.pi$VarExp[3] * 100
    r2_tbl$u[3] <- anova.pi$VarExp[2] * 100
    r2_tbl$B[3] <- anova.pi$VarExp[1] * 100
    
    # 1 Mb
    m_1Mb <- lm(sim_pi ~ (B + avg_mut) ^ 2, data=std_1Mb)
    summary(m_1Mb)
    r2_raw$r2_typeI[4] <- summary(m_1Mb)$r.squared * 100
    
    v1Mb <- suppressMessages(vif(m_1Mb, type = 'predictor'))
    vif_tbl$B[4] <- v1Mb$GVIF[1]
    vif_tbl$u[4] <- v1Mb$GVIF[2]
    
    dw_1Mb <- dwtest(m_1Mb)
    hmc_1Mb <- hmctest(m_1Mb)
    shapiro_1Mb <- shapiro.test(resid(m_1Mb))
    tests_tbl$DW_test_p[4] <- dw_1Mb$p.value
    tests_tbl$HMC_test_p[4] <- hmc_1Mb$p.value
    tests_tbl$Shapiro_test_p[4] <- shapiro_1Mb$p.value
    
    coeff_tbl$u[4] <- m_1Mb$coefficients[3]
    coeff_tbl$B[4] <- m_1Mb$coefficients[2]
    coeff_tbl$`B:u`[4] <- m_1Mb$coefficients[4]
    
    pval_tbl$u[4] <- summary(m_1Mb)$coefficients[3,4]
    pval_tbl$B[4] <- summary(m_1Mb)$coefficients[2,4]
    pval_tbl$`B:u`[4] <- summary(m_1Mb)$coefficients[4,4]
    
    anova.pi <- Anova(m_1Mb)
    apiss <- anova.pi$"Sum Sq"
    anova.pi$VarExp <- apiss / sum(apiss)
    
    r2_tbl$`B:u`[4] <- anova.pi$VarExp[3] * 100
    r2_tbl$u[4] <- anova.pi$VarExp[2] * 100
    r2_tbl$B[4] <- anova.pi$VarExp[1] * 100
    
    fwrite(r2_raw, paste("model_", m, "/rep_", rep, 
                         "/r2_raw_tbl.csv", sep=""))
    fwrite(coeff_tbl, paste("model_", m, "/rep_", rep, 
                         "/coeff_tbl.csv", sep=""))
    fwrite(pval_tbl, paste("model_", m, "/rep_", rep, 
                         "/pval_tbl.csv", sep=""))
    fwrite(r2_tbl, paste("model_", m, "/rep_", rep, 
                         "/r2_typeII_tbl.csv", sep=""))
    fwrite(vif_tbl, paste("model_", m, "/rep_", rep, 
                         "/vif_tbl.csv", sep=""))
    fwrite(tests_tbl, paste("model_", m, "/rep_", rep, 
                         "/tests_tbl.csv", sep=""))

    # 1 kb
    df_1kb <- cbind.data.frame(resid(m_1kb), fitted(m_1kb))
    names(df_1kb) <- c("residuals", "fitted")
    p_1kb <- ggplot(data=df_1kb, aes(x=residuals, y=fitted)) + 
             geom_point(size=2, shape=1) + 
             theme_bw() + labs(title="1kb", x=NULL, y="Fitted") +
             theme(axis.title.x=element_text(size=16),
                   axis.text.x=element_text(size=12),
                   axis.text.y=element_text(size=12),
                   axis.title.y=element_text(size=16),
                   plot.title=element_text(size=20))
    
    q_1kb <- ggplot(data=df_1kb, aes(x=residuals)) + 
             geom_histogram(aes(y=..density..), bins=50) + 
             stat_function(fun=dnorm, color="red",
                           args=list(mean=mean(df_1kb$residuals), 
                                    sd=sd(df_1kb$residuals))) +
             theme_bw() + labs(title=NULL, x="Residuals", y="Count") +
             theme(axis.title.x=element_text(size=16),
                   axis.text.x=element_text(size=12),
                   axis.text.y=element_text(size=12),
                   axis.title.y=element_text(size=16),
                   plot.title=element_text(size=20)) 
    
    lm_1kb <- plot_grid(p_1kb, q_1kb, ncol=1)
    
    # 10 kb
    df_10kb <- cbind.data.frame(resid(m_10kb), fitted(m_10kb))
    names(df_10kb) <- c("residuals", "fitted")
    p_10kb <- ggplot(data=df_10kb, aes(x=residuals, y=fitted)) + 
             geom_point(size=2, shape=1) + 
             theme_bw() + labs(title="10 kb", x=NULL, y=NULL) +
             theme(axis.title.x=element_text(size=16),
                   axis.text.x=element_text(size=12),
                   axis.text.y=element_text(size=12),
                   axis.title.y=element_text(size=16),
                   plot.title=element_text(size=20)) 
    q_10kb <- ggplot(data=df_10kb, aes(x=residuals)) + 
             geom_histogram(aes(y=..density..), bins=30) + 
             stat_function(fun=dnorm, color="red",
                           args=list(mean=mean(df_10kb$residuals), 
                                    sd=sd(df_10kb$residuals))) +
             theme_bw() + labs(title=NULL, x="Residuals", y=NULL) +
             theme(axis.title.x=element_text(size=16),
                   axis.text.x=element_text(size=12),
                   axis.text.y=element_text(size=12),
                   axis.title.y=element_text(size=16),
                   plot.title=element_text(size=20)) 
    
    lm_10kb <- plot_grid(p_10kb, q_10kb, ncol=1)
    
    # 100 kb
    df_100kb <- cbind.data.frame(resid(m_100kb), fitted(m_100kb))
    names(df_100kb) <- c("residuals", "fitted")
    p_100kb <- ggplot(data=df_100kb, aes(x=residuals, y=fitted)) + 
             geom_point(size=2, shape=1) + 
             theme_bw() + labs(title="100 kb", x=NULL, y=NULL) +
             theme(axis.title.x=element_text(size=16),
                   axis.text.x=element_text(size=12),
                   axis.text.y=element_text(size=12),
                   axis.title.y=element_text(size=16),
                   plot.title=element_text(size=20)) 
    q_100kb <- ggplot(data=df_100kb, aes(x=residuals)) + 
             geom_histogram(aes(y=..density..), bins=15) + 
             stat_function(fun=dnorm, color="red",
                           args=list(mean=mean(df_100kb$residuals), 
                                    sd=sd(df_100kb$residuals))) +
             theme_bw() + labs(title=NULL, x="Residuals", y=NULL) +
             theme(axis.title.x=element_text(size=16),
                   axis.text.x=element_text(size=12),
                   axis.text.y=element_text(size=12),
                   axis.title.y=element_text(size=16),
                   plot.title=element_text(size=20)) 
    
    lm_100kb <- plot_grid(p_100kb, q_100kb, ncol=1)
    
    # 1 Mb
    df_1Mb <- cbind.data.frame(resid(m_1Mb), fitted(m_1Mb))
    names(df_1Mb) <- c("residuals", "fitted")
    p_1Mb <- ggplot(data=df_1Mb, aes(x=residuals, y=fitted)) + 
             geom_point(size=2, shape=1) + 
             theme_bw() + labs(title="1 Mb", x=NULL, y=NULL) +
             theme(axis.title.x=element_text(size=16),
                   axis.text.x=element_text(size=12),
                   axis.text.y=element_text(size=12),
                   axis.title.y=element_text(size=16),
                   plot.title=element_text(size=20)) 
    q_1Mb <- ggplot(data=df_1Mb, aes(x=residuals)) + 
             geom_histogram(aes(y=..density..), bins=7) + 
             stat_function(fun=dnorm, color="red",
                           args=list(mean=mean(df_1Mb$residuals), 
                                    sd=sd(df_1Mb$residuals))) +
             theme_bw() + labs(title=NULL, x="Residuals", y=NULL) +
             theme(axis.title.x=element_text(size=16),
                   axis.text.x=element_text(size=12),
                   axis.text.y=element_text(size=12),
                   axis.title.y=element_text(size=16),
                   plot.title=element_text(size=20)) 
    
    lm_1Mb <- plot_grid(p_1Mb, q_1Mb, ncol=1)
    
    lm_plots <- plot_grid(lm_1kb, lm_10kb, lm_100kb, lm_1Mb, nrow=1)
    save_plot(paste("model_", m, "/rep_", rep, "/lm_plots.svg", sep=""),
              lm_plots, base_height=10, base_width=20)
  }
}
```

Structural Equation Modeling

```{r DAGs-lavaan, include=F, message=F, warning=F}
## pi expected
DAG1 <- "
pi_exp ~ c1*B
pi_exp ~ c2*avg_mut
B ~ c3*avg_mut
B ~ c4*avg_rec
avg_mut ~~ 0*avg_rec
# fixing exogenous residual variances since we standardize variables?
avg_mut ~~ 1*avg_mut
avg_rec ~~ 1*avg_rec
# defining indirect and total effects
rec_B_pi:=c1*c4
mu_B_pi:=c1*c3
total_mu_pi:=c2 + mu_B_pi
"

DAG2 <- "
pi_exp ~ c1*B
pi_exp ~ c2*avg_mut
B ~ c3*avg_mut
B ~ c4*avg_rec
avg_mut ~ c5*avg_rec
# fixing exogenous residual variance since we standardize variables?
avg_mut ~~ 1*avg_mut
# defining indirect and total effects
mu_B_pi:=c1*c3
rec_B_pi:=c1*c4
rec_mu_pi:=c2*c5
rec_mu_B_pi:=mu_B_pi*c5
total_mu_pi:=c2 + mu_B_pi
total_rec_pi:=rec_B_pi + rec_mu_pi + rec_mu_B_pi
"

## with mutational variance
DAG3 <- "
sim_pi ~ c1*B
sim_pi ~ c2*avg_mut
B ~ c3*avg_mut
B ~ c4*avg_rec
avg_mut ~~ 0*avg_rec
# fixing exogenous residual variances since we standardize variables?
avg_mut ~~ 1*avg_mut
avg_rec ~~ 1*avg_rec
# defining indirect and total effects
rec_B_pi:=c1*c4
mu_B_pi:=c1*c3
total_mu_pi:=c2 + mu_B_pi
"

DAG4 <- "
sim_pi ~ c1*B
sim_pi ~ c2*avg_mut
B ~ c3*avg_mut
B ~ c4*avg_rec
avg_mut ~ c5*avg_rec
# fixing exogenous residual variance since we standardize variables?
avg_mut ~~ 1*avg_mut
# defining indirect and total effects
mu_B_pi:=c1*c3
rec_B_pi:=c1*c4
rec_mu_pi:=c2*c5
rec_mu_B_pi:=mu_B_pi*c5
total_mu_pi:=c2 + mu_B_pi
total_rec_pi:=rec_B_pi + rec_mu_pi + rec_mu_B_pi
"
```

```{r SEM, include=F, message=F, warning=F}

# match with d-sep Fisher's C p-value
pval_sem1_1kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem1_10kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem1_100kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem1_1Mb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))

pval_sem2_1kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem2_10kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem2_100kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem2_1Mb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))

pval_sem3_1kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem3_10kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem3_100kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem3_1Mb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))

pval_sem4_1kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem4_10kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem4_100kb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))
pval_sem4_1Mb <- as.data.table(matrix(ncol=num_models, nrow=num_reps))

for(m in 1:num_models) {
  print(paste(m, Sys.Date(), Sys.time()), sep="\t")
  for(rep in 1:num_reps) {
    # reload
    maps_1kb <- fread(paste("model_", m, "/rep_", rep, 
                            "/tbl_1kb.csv.gz", sep=""))
    data_cols <- names(maps_1kb)[4:ncol(maps_1kb)]
    
    maps_1kb$bin_10kb <- (1:nrow(maps_1kb) - 1) %/% 10
    maps_1kb$bin_100kb <- (1:nrow(maps_1kb) - 1) %/% 100
    maps_1kb$bin_1Mb <- (1:nrow(maps_1kb) - 1) %/% 1000
    
    maps_10kb <- maps_1kb %>%
                 group_by(bin_10kb) %>% 
                 summarise_at(data_cols, mean) %>%
                 dplyr::select(., -bin_10kb)
    
    maps_100kb <- maps_1kb %>%
                  group_by(bin_100kb) %>% 
                  summarise_at(data_cols, mean) %>%
                  dplyr::select(., -bin_100kb)
    
    maps_1Mb <- maps_1kb %>%
                group_by(bin_1Mb) %>% 
                summarise_at(data_cols, mean) %>%
                dplyr::select(., -bin_1Mb)
    
    maps_1kb <- dplyr::select(maps_1kb, data_cols)
    
    # MVN tests
    ## excluding exonic_sites (too far from MVN, can test its corr. to Bvals)
    ## filtering regions to avoid auto-correlation
    ## and keeping only one pi variable to avoid singularity
    mvn_1kb <- mvn(data=dplyr::select(filter(maps_1kb, 
                                             sim_pi > 0, # can happen by chance
                                             row_number() %% 1000==0),
                        c(avg_rec, avg_mut, B, sim_pi)),
                   transform="log",
                   univariatePlot="none",
                   multivariatePlot="none",
                   mvnTest="hz")
    
    mvn_10kb <- mvn(data=dplyr::select(filter(maps_10kb, row_number() %% 100==0),
                         c(avg_rec, avg_mut, B, sim_pi)),
                    transform="log",
                    univariatePlot="none",
                    multivariatePlot="none",
                    mvnTest="hz")
    
    mvn_100kb <- mvn(data=dplyr::select(filter(maps_100kb, row_number() %% 4==0),
                          c(avg_rec, avg_mut, B, sim_pi)),
                     transform="log",
                     univariatePlot="none",
                     multivariatePlot="none",
                     mvnTest="hz")
    
    mvn_1Mb <- mvn(data=dplyr::select(maps_1Mb,
                         c(avg_rec, avg_mut, B, sim_pi)),
                    transform="log",
                    univariatePlot="none",
                    multivariatePlot="none",
                    mvnTest="hz",
                    showOutliers=T)
    
    mvn_tbl <- data.frame(pval=c(mvn_1kb$multivariateNormality$`p value`,
                                 mvn_10kb$multivariateNormality$`p value`,
                                 mvn_100kb$multivariateNormality$`p value`,
                                 mvn_1Mb$multivariateNormality$`p value`),
                           scale=c(1e+3, 1e+4, 1e+5, 1e+6))
    
    fwrite(mvn_tbl, paste("model_", m, "/rep_", rep, "/mvn_tests.csv", sep=""))
    
    # log-transforming and standardizing, filtering to remove autocorrelation
    filt_1kb <- filter(maps_1kb, row_number() %% 1000 == 0, sim_pi > 0) 
    std_1kb <- as.data.frame(apply(apply(dplyr::select(filt_1kb,
      -c(exonic_sites, pi_del_exp, pi_neu_exp, pi_neu_sim)), 2, log),
      2, function(x) (x-mean(x)) / sd(x)))
    
    filt_10kb <- filter(maps_10kb, row_number() %% 100 == 0) 
    std_10kb <- as.data.frame(apply(apply(dplyr::select(filt_10kb,
      -c(exonic_sites, pi_del_exp, pi_neu_exp, pi_neu_sim)), 2, log),
      2, function(x) (x-mean(x)) / sd(x)))
    
    filt_100kb <- filter(maps_100kb, row_number() %% 4 == 0) 
    std_100kb <- as.data.frame(apply(apply(dplyr::select(filt_100kb,
      -c(exonic_sites, pi_del_exp, pi_neu_exp, pi_neu_sim)), 2, log),
      2, function(x) (x-mean(x)) / sd(x)))
    
    std_1Mb <- as.data.frame(apply(apply(dplyr::select(maps_1Mb,
      -c(exonic_sites, pi_del_exp, pi_neu_exp, pi_neu_sim)), 2, log),
      2, function(x) (x-mean(x)) / sd(x)))
    
    # Q-Q plots
    svg(paste("model_", m, "/rep_", rep, "/qq_1kb.svg", sep=""),
        width=9, height=7)
    heplots::cqplot(dplyr::select(std_1kb, c(avg_rec, avg_mut, B, sim_pi)))
    dev.off()
    
    svg(paste("model_", m, "/rep_", rep, "/qq_10kb.svg", sep=""), 
        width=9, height=7)
    heplots::cqplot(dplyr::select(std_10kb, c(avg_rec, avg_mut, B, sim_pi)))
    dev.off()
    
    svg(paste("model_", m, "/rep_", rep, "/qq_100kb.svg", sep=""),
        width=9, height=7)
    heplots::cqplot(dplyr::select(std_100kb, c(avg_rec, avg_mut, B, sim_pi)))
    dev.off()
    
    svg(paste("model_", m, "/rep_", rep, "/qq_1Mb.svg", sep=""),
        width=9, height=7)
    heplots::cqplot(dplyr::select(std_1Mb, c(avg_rec ,avg_mut, B, sim_pi)))
    dev.off()
    
    # pairwise scatter plots
    svg(paste("model_", m, "/rep_", rep, "/scatter_1kb.svg", sep=""),
        width=9, height=7)
    pairs(std_1kb)
    dev.off()
    
    svg(paste("model_", m, "/rep_", rep, "/scatter_10kb.svg", sep=""), 
        width=9, height=7)
    pairs(std_10kb)
    dev.off()
    
    svg(paste("model_", m, "/rep_", rep, "/scatter_100kb.svg", sep=""),
        width=9, height=7)
    pairs(std_100kb)
    dev.off()
    
    svg(paste("model_", m, "/rep_", rep, "/scatter_1Mb.svg", sep=""),
        width=9, height=7)
    pairs(std_1Mb)
    dev.off()
    
    # using lavaan to fit path models, DAG 1
    sem1_1kb <- sem(DAG1, data=std_1kb)
    sem1_10kb <- sem(DAG1, data=std_10kb)
    sem1_100kb <- sem(DAG1, data=std_100kb)
    sem1_1Mb <- sem(DAG1, data=std_1Mb)
    
    # storing p-values
    pval_sem1_1kb[m, rep] <- fitMeasures(sem1_1kb)[5]
    pval_sem1_10kb[m, rep] <- fitMeasures(sem1_10kb)[5]
    pval_sem1_100kb[m, rep] <- fitMeasures(sem1_100kb)[5]
    pval_sem1_1Mb[m, rep] <- fitMeasures(sem1_1Mb)[5]
    
    # r-sqrd of endogenous variables, low for B because
    # (1) its determinants extend beyond the windows
    # (2) we exclude exonic_sites from the SEM (not MVN)
    sem1_r2 <- rbind.data.frame(inspect(sem1_1kb, "rsquare"),
                                inspect(sem1_10kb, "rsquare"),
                                inspect(sem1_100kb, "rsquare"),
                                inspect(sem1_1Mb, "rsquare"))
    names(sem1_r2) <- c("pi_exp", "B")
    fwrite(sem1_r2, paste("model_", m, "/rep_", rep, "/sem_DAG1_r2.csv", sep=""))
    
    fwrite(parameterestimates(sem1_1kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG1_1kb.csv", sep=""))
    
    fwrite(parameterestimates(sem1_10kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG1_10kb.csv", sep=""))
    
    fwrite(parameterestimates(sem1_100kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG1_100kb.csv", sep=""))
    
    fwrite(parameterestimates(sem1_1Mb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG1_1Mb.csv", sep=""))
    
    # DAG2
    sem2_1kb <- sem(DAG2, data=std_1kb)
    sem2_10kb <- sem(DAG2, data=std_10kb)
    sem2_100kb <- sem(DAG2, data=std_100kb)
    sem2_1Mb <- sem(DAG2, data=std_1Mb)
    
    pval_sem2_1kb[m, rep] <- fitMeasures(sem2_1kb)[5]
    pval_sem2_10kb[m, rep] <- fitMeasures(sem2_10kb)[5]
    pval_sem2_100kb[m, rep] <- fitMeasures(sem2_100kb)[5]
    pval_sem2_1Mb[m, rep] <- fitMeasures(sem2_1Mb)[5]
    
    sem2_r2 <- rbind.data.frame(inspect(sem2_1kb, "rsquare"),
                                inspect(sem2_10kb, "rsquare"),
                                inspect(sem2_100kb, "rsquare"),
                                inspect(sem2_1Mb, "rsquare"))
    names(sem2_r2) <- c("pi_exp", "B")
    fwrite(sem2_r2, paste("model_", m, "/rep_", rep, "/sem_DAG2_r2.csv", sep=""))
    
    fwrite(parameterestimates(sem2_1kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG2_1kb.csv", sep=""))
    
    fwrite(parameterestimates(sem2_10kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG2_10kb.csv", sep=""))
    
    fwrite(parameterestimates(sem2_100kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG2_100kb.csv", sep=""))
    
    fwrite(parameterestimates(sem2_1Mb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG2_1Mb.csv", sep=""))
    
    fwrite(parameterestimates(sem2_100kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG2_100kb.csv", sep=""))
    
    # DAG3
    sem3_1kb <- sem(DAG3, data=std_1kb)
    sem3_10kb <- sem(DAG3, data=std_10kb)
    sem3_100kb <- sem(DAG3, data=std_100kb)
    sem3_1Mb <- sem(DAG3, data=std_1Mb)
    
    pval_sem3_1kb[m, rep] <- fitMeasures(sem3_1kb)[5]
    pval_sem3_10kb[m, rep] <- fitMeasures(sem3_10kb)[5]
    pval_sem3_100kb[m, rep] <- fitMeasures(sem3_100kb)[5]
    pval_sem3_1Mb[m, rep] <- fitMeasures(sem3_1Mb)[5]
    
    sem3_r2 <- rbind.data.frame(inspect(sem3_1kb, "rsquare"),
                                inspect(sem3_10kb, "rsquare"),
                                inspect(sem3_100kb, "rsquare"),
                                inspect(sem3_1Mb, "rsquare"))
    names(sem3_r2) <- c("pi_exp", "B")
    fwrite(sem3_r2, paste("model_", m, "/rep_", rep, "/sem_DAG3_r2.csv", sep=""))
    
    fwrite(parameterestimates(sem3_1kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG3_1kb.csv", sep=""))
    
    fwrite(parameterestimates(sem3_10kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG3_10kb.csv", sep=""))
    
    fwrite(parameterestimates(sem3_100kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG3_100kb.csv", sep=""))
    
    fwrite(parameterestimates(sem3_1Mb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG3_1Mb.csv", sep=""))
    
    fwrite(parameterestimates(sem3_100kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG3_100kb.csv", sep=""))
    
    # DAG4
    sem4_1kb <- sem(DAG4, data=std_1kb)
    sem4_10kb <- sem(DAG4, data=std_10kb)
    sem4_100kb <- sem(DAG4, data=std_100kb)
    sem4_1Mb <- sem(DAG4, data=std_1Mb)
    
    pval_sem4_1kb[m, rep] <- fitMeasures(sem4_1kb)[5]
    pval_sem4_10kb[m, rep] <- fitMeasures(sem4_10kb)[5]
    pval_sem4_100kb[m, rep] <- fitMeasures(sem4_100kb)[5]
    pval_sem4_1Mb[m, rep] <- fitMeasures(sem4_1Mb)[5]
    
    sem4_r2 <- rbind.data.frame(inspect(sem4_1kb, "rsquare"),
                                inspect(sem4_10kb, "rsquare"),
                                inspect(sem4_100kb, "rsquare"),
                                inspect(sem4_1Mb, "rsquare"))
    names(sem4_r2) <- c("pi_exp", "B")
    fwrite(sem4_r2, paste("model_", m, "/rep_", rep, "/sem_DAG4_r2.csv", sep=""))
    
    fwrite(parameterestimates(sem4_1kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG4_1kb.csv", sep=""))
    
    fwrite(parameterestimates(sem4_10kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG4_10kb.csv", sep=""))
    
    fwrite(parameterestimates(sem4_100kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG4_100kb.csv", sep=""))
    
    fwrite(parameterestimates(sem4_1Mb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG4_1Mb.csv", sep=""))
    
    fwrite(parameterestimates(sem4_100kb, ci=T), 
           paste("model_", m, "/rep_", rep, "/lavaan_DAG4_100kb.csv", sep=""))
    
  }
}

pval_SEM1 <- rbind.data.frame(pval_SEM1_1kb,
                              pval_SEM1_10kb,
                              pval_SEM1_100kb,
                              pval_SEM1_1Mb)
pval_SEM1$DAG <- 1
pval_SEM1$scale <- c(rep(1e+3, num_models),
                     rep(1e+4, num_models),
                     rep(1e+5, num_models),
                     rep(1e+6, num_models))
  
pval_SEM2 <- rbind.data.frame(pval_SEM2_1kb,
                              pval_SEM2_10kb,
                              pval_SEM2_100kb,
                              pval_SEM2_1Mb)
pval_SEM2$DAG <- 2
pval_SEM2$scale <- c(rep(1e+3, num_models),
                     rep(1e+4, num_models),
                     rep(1e+5, num_models),
                     rep(1e+6, num_models))

pval_SEM3 <- rbind.data.frame(pval_SEM3_1kb,
                              pval_SEM3_10kb,
                              pval_SEM3_100kb,
                              pval_SEM3_1Mb)
pval_SEM3$DAG <- 3
pval_SEM3$scale <- c(rep(1e+3, num_models),
                     rep(1e+4, num_models),
                     rep(1e+5, num_models),
                     rep(1e+6, num_models))

pval_SEM4 <- rbind.data.frame(pval_SEM4_1kb,
                              pval_SEM4_10kb,
                              pval_SEM4_100kb,
                              pval_SEM4_1Mb)
pval_SEM4$DAG <- 4
pval_SEM4$scale <- c(rep(1e+3, num_models),
                     rep(1e+4, num_models),
                     rep(1e+5, num_models),
                     rep(1e+6, num_models))

pval_SEM <- rbind.data.frame(pval_SEM1, pval_SEM2, pval_SEM3, pval_SEM4)
names(pval_SEM)[1:10] <- paste("rep_", 1:num_reps, sep="")

pivot_longer(pval_SEM,
             cols=c(paste("rep", 1:num_reps, sep="_")),
             values_to="p-val",
             names_to="rep")
```

TODO: Manhattan plot of p-values per rep per model,
shape = d-sep || SEM, color = exon density, 
one panel per scale, one figure per DAG

```{r plots-lm, include=F, message=F, warning=F}

pcor_tbl_1kb <- as.data.frame(matrix(ncol=num_reps, nrow=num_models))
pval_tbl_1kb <- as.data.frame(matrix(ncol=num_reps, nrow=num_models))
pcor_tbl_10kb <- as.data.frame(matrix(ncol=num_reps, nrow=num_models))
pval_tbl_10kb <- as.data.frame(matrix(ncol=num_reps, nrow=num_models))
pcor_tbl_100kb <- as.data.frame(matrix(ncol=num_reps, nrow=num_models))
pval_tbl_100kb <- as.data.frame(matrix(ncol=num_reps, nrow=num_models))
pcor_tbl_1Mb <- as.data.frame(matrix(ncol=num_reps, nrow=num_models))
pval_tbl_1Mb <- as.data.frame(matrix(ncol=num_reps, nrow=num_models))

cv_u_cv_B <- as.data.frame(matrix(ncol=4, nrow=num_models))
names(cv_u_cv_B) <- c(1e+3, 1e+4, 1e+5, 1e+6)

for(i in 1:num_models) {
  
  print(Sys.time())
  cat(paste("Visualizing data from model", i, "...\n"))
  
  cv_u_cv_B_1kb <- 0
  cv_u_cv_B_10kb <- 0
  cv_u_cv_B_100kb <- 0
  cv_u_cv_B_1Mb <- 0
  
  for(j in 1:num_reps) {
    
    cat(paste("Rep. ", j, "\n"))
    
    m1kb <- fread(paste("model_", i, "/rep_", j, "/tbl_1kb.csv.gz", sep=""))
    m10kb <- fread(paste("model_", i, "/rep_", j, "/tbl_10kb.csv.gz", sep=""))
    m100kb <- fread(paste("model_", i, "/rep_", j, "/tbl_100kb.csv.gz", sep=""))
    m1Mb <- fread(paste("model_", i, "/rep_", j, "/tbl_1Mb.csv.gz", sep=""))
    
    cv_u_cv_B_1kb <- cv_u_cv_B_1kb + sd(m1kb$avg_mut) / 
      mean(m1kb$avg_mut) / sd(m1kb$B) / mean(m1kb$B)
    cv_u_cv_B_10kb <- cv_u_cv_B_10kb + sd(m10kb$avg_mut) /
      mean(m10kb$avg_mut) / sd(m10kb$B) / mean(m10kb$B)
    cv_u_cv_B_100kb <- cv_u_cv_B_100kb + sd(m100kb$avg_mut) / 
      mean(m100kb$avg_mut) / sd(m100kb$B) / mean(m100kb$B)
    cv_u_cv_B_1Mb <- cv_u_cv_B_1Mb + sd(m1Mb$avg_mut) /
      mean(m1Mb$avg_mut) / sd(m1Mb$B) / mean(m1Mb$B)
    
    pc1k <- ppcor::pcor.test(m1kb$B, 
                             m1kb$avg_mut,
                             m1kb$avg_rec, 
                             method="spearman")
    pc10k <- ppcor::pcor.test(m10kb$B, 
                              m10kb$avg_mut, 
                              m10kb$avg_rec, 
                              method="spearman")
    pc100k <- ppcor::pcor.test(m100kb$B, 
                               m100kb$avg_mut, 
                               m100kb$avg_rec, 
                               method="spearman")
    pc1M <- ppcor::pcor.test(m1Mb$B, 
                             m1Mb$avg_mut, 
                             m1Mb$avg_rec, 
                             method="spearman")
    
    pcor_tbl_1kb[i, j] <- pc1k$estimate
    pval_tbl_1kb[i, j] <- pc1k$p.value
    pcor_tbl_10kb[i, j] <- pc10k$estimate
    pval_tbl_10kb[i, j] <- pc10k$p.value
    pcor_tbl_100kb[i, j] <- pc100k$estimate
    pval_tbl_100kb[i, j] <- pc100k$p.value
    pcor_tbl_1Mb[i, j] <- pc1M$estimate
    pval_tbl_1Mb[i, j] <- pc1M$p.value
    
    m1kb$bin <- 1:nrow(m1kb)
    m10kb$bin <- 1:nrow(m10kb)
    m100kb$bin <- 1:nrow(m100kb)
    m1Mb$bin <- 1:nrow(m1Mb)
    
    # plots binned maps 
    m1kb_m <- pivot_longer(m1kb, cols=ends_with("pi"), names_to="diversity")
    pi_1kb <- ggplot(data=m1kb_m, aes(x=start / 1e+6, y=value, color=diversity)) +
      geom_point(data=m1kb_m, shape=1) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1kb$pi_exp), max(m1kb$pi_exp)),
                         labels=scale.4d) +
      scale_color_discrete(name=NULL, type=c("plum3", "seagreen3")) +
      labs(title="1 kb", x=NULL, y=expression(pi)) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_text(size=12),
            axis.title.y=element_text(size=16),
            plot.title=element_text(size=20),
            legend.position="inside", legend.position.inside=c(0.925, 0.925)) 
    
    u_1kb <- ggplot(data=m1kb, aes(x=start / 1e+6, y=avg_mut)) + 
      geom_line(data=m1kb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1kb$avg_mut), max(m1kb$avg_mut)),
                         labels=scientific) +
      labs(title=NULL, x=NULL, y=expression(mu)) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_text(size=12),
            axis.title.y=element_text(size=16),
            plot.title=element_text(size=20), 
            legend.position="none")
    
    B_1kb <- ggplot(data=m1kb, aes(x=start / 1e+6, y=B)) + 
      geom_line(data=m1kb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1kb$B), max(m1kb$B)),
                         labels=scientific) +
      labs(title=NULL, x=NULL, y="B") +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_text(size=12),
            axis.title.y=element_text(size=16),
            plot.title=element_text(size=20), 
            legend.position="none")
    
    r_1kb <- ggplot(data=m1kb, aes(x=start / 1e+6, y=avg_rec)) + 
      geom_line(data=m1kb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1kb$avg_rec), max(m1kb$avg_rec)),
                         labels=scientific) +
      labs(title=NULL, x="Position (Mb)", y="r") +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_text(size=12),
            axis.text.y=element_text(size=12),
            axis.title.y=element_text(size=16),
            plot.title=element_text(size=20),
            legend.position="none")
    
    lands_1kb <- plot_grid(pi_1kb, u_1kb, B_1kb, r_1kb, align='v', ncol=1)

    m10kb_m <- pivot_longer(m10kb, cols=ends_with("pi"), names_to="diversity")
    pi_10kb <- ggplot(data=m10kb_m, aes(x=start / 1e+6, y=value, color=diversity)) +
      geom_point(data=m10kb_m, shape=1) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m10kb$pi_exp), max(m10kb$pi_exp)),
                         labels=scale.4d) +
      scale_color_discrete(name=NULL, type=c("plum3", "seagreen3")) +
      labs(title="10 kb", x=NULL, y=NULL) + 
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="inside", legend.position.inside=c(0.925, 0.925)) 
    
    u_10kb <- ggplot(data=m10kb, aes(x=start / 1e+6, y=avg_mut)) + 
      geom_line(data=m10kb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1kb$avg_mut), max(m1kb$avg_mut)),
                         labels=scientific) +
      labs(title=NULL, x=NULL, y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="none")
    
    B_10kb <- ggplot(data=m10kb, aes(x=start / 1e+6, y=B)) + 
      geom_line(data=m10kb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1kb$B), max(m1kb$B)),
                         labels=scientific) +
      labs(title=NULL, x=NULL, y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="none")
    
    r_10kb <- ggplot(data=m10kb, aes(x=start / 1e+6, y=avg_rec)) +
      geom_line(data=m10kb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(),
                         #limits=c(min(m1kb$avg_rec), max(m1kb$avg_rec)),
                         labels=scientific) +
      labs(title=NULL, x="Position (Mb)", y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_text(size=12),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20), legend.position="none")
    
    lands_10kb <- plot_grid(pi_10kb, u_10kb, B_10kb, r_10kb, align='v', ncol=1)

    m100kb_m <- pivot_longer(m100kb, cols=ends_with("pi"), names_to="diversity")
    pi_100kb <- ggplot(data=m100kb_m, 
                       aes(x=start / 1e+6, 
                           y=value,
                           color=diversity)) +
      geom_line(data=m100kb_m) + geom_point() + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m100kb$pi_exp), max(m100kb$pi_exp)),
                         labels=scale.4d) +
      scale_color_discrete(name=NULL, type=c("plum3", "seagreen3")) +
      labs(title="100 kb", x=NULL, y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="inside", legend.position.inside=c(0.925, 0.925)) 
    
    u_100kb <- ggplot(data=m100kb, aes(x=start / 1e+6, y=avg_mut))+
      geom_line(data=m100kb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1kb$avg_mut), max(m1kb$avg_mut)),
                         labels=scientific) +
      labs(title=NULL, x=NULL, y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="none")
    
    B_100kb <- ggplot(data=m100kb, aes(x=start / 1e+6, y=B))+
      geom_line(data=m100kb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(),
                         #limits=c(min(m1kb$B), max(m1kb$B)),
                         labels=scientific) +
      labs(title=NULL, x=NULL, y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="none")
    
    r_100kb <- ggplot(data=m100kb, aes(x=start / 1e+6, y=avg_rec)) +
      geom_line(data=m100kb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1kb$avg_rec), max(m1kb$avg_rec)),
                         labels=scientific) +
      labs(title=NULL, x="Position (Mb)", y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_text(size=12),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="none")
    
    lands_100kb <- plot_grid(pi_100kb,
                             u_100kb, 
                             B_100kb, 
                             r_100kb, align='v', ncol=1)
    
    m1Mb_m <- pivot_longer(m1Mb, cols=ends_with("pi"), names_to="diversity")
    pi_1Mb <- ggplot(data=m1Mb_m, aes(x=start / 1e+6, y=value, color=diversity)) +
      geom_line(data=m1Mb_m) + geom_point() + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1Mb$pi_exp), max(m1Mb$pi_exp)),
                         labels=scale.4d) +
      scale_color_discrete(name=NULL, type=c("plum3", "seagreen3")) +
      labs(title="1 Mb", x=NULL, y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="inside", legend.position.inside=c(0.925, 0.925)) 
    
    u_1Mb <- ggplot(data=m1Mb, aes(x=start / 1e+6, y=avg_mut))+
      geom_line(data=m1Mb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         ##limits=c(min(m1kb$avg_mut), max(m1kb$avg_mut)),
                         labels=scientific) +
      labs(title=NULL, x=NULL, y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="none")
    
    B_1Mb <- ggplot(data=m1Mb, aes(x=start / 1e+6, y=B))+
      geom_line(data=m1Mb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(),
                         #limits=c(min(m1kb$B), max(m1kb$B)),
                         labels=scientific) +
      labs(title=NULL, x=NULL, y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_blank(),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="none")
    
    r_1Mb <- ggplot(data=m1Mb, aes(x=start / 1e+6, y=avg_rec)) +
      geom_line(data=m1Mb) + theme_bw() +
      scale_y_continuous(breaks=pretty_breaks(), 
                         #limits=c(min(m1kb$avg_rec), max(m1kb$avg_rec)),
                         labels=scientific) +
      labs(title=NULL, x="Position (Mb)", y=NULL) +
      theme(axis.title.x=element_text(size=16),
            axis.text.x=element_text(size=12),
            axis.text.y=element_blank(),
            plot.title=element_text(size=20),
            legend.position="none")
    
    lands_1Mb <- plot_grid(pi_1Mb, u_1Mb, B_1Mb, r_1Mb, align='v', ncol=1)

    lands_scales <- plot_grid(lands_1kb, 
                              lands_10kb, 
                              lands_100kb, 
                              lands_1Mb, nrow=1)
    save_plot(paste("model_", i, "/rep_", j, "/maps.png", sep=""),
              lands_scales, base_height=12, base_width=24)
  }
  
  cv_u_cv_B[i, 1] <- cv_u_cv_B_1kb / num_reps
  cv_u_cv_B[i, 2] <- cv_u_cv_B_10kb / num_reps
  cv_u_cv_B[i, 3] <- cv_u_cv_B_100kb / num_reps
  cv_u_cv_B[i, 4] <- cv_u_cv_B_1Mb / num_reps
}

cv_u_cv_B$model <- 1:nrow(cv_u_cv_B)
models <- merge(cv_u_cv_B, models, by="model")
models <- pivot_longer(models, cols=as.character(c(1e+3, 1e+4, 1e+5, 1e+6)),
                       names_to="scale", values_to="cv_u_cv_B")
models$scale <- as.numeric(models$scale)

# visualization of R^2 and linear coefficients across models
r2_tbl_exp <- data.table()
r2_tbl_sim <- data.table()
r2_tbl_raw <- data.table()

coeff_tbl_exp <- data.table()
coeff_tbl_sim <- data.table()

pb <- txtProgressBar(min=1, max=num_models, style=3)
for(i in 1:num_models) {
  
  setTxtProgressBar(pb, i)
  
  # converts num_rep tables of dim (3 x 4: 1kb, 10kb, 100kb, 1Mb x u, B, B:u)
  # into 4 tables of dimension num_reps x 3 (u, B, B:u)
  r2_1kb <- as.data.frame(matrix(nrow=num_reps, ncol=4))
  r2_10kb <- as.data.frame(matrix(nrow=num_reps, ncol=4))
  r2_100kb <- as.data.frame(matrix(nrow=num_reps, ncol=4))
  r2_1Mb <- as.data.frame(matrix(nrow=num_reps, ncol=4))
  
  coeff_1kb <- as.data.frame(matrix(nrow=num_reps, ncol=4))
  coeff_10kb <- as.data.frame(matrix(nrow=num_reps, ncol=4))
  coeff_100kb <- as.data.frame(matrix(nrow=num_reps, ncol=4))
  coeff_1Mb <- as.data.frame(matrix(nrow=num_reps, ncol=4))
  
  r2_raw_1kb <- as.data.frame(matrix(nrow=num_reps, ncol=3))
  r2_raw_10kb <- as.data.frame(matrix(nrow=num_reps, ncol=3))
  r2_raw_100kb <- as.data.frame(matrix(nrow=num_reps, ncol=3))
  r2_raw_1Mb <- as.data.frame(matrix(nrow=num_reps, ncol=3))
  
  # in expectation
  for(j in 1:num_reps) {
    tmp <- fread(paste("model_", i, "/rep_", j, "/r2_tbl_exp.csv.gz", sep=""))
    
    r2_1kb[j,] <- tmp[1,]
    r2_10kb[j,] <- tmp[2,]
    r2_100kb[j,] <- tmp[3,]
    r2_1Mb[j,] <- tmp[4,]
    
    tmp <- fread(paste("model_", i, "/rep_", j, "/coeff_tbl_exp.csv.gz", sep=""))
    
    coeff_1kb[j,] <- tmp[1,]
    coeff_10kb[j,] <- tmp[2,]
    coeff_100kb[j,] <- tmp[3,]
    coeff_1Mb[j,] <- tmp[4,]
  }
  
  tbl_r2 <- rbind.data.frame(r2_1kb, r2_10kb, r2_100kb, r2_1Mb)
  names(tbl_r2) <- c("u", "B", "B:u", "scale")
  tbl_r2$model <- i
  tbl_r2$rep <- rep(1:10, 4)
  
  tbl_coeff <- rbind.data.frame(coeff_1kb, coeff_10kb, coeff_100kb, coeff_1Mb)
  names(tbl_coeff) <- c("u", "B", "B:u", "scale")
  tbl_coeff$model <- i
  tbl_coeff$rep <- rep(1:10, 4)

  r2_tbl_exp <- rbind.data.frame(r2_tbl_exp, tbl_r2)
  coeff_tbl_exp <- rbind.data.frame(coeff_tbl_exp, tbl_coeff)
  
  # with mutational variance
  for(j in 1:num_reps) {
    tmp <- fread(paste("model_", i, "/rep_", j, "/r2_tbl_sim.csv.gz", sep=""))
    
    r2_1kb[j,] <- tmp[1,]
    r2_10kb[j,] <- tmp[2,]
    r2_100kb[j,] <- tmp[3,]
    r2_1Mb[j,] <- tmp[4,]
    
    tmp <- fread(paste("model_", i, "/rep_", j, "/coeff_tbl_sim.csv.gz", sep=""))
    
    coeff_1kb[j,] <- tmp[1,]
    coeff_10kb[j,] <- tmp[2,]
    coeff_100kb[j,] <- tmp[3,]
    coeff_1Mb[j,] <- tmp[4,]
  }
  
  tbl_r2 <- rbind.data.frame(r2_1kb, r2_10kb, r2_100kb, r2_1Mb)
  names(tbl_r2) <- c("u", "B", "B:u", "scale")
  tbl_r2$model <- i
  tbl_r2$rep <- rep(1:10, 4)
  
  tbl_coeff <- rbind.data.frame(coeff_1kb, coeff_10kb, coeff_100kb, coeff_1Mb)
  names(tbl_coeff) <- c("u", "B", "B:u", "scale")
  tbl_coeff$model <- i
  tbl_coeff$rep <- rep(1:10, 4)
  
  coeff_tbl_sim <- rbind.data.frame(coeff_tbl_sim, tbl_coeff)
  r2_tbl_sim <- rbind.data.frame(r2_tbl_sim, tbl_r2)
  
  # raw R^2 (from lm() or type I ANOVA)
  for(j in 1:num_reps) {
    tmp <- fread(paste("model_", i, "/rep_", j, "/r2_raw_tbl.csv.gz", sep=""))
    
    r2_raw_1kb[j,] <- tmp[1,]
    r2_raw_10kb[j,] <- tmp[2,]
    r2_raw_100kb[j,] <- tmp[3,]
    r2_raw_1Mb[j,] <- tmp[4,]
  }
  
  tbl_r2_raw <- rbind.data.frame(r2_raw_1kb, r2_raw_10kb, r2_raw_100kb, r2_raw_1Mb)
  names(tbl_r2_raw) <- c("Exp_Pi", "Sim_Pi", "scale")
  tbl_r2_raw$model <- i
  tbl_r2_raw$rep <- rep(1:10, 4)
  
  r2_tbl_raw <- rbind.data.frame(r2_tbl_raw, tbl_r2_raw)
}
close(pb)

r2s_exp <- r2_tbl_exp %>% group_by(model, scale) %>% 
                          summarize_at(vars(u, B, `B:u`), 
                                       list(avg=mean, sd=sd))

r2s_sim <- r2_tbl_sim %>% group_by(model, scale) %>% 
                          summarize_at(vars(u, B, `B:u`), 
                                       list(avg=mean, sd=sd))

r2_tbl_raw$Exp_Pi <- r2_tbl_raw$Exp_Pi * 100
r2_tbl_raw$Sim_Pi <- r2_tbl_raw$Sim_Pi * 100
r2s_raw <- r2_tbl_raw %>% group_by(model, scale) %>% 
  summarize_at(vars(Exp_Pi, Sim_Pi), 
               list(avg=mean, sd=sd))

cs_exp <- coeff_tbl_exp %>% group_by(model, scale) %>% 
  summarize_at(vars(u, B, `B:u`), 
               list(avg=mean, sd=sd))

cs_sim <- coeff_tbl_sim %>% group_by(model, scale) %>% 
  summarize_at(vars(u, B, `B:u`), 
               list(avg=mean, sd=sd))

fwrite(r2s_raw, "r2_raw_tbl_models.csv")
fwrite(r2s_exp, "r2_exp_tbl_models.csv")
fwrite(r2s_sim, "r2_sim_tbl_models.csv")

fwrite(cs_exp, "coeff_exp_tbl_models.csv")
fwrite(cs_sim, "coeff_sim_tbl_models.csv")

# plots raw r2
r2s_raw_f <- dplyr::select(r2s_raw, -starts_with("B:u")) %>%
  dplyr::select(., -ends_with("sd")) 

r2_raw_models <- merge(models, r2s_raw_f, by=c("model"))
m_r2_raw_models <- pivot_longer(r2_raw_models,
                                cols=ends_with("Pi_avg"), 
                                names_to="var")

b1 <- ggplot(data=filter(m_r2_raw_models, 
                         shapes_rate_r==shapes_rate_r[1], 
                         avg_rec_spans==avg_rec_spans[1]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=var,
                 color=as.factor(num_exons))) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_shape_manual(values=c(0, 1), name=NULL, labels=c("Exp", "Sim"))+
  scale_color_discrete(name="num exons", 
                       type=c("plum3", "seagreen3", "brown1")) +
  scale_x_continuous(breaks=unique(m_r2_raw_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("Total R^2, cols->shape(u), rows->avg mut. span"),
       x="Map Scale (kb)", y="Total Variance Explained (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")
save_plot("r2_total_models.pdf", b1, base_height=9, base_width=12)

# plots of R^2 per variable per model
pb <- txtProgressBar(min=1, max=num_models, style=3)
for(i in 1:num_models) {
  
  setTxtProgressBar(pb, i)
  
  molten_avgs <- pivot_longer(r2s_exp,
                              cols=ends_with("avg"),
                              names_to="variable")
  p <- ggplot(data=filter(molten_avgs, model==i), 
              aes(x=scale/1e+3, y=value, shape=variable)) +
    geom_line() + theme_bw() + geom_point(size=4) +
    scale_shape_manual(values=c(0, 1, 8),
                       name=NULL, labels=c("B", "B:u", "u")) +
    scale_x_continuous(breaks=unique(molten_avgs$scale/1e+3), trans="log10") +
    scale_y_continuous(breaks=pretty_breaks()) +
    labs(title=paste("Model", i, "(Mean over replicates)"),
         x="Map Scale (kb)", y="Variance Explained (%)") +
    theme(axis.title=element_text(size=16), 
          axis.text=element_text(size=12), 
          axis.text.x=element_text(size=12),
          legend.text=element_text(size=16),
          legend.position="bottom")
  
  molten_sds <- pivot_longer(r2s_exp, cols=ends_with("sd"), names_to="variable")
  q <- ggplot(data=filter(molten_sds, model==i), 
              aes(x=scale/1e+3, y=value, shape=variable)) +
    geom_line() + theme_bw() + geom_point(size=4) +
    scale_shape_manual(values=c(0, 1, 8),
                       name=NULL, labels=c("B", "B:u", "u")) +
    scale_x_continuous(breaks=unique(molten_sds$scale/1e+3), trans="log10") +
    scale_y_continuous(breaks=pretty_breaks()) +
    labs(title=paste("Model", i, "(SD over replicates)"),
         x="Map Scale (kb)", y=NULL) +
    theme(axis.title=element_text(size=16), 
          axis.text=element_text(size=12), 
          axis.text.x=element_text(size=12),
          legend.text=element_text(size=16), 
          legend.position="bottom")
  
  save_plot(paste("model_", i, "_exp_r2.png", sep=""), plot_grid(p, q, nrow=1), 
            base_height=10, base_width=15)
  
  molten_avgs <- pivot_longer(r2s_sim, 
                              cols=ends_with("avg"), 
                              names_to="variable")
  p <- ggplot(data=filter(molten_avgs, model==i), 
              aes(x=scale/1e+3, y=value, shape=variable)) +
    geom_line() + theme_bw() + geom_point(size=4) +
    scale_shape_manual(values=c(0, 1, 8),
                       name=NULL, labels=c("B", "B:u", "u")) +
    scale_x_continuous(breaks=unique(molten_avgs$scale/1e+3), trans="log10") +
    scale_y_continuous(breaks=pretty_breaks()) +
    labs(title=paste("Model", i, "(Mean over replicates)"),
         x="Map Scale (kb)", y="Variance explained (%)") +
    theme(axis.title=element_text(size=16), 
          axis.text=element_text(size=12), 
          axis.text.x=element_text(size=12),
          legend.text=element_text(size=16),
          legend.position="bottom")
  
  molten_sds <- pivot_longer(r2s_sim, 
                             cols=ends_with("sd"),
                             names_to="variable")
  q <- ggplot(data=filter(molten_sds, model==i), 
              aes(x=scale/1e+3, y=value, shape=variable)) +
    geom_line() + theme_bw() + geom_point(size=4) +
    scale_shape_manual(values=c(0, 1, 8),
                       name=NULL, labels=c("B", "B:u", "u")) +
    scale_x_continuous(breaks=unique(molten_sds$scale/1e+3), trans="log10") +
    scale_y_continuous(breaks=pretty_breaks()) +
    labs(title=paste("Model", i, "(SD over replicates)"),
         x="Map Scale (kb)", y=NULL) +
    theme(axis.title=element_text(size=16), 
          axis.text=element_text(size=12), 
          axis.text.x=element_text(size=12),
          legend.text=element_text(size=16), 
          legend.position="bottom")
  
  save_plot(paste("model_", i, "_sim_r2.png", sep=""), plot_grid(p, q, nrow=1), 
            base_height=10, base_width=15)
}
close(pb)

# plots of coeffs per variable per model
pb <- txtProgressBar(min=1, max=num_models, style=3)
for(i in 1:num_models) {
  
  setTxtProgressBar(pb, i)
  
  molten_avgs <- pivot_longer(cs_exp, 
                              cols=ends_with("avg"), 
                              names_to="variable")
  p <- ggplot(data=filter(molten_avgs, model==i), 
              aes(x=scale/1e+3, y=value, shape=variable)) +
    geom_line() + theme_bw() + geom_point(size=4) +
    scale_shape_manual(values=c(0, 1, 8),
                       name=NULL, labels=c("B", "B:u", "u")) +
    scale_x_continuous(breaks=unique(molten_avgs$scale/1e+3), trans="log10") +
    scale_y_continuous(breaks=pretty_breaks()) +
    labs(title=paste("Model", i, "(Mean over replicates)"),
         x="Map Scale (kb)", y="Linear Coefficient") +
    theme(axis.title=element_text(size=16), 
          axis.text=element_text(size=12), 
          axis.text.x=element_text(size=12),
          legend.text=element_text(size=16),
          legend.position="bottom")
  
  molten_sds <- pivot_longer(cs_exp, 
                             cols=ends_with("sd"),
                             names_to="variable")
  q <- ggplot(data=filter(molten_sds, model==i), 
              aes(x=scale/1e+3, y=value, shape=variable)) +
    geom_line() + theme_bw() + geom_point(size=4) +
    scale_shape_manual(values=c(0, 1, 8),
                       name=NULL, labels=c("B", "B:u", "u")) +
    scale_x_continuous(breaks=unique(molten_sds$scale/1e+3), trans="log10") +
    scale_y_continuous(breaks=pretty_breaks()) +
    labs(title=paste("Model", i, "(SD over replicates)"),
         x="Map Scale (kb)", y=NULL) +
    theme(axis.title=element_text(size=16), 
          axis.text=element_text(size=12), 
          axis.text.x=element_text(size=12),
          legend.text=element_text(size=16), 
          legend.position="bottom")
  
  save_plot(paste("model_", i, "_exp_coeff.png", sep=""),
            plot_grid(p, q, nrow=1), 
            base_height=10, base_width=15)
  
  molten_avgs <- pivot_longer(cs_sim, 
                              cols=ends_with("avg"), 
                              names_to="variable")
  p <- ggplot(data=filter(molten_avgs, model==i), 
              aes(x=scale/1e+3, y=value, shape=variable)) +
    geom_line() + theme_bw() + geom_point(size=4) +
    scale_shape_manual(values=c(0, 1, 8),
                       name=NULL, labels=c("B", "B:u", "u")) +
    scale_x_continuous(breaks=unique(molten_avgs$scale/1e+3), trans="log10") +
    scale_y_continuous(breaks=pretty_breaks()) +
    labs(title=paste("Model", i, "(Mean over replicates)"),
         x="Map Scale (kb)", y="Linear Coefficient") +
    theme(axis.title=element_text(size=16), 
          axis.text=element_text(size=12), 
          axis.text.x=element_text(size=12),
          legend.text=element_text(size=16),
          legend.position="bottom")
  
  molten_sds <- pivot_longer(cs_sim, 
                             cols=ends_with("sd"),
                             names_to="variable")
  q <- ggplot(data=filter(molten_sds, model==i), 
              aes(x=scale/1e+3, y=value, shape=variable)) +
    geom_line() + theme_bw() + geom_point(size=4) +
    scale_shape_manual(values=c(0, 1, 8),
                       name=NULL, labels=c("B", "B:u", "u")) +
    scale_x_continuous(breaks=unique(molten_sds$scale/1e+3), trans="log10") +
    scale_y_continuous(breaks=pretty_breaks()) +
    labs(title=paste("Model", i, "(SD over replicates)"),
         x="Map Scale (kb)", y=NULL) +
    theme(axis.title=element_text(size=16), 
          axis.text=element_text(size=12), 
          axis.text.x=element_text(size=12),
          legend.text=element_text(size=16), 
          legend.position="bottom")
  
  save_plot(paste("model_", i, "_sim_coeff.png", sep=""),
            plot_grid(p, q, nrow=1), 
            base_height=10, base_width=15)
}
close(pb)

# we combine plots across models
## expected pi
### R2
r2s_exp_f <- dplyr::select(r2s_exp, -starts_with("B:u")) %>%
             dplyr::select(., -ends_with("sd"))

r2_exp_models <- merge(models, r2s_exp_f,by=c("model", "scale"))
r2_exp_models$source_pi <- "exp"
m_r2_exp_models <- pivot_longer(r2_exp_models, 
                                cols=ends_with("avg"),
                                names_to="var")

### coeffs
coeff_exp_f <- dplyr::select(cs_exp, -starts_with("B:u")) %>%
               dplyr::select(., -ends_with("sd")) %>%
               mutate(., ratio = u_avg / B_avg)

coeff_exp_models <- merge(models, coeff_exp_f, by=c("model", "scale"))
coeff_exp_models$source_pi <- "exp"
m_coeff_exp_models <- pivot_longer(coeff_exp_models, 
                                   cols=c("ratio", ends_with("avg")),
                                   names_to="var")

## simulated pi
### R2
r2s_sim_f <- dplyr::select(r2s_sim, -starts_with("B:u")) %>%
             dplyr::select(., -ends_with("sd")) 

r2_sim_models <- merge(models, r2s_sim_f, by=c("model", "scale"))
r2_sim_models$source_pi <- "sim"
m_r2_sim_models <- pivot_longer(r2_sim_models,
                                cols=ends_with("avg"),
                                names_to="var")

### coeffs
coeff_sim_f <- dplyr::select(cs_sim, -starts_with("B:u")) %>%
               dplyr::select(., -ends_with("sd")) %>%
               mutate(., ratio = u_avg / B_avg)

coeff_sim_models <- merge(models, coeff_sim_f, by=c("model", "scale"))
coeff_sim_models$source_pi <- "sim"
m_coeff_sim_models <- pivot_longer(coeff_sim_models,
                                   cols=c("ratio", ends_with("avg")),
                                   names_to="var")

m_coeff_models <- rbind.data.frame(m_coeff_exp_models, m_coeff_sim_models)
m_r2_models <- rbind.data.frame(m_r2_exp_models, m_r2_sim_models)

fwrite(m_coeff_models, "coeff_models.csv.gz")
fwrite(m_r2_models, "r2_models.csv.gz")

## R2 plots
p1 <- ggplot(data=filter(m_r2_models,
                         num_exons[1],
                         shapes_rate_r==shapes_rate_r[1], 
                         avg_rec_spans==avg_rec_spans[1]),
       aes(x=scale/1e+3, y=value, shape=var, color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u"))+
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=unique(m_r2_exp_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("2% exonic, rec map exponential/1kb, ",
                   "cols->shape(u), rows->avg mut. span"),
       x="Map Scale (kb)", y="Variance Explained (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p2 <- ggplot(data=filter(m_r2_models,
                         num_exons[2], 
                         shapes_rate_r==shapes_rate_r[1],
                         avg_rec_spans==avg_rec_spans[1]),
       aes(x=scale/1e+3, y=value, shape=var, color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u"))+
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=unique(m_r2_exp_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, rec map exponential/1kb, ",
                   "cols->shape(u), rows->avg mut. span"),
       x="Map Scale (kb)", y="Variance Explained (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p3 <- ggplot(data=filter(m_r2_models, num_exons[3], 
                         shapes_rate_r==shapes_rate_r[1],
                         avg_rec_spans==avg_rec_spans[1]),
       aes(x=scale/1e+3, y=value, shape=var, color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u")) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=unique(m_r2_exp_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("10% exonic, rec map exponential/1kb, ",
                   "cols->shape(u), rows->avg mut. span"),
       x="Map Scale (kb)", y="Variance Explained (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("r2_exonic_0.02.png", p1, base_width=14, base_height=9)
save_plot("r2_exonic_0.05.png", p2, base_width=14, base_height=9)
save_plot("r2_exonic_0.1.png", p3, base_width=14, base_height=9)

x1kb <- ggplot(data=filter(m_r2_models, num_exons[1], scale==1e+3),
             aes(x=cv_u_cv_B, y=value, shape=var, color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+shapes_rate_r~avg_rec_spans) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u"))+
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=c(1, 10, 100), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="2% exonic, 1kb scale, rows>shape(r), rows->avg rec. span",
       x="CV(u) / CV(B)", y="Variance Explained (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

x10kb <- ggplot(data=filter(m_r2_models, num_exons[1], scale==1e+4),
             aes(x=cv_u_cv_B, y=value, shape=var, color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+shapes_rate_r~avg_rec_spans) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u"))+
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=c(1, 10, 100), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="5% exonic, 10kb scale, rows>shape(r), rows->avg rec. span",
       x="CV(u) / CV(B)", y="Variance Explained (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

x100kb <- ggplot(data=filter(m_r2_models, num_exons[1], scale==1e+5),
             aes(x=cv_u_cv_B, y=value, shape=var, color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+shapes_rate_r~avg_rec_spans) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u"))+
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=c(1, 10, 100), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="2% exonic, 100kb scale, rows>shape(r), rows->avg rec. span",
       x="CV(u) / CV(B)", y="Variance Explained (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

x1Mb <- ggplot(data=filter(m_r2_models, num_exons[1], scale==1e+6),
                 aes(x=cv_u_cv_B, y=value, shape=var, color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+shapes_rate_r~avg_rec_spans) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u"))+
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=c(1, 10, 100), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="2% exonic, 1Mb scale, rows>shape(r), rows->avg rec. span",
       x="CV(u) / CV(B)", y="Variance Explained (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("r2_exonic_0.02_1kb.png", x1kb, base_width=14, base_height=9)
save_plot("r2_exonic_0.02_10kb.png", x10kb, base_width=14, base_height=9)
save_plot("r2_exonic_0.02_100kb.png", x100kb, base_width=14, base_height=9)
save_plot("r2_exonic_0.02_1Mb.png", x1Mb, base_width=14, base_height=9)

q1 <- ggplot(data=filter(m_r2_models, var=="u_avg", 
                         num_exons[3],
                         shapes_rate_r==shapes_rate_r[1]),
             aes(x=scale/1e+3, y=value, 
                 shape=as.factor(avg_rec_spans), color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_r2_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("10% exonic, var rec HIGH, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

q2 <- ggplot(data=filter(m_r2_models, 
                         var=="u_avg", 
                         num_exons[3], 
                         shapes_rate_r==shapes_rate_r[2]),
             aes(x=scale/1e+3,
                 y=value,
                 shape=as.factor(avg_rec_spans),
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_r2_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("10% exonic, var rec MID, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

q3 <- ggplot(data=filter(m_r2_models, 
                         var=="u_avg", 
                         num_exons[3], 
                         shapes_rate_r==shapes_rate_r[3]),
             aes(x=scale/1e+3,
                 y=value, 
                 shape=as.factor(avg_rec_spans),
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_r2_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("10% exonic, var rec LOW, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("r2_u_exons_0.1_shape_r_1.png", q1, base_height=8, base_width=16)
save_plot("r2_u_exons_0.1_shape_r_3.png", q2, base_height=8, base_width=16)
save_plot("r2_u_exons_0.1_shape_r_10.png", q3, base_height=8, base_width=16)

y1kb <- ggplot(data=filter(m_r2_models, 
                           var=="u_avg", 
                           scale==1e+3),
             aes(x=cv_u_cv_B, 
                 y=value, 
                 shape=as.factor(num_exons), 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_rec_spans~shapes_rate_r) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2), name="# Exons") +
  scale_x_continuous(breaks=c(1, 10), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="1kb, cols->avg_rec_spans, rows->shapes_rate_r",
       x="CV(u) / CV(B)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

y10kb <- ggplot(data=filter(m_r2_models, 
                            var=="u_avg", 
                            scale==1e+4),
               aes(x=cv_u_cv_B, 
                   y=value, 
                   shape=as.factor(num_exons),
                   color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_rec_spans~shapes_rate_r) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2), name="# Exons") +
  scale_x_continuous(breaks=c(1, 10), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="10kb, cols->avg_rec_spans, rows->shapes_rate_r",
       x="CV(u) / CV(B)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

y100kb <- ggplot(data=filter(m_r2_models, 
                             var=="u_avg",
                             scale==1e+5),
                aes(x=cv_u_cv_B, 
                    y=value,
                    shape=as.factor(num_exons), 
                    color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_rec_spans~shapes_rate_r) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2), name="# Exons") +
  scale_x_continuous(breaks=c(1, 10), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="100kb, cols->avg_rec_spans, rows->shapes_rate_r",
       x="CV(u) / CV(B)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

y1Mb <- ggplot(data=filter(m_r2_models,
                           var=="u_avg", 
                           scale==1e+6),
                 aes(x=cv_u_cv_B, 
                     y=value, 
                     shape=as.factor(num_exons), 
                     color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_rec_spans~shapes_rate_r) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2), name="# Exons") +
  scale_x_continuous(breaks=c(1, 10), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="1Mb, cols->avg_rec_spans, rows->shapes_rate_r",
       x="CV(u) / CV(B)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("r2_u_1kb.png", y1kb, base_height=8, base_width=16)
save_plot("r2_u_10kb.png", y10kb, base_height=8, base_width=16)
save_plot("r2_u_100kb.png", y100kb, base_height=8, base_width=16)
save_plot("r2_u_1Mb.png", y1Mb, base_height=8, base_width=16)

r1 <- ggplot(data=filter(m_r2_models,
                         var=="u_avg", 
                         num_exons[2],
                         shapes_rate_r==shapes_rate_r[1]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans),
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_r2_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, var rec HIGH, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

r2 <- ggplot(data=filter(m_r2_models, 
                         var=="u_avg", 
                         num_exons[2], 
                         shapes_rate_r==shapes_rate_r[2]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans), 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_r2_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, var rec MID, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

r3 <- ggplot(data=filter(m_r2_models,
                         var=="u_avg",
                         num_exons[2],
                         shapes_rate_r==shapes_rate_r[3]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans), 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec Span (kb)") +
  scale_x_continuous(breaks=unique(m_r2_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, var rec LOW, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("r2_u_exons_0.05_shape_r_1.png", r1, base_height=8, base_width=16)
save_plot("r2_u_exons_0.05_shape_r_3.png", r2, base_height=8, base_width=16)
save_plot("r2_u_exons_0.05_shape_r_10.png", r3, base_height=8, base_width=16)

s1 <- ggplot(data=filter(m_r2_models, 
                         var=="u_avg",
                         num_exons[1], 
                         shapes_rate_r==shapes_rate_r[1]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans), 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_r2_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, var rec HIGH, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

s2 <- ggplot(data=filter(m_r2_models, 
                         var=="u_avg",
                         num_exons[1],
                         shapes_rate_r==shapes_rate_r[2]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans), 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_r2_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, var rec MID, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

s3 <- ggplot(data=filter(m_r2_models, 
                         var=="u_avg",
                         num_exons[1], 
                         shapes_rate_r==shapes_rate_r[3]),
             aes(x=scale/1e+3,
                 y=value,
                 shape=as.factor(avg_rec_spans), 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec Span (kb)") +
  scale_x_continuous(breaks=unique(m_r2_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, var rec LOW, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Variance Explained by Mutation (%)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("r2_u_exons_0.02_shape_r_1.png", s1, base_height=8, base_width=16)
save_plot("r2_u_exons_0.02_shape_r_3.png", s2, base_height=8, base_width=16)
save_plot("r2_u_exons_0.02_shape_r_10.png", s3, base_height=8, base_width=16)

## coeff plots
p1 <- ggplot(data=filter(m_coeff_models, 
                         num_exons[1],
                         var!="ratio",
                         shapes_rate_r==shapes_rate_r[1], 
                         avg_rec_spans==avg_rec_spans[1]),
             aes(x=scale/1e+3,
                 y=value, 
                 shape=var,
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u")) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("Mean coeff over replicates, cols->shape(u), rows->avg mut. span"),
       x="Map Scale (kb)", y="Std Linear Coeff.") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p2 <- ggplot(data=filter(m_coeff_models, 
                         num_exons[2],
                         var!="ratio",
                         shapes_rate_r==shapes_rate_r[1],
                         avg_rec_spans==avg_rec_spans[1]),
             aes(x=scale/1e+3,
                 y=value, 
                 shape=var, 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u")) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("Mean coeff over replicates, cols->shape(u), rows->avg mut. span"),
       x="Map Scale (kb)", y="Std Linear Coeff.") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p3 <- ggplot(data=filter(m_coeff_models, 
                         num_exons[3], 
                         var!="ratio", 
                         shapes_rate_r==shapes_rate_r[1],
                         avg_rec_spans==avg_rec_spans[1]),
             aes(x=scale/1e+3, y=value, shape=var, color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() + 
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  scale_shape_manual(values=c(0, 1, 2), name=NULL, labels=c("B", "u")) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("Mean coeff over replicates, cols->shape(u), rows->avg mut. span"),
       x="Map Scale (kb)", y="Std Linear Coeff.") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("coeff_exonic_0.02.png", p1, base_width=14, base_height=9)
save_plot("coeff_exonic_0.05.png", p2, base_width=14, base_height=9)
save_plot("coeff_exonic_0.1.png", p3, base_width=14, base_height=9)

q1 <- ggplot(data=filter(m_coeff_models,
                         var=="ratio", 
                         num_exons[3], 
                         shapes_rate_r==shapes_rate_r[1]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans),
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  geom_hline(yintercept=1, linetype="dashed") +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("10% exonic, var rec HIGH, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

q2 <- ggplot(data=filter(m_coeff_models,
                         var=="ratio",
                         num_exons[3], 
                         shapes_rate_r==shapes_rate_r[2]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans),
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  geom_hline(yintercept=1, linetype="dashed") +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("10% exonic, var rec MID, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

q3 <- ggplot(data=filter(m_coeff_models, 
                         var=="ratio",
                         num_exons[3],
                         shapes_rate_r==shapes_rate_r[3]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans),
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  geom_hline(yintercept=1, linetype="dashed") +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("10% exonic, var rec LOW, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("coeff_ratios_exons_0.1_shape_r_1.png", q1, 
          base_height=8, base_width=16)
save_plot("coeff_ratios_exons_0.1_shape_r_3.png", q2, 
          base_height=8, base_width=16)
save_plot("coeff_ratios_exons_0.1_shape_r_10.png", q3, 
          base_height=8, base_width=16)

r1 <- ggplot(data=filter(m_coeff_models, 
                         var=="ratio", 
                         num_exons[2], 
                         shapes_rate_r==shapes_rate_r[1]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans),
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  geom_hline(yintercept=1, linetype="dashed") +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, var rec HIGH, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

r2 <- ggplot(data=filter(m_coeff_models, 
                         var=="ratio", 
                         num_exons[2], 
                         shapes_rate_r==shapes_rate_r[2]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans), 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  geom_hline(yintercept=1, linetype="dashed") +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, var rec MID, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

r3 <- ggplot(data=filter(m_coeff_models, 
                         var=="ratio",
                         num_exons[2], 
                         shapes_rate_r==shapes_rate_r[3]),
             aes(x=scale/1e+3,
                 y=value, 
                 shape=as.factor(avg_rec_spans))) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  geom_hline(yintercept=1, linetype="dashed") +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec Span (kb)") +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("5% exonic, var rec LOW, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("coeff_u_exons_0.05_shape_r_1.png", r1, base_height=8, base_width=16)
save_plot("coeff_u_exons_0.05_shape_r_3.png", r2, base_height=8, base_width=16)
save_plot("coeff_u_exons_0.05_shape_r_10.png", r3, base_height=8, base_width=16)

s1 <- ggplot(data=filter(m_coeff_models,
                         var=="ratio", 
                         num_exons[1], 
                         shapes_rate_r==shapes_rate_r[1]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans), 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  geom_hline(yintercept=1, linetype="dashed") +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("2% exonic, var rec HIGH, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)",  y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

s2 <- ggplot(data=filter(m_coeff_models, 
                         var=="ratio", 
                         num_exons[1],
                         shapes_rate_r==shapes_rate_r[2]),
             aes(x=scale/1e+3, 
                 y=value,
                 shape=as.factor(avg_rec_spans), 
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  geom_hline(yintercept=1, linetype="dashed") +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec. Span (kb)") +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("2% exonic, var rec MID, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)",  y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

s3 <- ggplot(data=filter(m_coeff_models,
                         var=="ratio",
                         num_exons[1], 
                         shapes_rate_r==shapes_rate_r[3]),
             aes(x=scale/1e+3, 
                 y=value, 
                 shape=as.factor(avg_rec_spans),
                 color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_mut_spans~shapes_rate_u) +
  geom_hline(yintercept=1, linetype="dashed") +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 3, 4, 8), name="Avg. Rec Span (kb)") +
  scale_x_continuous(breaks=unique(m_coeff_models$scale/1e+3), trans="log10") +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title=paste("2% exonic, var rec LOW, ", 
                   "cols->shape mu dist., rows->avg mu span"),
       x="Map Scale (kb)",  y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("coeff_ratios_exons_0.02_shape_r_1.png", s1,
          base_height=8, base_width=16)
save_plot("coeff_ratios_exons_0.02_shape_r_3.png", s2,
          base_height=8, base_width=16)
save_plot("coeff_ratios_exons_0.02_shape_r_10.png", s3, 
          base_height=8, base_width=16)

z1kb <- ggplot(data=filter(m_coeff_models,
                           var=="ratio", 
                           scale==1e+3),
               aes(x=cv_u_cv_B,
                   y=value,
                   shape=as.factor(num_exons), 
                   color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_rec_spans~shapes_rate_r) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2), name="# Exons") +
  scale_x_continuous(breaks=c(1, 10, 100)) +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="1kb, cols->avg_rec_spans, rows->shapes_rate_r",
       x="CV(u) / CV(B)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

z10kb <- ggplot(data=filter(m_coeff_models,
                            var=="ratio",
                            scale==1e+4),
                aes(x=cv_u_cv_B, 
                    y=value, 
                    shape=as.factor(num_exons), 
                    color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_rec_spans~shapes_rate_r) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2), name="# Exons") +
  scale_x_continuous(breaks=c(1, 10, 100)) +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="10kb, cols->avg_rec_spans, rows->shapes_rate_r",
       x="CV(u) / CV(B)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

z100kb <- ggplot(data=filter(m_coeff_models, 
                             var=="ratio", 
                             scale==1e+5),
               aes(x=cv_u_cv_B,
                   y=value, 
                   shape=as.factor(num_exons), 
                   color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_rec_spans~shapes_rate_r) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2), name="# Exons") +
  scale_x_continuous(breaks=c(1, 10, 100)) +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="1kb, cols->avg_rec_spans, rows->shapes_rate_r",
       x="CV(u) / CV(B)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

z1Mb <- ggplot(data=filter(m_coeff_models, 
                           var=="ratio", 
                           scale==1e+6),
               aes(x=cv_u_cv_B, 
                   y=value, 
                   shape=as.factor(num_exons), 
                   color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_grid(+avg_rec_spans~shapes_rate_r) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2), name="# Exons") +
  scale_x_continuous(breaks=c(1, 10, 100)) +
  scale_y_continuous(breaks=pretty_breaks()) +
  labs(title="1Mb, cols->avg_rec_spans, rows->shapes_rate_r",
       x="CV(u) / CV(B)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("coeff_ratios_1kb.png", z1kb, 
          base_height=8, base_width=16)
save_plot("coeff_ratios_10kb.png", z10kb, 
          base_height=8, base_width=16)
save_plot("coeff_ratios_100kb.png", z100kb, 
          base_height=8, base_width=16)
save_plot("coeff_ratios_1Mb.png", z1Mb, 
          base_height=8, base_width=16)

w1 <- ggplot(data=filter(m_coeff_models, 
                         var=="ratio", 
                         avg_rec_spans==avg_rec_spans[3], 
                         shapes_rate_r==shapes_rate_r[1]),
            aes(x=cv_u_cv_B, 
                y=value, 
                shape=as.factor(num_exons),
                color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  facet_wrap(~scale) +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2), name="# Exons") +
  scale_x_continuous(breaks=c(0.1, 1, 10), trans="log10") +
  scale_y_continuous(breaks=c(0.1, 1, 10), trans="log10") +
  labs(title=NULL, x="CV(u) / CV(B)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("coeff_ratios_scale.png", w1, base_height=8, base_width=16)

w2 <- ggplot(data=filter(m_coeff_models,
                         var=="ratio",
                         num_exons[2],
                         avg_rec_spans==avg_rec_spans[3],
                         shapes_rate_r==shapes_rate_r[1]),
             aes(x=cv_u_cv_B, y=value, shape=as.factor(scale), color=source_pi)) +
  geom_line() + geom_point(size=4) + theme_bw() +
  scale_color_discrete(name="source pi", type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 4), name="Scale") +
  scale_x_continuous(breaks=c(0.1, 1, 10), trans="log10") +
  scale_y_continuous(breaks=c(0.1, 1, 10), trans="log10") +
  labs(title=NULL, x="CV(u) / CV(B)", y="Ratio of Linear Coeffs (u/B)") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("coeff_ratios_scale_2.png", w2, base_height=8, base_width=16)


# meta linear models (pi exp)
## 1 kb
std_r2_1kb <- as.data.frame(r2_exp_models %>%
                            filter(., scale==1e+3) %>% 
                            dplyr::select(c(u_avg, B_avg,
                                            num_exons,
                                            shapes_rate_u,
                                            shapes_rate_r,
                                            avg_mut_spans,
                                            avg_mut_spans)) %>%
                            apply(., 2, function(x) (x-mean(x)) / sd(x)))

m_u_1kb <- lm(u_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                       avg_mut_spans + avg_rec_spans)^2, data=std_r2_1kb)
m_B_1kb <- lm(B_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                       avg_mut_spans + avg_rec_spans)^2, data=std_r2_1kb)

summary(m_u_1kb)
summary(m_B_1kb)

## 10 kb
std_r2_10kb <- as.data.frame(r2_exp_models %>% 
                              filter(., scale==1e+4) %>% 
                              dplyr::select(c(u_avg, B_avg,
                                              num_exons,
                                              shapes_rate_u,
                                              shapes_rate_r,
                                              avg_mut_spans,
                                              avg_mut_spans)) %>%
                              apply(., 2, function(x) (x-mean(x)) / sd(x)))

m_u_10kb <- lm(u_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                          avg_mut_spans + avg_rec_spans)^2, data=std_r2_10kb)
m_B_10kb <- lm(B_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                          avg_mut_spans + avg_rec_spans)^2, data=std_r2_10kb)

summary(m_u_10kb)
summary(m_B_10kb)

## 100 kb
std_r2_100kb <- as.data.frame(r2_exp_models %>% 
                              filter(., scale==1e+5) %>% 
                              dplyr::select(c(u_avg, B_avg,
                                              num_exons,
                                              shapes_rate_u,
                                              shapes_rate_r,
                                              avg_mut_spans,
                                              avg_mut_spans)) %>%
                              apply(., 2, function(x) (x-mean(x)) / sd(x)))

m_u_100kb <- lm(u_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                           avg_mut_spans + avg_rec_spans)^2, data=std_r2_100kb)
m_B_100kb <- lm(B_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                           avg_mut_spans + avg_rec_spans)^2, data=std_r2_100kb)

summary(m_u_100kb)
summary(m_B_100kb)

## 1 Mb
std_r2_1Mb <- as.data.frame(r2_exp_models %>% 
                            filter(., scale==1e+6) %>% 
                            dplyr::select(c(u_avg, B_avg,
                                            num_exons,
                                            shapes_rate_u,
                                            shapes_rate_r,
                                            avg_mut_spans,
                                            avg_mut_spans)) %>%
                            apply(., 2, function(x) (x-mean(x)) / sd(x)))

m_u_1Mb <- lm(u_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                       avg_mut_spans + avg_rec_spans)^2, data=std_r2_1Mb)
m_B_1Mb <- lm(B_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                           avg_mut_spans + avg_rec_spans)^2, data=std_r2_1Mb)

summary(m_u_1Mb)
summary(m_B_1Mb)

# mut
meta_lm_u <- rbind.data.frame(m_u_1kb$coefficients,
                              m_u_10kb$coefficients,
                              m_u_100kb$coefficients,
                              m_u_1Mb$coefficients)
names(meta_lm_u) <- names(m_u_1kb$coefficients)

meta_lm_u <- dplyr::select(meta_lm_u, c("shapes_rate_u",
                                        "avg_mut_spans",
                                        "num_exons",
                                        "shapes_rate_r",
                                        "avg_rec_spans"))

meta_lm_u$bin_size <- c(1e+3, 1e+4, 1e+5, 1e+6)
meta_lm_u$response <- "Mu"

mmlm_mu <- pivot_longer(meta_lm_u, cols=names(meta_lm_u)[1:(ncol(meta_lm_u)-2)],
                        names_to="var", values_to="coeff")

# B-val
meta_lm_B <- rbind.data.frame(m_B_1kb$coefficients,
                              m_B_10kb$coefficients,
                              m_B_100kb$coefficients,
                              m_B_1Mb$coefficients)
names(meta_lm_B) <- names(m_B_1kb$coefficients)

meta_lm_B <- dplyr::select(meta_lm_B, c("shapes_rate_u",
                                        "avg_mut_spans",
                                        "num_exons",
                                        "shapes_rate_r",
                                        "avg_rec_spans"))

meta_lm_B$bin_size <- c(1e+3, 1e+4, 1e+5, 1e+6)
meta_lm_B$response <- "B"

mmlm_B <- pivot_longer(meta_lm_B, cols=names(meta_lm_B)[1:(ncol(meta_lm_B)-2)],
                       names_to="var", values_to="coeff")

mmlm_tbl <- rbind.data.frame(mmlm_mu, mmlm_B)

meta_lm <- ggplot(data=mmlm_tbl, 
                  aes(x=var, 
                      y=coeff, 
                      shape=as.factor(bin_size),
                      color=response)) +
  geom_point(size=4) + theme_bw() +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_color_discrete(name=NULL, type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 4), name="Bin Size") +
  labs(title="Meta Linear Model for Variance Explained by 'Response'",
       x="Variable", y="Coefficient") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("meta_lm_pi_exp.png", meta_lm, base_height=8, base_width=10)

## 1 kb
std_r2_1kb <- as.data.frame(r2_sim_models %>%
                            filter(., scale==1e+3) %>% 
                            dplyr::select(c(u_avg, B_avg,
                                            num_exons,
                                            shapes_rate_u,
                                            shapes_rate_r,
                                            avg_mut_spans,
                                            avg_mut_spans)) %>%
                            apply(., 2, function(x) (x-mean(x)) / sd(x)))

m_u_1kb <- lm(u_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                         avg_mut_spans + avg_rec_spans)^2, data=std_r2_1kb)
m_B_1kb <- lm(B_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                         avg_mut_spans + avg_rec_spans)^2, data=std_r2_1kb)

summary(m_u_1kb)
summary(m_B_1kb)

## 10 kb
std_r2_10kb <- as.data.frame(r2_sim_models %>% 
                             filter(., scale==1e+4) %>% 
                             dplyr::select(c(u_avg, B_avg,
                                             num_exons,
                                             shapes_rate_u,
                                             shapes_rate_r,
                                             avg_mut_spans,
                                             avg_mut_spans)) %>%
                             apply(., 2, function(x) (x-mean(x)) / sd(x)))

m_u_10kb <- lm(u_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                          avg_mut_spans + avg_rec_spans)^2, data=std_r2_10kb)
m_B_10kb <- lm(B_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                          avg_mut_spans + avg_rec_spans)^2, data=std_r2_10kb)

summary(m_u_10kb)
summary(m_B_10kb)

## 100 kb
std_r2_100kb <- as.data.frame(r2_sim_models %>% 
                              filter(., scale==1e+5) %>% 
                              dplyr::select(c(u_avg, B_avg,
                                              num_exons,
                                              shapes_rate_u,
                                              shapes_rate_r,
                                              avg_mut_spans,
                                              avg_mut_spans)) %>%
                              apply(., 2, function(x) (x-mean(x)) / sd(x)))

m_u_100kb <- lm(u_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                           avg_mut_spans + avg_rec_spans)^2, data=std_r2_100kb)
m_B_100kb <- lm(B_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                           avg_mut_spans + avg_rec_spans)^2, data=std_r2_100kb)

summary(m_u_100kb)
summary(m_B_100kb)

## 1 Mb
std_r2_1Mb <- as.data.frame(r2_sim_models %>% 
                            filter(., scale==1e+6) %>% 
                            dplyr::select(c(u_avg, B_avg,
                                            num_exons,
                                            shapes_rate_u,
                                            shapes_rate_r,
                                            avg_mut_spans,
                                            avg_mut_spans)) %>%
                            apply(., 2, function(x) (x-mean(x)) / sd(x)))

m_u_1Mb <- lm(u_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                         avg_mut_spans + avg_rec_spans)^2, data=std_r2_1Mb)
m_B_1Mb <- lm(B_avg ~ (num_exons + shapes_rate_u + shapes_rate_r + 
                         avg_mut_spans + avg_rec_spans)^2, data=std_r2_1Mb)

summary(m_u_1Mb)
summary(m_B_1Mb)

# mut
meta_lm_u <- rbind.data.frame(m_u_1kb$coefficients,
                              m_u_10kb$coefficients,
                              m_u_100kb$coefficients,
                              m_u_1Mb$coefficients)
names(meta_lm_u) <- names(m_u_1kb$coefficients)

meta_lm_u <- dplyr::select(meta_lm_u, c("shapes_rate_u",
                                        "avg_mut_spans",
                                        "num_exons",
                                        "shapes_rate_r",
                                        "avg_rec_spans"))

meta_lm_u$bin_size <- c(1e+3, 1e+4, 1e+5, 1e+6)
meta_lm_u$response <- "Mu"

mmlm_mu <- pivot_longer(meta_lm_u, cols=names(meta_lm_u)[1:(ncol(meta_lm_u)-2)],
                        names_to="var", values_to="coeff")

# B-val
meta_lm_B <- rbind.data.frame(m_B_1kb$coefficients,
                              m_B_10kb$coefficients,
                              m_B_100kb$coefficients,
                              m_B_1Mb$coefficients)
names(meta_lm_B) <- names(m_B_1kb$coefficients)

meta_lm_B <- dplyr::select(meta_lm_B, c("shapes_rate_u",
                                        "avg_mut_spans",
                                        "num_exons",
                                        "shapes_rate_r",
                                        "avg_rec_spans"))

meta_lm_B$bin_size <- c(1e+3, 1e+4, 1e+5, 1e+6)
meta_lm_B$response <- "B"

mmlm_B <- pivot_longer(meta_lm_B, cols=names(meta_lm_B)[1:(ncol(meta_lm_B)-2)],
                       names_to="var", values_to="coeff")

mmlm_tbl <- rbind.data.frame(mmlm_mu, mmlm_B)

meta_lm <- ggplot(data=mmlm_tbl,
                  aes(x=var, 
                      y=coeff, 
                      shape=as.factor(bin_size), 
                      color=response)) +
  geom_point(size=4) + theme_bw() +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_color_discrete(name=NULL, type=c("plum3", "seagreen3")) +
  scale_shape_manual(values=c(0, 1, 2, 4), name="Bin Size") +
  labs(title="Meta Linear Model for Variance Explained by 'Response'",
       x="Variable", y="Coefficient") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

save_plot("meta_lm_pi_sim.png", meta_lm, base_height=8, base_width=10)
```

TODO: continue here

```{r real-data, include=F, message=F, warning=F}

num_chr <- 22

tbl_1kb <- list(length=num_chr)
tbl_10kb <- list(length=num_chr)
tbl_100kb <- list(length=num_chr)
tbl_1Mb <- list(length=num_chr)

# YRI pop
for(i in 1:num_chr) {
  tbl_1kb[[i]] <- fread(paste("B_tbl_functional_YRI_chr", i, "_1kb.csv.gz", sep=""))
  tbl_10kb[[i]] <- fread(paste("B_tbl_functional_YRI_chr", i, "_10kb.csv.gz", sep=""))
  tbl_100kb[[i]] <- fread(paste("B_tbl_functional_YRI_chr", i, "_100kb.csv.gz", sep=""))
  tbl_1Mb[[i]] <- fread(paste("B_tbl_functional_YRI_chr", i, "_1Mb.csv.gz", sep=""))
  
  tbl_1kb[[i]]$'#chrom' <- i
  tbl_10kb[[i]]$'#chrom' <- i
  tbl_100kb[[i]]$'#chrom' <- i
  tbl_1Mb[[i]]$'#chrom' <- i
}

big_tbl_1kb <- do.call(rbind.data.frame, tbl_1kb)
big_tbl_10kb <- do.call(rbind.data.frame, tbl_10kb)
big_tbl_100kb <- do.call(rbind.data.frame, tbl_100kb)
big_tbl_1Mb <- do.call(rbind.data.frame, tbl_1Mb)

names(big_tbl_1kb)[1] <- "chr"
names(big_tbl_10kb)[1] <- "chr"
names(big_tbl_100kb)[1] <- "chr"
names(big_tbl_1Mb)[1] <- "chr"


# mut x rec
p1 <- ggplot(data=big_tbl_1kb, aes(y=avg_rec, x=avg_mut)) +
  geom_point(size=3, shape=1) + theme_bw() + geom_smooth() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_continuous(breaks=pretty_breaks()) +
  labs(title="1kb", x=expression(mu), y="r") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p2 <- ggplot(data=big_tbl_10kb, aes(y=avg_rec, x=avg_mut)) +
  geom_point(size=3, shape=1) + theme_bw() + geom_smooth() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_continuous(breaks=pretty_breaks()) +
  labs(title="10kb", x=expression(mu), y="r") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p3 <- ggplot(data=big_tbl_100kb, aes(y=avg_rec, x=avg_mut)) +
  geom_point(size=3, shape=1) + theme_bw() + geom_smooth() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_continuous(breaks=pretty_breaks()) +
  labs(title="100kb", x=expression(mu), y="r") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p4 <- ggplot(data=big_tbl_1Mb, aes(y=avg_rec, x=avg_mut)) +
  geom_point(size=3, shape=1) + theme_bw() + geom_smooth() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_continuous(breaks=pretty_breaks()) +
  labs(title="1Mb", x=expression(mu), y="r") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

cp1 <- plot_grid(p1, p2, p3, p4, nrow=2)
save_plot("cor_r_u.svg", cp1)
save_plot("cor_r_u.pdf", cp1)

tbl_mut_rec <- as.data.frame(matrix(ncol=4, nrow=4))
names(tbl_mut_rec) <- c("pearson", "spearman", "kendall", "scale")
tbl_mut_rec$scale <- c(1e+3, 1e+4, 1e+5, 1e+6)

tbl_mut_rec[1, 1] <- cor.test(big_tbl_1kb$avg_rec, big_tbl_1kb$avg_mut, method="pearson")$estimate
tbl_mut_rec[2, 1] <- cor.test(big_tbl_10kb$avg_rec, big_tbl_10kb$avg_mut, method="pearson")$estimate
tbl_mut_rec[3, 1] <- cor.test(big_tbl_100kb$avg_rec, big_tbl_100kb$avg_mut, method="pearson")$estimate
tbl_mut_rec[4, 1] <- cor.test(big_tbl_1Mb$avg_rec, big_tbl_1Mb$avg_mut, method="pearson")$estimate

tbl_mut_rec[1, 2] <- cor.test(big_tbl_1kb$avg_rec, big_tbl_1kb$avg_mut, method="spearman")$estimate
tbl_mut_rec[2, 2] <- cor.test(big_tbl_10kb$avg_rec, big_tbl_10kb$avg_mut, method="spearman")$estimate
tbl_mut_rec[3, 2] <- cor.test(big_tbl_100kb$avg_rec, big_tbl_100kb$avg_mut, method="spearman")$estimate
tbl_mut_rec[4, 2] <- cor.test(big_tbl_1Mb$avg_rec, big_tbl_1Mb$avg_mut, method="spearman")$estimate

tbl_mut_rec[1, 3] <- cor.test(big_tbl_1kb$avg_rec, big_tbl_1kb$avg_mut, method="kendall")$estimate
tbl_mut_rec[2, 3] <- cor.test(big_tbl_10kb$avg_rec, big_tbl_10kb$avg_mut, method="kendall")$estimate
tbl_mut_rec[3, 3] <- cor.test(big_tbl_100kb$avg_rec, big_tbl_100kb$avg_mut, method="kendall")$estimate
tbl_mut_rec[4, 3] <- cor.test(big_tbl_1Mb$avg_rec, big_tbl_1Mb$avg_mut, method="kendall")$estimate

m_cor <- pivot_longer(tbl_mut_rec, cols=c("pearson", "spearman"), names_to="method", values_to="cor")

q1 <- ggplot(data=m_cor, aes(y=cor, x=scale, color=method)) +
  geom_point(size=3) + geom_line() + theme_bw() +
  scale_y_continuous(breaks=pretty_breaks(), limits=c(0, 1)) +
  scale_x_log10(breaks=c(1e+3, 1e+4, 1e+5, 1e+6)) +
  labs(title="Correlation mut x rec", x="scale", y="coeff.") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

tbl_B_rec <- as.data.frame(matrix(ncol=4, nrow=4))
names(tbl_B_rec) <- c("pearson", "spearman", "kendall", "scale")
tbl_B_rec$scale <- c(1e+3, 1e+4, 1e+5, 1e+6)

tbl_B_rec[1, 1] <- cor.test(big_tbl_1kb$avg_rec, big_tbl_1kb$B, method="pearson")$estimate
tbl_B_rec[2, 1] <- cor.test(big_tbl_10kb$avg_rec, big_tbl_10kb$B, method="pearson")$estimate
tbl_B_rec[3, 1] <- cor.test(big_tbl_100kb$avg_rec, big_tbl_100kb$B, method="pearson")$estimate
tbl_B_rec[4, 1] <- cor.test(big_tbl_1Mb$avg_rec, big_tbl_1Mb$B, method="pearson")$estimate

tbl_B_rec[1, 2] <- cor.test(big_tbl_1kb$avg_rec, big_tbl_1kb$B, method="spearman")$estimate
tbl_B_rec[2, 2] <- cor.test(big_tbl_10kb$avg_rec, big_tbl_10kb$B, method="spearman")$estimate
tbl_B_rec[3, 2] <- cor.test(big_tbl_100kb$avg_rec, big_tbl_100kb$B, method="spearman")$estimate
tbl_B_rec[4, 2] <- cor.test(big_tbl_1Mb$avg_rec, big_tbl_1Mb$B, method="spearman")$estimate

tbl_B_rec[1, 3] <- cor.test(big_tbl_1kb$avg_rec, big_tbl_1kb$B, method="kendall")$estimate
tbl_B_rec[2, 3] <- cor.test(big_tbl_10kb$avg_rec, big_tbl_10kb$B, method="kendall")$estimate
tbl_B_rec[3, 3] <- cor.test(big_tbl_100kb$avg_rec, big_tbl_100kb$B, method="kendall")$estimate
tbl_B_rec[4, 3] <- cor.test(big_tbl_1Mb$avg_rec, big_tbl_1Mb$B, method="kendall")$estimate

m_cor <- pivot_longer(tbl_B_rec, cols=c("pearson", "spearman"), names_to="method", values_to="cor")

q1 <- ggplot(data=m_cor, aes(y=cor, x=scale, color=method)) +
  geom_point(size=3) + geom_line() + theme_bw() +
  scale_y_continuous(breaks=pretty_breaks(), limits=c(0, 1)) +
  scale_x_log10(breaks=c(1e+3, 1e+4, 1e+5, 1e+6)) +
  labs(title="Correlation B x rec", x="scale", y="coeff.") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")


tbl_B_mut <- as.data.frame(matrix(ncol=4, nrow=4))
names(tbl_B_mut) <- c("pearson", "spearman", "kendall", "scale")
tbl_B_mut$scale <- c(1e+3, 1e+4, 1e+5, 1e+6)

tbl_B_mut[1, 1] <- cor.test(big_tbl_1kb$avg_mut, big_tbl_1kb$B, method="pearson")$estimate
tbl_B_mut[2, 1] <- cor.test(big_tbl_10kb$avg_mut, big_tbl_10kb$B, method="pearson")$estimate
tbl_B_mut[3, 1] <- cor.test(big_tbl_100kb$avg_mut, big_tbl_100kb$B, method="pearson")$estimate
tbl_B_mut[4, 1] <- cor.test(big_tbl_1Mb$avg_mut, big_tbl_1Mb$B, method="pearson")$estimate

tbl_B_mut[1, 2] <- cor.test(big_tbl_1kb$avg_mut, big_tbl_1kb$B, method="spearman")$estimate
tbl_B_mut[2, 2] <- cor.test(big_tbl_10kb$avg_mut, big_tbl_10kb$B, method="spearman")$estimate
tbl_B_mut[3, 2] <- cor.test(big_tbl_100kb$avg_mut, big_tbl_100kb$B, method="spearman")$estimate
tbl_B_mut[4, 2] <- cor.test(big_tbl_1Mb$avg_mut, big_tbl_1Mb$B, method="spearman")$estimate

tbl_B_mut[1, 3] <- cor.test(big_tbl_1kb$avg_mut, big_tbl_1kb$B, method="kendall")$estimate
tbl_B_mut[2, 3] <- cor.test(big_tbl_10kb$avg_mut, big_tbl_10kb$B, method="kendall")$estimate
tbl_B_mut[3, 3] <- cor.test(big_tbl_100kb$avg_mut, big_tbl_100kb$B, method="kendall")$estimate
tbl_B_mut[4, 3] <- cor.test(big_tbl_1Mb$avg_mut, big_tbl_1Mb$B, method="kendall")$estimate


p1 <- ggplot(data=big_tbl_1kb, aes(y=del_sites, x=avg_mut, alpha=0.25)) +
  geom_point(size=3, shape=1) + theme_bw() + geom_smooth() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_continuous(breaks=pretty_breaks()) +
  labs(title=NULL, x=expression(mu), y="# del. sites") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p2 <- ggplot(data=big_tbl_10kb, aes(y=del_sites, x=avg_mut, alpha=0.25)) +
  geom_point(size=3, shape=1) + theme_bw() + geom_smooth() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_continuous(breaks=pretty_breaks()) +
  labs(title=NULL, x=expression(mu), y="# del. sites") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p3 <- ggplot(data=big_tbl_100kb, aes(y=del_sites, x=avg_mut, alpha=0.25)) +
  geom_point(size=3, shape=1) + theme_bw() + geom_smooth() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_continuous(breaks=pretty_breaks()) +
  labs(title=NULL, x=expression(mu), y="# del. sites") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

p4 <- ggplot(data=big_tbl_1Mb, aes(y=del_sites, x=avg_mut, alpha=0.25)) +
  geom_point(size=3, shape=1) + theme_bw() + geom_smooth() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_continuous(breaks=pretty_breaks()) +
  labs(title=NULL, x=expression(mu), y="# del. sites") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")
ggsave("u_delsites.svg", p1, dpi=1000)

# u x del sites
tbl_del_sites_mut <- as.data.frame(matrix(ncol=4, nrow=4))
names(tbl_del_sites_mut) <- c("pearson", "spearman", "kendall", "scale")
tbl_del_sites_mut$scale <- c(1e+3, 1e+4, 1e+5, 1e+6)

tbl_del_sites_mut[1, 1] <- cor.test(big_tbl_1kb$avg_mut, big_tbl_1kb$del_sites, method="pearson")$estimate
tbl_del_sites_mut[2, 1] <- cor.test(big_tbl_10kb$avg_mut, big_tbl_10kb$del_sites, method="pearson")$estimate
tbl_del_sites_mut[3, 1] <- cor.test(big_tbl_100kb$avg_mut, big_tbl_100kb$del_sites, method="pearson")$estimate
tbl_del_sites_mut[4, 1] <- cor.test(big_tbl_1Mb$avg_mut, big_tbl_1Mb$del_sites, method="pearson")$estimate

tbl_del_sites_mut[1, 2] <- cor.test(big_tbl_1kb$avg_mut, big_tbl_1kb$del_sites, method="spearman")$estimate
tbl_del_sites_mut[2, 2] <- cor.test(big_tbl_10kb$avg_mut, big_tbl_10kb$del_sites, method="spearman")$estimate
tbl_del_sites_mut[3, 2] <- cor.test(big_tbl_100kb$avg_mut, big_tbl_100kb$del_sites, method="spearman")$estimate
tbl_del_sites_mut[4, 2] <- cor.test(big_tbl_1Mb$avg_mut, big_tbl_1Mb$del_sites, method="spearman")$estimate

tbl_del_sites_mut[1, 3] <- cor.test(big_tbl_1kb$avg_mut, big_tbl_1kb$del_sites, method="kendall")$estimate
tbl_del_sites_mut[2, 3] <- cor.test(big_tbl_10kb$avg_mut, big_tbl_10kb$del_sites, method="kendall")$estimate
tbl_del_sites_mut[3, 3] <- cor.test(big_tbl_100kb$avg_mut, big_tbl_100kb$del_sites, method="kendall")$estimate
tbl_del_sites_mut[4, 3] <- cor.test(big_tbl_1Mb$avg_mut, big_tbl_1Mb$del_sites, method="kendall")$estimate

m_cor <- pivot_longer(tbl_del_sites_mut, cols=c("pearson", "spearman"), names_to="method", values_to="cor")

q1 <- ggplot(data=m_cor, aes(y=cor, x=scale, color=method)) +
  geom_point(size=3) + geom_line() + theme_bw() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_log10(breaks=c(1e+3, 1e+4, 1e+5, 1e+6)) +
  labs(title="Correlation u x # del sites", x="scale", y="coeff.") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")

# B x del sites
tbl_del_sites_B <- as.data.frame(matrix(ncol=4, nrow=4))
names(tbl_del_sites_B) <- c("pearson", "spearman", "kendall", "scale")
tbl_del_sites_B$scale <- c(1e+3, 1e+4, 1e+5, 1e+6)

tbl_del_sites_B[1, 1] <- cor.test(big_tbl_1kb$B, big_tbl_1kb$del_sites, method="pearson")$estimate
tbl_del_sites_B[2, 1] <- cor.test(big_tbl_10kb$B, big_tbl_10kb$del_sites, method="pearson")$estimate
tbl_del_sites_B[3, 1] <- cor.test(big_tbl_100kb$B, big_tbl_100kb$del_sites, method="pearson")$estimate
tbl_del_sites_B[4, 1] <- cor.test(big_tbl_1Mb$B, big_tbl_1Mb$del_sites, method="pearson")$estimate

tbl_del_sites_B[1, 2] <- cor.test(big_tbl_1kb$B, big_tbl_1kb$del_sites, method="spearman")$estimate
tbl_del_sites_B[2, 2] <- cor.test(big_tbl_10kb$B, big_tbl_10kb$del_sites, method="spearman")$estimate
tbl_del_sites_B[3, 2] <- cor.test(big_tbl_100kb$B, big_tbl_100kb$del_sites, method="spearman")$estimate
tbl_del_sites_B[4, 2] <- cor.test(big_tbl_1Mb$B, big_tbl_1Mb$del_sites, method="spearman")$estimate

tbl_del_sites_B[1, 3] <- cor.test(big_tbl_1kb$B, big_tbl_1kb$del_sites, method="kendall")$estimate
tbl_del_sites_B[2, 3] <- cor.test(big_tbl_10kb$B, big_tbl_10kb$del_sites, method="kendall")$estimate
tbl_del_sites_B[3, 3] <- cor.test(big_tbl_100kb$B, big_tbl_100kb$del_sites, method="kendall")$estimate
tbl_del_sites_B[4, 3] <- cor.test(big_tbl_1Mb$B, big_tbl_1Mb$del_sites, method="kendall")$estimate

m_cor <- pivot_longer(tbl_del_sites_B, cols=c("pearson", "spearman"), names_to="method", values_to="cor")

q1 <- ggplot(data=m_cor, aes(y=cor, x=scale, color=method)) +
  geom_point(size=3) + geom_line() + theme_bw() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_log10(breaks=c(1e+3, 1e+4, 1e+5, 1e+6)) +
  labs(title="Correlation B x # del sites", x="scale", y="coeff.") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")
q1

# B x del pi0
tbl_del_sites_B <- as.data.frame(matrix(ncol=4, nrow=4))
names(tbl_del_sites_B) <- c("pearson", "spearman", "kendall", "scale")
tbl_del_sites_B$scale <- c(1e+3, 1e+4, 1e+5, 1e+6)

tbl_del_sites_B[1, 1] <- cor.test(big_tbl_1kb$B, big_tbl_1kb$del_sites, method="pearson")$estimate
tbl_del_sites_B[2, 1] <- cor.test(big_tbl_10kb$B, big_tbl_10kb$del_sites, method="pearson")$estimate
tbl_del_sites_B[3, 1] <- cor.test(big_tbl_100kb$B, big_tbl_100kb$del_sites, method="pearson")$estimate
tbl_del_sites_B[4, 1] <- cor.test(big_tbl_1Mb$B, big_tbl_1Mb$del_sites, method="pearson")$estimate

tbl_del_sites_B[1, 2] <- cor.test(big_tbl_1kb$B, big_tbl_1kb$del_sites, method="spearman")$estimate
tbl_del_sites_B[2, 2] <- cor.test(big_tbl_10kb$B, big_tbl_10kb$del_sites, method="spearman")$estimate
tbl_del_sites_B[3, 2] <- cor.test(big_tbl_100kb$B, big_tbl_100kb$del_sites, method="spearman")$estimate
tbl_del_sites_B[4, 2] <- cor.test(big_tbl_1Mb$B, big_tbl_1Mb$del_sites, method="spearman")$estimate

tbl_del_sites_B[1, 3] <- cor.test(big_tbl_1kb$B, big_tbl_1kb$del_sites, method="kendall")$estimate
tbl_del_sites_B[2, 3] <- cor.test(big_tbl_10kb$B, big_tbl_10kb$del_sites, method="kendall")$estimate
tbl_del_sites_B[3, 3] <- cor.test(big_tbl_100kb$B, big_tbl_100kb$del_sites, method="kendall")$estimate
tbl_del_sites_B[4, 3] <- cor.test(big_tbl_1Mb$B, big_tbl_1Mb$del_sites, method="kendall")$estimate

m_cor <- pivot_longer(tbl_del_sites_B, cols=c("pearson", "spearman"), names_to="method", values_to="cor")

q1 <- ggplot(data=m_cor, aes(y=cor, x=scale, color=method)) +
  geom_point(size=3) + geom_line() + theme_bw() +
  scale_y_continuous(breaks=pretty_breaks()) +
  scale_x_log10(breaks=c(1e+3, 1e+4, 1e+5, 1e+6)) +
  labs(title="Correlation B x # del sites", x="scale", y="coeff.") +
  theme(axis.title=element_text(size=16), 
        axis.text=element_text(size=12), 
        axis.text.x=element_text(size=12),
        legend.text=element_text(size=16),
        legend.title=element_text(size=16),
        legend.position="bottom")
q1
```