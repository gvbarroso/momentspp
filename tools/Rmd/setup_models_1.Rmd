---
title: "BGS under non-equilibrium demography (paper 1)"
author: "Gustavo V. Barroso"
date: "`r Sys.Date()`"
output:
  pdf_document:
  toc: true
number_sections: true
toc_depth: 1
---
  
```{r setup, include=F, message=F, warning=F}

knitr::opts_chunk$set(echo=TRUE)

library(tidyverse)
library(bigsnpr) # for seq_log
library(data.table)

knitr::opts_knit$set(root.dir="~/Data/momentspp/paper_1/single_neutral")
```

# Creating folders and files

This builds a look-up table on a dense parameter grid that will allow for fast 
assembly of whole chromosomes

```{r, params, include=F, eval=T, results=F, message=F, warning=F}

# in practice a two-epoch demographic model, even under equilibrium
Na <- 1e+4 # ancestral N
N1 <- c(Na / 10, 10 * Na) # current N
N2 <- c(N1, Na)
t <- 50000 # in generations
u <- 1e-8 # constant among exons as well as "fake" neutral u used to get B-vals
# rounding is required so that directory names don't diverge due to precision
lookup_r <- c(1e-8, 1e-7, 1e-6, 1e-5, 1e-4, 1e-3, 1e-2)
lookup_s <- c(-1e-3, -1e-4, -1e-5)

# for discretizing Gamma distributions
dt_r <- data.table(lookup_r)
dt_s <- data.table(lookup_s)

setkey(dt_r, lookup_r)
setkey(dt_s, lookup_s)

params <- setDT(crossing(Na, N1, t, u, lookup_r, lookup_s))
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

fwrite(dt_r, "r.csv", quote=F, row.names=F, col.names=F)
fwrite(dt_s, "s.csv", quote=F, row.names=F, col.names=F)
fwrite(params, "params.csv", quote=F, row.names=F)
```

```{bash dirs, engine.opts='-i', include=F, eval=T, results=F, warning=F}

# NOTE: this chunk requires that the directories do not already exist
source ~/.bashrc
  
cat r.csv | while IFS=, read -r r
do
  mkdir r_$r
  
  cat s.csv | while IFS=, read -r s
  do
    mkdir r_$r/s_$s
  done
done

find -mindepth 2 -type d -exec cp opt.bpp {} \;
```

Creates files that will be used as input for moments++

```{r, demes, include=F, eval=T, results=F, message=F, warning=F}

# writes demes files specifying models
for(i in 1:n_models) {
  
  if(i %% 10000 == 0) {
    print(Sys.time())
    cat(paste(i, "\n"))
  }
  
  Na <- as.integer(params[i,]$Na)
  N1 <- as.integer(params[i,]$N1)
  t <- as.integer(params[i,]$t)
  u <- as.numeric(params[i,]$u)
  r <- as.numeric(params[i,]$lookup_r)
  s <- as.numeric(params[i,]$lookup_s)
  
  name <- paste("model_", i, sep="")
  sink(paste("r_", r, "/s_", s, "/", name, ".yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(t)
  cat("\n")
  cat("        start_size: ")
  cat(Na)
  cat("\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(N1)
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    left_factor: 1\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(u)
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(r)
  cat("]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(s)
  cat("]\n")
  
  sink()
}
```

# Running moments++

Computes summary statistics for each parameter combination in lookup_tbl

```{bash moments++, engine.opts='-i', include=F, eval=F, results=F, warning=F}

#!/bin/bash

for r in r_*
do
  cd $r
  for s in s_*
  do
    cd $s
    for f in model_*.yaml
    do
      # this is to get the correct Order of (1-2p)
      # which is a function of 2Ns (maximum = 2N/1000 here)
      N=$(sed '8q;d' $f | cut -d : -f 2 | cut -d ' ' -f 2)
      x=$((2*$N/1000))
      if [[ $x -gt 90 ]]
      then
        momentspp params=opt.bpp F=$f O=$x > /dev/null
      else
        momentspp params=opt.bpp F=$f O=50
      fi
    done
    cd ..
  done
  cd ..
done
```

Collects lookup table with Hr values on the parameter grid

```{r, grid, include=F, eval=F, results=F, message=F, warning=F}

params <- fread("params.csv")

n_models <- nrow(params)
t <- unique(params$t)
sampling_times <- seq(from=t, to=0, by=-100)

# Het stats over time
hrs <- as.data.frame(matrix(nrow=n_models, ncol=length(sampling_times)))
hls <- as.data.frame(matrix(nrow=n_models, ncol=length(sampling_times)))

names(hrs) <- as.character(sampling_times)
names(hls) <- as.character(sampling_times)

# Het stats at present time
hr <- numeric(length=n_models)
hl <- numeric(length=n_models)

for(i in 1:length(lookup_r)) {
  cat(paste(i, "\n"))
  print(Sys.time())
  for(j in 1:length(lookup_s)) {
    fnames <- list.files(paste("r_", lookup_r[i], "/s_", lookup_s[j], sep=""),
                         pattern="*e_1_expectations.txt", full.names=TRUE)
    
    for(k in 1:length(fnames)) {
      moms <- fread(fnames[k])
      idx <- as.numeric(strsplit(strsplit(fnames[k], "_e_1")[[1]][1], 
                                 "model_")[[1]][2])
      
      hls[idx,] <- t(dplyr::select(filter(moms, V1=="Hl_0_0"), V3))
      hrs[idx,] <- t(dplyr::select(filter(moms, V1=="Hr_0_0"), V3))
      
      # expectations at present time
      hl[idx] <- moms[nrow(moms) - 1, 3]
      hr[idx] <- moms[nrow(moms), 3]
    }
  }
}

params_hl <- cbind.data.frame(params, hls)
params_hr <- cbind.data.frame(params, hrs)

fwrite(params_hl, "hl_time.csv.gz", compress="gzip") # used by other scripts
fwrite(params_hr, "hr_time.csv.gz", compress="gzip") # used by other scripts

params$hr <- hr
params$hl <- hl
fwrite(params, "lookup_tbl.csv.gz", compress="gzip") # used by other scripts
```

# TODO 
Add Python chunk with fwdpy11 simulations
