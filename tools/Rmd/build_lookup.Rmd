---
title: "BGS under non-equilibrium demography (paper 1)"
author: "Gustavo V. Barroso"
date: "`r Sys.Date()`"
output:
  pdf_document:
  toc: true
number_sections: true
toc_depth: 1
---
  
```{r setup, include=F, message=F, warning=F}

knitr::opts_chunk$set(echo=TRUE)

library(tidyverse)
library(bigsnpr) # for seq_log
library(data.table)

knitr::opts_knit$set(root.dir="~/Data/momentspp/paper_1/study/")
```

# Creating folders and files

Builds a parameter grid that allows for fast assembly of whole chromosomes

```{r, params, include=F, eval=T, results=F, message=F, warning=F}

Na <- 1e+4 # ancestral N
N1 <- c(Na / 10, 10 * Na) # current N
t <- 2 * Na # in generations

uL <- 1e-8
uR <- 1e-8
# rounding is required so that directory names don't diverge due to precision
r <- round(c(0, seq_log(1e-8, 1e-1, 71)), digits=12)
s <- round(-c(0, seq_log(1e-6, 1e-3, 3*11+1)), digits=12)

params <- setDT(crossing(Na, N1, t, r, s, uL, uR))
n_models <- nrow(params)

fwrite(as.data.frame(r), "r.csv", col.names=F)
fwrite(as.data.frame(s), "s.csv", col.names=F)
fwrite(params, "params.csv")
```

Creates directories where files will be written to

```{bash dirs, engine.opts='-i', include=F, eval=T, results=F, warning=F}

# NOTE: this chunk requires that the directories do not already exist
source ~/.bashrc
  
cat r.csv | while IFS=, read -r r
do
  mkdir r_$r
  cat s.csv | while IFS=, read -r s
  do
    mkdir r_$r/s_$s
  done
done

find -mindepth 2 -type d -exec cp opt.bpp {} \;

# makes directory to store purely neutral models to get pi0 predictions
mkdir demo
cp opt.bpp demo
```

Creates files that will be used as input for moments++

```{r, demes, include=F, eval=T, results=F, message=F, warning=F}

params <- fread("params.csv")
n_models <- nrow(params)

options(digits=16)
# writes demes files specifying models
for(i in 1:n_models) {
  
  if(i %% 10000 == 0) {
    print(Sys.time())
    cat(paste(i, "\n"))
  }
  
  Na <- as.numeric(params[i,]$Na)
  N1 <- as.numeric(params[i,]$N1)
  N2 <- as.numeric(params[i,]$N2)
  t1 <- as.integer(params[i,]$t1)
  t2 <- as.integer(params[i,]$t2)
  u <- as.numeric(params[i,]$uL)
  r <- as.numeric(params[i,]$r)
  s <- as.numeric(params[i,]$s)
  
  name <- paste("model_", i, sep="")
  sink(paste("r_", r, "/s_", s,"/", name, ".yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(t1)
  cat("\n")
  cat("        start_size: ")
  cat(Na)
  cat("\n")
  cat("      - end_time: ")
  cat(t2)
  cat("\n")
  cat("        start_size: ")
  cat(N1)
  cat("\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(N2)
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    left_factor: 1\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(u)
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(r)
  cat("]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(format(s, scientific=F))
  cat("]\n")
  
  sink()
}

# creates the (purely neutral) demographic model
Na <- as.integer(unique(params$Na))
N1 <- as.integer(unique(params$N1))
t <- as.integer(unique(params$t))
u <- as.numeric(unique(params$uL))

c <- 1
for(N in N1) {
  sink(paste("demo/model_", c, ".yaml", sep=""))
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  if(N != Na) {
    cat("      - end_time: ")
    cat(t)
    cat("\n")
    cat("        start_size: ")
    cat(Na)
    cat("\n")
  }
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(N)
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    left_factor: 1\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(u)
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [0]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [0]\n")
  sink()
  
  c <- c + 1
}
  
```

# Running moments++

Computes summary statistics for each parameter combination

```{bash moments++, engine.opts='-i', include=F, eval=T, results=F, warning=F}

#!/bin/bash

i=1
nr=$(wc -l r.csv | cut -d ' ' -f 1)

for r in r_*
do
  date
  echo "$i of $nr"
  cd $r
  for s in s_*
  do
    cd $s
    for f in model_*.yaml
    do
	    Na=$(sed '6q;d' $f | cut -d : -f 2 | cut -d ' ' -f 2) # fix which lines you get Na, N1, and s
	    N1=$(sed '8q;d' $f | cut -d : -f 2 | cut -d ' ' -f 2)
	    Ne=$Na
	    if [[ $N1 -gt $Na ]]
      then
	      Ne=$N1
	    fi
      x=$(sed '23q;d' $f | cut -d : -f 2 | cut -d [ -f 2 | cut -d ] -f 1)
      s=$(echo "scale=10; $x" | bc)
	    a=$(echo "scale=10; $Ne * $s" | bc)
      if [[ $(echo "$a < -1" | bc) == 1 ]]
	    then
	      b=${a%.*}
	      Ns=$(($b * -2))
	      if [[ $Ns -lt 30 ]]
	      then
  	      momentspp params=opt.bpp F=$f O=70 > /dev/null
  	    elif [[ $Ns -lt 70 ]]
  	    then 
  	      momentspp params=opt.bpp F=$f O=150 > /dev/null
  	    elif [[ $Ns -lt 150 ]]
  	    then    
  	      momentspp params=opt.bpp F=$f O=300 > /dev/null
  	    else
  	      momentspp params=opt.bpp F=$f O=400 > /dev/null
  	    fi
      else
	      momentspp params=opt.bpp F=$f O=10 > /dev/null
	    fi
    done
    cd ..
  done
  cd ..
  i=$(($i + 1))
done

# get pi0 over time
cd demo
for f in *yaml
do 
  momentspp params=opt.bpp F=$f O=2
done
```

Collects look-up table with Hr values on the parameter grid

```{r, lookup, include=F, eval=T, results=F, message=F, warning=F}

params <- fread("params.csv")

lookup_r <- unique(params$r)
lookup_s <- unique(params$s)

n_models <- nrow(params)
t <- unique(params$t)
sampling_times <- seq(from=t, to=0, by=-20000)

# Het stats over time (include steady-state and present-time)
hrs <- as.data.frame(matrix(nrow=n_models, ncol=length(sampling_times)))
hls <- as.data.frame(matrix(nrow=n_models, ncol=length(sampling_times)))

names(hrs) <- as.character(sampling_times)
names(hls) <- as.character(sampling_times)

hrs$Order <- 0
hls$Order <- 0

for(i in 1:length(lookup_r)) {
  cat(paste(i, "\n"))
  print(Sys.time())
  for(j in 1:length(lookup_s)) {
    fnames <- list.files(paste("r_", lookup_r[i], "/s_", lookup_s[j], sep=""),
                         pattern="exp_extended_*.*_time.txt", full.names=TRUE)
    
    idx <- 0  
    hets <- NULL
    for(l in 1:length(fnames)) {
      moms <- fread(fnames[l])
      str_sides <- strsplit(fnames[l], "_O_")[[1]]
      idx <- as.numeric(strsplit(str_sides[1], "exp_extended_")[[1]][2])
      order <- as.numeric(strsplit(str_sides[2], "*_e_*")[[1]][1])
      hets <- rbind.data.frame(hets, moms)
    }
    
    #hets <- hets[!duplicated(hets$V4)]
    hls[idx,] <- c(t(dplyr::select(filter(hets, V1=="Hl_0_0"), V3)), order)
    hrs[idx,] <- c(t(dplyr::select(filter(hets, V1=="Hr_0_0"), V3)), order)
  }
}

lookup_hl <- cbind.data.frame(params, hls)
lookup_hr <- cbind.data.frame(params, hrs)
lookup_tbl <- pivot_longer(lookup_hr, cols=as.character(sampling_times),
                       names_to="Generation", values_to="Hr")
lookup_tbl$Hr <- as.numeric(lookup_tbl$Hr)
lookup_tbl_hl <- pivot_longer(lookup_hl, cols=as.character(sampling_times),
                       names_to="Generation", values_to="Hl")
lookup_tbl$Hl <- as.numeric(lookup_tbl_hl$Hl)
lookup_tbl$Generation <- as.numeric(lookup_tbl$Generation)

# get pi0 from demography
demo_models <- crossing(unique(params$Na), unique(params$N1), unique(params$t))
names(demo_models) <- c("Na", "N1", "t")
num_models <- nrow(demo_models)
pi0 <- as.data.frame(matrix(nrow=num_models, ncol=length(sampling_times)))
names(pi0) <- as.character(sampling_times)

for(i in 1:num_models) {
  
  moms <- read.csv(paste("demo/model_", i, 
          "_O_2_e_1_hets_time.txt", sep=""), sep=" ", header=F)
  
  pi0[i,] <- t(dplyr::select(filter(moms, V1=="Hr_0_0"), V3))
}

demo_pi0 <- cbind.data.frame(demo_models, pi0)
m_pi0 <- pivot_longer(demo_pi0, 
                      cols=as.character(sampling_times),
                      names_to="Generation", values_to="pi0")
m_pi0$Generation <- as.numeric(m_pi0$Generation)

lookup_tbl <- left_join(lookup_tbl, dplyr::select(m_pi0,
                        -c(Na, t, N1)), by=c("Generation"))
lookup_tbl$B <- lookup_tbl$Hr / lookup_tbl$pi0
lookup_tbl$piN_pi0 <- lookup_tbl$Hl / lookup_tbl$pi0
lookup_tbl$piN_piS <- lookup_tbl$Hl / lookup_tbl$Hr

fwrite(lookup_tbl, "lookup_tbl_extended.csv.gz", compress="gzip") 
```

```{r, lookup, include=F, eval=T, results=F, message=F, warning=F}

# viz
r_vals <- c(1e-8, 2.5e-5, 1e-3)
p1 <- ggplot(data=filter(lookup_tbl, s==-1e-3, r %in% r_vals),
             aes(x=Generation, y=B, color=as.factor(r))) + 
      theme_bw() + geom_line(linewidth=1.25) + 
      scale_x_continuous(breaks=pretty_breaks()) +
      scale_y_continuous(breaks=pretty_breaks()) +
      labs(title="10X Expansion", x=NULL, y="B (s=-1e-3)") +
        theme(axis.title=element_text(size=16), 
              axis.text=element_text(size=12), 
              axis.text.x=element_blank(), 
              axis.text.y=element_blank(),
              legend.position="none")
  
p2 <- ggplot(data=filter(lookup_tbl, s==-1e-4, r %in% r_vals),
             aes(x=Generation, y=B, color=as.factor(r))) + 
      theme_bw() + geom_line(linewidth=1.25) + 
      scale_x_continuous(breaks=pretty_breaks()) +
      scale_y_continuous(breaks=pretty_breaks()) +
      labs(title=NULL, x=NULL, y="B (s=-1e-4)") +
      theme(axis.title=element_text(size=16), 
            axis.text=element_text(size=12), 
            axis.text.x=element_blank(), 
            axis.text.y=element_blank(),
            legend.position="none")

p3 <- ggplot(data=filter(lookup_tbl, s==-1e-5, r %in% r_vals),
             aes(x=Generation, y=B, color=as.factor(r))) + 
      theme_bw() + geom_line(linewidth=1.25) + 
      scale_x_continuous(breaks=pretty_breaks()) +
      scale_y_continuous(breaks=pretty_breaks()) +
      labs(title=NULL, x="Generations ago", y="B (s=-1e-5)") +
      theme(axis.title=element_text(size=16), 
            axis.text=element_text(size=12), 
            axis.text.x=element_text(size=12), 
            axis.text.y=element_blank(),
            legend.position="bottom") +
      guides(color=guide_legend(title="r"))

  
cp <- plot_grid(p1, p2, p3, ncol=1, rel_heights=c(1, 1, 1.35), align='v')
cp

p1 <- ggplot(data=filter(lookup_tbl, s==-1e-3, r==1e-8),
             aes(x=Generation, y=Hl)) + 
      theme_bw() + geom_line(linewidth=1.25) + 
      scale_x_continuous(breaks=pretty_breaks()) +
      scale_y_continuous(breaks=pretty_breaks()) +
      labs(title="Human-like history", x=NULL, y="Hl (s=-1e-3)") +
        theme(axis.title=element_text(size=16), 
              axis.text=element_text(size=12), 
              axis.text.x=element_blank(), 
              axis.text.y=element_text(size=12),
              legend.position="none")

p2 <- ggplot(data=filter(lookup_tbl, s==-1e-4, r==1e-8),
             aes(x=Generation, y=Hl)) + 
      theme_bw() + geom_line(linewidth=1.25) + 
      scale_x_continuous(breaks=pretty_breaks()) +
      scale_y_continuous(breaks=pretty_breaks()) +
      labs(title=NULL, x=NULL, y="Hl (s=-1e-4)") +
        theme(axis.title=element_text(size=16), 
              axis.text=element_text(size=12), 
              axis.text.x=element_blank(), 
              axis.text.y=element_text(size=12),
              legend.position="none")

p3 <- ggplot(data=filter(lookup_tbl, s==-1e-5, r==1e-8),
             aes(x=Generation, y=Hl)) + 
      theme_bw() + geom_line(linewidth=1.25) + 
      scale_x_continuous(breaks=pretty_breaks()) +
      scale_y_continuous(breaks=pretty_breaks()) +
      labs(title=NULL, x="Generations", y="Hl (s=-1e-5)") +
        theme(axis.title=element_text(size=16), 
              axis.text=element_text(size=12), 
              axis.text.x=element_text(size=12), 
              axis.text.y=element_text(size=12),
              legend.position="bottom")

cp <- plot_grid(p1, p2, p3, ncol=1, rel_heights=c(1, 1, 1.35), align='v')
cp


p <- ggplot(data=filter(lookup_tbl, r==1e-8, s == -1e-3), aes(x=Na, y=B)) + 
      geom_point() + theme_bw() + geom_line() + #facet_wrap(~s) +
      #scale_color_brewer(palette="Dark2", name="s") +
      scale_x_continuous(breaks=pretty_breaks()) +
      scale_y_continuous(breaks=pretty_breaks()) + guides(alpha="none") +
      labs(title="B-values over time, Bottleneck", x="Generation", y="B") +
      theme(axis.title=element_text(size=16), 
            axis.text=element_text(size=12), 
            axis.text.x=element_text(size=12),
            legend.text=element_text(size=16),
            legend.title=element_text(size=16),
            legend.position="bottom")
save_plot("B_gen_s.png", p, base_height=8, base_width=10)
```
