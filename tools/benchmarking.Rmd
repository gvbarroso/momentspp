---
title: "Benchmarking Moments++"
author: "Gustavo V. Barroso"
date: "Dec 8th 2022"
output:
  pdf_document:
  toc: true
number_sections: true
toc_depth: 3
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(matlib)
library(tidyverse)
library(scales)
library(reticulate)

knitr::opts_knit$set(root.dir = "~/Devel/momentspp/benchmarking/", engine.opts = list(bash = "-l"))
```

# Setting up scenarios to test (parameter combinations)

## TODO: write multiple models in the same YAML file using --- separator?

## 1_population parameters

```{r, message=FALSE, warning=FALSE}

p1_stats <- c("DD", "Dz", "H", "I", "Pi2")
num_stats <- length(p1_stats)

r <- c(1e-8, 1e-7, 1e-6)
mu <- c(1e-8, 1e-7, 1e-6)
N <- c(1e+3, 1e+4, 1e+5)

params_1_pop <- crossing(N, mu, r)

write.csv(params_1_pop, "params_1_pop.csv", quote = F, sep = ",", row.names = F)
```

## 2_populations parameters

```{r, message=FALSE, warning=FALSE}

mu <- 1e-7
r <- c(0, 1e-6)
N_0 <- c(1e+4, 1e+5)
N_1 <- 1e+5
m_01 <- c(0, 1e-4)
m_10 <- 1e-4
num_epochs <- c(1, 2)

num_gen_epoch_2 <- 5000
N_0_epoch_2 <- N_0 / 10
N_1_epoch_2 <- N_1 / 10

params_2_pop <- crossing(num_epochs, mu, r , m_01, m_10, N_0, N_1)
params_2_pop <- mutate(params_2_pop, N_0_epoch_2 = case_when(num_epochs == 1 ~ NA_real_, num_epochs == 2 ~ (N_0 / 10)))
params_2_pop <- mutate(params_2_pop, N_1_epoch_2 = case_when(num_epochs == 1 ~ NA_real_, num_epochs == 2 ~ (N_1 / 10)))
params_2_pop <- mutate(params_2_pop, num_gen_epoch_2 = case_when(num_epochs == 1 ~ NA_real_, num_epochs == 2 ~ 5000))

write.csv(params_2_pop, "accuracy/params_2_pops.csv", sep = ",", quote = F, row.names = F, col.names = T)
```

# Running moments++

## 1_population

```{bash}

# create directories and input files
mkdir pops_1
cd pops_1

a <- c("low_N", "mid_N", "high_N")
b <- c("low_mu", "mid_mu", "high_mu")
c <- c("low_r", "mid_r", "high_r")

for(x in 1:length(a)) {
  for(y in 1:length(b)) {
    for(z in 1:length(c)) {
      
      mkdir a[x]
      
    }
  }
}
```

## 2_populations

```{bash}

mkdir pops_2
cd pops_2




```

# Running moments.LD

```{python}

import moments.LD

with open("params_2_pops.csv") as fin:
    params = fin.readlines()

p_names = params[0].strip().split(",")

with open("accuracy/moments_LD_out.csv", "w+") as fout:
    stats = moments.LD.Util.moment_names(2)
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    for p_list in params[1:]:
        p_list = p_list.split(",")
        u = eval(p_list[p_names.index('mu')])
        r = eval(p_list[p_names.index('r')])
        m01 = eval(p_list[p_names.index('m_01')])
        m10 = eval(p_list[p_names.index('m_10')])
        N0 = eval(p_list[p_names.index('N_0')])
        N1 = eval(p_list[p_names.index('N_1')])
        rho = 4 * N0 * r
        theta = 4 * N0 * u
        nus = [N0 / N0, N1 / N0]
        m = [[0, 2 * N0 * m01], [2 * N0 * m10, 0]]
        y = moments.LD.LDstats(
            moments.LD.Numerics.steady_state_two_pop(nus, m, rho=rho, theta=theta),
            num_pops=2,
        )
        num_epochs = eval(p_list[p_names.index('num_epochs')])
        if num_epochs == 2:
            T = eval(p_list[p_names.index('num_gen_epoch_2')]) / 2 / N1
            N0b = eval(p_list[p_names.index('N_0_epoch_2')])
            N1b = eval(p_list[p_names.index('N_1_epoch_2')])
            nus = [N0b / N0, N1b / N0]
            y.integrate(nus, T, theta=theta, rho=rho, m=m)
        else:
            assert num_epochs == 1
        l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
        fout.write(l)
```

# Accuracy in 1_pop scenarios

```{r, message=FALSE, warning=FALSE}

params_1_pop <- read.csv("params_1_pop.csv", header = T, sep = ",", row.names = F)
num_scenarios <- nrow(params)
  
steadyStateTable <- as.data.frame(matrix(nrow = length(a) * length(b) * length(c), ncol = num_stats))
finalMomentsTable <- as.data.frame(matrix(nrow = length(a) * length(b) * length(c), ncol = num_stats))

names(steadyStateTable) <- p1_stats
names(finalMomentsTable) <- p1_stats

a <- c("low_N", "mid_N", "high_N")
b <- c("low_mu", "mid_mu", "high_mu")
c <- c("low_r", "mid_r", "high_r")

idx = 1
for(x in 1:length(a)) {
  for(y in 1:length(b)) {
    for(z in 1:length(c)) {
      
      s <- t(read.table(paste(paste("accuracy/pops_1", a[x], b[y], c[z], sep = "/"), "/steady_state.txt", sep = ""))$V5)
      f <- t(read.table(paste(paste("accuracy/pops_1", a[x], b[y], c[z], sep = "/"), "/final_moments.txt", sep = ""))$V5)
      
      steadyStateTable[idx,] <- s
      finalMomentsTable[idx,] <- f
      
      idx = idx + 1
    }
  }
}

stats <- bind_cols(bind_rows(steadyStateTable, finalMomentsTable), bind_rows(params_1_pop, params_1_pop))
stats$type <- c(rep("steady", num_scenarios), rep("final", num_scenarios))

write.table(stats, "accuracy/bench_1_pop_moments.csv", sep = ",", row.names = F, quote = F)

dat_stats <- pivot_longer(stats, cols = all_of(p1_stats), names_to = "variable")

p <- ggplot(data = dat_stats, aes(x = variable, y = value, shape = type, color = as.factor(N))) + facet_grid(r~mu)
p <- p + geom_point(size = 5) + theme_bw()
p <- p + scale_shape_manual(values = c(0, 1, 2, 3, 4))
p <- p + scale_y_continuous(trans = "log10")
p <- p + labs(title = "1-Epoch Moments x r (rows) and u (cols)", x = "Moment", y = "Value")
p <- p + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), legend.position = "bottom")
p

ggsave("accuracy/moments_1_pop.png", p, device = "png", width = 12, height = 12)
```

# Accuracy in 2_pops scenarios

## moments++ 

```{r, message=FALSE, warning=FALSE}

params_2_pop <- read.csv("params_2_pops.csv", header = T, sep = ",")
num_scenarios <- nrow(params_2_pop)

pop_indices <- c(0, 1)
DD_stats <- NULL
Dz_stats <- NULL
H_stats <- NULL
pi2_stats <- NULL

for(i in 1:length(pop_indices)) {
  for(j in 1:length(pop_indices)) {
    
    DD_stats <- c(DD_stats, paste("DD", pop_indices[i], pop_indices[j], sep = "_"))
    H_stats <- c(H_stats, paste("H", pop_indices[i], pop_indices[j], sep = "_"))
    
    for(k in 1:length(pop_indices)) {
      
      Dz_stats <- c(Dz_stats, paste("Dz", pop_indices[i], pop_indices[j], pop_indices[k], sep = "_"))
      
      for(l in 1:length(pop_indices)) {
        
        pi2_stats <- c(pi2_stats, paste("pi2", pop_indices[i], pop_indices[j], pop_indices[k], pop_indices[l], sep = "_"))
      }
    }
  }
}

p2_stats <- c(DD_stats, Dz_stats, H_stats, "I", pi2_stats)
num_stats <- length(p2_stats)

a <- c("zero_rec", "nonzero_rec")
b <- c("single_epoch", "two_epochs")
c <- c("asymmetric_mig", "symmetric_mig")
d <- c("diff_Ne", "same_Ne")

steadyStateTable <- as.data.frame(matrix(nrow = num_scenarios, ncol = num_stats))
finalMomentsTable <- as.data.frame(matrix(nrow = num_scenarios, ncol = num_stats))

idx = 1
for(x in 1:length(a)) {
  for(y in 1:length(b)) {
    for(z in 1:length(c)) {
      for(w in 1:length(d)) {
        
        steady_state <- read.table(paste(paste("accuracy/pops_2", a[x], b[y], c[z], d[w], sep = "/"), "/steady_state.txt", sep = ""))
        steadyStateTable[idx,] <- t(steady_state$V5)
        
        final_moments <- read.table(paste(paste("accuracy/pops_2", a[x], b[y], c[z], d[w], sep = "/"), "/final_moments.txt", sep = ""))
        finalMomentsTable[idx,] <- t(final_moments$V5)
        
        idx = idx + 1
      }
    }
  }
}

names(steadyStateTable) <- p2_stats
names(finalMomentsTable) <- p2_stats

steadY <- bind_cols(steadyStateTable, params_2_pop)
finY <- bind_cols(finalMomentsTable, params_2_pop)

stats <- bind_rows(steadY, finY)
stats$type <- c(rep("steady", num_scenarios), rep("final", num_scenarios))

write.table(stats, "accuracy/moments++_2_pops_stats.csv", sep = ",", row.names = F, quote = F)

dat_stats <- pivot_longer(stats, cols = all_of(p2_stats), names_to = "variable")

# one epoch plot
p1 <- ggplot(data = filter(dat_stats, num_epochs == 1), aes(x = variable, y = value, shape = type, color = as.factor(r))) + facet_grid(N_0~m_01)
p1 <- p1 + geom_point(size = 5) + theme_bw()
p1 <- p1 + scale_shape_manual(values = c(0, 1))
p1 <- p1 + labs(title = "1-Epoch Moments x N_0 (rows) and m_01 (cols)", x = "Moment", y = "Value")
p1 <- p1 + scale_y_continuous(trans = "log10")
p1 <- p1 + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom")
p1

ggsave("accuracy/moments_1-epoch.png", p1, device = "png", width = 12, height = 12)

# two epochs plot
p2 <- ggplot(data = filter(dat_stats, num_epochs == 2), aes(x = variable, y = value, shape = type, color = as.factor(r))) + facet_grid(N_0~m_01)
p2 <- p2 + geom_point(size = 5) + theme_bw()
p2 <- p2 + scale_shape_manual(values = c(0, 1))
p2 <- p2 + labs(title = "2-Epoch Moments x N_0 (rows) and m_01 (cols)", x = "Moment", y = "Value")
p2 <- p2 + scale_y_continuous(trans = "log10")
p2 <- p2 + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom")
p2

ggsave("accuracy/moments_2-epochs.png", p2, device = "png", width = 12, height = 12)
```


## Comparison with moments.LD 

```{r, message=FALSE, warning=FALSE}

py_moments <- read.csv("accuracy/moments_LD_out.csv") # output file from python chunk above

common_moments <- intersect(names(finalMomentsTable), names(py_moments))
match_moments <- bind_rows(select(finalMomentsTable, all_of(common_moments)), select(py_moments, all_of(common_moments)))
match_moments$scenario <- rep(seq(1:num_scenarios), 2)
match_moments$method <- c(rep("moments++", num_scenarios), rep("moments.LD", num_scenarios))
full_tbl <- bind_cols(match_moments, bind_rows(params_2_pop, params_2_pop)) # binds parameters together with moments

dat_matched <- pivot_longer(full_tbl, cols = all_of(common_moments), names_to = "variable")

# all moments/all scenarios together
p3 <- ggplot(data = dat_matched, aes(x = variable, y = value, color = method, shape = as.factor(scenario)))
p3 <- p3 + geom_point(size = 3) + theme_bw()
p3 <- p3 + labs(title = "2-Epoch Moments (moments++ vs moments.LD)", x = "Moment", y = "Value")
p3 <- p3 + scale_y_continuous(trans = "log10")
p3 <- p3 + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom")
ggsave("accuracy/all_stats_moments++_vs_moments.LD.png", p3, device = "png", width = 12, height = 12)

# for each moment
for(i in 1:length(common_moments)) {
  
  mom <- common_moments[i]
  
  p <- ggplot(data = filter(dat_matched, variable == mom), aes(x = scenario, y = value, shape = method, color = as.factor(num_epochs)))
  p <- p + geom_point(size = 5) + theme_bw()
  p <- p + scale_shape_manual(values = c(0, 1))
  p <- p + scale_y_continuous(trans = "log10")
  p <- p + labs(title = paste(mom, "(moments++ vs moments.LD)", sep = " "), x = "Scenario", y = "Value")
  p <- p + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), legend.position = "bottom")
  p
  
  ggsave(paste("accuracy/", mom, "_moments++_vs_moments.LD.png", sep = ""), p, device = "png", width = 12, height = 12)
}

# for each scenario
for(i in 1:num_scenarios) {
  
  p <- ggplot(data = filter(dat_matched, scenario == i), aes(x = variable, y = value, shape = method))
  p <- p + geom_point(size = 5) + theme_bw()
  p <- p + scale_shape_manual(values = c(0, 1))
  p <- p + scale_y_continuous(trans = "log10")
  p <- p + labs(title = paste("scenario", i, "(moments++ vs moments.LD)", sep = " "), x = "Moment", y = "Value")
  p <- p + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom")
  p
  
  ggsave(paste("accuracy/scenario_", i, "python_vs_c++.png", sep = "_"), p, device = "png", width = 12, height = 12)
}

# check parameters in scenarios
p4 <- ggplot(data = filter(dat_matched, r == 0), aes(x = variable, y = value, color = method, shape = as.factor(scenario))) 
p4 <- p4 + geom_point(size = 3) + theme_bw() + facet_grid(N_0 ~ m_01)
p4 <- p4 + scale_y_continuous(trans = "log10")
p4 <- p4 + scale_shape_manual(values = seq(from=1, to=8))
p4 <- p4 + labs(title = "Moments (r == 0) x N_0 (rows) and m_01 (cols)", x = "Moment", y = "Value")
p4 <- p4 + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom")
p4

ggsave("accuracy/moments_no-rec_moments++_vs_moments.LD.png", p4, device = "png", width = 12, height = 12)

p5 <- ggplot(data = filter(dat_matched, r == 1e-5), aes(x = variable, y = value, color = method, shape = as.factor(scenario))) 
p5 <- p5 + geom_point(size = 3) + theme_bw() + facet_grid(N_0 ~ m_01)
p5 <- p5 + scale_y_continuous(trans = "log10")
p5 <- p5 + scale_shape_manual(values = seq(from=1, to=8))
p5 <- p5 + labs(title = "Moments (r == 1.5e-05) x N_0 (rows) and m_01 (cols)", x = "Moment", y = "Value")
p5 <- p5 + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom")
p5

ggsave("accuracy/moments_rec_moments++_vs_moments.LD.png", p5, device = "png", width = 12, height = 12)

p6 <- ggplot(data = filter(dat_matched, num_epochs == 1), aes(x = variable, y = value, color = method, shape = as.factor(scenario))) 
p6 <- p6 + geom_point(size = 3) + theme_bw() + facet_grid(N_0 ~ m_01)
p6 <- p6 + scale_y_continuous(trans = "log10")
p6 <- p6 + scale_shape_manual(values = seq(from=1, to=8))
p6 <- p6 + labs(title = "Moments (1-epoch) x N_0 (rows) and m_01 (cols)", x = "Moment", y = "Value")
p6 <- p6 + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom")
p6

ggsave("accuracy/moments_1-epoch_moments++_vs_moments.LD.png", p6, device = "png", width = 12, height = 12)

p7 <- ggplot(data = filter(dat_matched, num_epochs == 2), aes(x = variable, y = value, color = method, shape = as.factor(scenario))) 
p7 <- p7 + geom_point(size = 3) + theme_bw() + facet_grid(N_0 ~ m_01)
p7 <- p7 + scale_y_continuous(trans = "log10")
p7 <- p7 + scale_shape_manual(values = seq(from=1, to=8))
p7 <- p7 + labs(title = "Moments (2-epochs) x N_0 (rows) and m_01 (cols)", x = "Moment", y = "Value")
p7 <- p7 + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 14), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom")
p7

ggsave("accuracy/moments_2-epoch_moments++_vs_moments.LD.png", p7, device = "png", width = 12, height = 12)
```

# Timing method for matrix multiplication

```{r, message=FALSE, warning=FALSE}

pop_scenarios <- 2^(0:3)
MultTimeTable <- as.data.frame(matrix(nrow = length(pop_scenarios), ncol = 5))
names(MultTimeTable) <- c("num_pops", "num_stats", "direct", "eigen", "pseudo-eigen")

for(i in 1:length(pop_scenarios)) {
  stats <- read.table(paste("timing/pops_", pop_scenarios[i], "/final_moments.txt", sep = ""))
  dir <- read.table(paste("timing/pops_", pop_scenarios[i], "/timing_direct.txt", sep = ""))
  eigen <- read.table(paste("timing/pops_", pop_scenarios[i], "/timing_eigen.txt", sep = ""))
  pseudo <- read.table(paste("timing/pops_", pop_scenarios[i], "/timing_pseudo-eigen.txt", sep = ""))
  
  MultTimeTable[i,] <- c(pop_scenarios[i], nrow(stats), dir, eigen, pseudo)
}

molten_time <- pivot_longer(MultTimeTable, cols = c("direct", "eigen", "pseudo-eigen"), names_to = "variable")

b <- ggplot(data = molten_time, aes(x = num_pops, y = value, shape = variable))
b <- b + geom_line(data = molten_time)
b <- b + geom_point(aes(shape = variable), size = 4)
b <- b + scale_x_continuous(breaks = pop_scenarios, trans="log2") 
b <- b + scale_y_continuous(breaks = c(1e-5, 1e-4, 1e-3, 1e-2, 1e-1, 1e+0, 1e+1, 1e+2, 1e+3, 1e+4), trans="log10")
b <- b + scale_shape_manual(values = c(0, 1, 2))
b <- b + labs(title = "Timing benchmark (apply transformation to 10000 generations)", x = "Num Pops.", y = "Time (seconds)") + theme_bw()
b <- b + theme(axis.title = element_text(size = 20), axis.text = element_text(size = 16), legend.position = "bottom")
b

ggsave("timing/mat_mult_timing.png", b, device = "png", width = 12, height = 12)
```
