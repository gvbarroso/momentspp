---
title: "Benchmarking Moments++"
author: "Gustavo V. Barroso"
date: "`r Sys.Date()`"
output:
  pdf_document:
  toc: true
number_sections: true
toc_depth: 3
---
  
```{r setup, include=FALSE, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(echo=TRUE)

library(tidyverse)
library(cowplot)
library(stringr)

# for running moments.LD:
library(reticulate)
use_python("/usr/bin/python3")

knitr::opts_knit$set(root.dir="~/Devel/momentspp/benchmarking/")
```

```{bash draw-models, engine.opts='-i', include=FALSE, eval=FALSE}

source ~/.bashrc

for((i=1;i<=6;++i)); do demesdraw tubes model_$i.yaml model_$i.pdf; done
```

# Running moments++

```{bash run-moments++, engine.opts='-i', include=TRUE, eval=TRUE, results=FALSE}

source ~/.bashrc

momentspp params=opt.bpp FILE=model_1.yaml LABEL=model_1
momentspp params=opt.bpp FILE=model_2.yaml LABEL=model_2
momentspp params=opt.bpp FILE=model_3.yaml LABEL=model_3
momentspp params=opt.bpp FILE=model_4.yaml LABEL=model_4
momentspp params=opt.bpp FILE=model_5.yaml LABEL=model_5
momentspp params=opt.bpp FILE=model_6.yaml LABEL=model_6
```

# Running moments.LD

```{python run-momentsLD, include=TRUE, eval=TRUE, results=FALSE}

import moments.LD
import demes

def simulate_ld(f, sampled_demes):
    """
    f: the demes filename
    """
    g = demes.load(f)
    u = g.metadata["mutation"]["rate"]
    r = g.metadata["recombination"]["rate"]

    y = moments.LD.LDstats.from_demes(g, sampled_demes, r=r, u=u)
    return y

with open("moments_LD_model_1.csv", "w+") as fout:
    f = "model_1.yaml"
    pops = ["A", "B", "C"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_2.csv", "w+") as fout:
    f = "model_2.yaml"
    pops = ["A", "B", "C"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_3.csv", "w+") as fout:
    f = "model_3.yaml"
    pops = ["A", "B", "C"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_4.csv", "w+") as fout:
    f = "model_4.yaml"
    pops = ["A", "B", "C"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_5.csv", "w+") as fout:
    f = "model_5.yaml"
    pops = ["A", "B", "C", "D"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_6.csv", "w+") as fout:
    f = "model_6.yaml"
    pops = ["A", "B", "C", "D"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
```

# Plots

```{r plots, include=TRUE, eval=TRUE, results=FALSE, message=FALSE, warning=FALSE}

# 3-populations (models m1-m4)
mpp_m1 <- read.table("model_1_expectations.txt") %>% select(!V2)
mpp_m2 <- read.table("model_2_expectations.txt") %>% select(V3)
mpp_m3 <- read.table("model_3_expectations.txt") %>% select(V3)
mpp_m4 <- read.table("model_4_expectations.txt") %>% select(V3)

momspp <- bind_cols(mpp_m1, mpp_m2, mpp_m3, mpp_m4)
names(momspp) <- c("stat", "m1++", "m2++", "m3++", "m4++")
momspp <- momspp[-31,] # deletes dummy moment I
momspp <- slice(momspp, 1:24, 31:52, 25:30) # re-orders rows to match moments.LD

py_m1 <- read.csv("moments_LD_model_1.csv") 
py_m2 <- read.csv("moments_LD_model_2.csv") 
py_m3 <- read.csv("moments_LD_model_3.csv") 
py_m4 <- read.csv("moments_LD_model_4.csv") 

py_moms <- as_tibble(cbind(names(py_m1), t(bind_rows(py_m1, py_m2, py_m3, py_m4))))
names(py_moms) <- c("stat", "m1py", "m2py", "m3py", "m4py")
py_moms <- type_convert(py_moms)

ratios <- select(momspp, starts_with("m")) / select(py_moms, starts_with("m"))
ratios <- bind_cols(momspp$stat, ratios)
names(ratios) <- c("stat", "m1", "m2", "m3", "m4")
ratios$count_2 <- as.factor(str_count(ratios$stat, "2"))

molten_ratios <- pivot_longer(ratios, cols=starts_with("m"))
p1 <- ggplot(data=molten_ratios, aes(x=stat, y=value, shape=name, color=count_2))
p1 <- p1 + geom_point(size=3) + theme_bw()
p1 <- p1 + geom_hline(yintercept=0.99, linetype=2)
p1 <- p1 + geom_hline(yintercept=1.01, linetype=2)
p1 <- p1 + labs(title="++ / LD", x="Moment", y="Ratio", shape="Model")
p1 <- p1 + scale_shape_manual(values=c(0, 1, 2, 3))
p1 <- p1 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")

p1
save_plot("ratios_1-4.pdf", p1, base_height=12, base_width=12)

# 4-populations (models m5-m6)
mpp_m5 <- read.table("model_5_expectations.txt") %>% select(!V2)
mpp_m6 <- read.table("model_6_expectations.txt") %>% select(V3)

momspp <- bind_cols(mpp_m5, mpp_m6)
names(momspp) <- c("stat", "m5++", "m6++")
momspp <- momspp[-61,] # deletes dummy moment I
momspp <- slice(momspp, 1:50, 61:115, 51:60) # re-orders rows to match moments.LD

py_m5 <- read.csv("moments_LD_model_5.csv") 
py_m6 <- read.csv("moments_LD_model_6.csv") 

py_moms <- as_tibble(cbind(names(py_m5), t(bind_rows(py_m5, py_m6))))
names(py_moms) <- c("stat", "m5py", "m6py")
py_moms <- type_convert(py_moms)

ratios <- select(momspp, starts_with("m")) / select(py_moms, starts_with("m"))
ratios <- bind_cols(momspp$stat, ratios)
names(ratios) <- c("stat", "m5", "m6")
ratios$count_4 <- as.factor(str_count(ratios$stat, "4"))

molten_ratios <- pivot_longer(ratios, cols=starts_with("m"))
p2 <- ggplot(data=molten_ratios, aes(x=stat, y=value, shape=name, color=count_4))
p2 <- p2 + geom_point(size=3) + theme_bw()
p2 <- p2 + geom_hline(yintercept=0.99, linetype=2) 
p2 <- p2 + geom_hline(yintercept=1.01, linetype=2)
p2 <- p2 + labs(title="++ / LD", x="Moment", y="Ratio", shape="Model")
p2 <- p2 + scale_shape_manual(values=c(0, 1))
p2 <- p2 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")

p2
save_plot("ratios_5-6.pdf", p2, base_height=15, base_width=15)
```

```{bash clean-up, engine.opts='-i', include=FALSE, eval=TRUE}

source ~/.bashrc

rm *.txt
rm *.csv
```