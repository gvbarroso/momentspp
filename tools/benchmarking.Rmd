---
title: "Benchmarking Moments++"
author: "Gustavo V. Barroso"
date: "`r Sys.Date()`"
output:
  pdf_document:
  toc: true
number_sections: true
toc_depth: 3
---
  
```{r setup, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(echo=TRUE)

library(tidyverse)
library(cowplot)

# for running moments.LD:
library(reticulate)
use_python("/usr/bin/python3")

knitr::opts_knit$set(root.dir="~/Devel/momentspp/benchmarking/")
```

# Validating and visualizing demes models

```{bash draw-models, engine.opts='-i', include=TRUE, eval=TRUE}

source ~/.bashrc

for((i=1;i<=6;++i)); do demesdraw tubes model_$i.yaml model_$i.pdf; done

```

# Running moments++

```{bash run-moments++, engine.opts='-i', include=TRUE}

source ~/.bashrc

momentspp params=opt.bpp FILE=model_1.yaml LABEL=model_1
momentspp params=opt.bpp FILE=model_2.yaml LABEL=model_2
momentspp params=opt.bpp FILE=model_3.yaml LABEL=model_3
momentspp params=opt.bpp FILE=model_4.yaml LABEL=model_4
momentspp params=opt.bpp FILE=model_5.yaml LABEL=model_5
momentspp params=opt.bpp FILE=model_6.yaml LABEL=model_6

```

# Running moments.LD

```{python run-momentsLD, include=TRUE, eval=TRUE}

import moments.LD
import demes

def simulate_ld(f, sampled_demes):
    """
    f: the demes filename
    """
    g = demes.load(f)
    u = g.metadata["mutation"]["rate"]
    r = g.metadata["recombination"]["rate"]

    y = moments.LD.LDstats.from_demes(g, sampled_demes, r=r, u=u)
    return y

with open("moments_LD_model_1.csv", "w+") as fout:
    f = "model_1.yaml"
    pops = ["A", "B", "C"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_2.csv", "w+") as fout:
    f = "model_2.yaml"
    pops = ["A", "B", "C"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_3.csv", "w+") as fout:
    f = "model_3.yaml"
    pops = ["A", "B", "C"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_4.csv", "w+") as fout:
    f = "model_4.yaml"
    pops = ["A", "B", "C"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_5.csv", "w+") as fout:
    f = "model_5.yaml"
    pops = ["A", "B", "C", "D"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
    
with open("moments_LD_model_6.csv", "w+") as fout:
    f = "model_6.yaml"
    pops = ["A", "B", "C", "D"]
    y = simulate_ld(f, pops)
    stats = moments.LD.Util.moment_names(len(pops))
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
    fout.write(l)
```

# plots

```{r plots, include=TRUE, eval=FALSE}

# 3-populations (models 1-4)
mpp_m1 <- read.table("model_1_expectations.txt") %>% select(!V2)
mpp_m2 <- read.table("model_2_expectations.txt") %>% select(V3)
mpp_m3 <- read.table("model_3_expectations.txt") %>% select(V3)
mpp_m4 <- read.table("model_4_expectations.txt") %>% select(V3)

momspp <- bind_cols(mpp_m1, mpp_m2, mpp_m3, mpp_m4)
names(momspp) <- c("stat", "m1++", "m2++", "m3++", "m4++")
momspp <- momspp[-31,]
momspp <- slice(momspp, 1:24, 31:52, 25:30) # re-orders rows to match moments.LD

py_m1 <- read.csv("moments_LD_model_1.csv") 
py_m2 <- read.csv("moments_LD_model_2.csv") 
py_m3 <- read.csv("moments_LD_model_3.csv") 
py_m4 <- read.csv("moments_LD_model_4.csv") 

py_moms <- as_tibble(cbind(names(py_m1), t(bind_rows(py_m1, py_m2, py_m3, py_m4))))
names(py_moms) <- c("stat", "m1py", "m2py", "m3py", "m4py")

models <- bind_cols(momspp[,1:3], py_moms[,2:3])
models <- head(models, - 6)
names(models) <- c("stat", "admix++", "no-admix++", "admix_py", "no-admix_py")
models$ratio_admix <- models$`admix++` / models$admix_py
models$ratio_no_admix <- models$`no-admix++` / models$`no-admix_py`

molten_admix <- pivot_longer(models, cols=starts_with("admix"))
r <- ggplot(data=molten_admix, aes(x=stat, y=value, shape=name))
r <- r + geom_point(size=3) + theme_bw()
r <- r + labs(title="++ vs LD (pulse)", x="Moment", y="Value", shape="model")
r <- r + scale_shape_manual(values=c(1, 2))
r <- r + theme(axis.title=element_text(size=12),
               axis.text=element_text(size=10),
               axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
               legend.position="bottom")

molten_no_admix <- pivot_longer(models, cols=starts_with("no-admix"))
s <- ggplot(data=molten_no_admix, aes(x=stat, y=value, shape=name))
s <- s + geom_point(size=3) + theme_bw()
s <- s + labs(title="++ vs LD (no-pulse)", x="Moment", y="Value", shape="model")
s <- s + scale_shape_manual(values=c(1, 2))
s <- s + theme(axis.title=element_text(size=12),
               axis.text=element_text(size=10),
               axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
               legend.position="bottom")

plot <- plot_grid(r, s, ncol = 2)
plot

molten_ratios <- pivot_longer(models, cols=starts_with("ratio"))
t <- ggplot(data=molten_ratios, aes(x=stat, y=value, shape=name))
t <- t + geom_point(size=3) + theme_bw()
t <- t + labs(title="++ / LD", x="Moment", y="Value", shape="model")
t <- t + scale_shape_manual(values=c(1, 2))
t <- t + theme(axis.title=element_text(size=12),
               axis.text=element_text(size=10),
               axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
               legend.position="bottom")
t
save_plot("ratios.pdf", t, base_height=12, base_width=12)

```
