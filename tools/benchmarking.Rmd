---
title: "Benchmarking Moments++"
author: "Gustavo V. Barroso"
date: "`r Sys.Date()`"
output:
  pdf_document:
  toc: true
number_sections: true
toc_depth: 3
---

```{r setup, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(matlib)
library(tidyverse)
library(scales)
library(reticulate)
use_python("/usr/bin/python3")

knitr::opts_knit$set(root.dir="~/Devel/momentspp/benchmarking/")
```

# Setting up scenarios to test (parameter combinations)
## 1_population parameters

```{r 1-pop-params, message=FALSE, warning=FALSE}

r <- c(1e-8, 1e-7, 1e-6)
mu <- c(1e-8, 1e-7, 1e-6)
N <- c(1e+3, 1e+4, 1e+5)

params_1_pop <- crossing(N, mu, r) %>% arrange(N, mu, r)
write.csv(params_1_pop, "params_1_pop.csv", quote=F, sep=",", row.names=F)
```

## 2_populations parameters

```{r 2-pops-params, message=FALSE, warning=FALSE}

mu <- 1e-7
r <- c(0, 1e-6)
N_0 <- c(1e+4, 1e+5)
N_1 <- 1e+5
m_01 <- c(0, 1e-4)
m_10 <- 1e-4
num_epochs <- c(1, 2)

num_gen_epoch_2 <- 5000
N_0_epoch_2 <- N_0 / 10
N_1_epoch_2 <- N_1 / 10

params_2_pop <- crossing(num_epochs, mu, r , m_01, m_10, N_0, N_1) 
params_2_pop <- mutate(params_2_pop, 
                       N_0_epoch_2 = case_when(num_epochs==1 ~ NA_real_,
                                               num_epochs==2 ~ (N_0 / 10)))
params_2_pop <- mutate(params_2_pop, 
                       N_1_epoch_2 = case_when(num_epochs==1 ~ NA_real_,
                                               num_epochs==2 ~ (N_1 / 10)))
params_2_pop <- mutate(params_2_pop, 
                       num_gen_epoch_2 = case_when(num_epochs==1 ~ NA_real_, 
                                                   num_epochs==2 ~ 5000))

write.csv(params_2_pop, "params_2_pops.csv", sep=",", 
          quote=F, row.names=F, col.names=T)
```

# Running moments++

```{bash run-moments++, engine.opts='-i', message=FALSE, warning=FALSE}

source ~/.bashrc

# 1 population
input="params_1_pop.csv";
id=1 # line counter, scenario_id

{
  read # ignores header 
  while IFS=, read -r a b c; do
    momentspp params=opt_1.bpp i=$id N=$a u=$b r=$c
    ((id=id+1))
  done
} < "$input"

# 2 populations
input="params_2_pops.csv";
id=1 # line counter, scenario_id

{
  read # ignores header 
  while IFS=, read -r a b c d e f g h i j
  do
    echo $a; echo $f; echo $g; echo $d; echo $e; echo $b; echo $c;
    momentspp params=opt_2.bpp i=$id epochs=$a N0=$f N1=$g m01=$d m10=$e u=$b r=$c
    ((id=id+1))
  done 
} < "$input"

```

# Running moments.LD
## 1 population

```{python run-momentsLD-1pop, message=FALSE, warning=FALSE}

import moments.LD

# 1 population
with open("params_1_pop.csv") as fin:
    params = fin.readlines()
  
p_names = params[0].strip().split(",")

with open("moments_LD_1_pop_out.csv", "w+") as fout:
    stats = moments.LD.Util.moment_names(1)
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    for p_list in params[1:]:
        p_list = p_list.split(",")
        N = float(p_list[p_names.index('N')])
        u = float(p_list[p_names.index('mu')])
        r = float(p_list[p_names.index('r')])
        y = moments.LD.Demographics1D.snm(rho = 4 * N * r, theta = 4 * N * u)
        l = ",".join([str(_) for _ in y.LD()[0]]) + "," + str(y.H()[0]) + "\n"
        fout.write(l)
```

## 2 populations

```{python run-momentsLD-2pops, message=FALSE, warning=FALSE}

import moments.LD

# 2 populations
with open("params_2_pops.csv") as fin:
    params = fin.readlines()

p_names = params[0].strip().split(",")

with open("moments_LD_2_pops_out.csv", "w+") as fout:
    stats = moments.LD.Util.moment_names(2)
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    for p_list in params[1:]:
        p_list = p_list.split(",")
        u = eval(p_list[p_names.index('mu')])
        r = eval(p_list[p_names.index('r')])
        m01 = eval(p_list[p_names.index('m_01')]) 
        m10 = eval(p_list[p_names.index('m_10')]) 
        N0 = eval(p_list[p_names.index('N_0')])
        N1 = eval(p_list[p_names.index('N_1')])
        rho = 4 * N0 * r
        theta = 4 * N0 * u
        nus = [N0 / N0, N1 / N0]
        m = [[0, 2 * N0 * m01], [2 * N0 * m10, 0]]
        y = moments.LD.LDstats(
            moments.LD.Numerics.steady_state_two_pop(nus, m, rho=rho, theta=theta),
            num_pops=2,
        )
        num_epochs = eval(p_list[p_names.index('num_epochs')])
        if num_epochs == 2:
            T = eval(p_list[p_names.index('num_gen_epoch_2')]) / 2 / N1
            N0b = eval(p_list[p_names.index('N_0_epoch_2')])
            N1b = eval(p_list[p_names.index('N_1_epoch_2')])
            nus = [N0b / N0, N1b / N0]
            y.integrate(nus, T, theta=theta, rho=rho, m=m)
        else:
            assert num_epochs == 1
        l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
        fout.write(l)
```

# 1-population plots
## moments++

```{r 1-population-plots}

params_1_pop <- read.csv("params_1_pop.csv", header=T, sep=",")
num_scenarios <- nrow(params_1_pop)

# extracting names of moments
stats_1_pop <- read.table("1-pop_scenario_1_final_unsorted.txt")[,1]
suffixes <- c("A", "B", "X") # from sorting in moments++ (SumStatsLibrary class)

# convert to unsorted moments as presented in moments.LD
for(i in 1:length(suffixes)) {
  stats_1_pop <- str_remove(stats_1_pop, paste("_", suffixes[i], sep=""))
}
num_stats <- length(stats_1_pop)

momspp <- as_tibble(matrix(nrow=num_scenarios, ncol=num_stats), .name_repair="unique")
names(momspp) <- stats_1_pop
write.table(momspp, "moments++_1_pop_stats.csv", sep=",", row.names=F, quote=F)

idx=1
for(i in 1:num_scenarios) {
  tmp <- read.table(paste("1-pop_scenario_", idx, "_final_unsorted.txt", sep=""))
  momspp[idx,] <- t(tmp[ncol(tmp)])
  idx=idx + 1
}

stats <- bind_cols(momspp, params_1_pop)
dat_stats <- pivot_longer(stats, cols=all_of(stats_1_pop), names_to="variable")

p <- ggplot(data=dat_stats, aes(x=variable, y=value, shape=as.factor(N)))
p <- p + geom_point(size=5) + theme_bw() + facet_grid(r~mu)
p <- p + scale_shape_manual(values=c(0, 1, 2, 3, 4))
p <- p + scale_y_continuous(trans="log10")
p <- p + labs(title="1-Pop Moments x r (rows) and u (cols)",
              x="Moment", y="Value", shape="N")
p <- p + theme(axis.title=element_text(size=20),
               axis.text=element_text(size=14),
               axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
               legend.position="bottom")

ggsave("moments++_1_pop.png", p, device="png", width=12, height=12)
```

## Comparison with moments.LD 

```{r 1-population-LDx++}

py_moments <- read.csv("moments_LD_1_pop_out.csv") # out from python chunk 

common_moments <- intersect(names(momspp), names(py_moments))
match_moments <- bind_rows(select(momspp, all_of(common_moments)),
                           select(py_moments, all_of(common_moments)))
match_moments$scenario <- rep(seq(1:num_scenarios), 2)
match_moments$method <- c(rep("moments++", num_scenarios),
                          rep("moments.LD", num_scenarios))
match_moments$scenario <- rep(seq(1:num_scenarios), 2)
full_tbl <- bind_cols(match_moments, 
                      bind_rows(params_1_pop, params_1_pop)) 

dat_matched <- pivot_longer(full_tbl,
                            cols=all_of(common_moments), 
                            names_to="variable")
write.table(dat_matched, "LD_++_1-pop.csv", sep=",", row.names=F, quote=F)

# all moments/scenarios together
p <- ggplot(data=dat_matched,
            aes(x=variable, y=value, color=method, shape=method))
p <- p + geom_point(size=3) + theme_bw()
p <- p + labs(title="1-Pop moments++ vs moments.LD",
                x="Moment", y="Value")
p <- p + scale_y_continuous(trans="log10")
p <- p + scale_shape_manual(values=c(1,2))
p <- p + theme(axis.title=element_text(size=20),
                 axis.text=element_text(size=14),
                 axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1),
                 legend.position="bottom")
ggsave("moments++_vs_moments.LD_1-pop_all_stats.png",
       p, device="png", width=12, height=12)

# for each moment
for(i in 1:length(common_moments)) {
  
  mom <- common_moments[i]
  
  p <- ggplot(data=filter(dat_matched, variable==mom),
              aes(x=scenario, y=value, color=method, shape=method))
  p <- p + geom_point(size=5) + theme_bw()
  p <- p + scale_y_continuous(trans="log10")
  p <- p + scale_shape_manual(values=c(1,2))
  p <- p + labs(title=paste(mom, "moments++ vs moments.LD", sep=" "),
                x="Scenario", y="Value")
  p <- p + theme(axis.title=element_text(size=20),
                 axis.text=element_text(size=14),
                 legend.position="bottom")

  ggsave(paste(mom, "_moments++_vs_moments.LD_1-pop.png", sep=""),
         p, device="png", width=12, height=12)
}

# for each scenario
for(i in 1:num_scenarios) {
  
  p <- ggplot(data=filter(dat_matched, scenario==i), 
              aes(x=variable, y=value, color=method))
  p <- p + geom_point(size=5) + theme_bw()
  p <- p + scale_y_continuous(trans="log10")
  p <- p + labs(title=paste("scenario", i, "(moments++ vs moments.LD)", sep=" "),
                x="Moment", y="Value")
  p <- p + theme(axis.title=element_text(size=20), 
                 axis.text=element_text(size=14),
                 axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
                 legend.position="bottom")

  ggsave(paste("scenario", i, "moments++_vs_moments.LD_1-pop.png", sep="_"),
         p, device="png", width=12, height=12)
}
```

# 2-populations plots
## moments++

```{r 2-population-plots}

params_2_pops <- read.csv("params_2_pops.csv", header=T, sep=",")
num_scenarios <- nrow(params_2_pops)

# extracting names of moments
stats_2_pops <- read.table("2-pops_scenario_1_final_unsorted.txt")[,1]
suffixes <- c("A", "B", "X") # from sorting in moments++

# convert to unsorted moments as presented in moments.LD
for(i in 1:length(suffixes)) {
  stats_2_pops <- str_remove(stats_2_pops, paste("_", suffixes[i], sep=""))
}
num_stats <- length(stats_2_pops)

momspp <- as_tibble(matrix(nrow=num_scenarios, ncol=num_stats), .name_repair="unique")
names(momspp) <- stats_2_pops

idx=1
for(i in 1:num_scenarios) {
  tmp <- read.table(paste("2-pops_scenario_", idx, "_final_unsorted.txt", sep=""))
  momspp[idx,] <- t(tmp[ncol(tmp)])
  idx=idx + 1
}

stats <- bind_cols(momspp, params_2_pops)
write.table(momspp, "moments++_2_pops_stats.csv", sep=",", row.names=F, quote=F)

dat_stats <- pivot_longer(stats, cols=all_of(stats_2_pops), names_to="variable")

# 1-epoch plot
p <- ggplot(data=filter(dat_stats, num_epochs==1), 
            aes(x=variable, y=value, shape=as.factor(r))) 
p <- p + geom_point(size=5) + theme_bw() + facet_grid(N_0~m_01)
p <- p + scale_shape_manual(values=c(1, 2))
p <- p + labs(title = "1-Epoch Moments x N_0 (rows) and m_01 (cols)",
                x="Moment", y="Value", shape="r")
p <- p + scale_y_continuous(trans="log10")
p <- p + theme(axis.title=element_text(size=20),
                 axis.text=element_text(size=14),
                 axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
                 legend.position = "bottom")

ggsave("moments++_2_pops_1_epoch.png", p, device="png", width=12, height=12)

# two epochs plot
p <- ggplot(data=filter(dat_stats, num_epochs==2),
            aes(x=variable, y=value, shape=as.factor(r)))
p <- p + geom_point(size=5) + theme_bw() + facet_grid(N_0~m_01)
p <- p + scale_shape_manual(values=c(1, 2))
p <- p + labs(title="2-Epoch Moments x N_0 (rows) and m_01 (cols)",
                x="Moment", y="Value", shape="r")
p <- p + scale_y_continuous(trans="log10")
p <- p + theme(axis.title=element_text(size=20),
                 axis.text=element_text(size=14), 
                 axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
                 legend.position="bottom")

ggsave("moments++_2_pops_2_epochs.png", p, device="png", width=12, height=12)
```

## Comparison with moments.LD 

```{r 2-population-LDx++}

py_moments <- read.csv("moments_LD_2_pops_out.csv") # out from python chunk 

common_moments <- intersect(names(momspp), names(py_moments))
match_moments <- bind_rows(select(momspp, all_of(common_moments)),
                           select(py_moments, all_of(common_moments)))
match_moments$scenario <- rep(seq(1:num_scenarios), 2)
match_moments$method <- c(rep("moments++", num_scenarios),
                          rep("moments.LD", num_scenarios))
full_tbl <- bind_cols(match_moments, 
                      bind_rows(params_2_pop, params_2_pop)) 

dat_matched <- pivot_longer(full_tbl,
                            cols=all_of(common_moments), 
                            names_to="variable")

# all moments/scenarios together
p <- ggplot(data=dat_matched,
            aes(x=variable, y=value, shape=method, color=as.factor(scenario)))
p <- p + geom_point(size=3) + theme_bw()
p <- p + scale_shape_manual(values=c(1, 2))
p <- p + labs(title="2-Pops moments++ vs moments.LD",
              x="Moment", y="Value", shape="Method", color="Scenario")
p <- p + scale_y_continuous(trans="log10")
p <- p + theme(axis.title=element_text(size=20),
               axis.text=element_text(size=14),
               axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1),
               legend.position="bottom")
ggsave("moments++_vs_momentsLD_all_stats_2-pops.png",
       p, device="png", width=12, height=12)

# for each moment
for(i in 1:length(common_moments)) {
  
  mom <- common_moments[i]
  
  p <- ggplot(data=filter(dat_matched, variable==mom),
              aes(x=scenario, y=value, shape=method, color=as.factor(num_epochs)))
  p <- p + geom_point(size=5) + theme_bw()
  p <- p + scale_shape_manual(values=c(1, 2))
  p <- p + scale_y_continuous(trans="log10")
  p <- p + labs(title=paste(mom, "moments++ vs moments.LD (2-pops)", sep=" "),
                x="Scenario", y="Value", shape="Method", color="# epochs")
  p <- p + theme(axis.title=element_text(size=20),
                 axis.text=element_text(size=14),
                 legend.position="bottom")

  ggsave(paste(mom, "_moments++_vs_moments.LD_2-pops.png", sep=""),
         p, device="png", width=12, height=12)
}

# for each scenario
for(i in 1:num_scenarios) {
  
  p <- ggplot(data=filter(dat_matched, scenario==i), 
              aes(x=variable, y=value, shape=method, color=as.factor(num_epochs)))
  p <- p + geom_point(size=5) + theme_bw()
  p <- p + scale_shape_manual(values=c(1, 2))
  p <- p + scale_y_continuous(trans="log10")
  p <- p + labs(title=paste("scenario", i, "(moments++ vs moments.LD)", sep=" "),
                x="Moment", y="Value", shape="Method", color="# epochs")
  p <- p + theme(axis.title=element_text(size=20), 
                 axis.text=element_text(size=14),
                 axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
                 legend.position="bottom")

  ggsave(paste("scenario", i, "moments++_vs_moments.LD_2-pops.png", sep="_"),
         p, device="png", width=12, height=12)
}

# check parameters in scenarios
p <- ggplot(data=filter(dat_matched, r==0),
             aes(x=variable, y=value, shape=method, color=as.factor(scenario))) 
p <- p + geom_point(size=3) + theme_bw() + facet_grid(N_0~m_01)
p <- p + scale_y_continuous(trans="log10")
p <- p + scale_shape_manual(values=c(1, 2))
p <- p + labs(title = "Moments (r == 0) x N_0 (rows) and m_01 (cols)",
              x="Moment", y="Value", shape="Method", color="Scenario")
p <- p + theme(axis.title=element_text(size=20),
               axis.text=element_text(size=14),
               axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
               legend.position="bottom")

ggsave("moments++_vs_moments.LD_2-pops_r!=zero.png",
       p, device="png", width=12, height=12)

p <- ggplot(data=filter(dat_matched, r > 0),
            aes(x=variable, y=value, shape=method, color=as.factor(scenario))) 
p <- p + geom_point(size=3) + theme_bw() + facet_grid(N_0~m_01)
p <- p + scale_y_continuous(trans="log10")
p <- p + scale_shape_manual(values=c(1, 2))
p <- p + labs(title="Moments (r > 0) x N_0 (rows) and m_01 (cols)",
              x="Moment", y="Value", shape="Method", color="Scenario")
p <- p + theme(axis.title=element_text(size=20),
               axis.text=element_text(size=14), 
               axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
               legend.position="bottom")

ggsave("moments++_vs_moments.LD_2-pops_r=zero.png",
       p, device="png", width=12, height=12)

p <- ggplot(data=filter(dat_matched, num_epochs==1),
            aes(x=variable, y=value, shape=method, color=as.factor(scenario))) 
p <- p + geom_point(size=3) + theme_bw() + facet_grid(N_0~m_01)
p <- p + scale_y_continuous(trans="log10")
p <- p + scale_shape_manual(values=c(1, 2))
p <- p + labs(title="Moments (1-epoch) x N_0 (rows) and m_01 (cols)",
              x="Moment", y="Value", shape="Method", color="Scenario")
p <- p + theme(axis.title=element_text(size=20),
               axis.text=element_text(size=14),
               axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
               legend.position="bottom")

ggsave("moments++_vs_moments.LD_2-pops_1-epoch.png",
       p, device="png", width=12, height=12)

p <- ggplot(data=filter(dat_matched, num_epochs==2),
            aes(x=variable, y=value, shape=method, color=as.factor(scenario))) 
p <- p + geom_point(size=3) + theme_bw() + facet_grid(N_0~m_01)
p <- p + scale_y_continuous(trans="log10")
p <- p + scale_shape_manual(values=c(1, 2))
p <- p + labs(title="Moments (2-epochs) x N_0 (rows) and m_01 (cols)",
              x="Moment", y="Value", shape="Method", color="Scenario")
p <- p + theme(axis.title=element_text(size=20),
               axis.text=element_text(size=14),
               axis.text.x=element_text(angle=90, vjust=0.5, hjust=1),
               legend.position="bottom")

ggsave("moments++_vs_moments.LD_2-pops_2-epochs.png", 
       p, device="png", width=12, height=12)
```
