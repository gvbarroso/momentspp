---
title: "Benchmarking Moments++"
author: "Gustavo V. Barroso"
date: "`r Sys.Date()`"
output:
  pdf_document:
  toc: true
number_sections: true
toc_depth: 3
---
  
```{r setup, include=F, message=F, warning=F}

knitr::opts_chunk$set(echo=TRUE)

library(tidyverse)
library(cowplot)
library(stringr)
library(RColorBrewer)
library(scales)
library(plotly)

library(reticulate)
use_python("/usr/bin/python3")

scale.4d <- function(x) sprintf("%.4f", x)

knitr::opts_knit$set(root.dir="~/Devel/momentspp/benchmarking/")
```

This is an empty python chunk.
Apparently this must exist in order for reticulate to be able to read
R data frames in future python chunks.

```{python}
```

# Neutrality

## No-migration

### Building Demes files

```{r, demes-neutral-2-pop, include=F, eval=T, results=F, message=F, warning=F}

N1 <- 10000
N2 <- c(N1, N1 / 10)
u <- 1e-7
s <- 0
r  <- c(1e-4, 1e-5, 1e-6, 1e-7, 0)
split_time <- c(500, 2000)

params <- crossing(N1, N2, u, r, s, split_time)
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

write.csv(params, "neutrality/no_migration/params.csv", quote=F, row.names=F)

Sys.setenv(num_models=n_models)

py$params <- params # stores df to be used in python sections
py$n_models <- as.integer(n_models + 1) # because python is indexed from zero

# writes files in strict Demes format (no metadata)
for(i in 1:n_models) {
  
  name <- paste("model_", i, sep="")
  sink(paste("neutrality/no_migration/", name, "_demes.yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(params$split_time[i])
  cat("\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: A\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: B\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N2[i])
  cat("\n")
  
  sink()
}

# writes files with enriched metadata, moments++ can parse it
for(i in 1:n_models) {
  
  name <- paste("model_", i, sep="")
  sink(paste("neutrality/no_migration/", name, ".yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(params$split_time[i])
  cat("\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: A\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: B\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N2[i])
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$u[i])
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$r[i])
  cat("]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [0]\n")
  
  sink()
}

```

### Running moments++

```{bash run-moments++, engine.opts='-i', include=F, eval=T, results=F, message=F, warning=F}

source ~/.bashrc

cd neutrality/no_migration

for((i=1;i<=$num_models;i++))
do
  momentspp params=opt.bpp FILE=model_$i.yaml LABEL=model_$i ORDER=1
done

cd ../..
```

### Running moments.LD

```{python run-momentsLD, include=F, eval=T, results=F}

import moments.LD
import demes
import sys, os
import numpy as np

def simulate_ld(f, sampled_demes, u, r):
    g = demes.load(f)
    y = moments.LD.LDstats.from_demes(g, sampled_demes, r=r, u=u)
    return y
  
def write_column(y, out_file):
    mld, mh = moments.LD.Util.moment_names(y.num_pops)
    # write D2
    for m, v in zip(mld, y[0]):
        if m.split("_")[0] == "DD":
            out_file.write(str(v) + "\n")
    # write Dz
    for m, v in zip(mld, y[0]):
        if m.split("_")[0] == "Dz":
            out_file.write(str(v) + "\n")
    # write H
    for m, v in zip(mh, y[-1]):
        out_file.write(str(v) + "\n")
    # write pi2
    for m, v in zip(mld, y[0]):
        if m.split("_")[0] == "pi2":
            out_file.write(str(v) + "\n")

for i in range(1, n_models):
  with open(f"neutrality/no_migration/moments_LD_model_{i}.csv", "w+") as fout:
      f = f"neutrality/no_migration/model_{i}_demes.yaml"
      pops = ["A", "B"]
      u = params["u"][i - 1] # python is indexed from zero
      r = params["r"][i - 1] # python is indexed from zero
      y = simulate_ld(f, pops, u, r)
      stats = moments.LD.Util.moment_names(len(pops))
      l = ",".join(stats[0] + stats[1]) + "\n"
      fout.write(l)
      l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
      fout.write(l)
```

### Plots

```{r neutral-bench, include=T, eval=T, results=F, message=F, warning=F}

core_stats <- c("DD_1_1", 
                "DD_1_2", 
                "DD_2_2",
                "Dr_1_1_(1-2p1)^1",
                "Dr_1_1_(1-2p2)^1",
                "Dr_1_2_(1-2p2)^1",
                "Dr_2_1_(1-2p1)^1", 
                "Dr_2_1_(1-2p2)^1",
                "Dr_2_2_(1-2p2)^1",
                "pi2_1_1_1_1", 
                "pi2_1_1_1_2",
                "pi2_1_1_2_2", 
                "pi2_1_2_1_2", 
                "pi2_1_2_2_2", 
                "pi2_2_2_2_2",
                "Hl_1_1", 
                "Hl_1_2",
                "Hl_2_2")

# constant Ne
mpp <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("neutrality/no_migration/model_", i, "_expectations.txt", sep=""))
  vals <- subset(vals, V1 %in% core_stats)
  vals <- slice(vals, 1:9, 13:18, 10:12) # to match moments.LD output and plot
  mpp <- c(mpp, vals$V3)
}

tbl <- as.data.frame(mpp)
tbl$stats <- core_stats
scenario <- NULL
for(i in 1:n_models) { 
  scenario <- c(scenario, rep(i, length(core_stats)))
}
tbl$scenario <- scenario

mLD <- numeric()
for(i in 1:n_models) {
  vals <- as.numeric(read.csv(paste("neutrality/no_migration/moments_LD_model_", i, ".csv", sep=""), header=T))
  mLD <- c(mLD, vals)
}

tbl$mLD <- mLD
tbl <- select(tbl, scenario, stats, mpp, mLD)
tbl$ratio <- tbl$mpp / tbl$mLD

molten_tbl <- pivot_longer(tbl, cols=starts_with("m"))

p1 <- ggplot(data=molten_tbl, aes(x=stats, y=ratio, shape=as.factor(scenario)))
p1 <- p1 + geom_point(size=3) + theme_bw()
p1 <- p1 + geom_hline(yintercept=0.99, linetype=2)
p1 <- p1 + geom_hline(yintercept=1.01, linetype=2)
p1 <- p1 + labs(title="++ / LD", x="Moment", y="Ratio", shape="Model")
p1 <- p1 + scale_shape_manual(values=(0:(n_models - 1)))
p1 <- p1 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")

save_plot("neutrality/no_migration/ratios_no-mig.pdf", p1, base_height=12, base_width=12)
```

## Migration (TODO)


# Selection 1-population

### Building Demes files

```{r, demes-selected-1-pop, include=F, eval=T, results=F, message=F, warning=F}

N <- c(1000, 10000, 20000)
u <- 1e-7
r  <- c(1e-3, 1e-4, 1e-5, 1e-6, 1e-7)
s <- c(0, -1e-5, -1e-04, -1e-3)

params <- crossing(N, u, r, s)
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

write.csv(params, "selection/single-pop/params.csv", quote=F, row.names=F)

Sys.setenv(num_models=n_models)

py$params <- params # stores df to be used in python sections
py$n_models <- as.integer(n_models + 1) # because python is indexed from zero

for(i in 1:n_models) {
  
  name <- paste("model_", i, sep="")
  sink(paste("selection/single-pop/", name, ".yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N[i])
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$u[i])
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$r[i])
  cat("]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$s[i])
  cat("]\n")
  
  sink()
}

```

### Running TwoLocusSim

```{bash run-twoLocusSim, engine.opts='-i', include=F, eval=T, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/single-pop

sed 1d params.csv | while IFS=, read -r N u r s m
do
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_1 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_2 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_3 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_4 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_5 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_6 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_7 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_8 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_9 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_10
done

cd ../..

```

### Running moments++

```{bash run-moments++-1-pop, engine.opts='-i', include=F, eval=T, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/single-pop

for((i=1;i<=$num_models;i++))
do
  momentspp params=opt.bpp FILE=model_$i.yaml LABEL=model_$i ORDER=25
done

cd ../..
```

### Running moments.TwoLocus

For benchmarking the single population case, we use equilibrium demography:

```{python run-momentsTwoLocus, include=F, eval=T, results=F}

import moments.TwoLocus
import sys, os
import numpy as np
    
for i in range(1, n_models):
  with open(f"selection/single-pop/moments_twoLocus_n40_model_{i}.csv", "w+") as fout:
      n_samples = 40
      
     # i - 1 because python is indexed from zero
      Ne = params["N"][i - 1] 
      u = params["u"][i - 1] 
      r = params["r"][i - 1] 
      s = params["s"][i - 1]
      
      gammas = [2 * Ne * s, 2 * Ne * s, 0] # sel on [AB, Ab, aB] haplotypes, resp
      rho = 4 * Ne * r
      theta = 4 * Ne * u
      
      F = moments.TwoLocus.Demographics.equilibrium(n_samples, 
                                                    rho=rho, 
                                                    theta=theta, 
                                                    sel_params=gammas)
        
      fs = moments.Spectrum(moments.LinearSystem_1D.steady_state_1D(n_samples, gamma=2 * Ne * s) * theta)    
      fs_left = moments.Spectrum(F[0, :, 0])
      fs_right = moments.Spectrum(F[0, 0, :])
      
      fout.write(f"D^2 = {F.D2():}\n")
      fout.write(f"Dz = {F.Dz():}\n")
      fout.write(f"Hl = {fs_left.pi()}\n")
      fout.write(f"Hr = {fs_right.pi()}\n")
      fout.write(f"pi2 = {F.pi2():}\n")
      
      assert np.allclose(fs_left, fs)

for i in range(1, n_models):
  with open(f"selection/single-pop/moments_twoLocus_n60_model_{i}.csv", "w+") as fout:
      n_samples = 60
      
      # i - 1 because python is indexed from zero
      Ne = params["N"][i - 1] 
      u = params["u"][i - 1] 
      r = params["r"][i - 1] 
      s = params["s"][i - 1]
      
      gammas = [2 * Ne * s, 2 * Ne * s, 0] # sel on [AB, Ab, aB] haplotypes, resp
      rho = 4 * Ne * r
      theta = 4 * Ne * u
      
      F = moments.TwoLocus.Demographics.equilibrium(n_samples, 
                                                    rho=rho, 
                                                    theta=theta, 
                                                    sel_params=gammas)
        
      fs = moments.Spectrum(moments.LinearSystem_1D.steady_state_1D(n_samples, gamma=2 * Ne * s) * theta)    
      fs_left = moments.Spectrum(F[0, :, 0])
      fs_right = moments.Spectrum(F[0, 0, :])
      
      fout.write(f"D^2 = {F.D2():}\n")
      fout.write(f"Dz = {F.Dz():}\n")
      fout.write(f"Hl = {fs_left.pi()}\n")
      fout.write(f"Hr = {fs_right.pi()}\n")
      fout.write(f"pi2 = {F.pi2():}\n")
      
      assert np.allclose(fs_left, fs)
```

### Plots

```{r, plots-selected-1-pop, include=T, eval=T, results=F, message=F, warning=F}

commom_stats <- c("DD_0_0",
                  "Dr_0_0_(1-2p0)^1",
                  "Hl_0_0", 
                  "Hr_0_0",
                  "pi2_0_0_0_0")

expectation <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("selection/single-pop/model_", i, "_expectations.txt", sep=""))
  vals <- subset(vals, V1 %in% commom_stats)$V3
  expectation <- c(expectation, vals)
}

tbl <- as.data.frame(expectation)
tbl$stats <- commom_stats
scenario <- NULL
for(i in 1:n_models) { 
  scenario <- c(scenario, rep(i, length(commom_stats)))
}
tbl$scenario <- scenario

mpp <- full_join(tbl, params, by="scenario")
mpp$alpha <- 2 * mpp$s * mpp$N

# moments.TwoLocus was fitted with 2 sample sizes, n=40 and n=60

# n = 40
expectation <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("selection/single-pop/moments_twoLocus_n40_model_", i, ".csv", sep=""))$V3
  expectation <- c(expectation, vals)
}

tbl_py_n40 <- as.data.frame(expectation)
tbl_py_n40$stats <- commom_stats
tbl_py_n40$scenario <- scenario
tbl_py_n40$sample_size <- 40
tbl_py_n40 <- full_join(tbl_py_n40, params, by="scenario")

# from 2p(1-p) to p(1-p)
tbl_py_n40[tbl_py_n40$stats=="Hl_0_0", 1] <- tbl_py_n40[tbl_py_n40$stats=="Hl_0_0", 1] / 2
tbl_py_n40[tbl_py_n40$stats=="Hr_0_0", 1] <- tbl_py_n40[tbl_py_n40$stats=="Hr_0_0", 1] / 2

# n = 60
expectation <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("selection/single-pop/moments_twoLocus_n60_model_", i, ".csv", sep=""))$V3
  expectation <- c(expectation, vals)
}

tbl_py_n60 <- as.data.frame(expectation)
tbl_py_n60$stats <- commom_stats
tbl_py_n60$scenario <- scenario
tbl_py_n60$sample_size <- 60
tbl_py_n60 <- full_join(tbl_py_n60, params, by="scenario")

# from 2p(1-p) to p(1-p)
tbl_py_n60[tbl_py_n60$stats=="Hl_0_0", 1] <- tbl_py_n60[tbl_py_n60$stats=="Hl_0_0", 1] / 2
tbl_py_n60[tbl_py_n60$stats=="Hr_0_0", 1] <- tbl_py_n60[tbl_py_n60$stats=="Hr_0_0", 1] / 2

tbl_py_ns <- bind_rows(tbl_py_n40, tbl_py_n60)
tbl_pp <- bind_rows(mpp, mpp)

tbl_pp <- tbl_pp %>% mutate(ratio = expectation / tbl_py_ns$expectation)
tbl_pp$sample_size <- tbl_py_ns$sample_size
  
p1 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[1],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p1 <- p1 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p1 <- p1 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p1 <- p1 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p1 <- p1 + labs(title=NULL, x=NULL, y=expression(D^2))
p1 <- p1 + geom_hline(yintercept=1, linetype="dashed", color="red")
p1 <- p1 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 legend.position="none")
p1

p2 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[2],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p2 <- p2 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p2 <- p2 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p2 <- p2 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p2 <- p2 + labs(title=NULL, x=NULL, y=expression(Dz))
p2 <- p2 + geom_hline(yintercept=1, linetype="dashed", color="red")
p2 <- p2 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x = element_blank(),
                 legend.position="none")
p2

p3 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[3],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p3 <- p3 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p3 <- p3 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p3 <- p3 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p3 <- p3 + labs(title=NULL, x=NULL, y=expression(H[l]))
p3 <- p3 + geom_hline(yintercept=1, linetype="dashed", color="red")
p3 <- p3 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x = element_blank(),
                 legend.position="none")
p3

p4 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[4],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p4 <- p4 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p4 <- p4 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p4 <- p4 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p4 <- p4 + labs(title=NULL, x=NULL, y=expression(H[r]))
p4 <- p4 + geom_hline(yintercept=1, linetype="dashed", color="red")
p4 <- p4 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x = element_blank(),
                 legend.position="none")
p4

p5 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[5],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size))) 
p5 <- p5 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p5 <- p5 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p5 <- p5 + scale_x_log10(breaks = r) + scale_y_continuous(breaks=pretty_breaks(), labels = scale.4d)
p5 <- p5 + labs(title=NULL, x="r", y=expression(pi[2]))
p5 <- p5 + geom_hline(yintercept=1, linetype="dashed", color="red")
p5 <- p5 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 strip.text.x = element_blank(),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p5

moms_comp_ratios <- plot_grid(p1, p2, p3, p4, p5, ncol=1, rel_heights=c(1, 1, 1, 1, 1.85))
save_plot("selection/single-pop/moms_++_vs_py_ratios.pdf", moms_comp_ratios, base_height=10, base_width=20)

# focusing on lower recombination rates to zoom in (exclude moments.TwoLocus outliers)
tbl_pp <- tbl_pp[tbl_pp$r < 1e-3,]
  
p1 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[1],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p1 <- p1 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p1 <- p1 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p1 <- p1 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p1 <- p1 + labs(title=NULL, x=NULL, y=expression(D^2))
p1 <- p1 + geom_hline(yintercept=1, linetype="dashed", color="red")
p1 <- p1 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 legend.position="none")
p1

p2 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[2],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p2 <- p2 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p2 <- p2 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p2 <- p2 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p2 <- p2 + labs(title=NULL, x=NULL, y=expression(Dz))
p2 <- p2 + geom_hline(yintercept=1, linetype="dashed", color="red")
p2 <- p2 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x = element_blank(),
                 legend.position="none")
p2

p3 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[3],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p3 <- p3 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p3 <- p3 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p3 <- p3 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p3 <- p3 + labs(title=NULL, x=NULL, y=expression(H[l]))
p3 <- p3 + geom_hline(yintercept=1, linetype="dashed", color="red")
p3 <- p3 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x = element_blank(),
                 legend.position="none")
p3

p4 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[4],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p4 <- p4 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p4 <- p4 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p4 <- p4 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p4 <- p4 + labs(title=NULL, x=NULL, y=expression(H[r]))
p4 <- p4 + geom_hline(yintercept=1, linetype="dashed", color="red")
p4 <- p4 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x = element_blank(),
                 legend.position="none")
p4

p5 <- ggplot(data=tbl_pp[tbl_pp$stats==commom_stats[5],], aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size))) 
p5 <- p5 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p5 <- p5 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p5 <- p5 + scale_x_log10(breaks = r) + scale_y_continuous(breaks=pretty_breaks(), labels = scale.4d)
p5 <- p5 + labs(title=NULL, x="r", y=expression(pi[2]))
p5 <- p5 + geom_hline(yintercept=1, linetype="dashed", color="red")
p5 <- p5 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 strip.text.x = element_blank(),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p5

moms_comp_ratios <- plot_grid(p1, p2, p3, p4, p5, ncol=1, rel_heights=c(1, 1, 1, 1, 1.85))
save_plot("selection/single-pop/moms_++_vs_py_ratios_low_rec.pdf", moms_comp_ratios, base_height=10, base_width=20)

# appending two-locus simulations (performed w/ twoLocusSim binary from momentspp)
n_reps <- 10
twoLocusSim <- numeric()
for(i in 1:n_models) {
  rp <- numeric()
  for(j in 1:n_reps) {
    vals <- read.table(paste("selection/single-pop/tls_", i, "_rep_", j, ".txt", sep=""))$V3
    rp <- c(rp, vals)
  }
  twoLocusSim <- c(twoLocusSim, rp)
}

tls <- as.data.frame(twoLocusSim)
tls$stats <- commom_stats # not needed, output stats are in same order

reps <- NULL
for(i in 1:n_reps) { 
  reps <- c(reps, rep(i, length(commom_stats)))
}
tls$reps <- reps

scenario <- NULL
for(i in 1:n_models) { 
  scenario <- c(scenario, rep(i, length(commom_stats) * n_reps))
}
tls$scenario <- scenario

df <- cbind.data.frame(mpp, tbl_py_ns$expectation)
names(df)[1] <- "moments++"
names(df)[9] <- "momentsTwoLocus"

df_all <- full_join(df, tls, by=c("stats", "scenario")) 

sd <- df_all %>% group_by(scenario, stats) %>% summarize(sd = sd(twoLocusSim))
rep_means <- df_all %>% group_by(scenario, stats) %>% summarize(avg = mean(twoLocusSim))

df_all <- full_join(df_all, sd, by=c("stats", "scenario")) 
df_all <- full_join(df_all, rep_means, by=c("stats", "scenario")) 
df_m <- pivot_longer(df_all, cols=c("moments++", "momentsTwoLocus", "twoLocusSim"), names_to="Method")

dd <- df_m[df_m$stats==commom_stats[1],]
p6 <- ggplot() + geom_errorbar(data=dd[dd$Method=="twoLocusSim",], aes(x=r, ymax=avg + sd, ymin=avg - sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p6 <- p6 + geom_point(data=dd[dd$Method!="twoLocusSim",], aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p6 <- p6 + scale_shape_manual(values=c(0, 1))
p6 <- p6 + scale_x_log10(breaks = r) + scale_y_log10()
p6 <- p6 + labs(x="r", y=expression(D^2))
p6 <- p6 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 legend.position="none")
p6

summary(dd[dd$Method=="momentsTwoLocus",]$value)
dd[which(dd$value < 0),]

dz <- df_m[df_m$stats==commom_stats[2],]
p7 <- ggplot() + geom_errorbar(data=dz[dz$Method=="twoLocusSim",], aes(x=r, ymax=avg + sd, ymin=avg - sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p7 <- p7 + geom_point(data=dz[dz$Method!="twoLocusSim",], aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p7 <- p7 + scale_shape_manual(values=c(0, 1))
p7 <- p7 + scale_x_log10(breaks = r) + scale_y_log10()
p7 <- p7 + labs(x="r", y=expression(Dz))
p7 <- p7 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x=element_blank(),
                 legend.position="none")
p7

hl <- df_m[df_m$stats==commom_stats[3],]
p8 <- ggplot() + geom_errorbar(data=hl[hl$Method=="twoLocusSim",], aes(x=r, ymax=avg + sd, ymin=avg - sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p8 <- p8 + geom_point(data=hl[hl$Method!="twoLocusSim",], aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p8 <- p8 + scale_shape_manual(values=c(0, 1))
p8 <- p8 + scale_x_log10(breaks=r) + scale_y_log10()
p8 <- p8 + labs(x="r", y=expression(H[l]))
p8 <- p8 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x=element_blank(),
                 legend.position="none")
p8

hr <- df_m[df_m$stats==commom_stats[4],]
p9 <- ggplot() + geom_errorbar(data=hr[hr$Method=="twoLocusSim",], aes(x=r, ymax=avg + sd, ymin=avg - sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p9 <- p9 + geom_point(data=hr[hr$Method!="twoLocusSim",], aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p9 <- p9 + scale_shape_manual(values=c(0, 1))
p9 <- p9 + scale_x_log10(breaks=r) + scale_y_log10()
p9 <- p9 + labs(x="r", y=expression(H[l]))
p9 <- p9 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x=element_blank(),
                 legend.position="none")
p9

pi2 <- df_m[df_m$stats==commom_stats[5],]
p10 <- ggplot() + geom_errorbar(data=pi2[pi2$Method=="twoLocusSim",], aes(x=r, ymax=avg + sd, ymin=avg - sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p10 <- p10 + geom_point(data=pi2[pi2$Method!="twoLocusSim",], aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p10 <- p10 + scale_shape_manual(values=c(0, 1))
p10 <- p10 + scale_x_log10(breaks=r) + scale_y_log10()
p10 <- p10 + labs(x="r", y=expression(pi[2]))
p10 <- p10 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 strip.text.x=element_blank(),
                 legend.position="bottom")
p10

moms_comp_vals <- plot_grid(p6, p7, p8, p9, p10, ncol=1, rel_heights=c(1.15, 1, 1, 1, 1.85))
save_plot("selection/single-pop/moms_++_vs_py_expect.pdf", moms_comp_vals, base_height=10, base_width=20)
```



# Selection 2-populations

## No-migration

### Building Demes files

```{r, demes-selected-2-pop, include=F, eval=T, results=F, message=F, warning=F}

N1 <- 10000
N2 <- c(N1, N1 / 10)
u <- 1e-7
r  <- c(1e-4, 1e-5, 1e-6, 1e-7, 0)
s1 <- c(0, -5e-05, -1e-04, -2.5e-04, -5e-04, -1e-3)
s2 <- c(0, -5e-05, -1e-04, -2.5e-04, -5e-04, -1e-3)
sanc <- c(0, -1/2/N1)
split_time <- 2000 #c(400, 2000)

params <- crossing(N1, N2, u, r, s1, s2, sanc, split_time)
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

write.csv(params, "selection/no_migration//params.csv", quote=F, row.names=F)

Sys.setenv(num_models=n_models)

py$params <- params # stores df to be used in python sections
py$n_models <- as.integer(n_models + 1) # because python is indexed from zero

for(i in 1:n_models) {
  
  name <- paste("model_", i, sep="")
  sink(paste("selection/no_migration/", name, ".yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(split_time)
  cat("\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: A\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: B\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N2[i])
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$u[i])
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$r[i])
  cat("]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(params$split_time[i])
  cat("\n")
  cat("        rates: [")
  cat(params$sanc[i])
  cat("]\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$s1[i])
  cat(", ")
  cat(params$s2[i])
  cat("]\n")
  
  sink()
}

```

### Running moments++

```{bash run-moments++-2-pops, engine.opts='-i', include=F, eval=T, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/no_migration

for((i=1;i<=$num_models;i++))
do
  momentspp params=opt.bpp FILE=model_$i.yaml LABEL=model_$i ORDER=25
done

cd ../..
```

### Plots

```{r, plots-selected-2-pop, include=T, eval=T, results=F, message=F, warning=F}

core_stats <- c("DD_1_1", 
                "DD_1_2", 
                "DD_2_2",
                "Dr_1_1_(1-2p1)^1",
                "Dr_1_1_(1-2p2)^1",
                "Dr_1_2_(1-2p2)^1",
                "Dr_2_1_(1-2p1)^1", 
                "Dr_2_1_(1-2p2)^1",
                "Dr_2_2_(1-2p2)^1",
                "Hl_1_1", 
                "Hl_1_2",
                "Hl_2_1",
                "Hl_2_2",
                "Hr_1_1", 
                "Hr_1_2",
                "Hr_2_2",
                "pi2_1_1_1_1", 
                "pi2_1_1_1_2",
                "pi2_1_1_2_2", 
                "pi2_1_2_1_2", 
                "pi2_1_2_2_2", 
                "pi2_2_1_1_2", 
                "pi2_2_2_1_1",
                "pi2_2_2_2_2")

# to be on the very safe side...
core_stats <- sort(core_stats)

expectation <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("selection/no_migration/model_", i, "_expectations.txt", sep=""))
  vals <- subset(vals, V1 %in% core_stats)
  expectation <- c(expectation, vals$V3)
}

tbl <- as.data.frame(expectation)
tbl$stats <- core_stats
scenario <- NULL
for(i in 1:n_models) { 
  scenario <- c(scenario, rep(i, length(core_stats)))
}
tbl$scenario <- scenario

df <- full_join(tbl, params, by="scenario")

# transforms variables
df$alpha_1 <- 2 * df$s1 * df$N1
df$alpha_2 <- 2 * df$s2 * df$N2

# symmetric population sizes
df_sym_N <- df[df$N1==df$N2,]
df_sym_N[df_sym_N$r==0,]$r <- 1e-12 # for log transformation

# pi2 within
pa1 <- ggplot(data=subset(filter(df_sym_N, stats %in% c("pi2_1_1_1_1", "pi2_2_2_2_2")), sanc == 0), aes(x=r, y=expectation, color=stats)) 
pa1 <- pa1 + geom_point(size=3, shape=0) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pa1 <- pa1 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pa1 <- pa1 + scale_y_log10(breaks=c(1e-6, 2e-6, 3e-6, 4e-6, 5e-6))
pa1 <- pa1 + scale_shape_manual(values=c(0))
pa1 <- pa1 + scale_color_brewer(palette = "Dark2")
pa1 <- pa1 + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pa1 <- pa1 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pa1
save_plot("selection/no_migration/pi2_within_no-mig.pdf", pa1, base_height=12, base_width=12)

# pi2 cross-pop
pa2 <- ggplot(data=subset(filter(df_sym_N, stats %in% c("pi2_1_1_1_2", "pi2_1_1_2_2", "pi2_1_2_1_2", "pi2_2_1_1_2", "pi2_1_2_2_2", "pi2_2_2_1_1")), sanc == 0),
              aes(x=r, y=expectation, color=stats)) 
pa2 <- pa2 + geom_point(size=3, shape=0) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pa2 <- pa2 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pa2 <- pa2 + scale_y_log10(breaks=c(1e-6, 2e-6, 3e-6, 4e-6, 5e-6, 1e-5))
pa2 <- pa2 + scale_color_brewer(palette = "Dark2")
pa2 <- pa2 + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pa2 <- pa2 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pa2
save_plot("selection/no_migration/pi2_cross_no-mig.pdf", pa2, base_height=12, base_width=12)

# Dr
pb <- ggplot(data=subset(filter(df_sym_N, str_detect(stats, "^Dr")), sanc == 0), aes(x=r, y=expectation, color=stats)) 
pb <- pb + geom_point(size=3, shape=0) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pb <- pb + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pb <- pb + scale_color_brewer(palette = "Dark2")
pb <- pb + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pb <- pb + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pb
save_plot("selection/no_migration/Dr_no-mig.pdf", pd, base_height=12, base_width=12)

# Hets
pc <- ggplot(data=subset(filter(df_sym_N, str_detect(stats, "^H")), sanc == 0), aes(x=r, y=expectation, color=stats)) 
pc <- pc + geom_point(size=3, shape=0) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pc <- pc + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pc <- pc + scale_y_log10(breaks=pretty_breaks())
pc <- pc + scale_color_brewer(palette = "Dark2")
pc <- pc + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pc <- pc + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pc
save_plot("selection/no_migration/Hets_no-mig.pdf", pd, base_height=12, base_width=12)

# Hr
pd <- ggplot(data=filter(df_sym_N, stats %in% c("Hr_1_1", "Hr_2_2")), aes(x=r, y=expectation, color=stats, shape=as.factor(sanc))) 
pd <- pd + geom_point(size=3) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pd <- pd + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pd <- pd + scale_y_log10(breaks=pretty_breaks())
pd <- pd + scale_color_brewer(palette = "Dark2")
pd <- pd + scale_shape_manual(values=c(0, 1))
pd <- pd + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pd <- pd + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pd
save_plot("selection/no_migration/Hr_no-mig.pdf", pd, base_height=12, base_width=12)

# Hl
pe <- ggplot(data=subset(filter(df_sym_N, str_detect(stats, "^Hl")), sanc == 0), aes(x=alpha_1, y=expectation, color=stats, shape=as.factor(alpha_2))) 
pe <- pe + geom_point(size=3) + geom_line() + theme_bw() #+ facet_wrap(~alpha_2, nrow=1)
pe <- pe + scale_y_log10(breaks=pretty_breaks())
pe <- pe + scale_color_brewer(palette = "Dark2")
pe <- pe + scale_shape_manual(values=0:length(levels(as.factor(df_sym_N$alpha_2))))
pe <- pe + labs(title="Symmetric Population Sizes", x="alpha_1", y="Expectation")
pe <- pe + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pe
save_plot("selection/no_migration/Hl_no-mig.pdf", pe, base_height=12, base_width=12)

pf <- plot_ly(data=subset(filter(df_sym_N, stats %in% c("Hl_1_2", "Hl_2_1")), sanc == 0), x=~alpha_1, y=~alpha_2, z=~expectation, type="scatter3d", 
              mode="markers", color=~stats)
pf

# D1D2
d1d2 <- filter(df_sym_N, stats %in% "DD_1_2") 
d1d2$ratio <- d1d2$expectation / subset(df_sym_N, stats %in% "pi2_1_2_1_2")$expectation

# save ratio D1D2/ pi2_1212 for later, plot D1D2 expectation now
p1 <- ggplot(data=d1d2, aes(x=r, y=expectation, shape=as.factor(sanc))) + facet_grid(+alpha_1~alpha_2)
p1 <- p1 + geom_point(size=3) + geom_line() + theme_bw()
p1 <- p1 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
p1 <- p1 + scale_y_log10(breaks=c(5e-8, 1e-7, 2e-7, 5e-7, 1e-6))
p1 <- p1 + scale_shape_manual(values=c(0, 1))
p1 <- p1 + labs(title="Symmetric Population Sizes", x="r", y="E[D1D2]")
p1 <- p1 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p1
save_plot("selection/no_migration/Covar_D_no-mig_1.pdf", p1, base_height=12, base_width=12)

d1d2 <- d1d2[d1d2$alpha_1==d1d2$alpha_2,] # symmetric alpha

p2 <- ggplot(data=d1d2, aes(x=alpha_1, y=expectation, color=as.factor(r), shape=as.factor(sanc)))
p2 <- p2 + geom_point(size=3) + geom_line() + theme_bw()
p2 <- p2 + scale_color_brewer(palette="Dark2")
p2 <- p2 + scale_shape_manual(values=c(0, 1))
p2 <- p2 + scale_y_log10(breaks=c(1e-7, 2e-7, 4e-7, 6e-7, 1e-6))
p2 <- p2 + labs(title="Symmetric Population Sizes and Selection coefficients", x="2Ns", y="E[D1D2]")
p2 <- p2 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p2
save_plot("selection/no_migration/Covar_D_no-mig_2.pdf", p2, base_height=12, base_width=12)

# Hr
hr11 <- subset(df_sym_N, stats %in% "Hr_1_1") 

p3 <- ggplot(data=hr11, aes(x=r, y=expectation * 1e+3, color=as.factor(alpha_1), shape=as.factor(sanc)))
p3 <- p3 + geom_point(size=3) + geom_line() + theme_bw()
p3 <- p3 + scale_color_brewer(palette="Dark2")
p3 <- p3 + scale_shape_manual(values=c(0, 1))
p3 <- p3 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4))
p3 <- p3 + scale_y_log10(breaks=pretty_breaks())
p3 <- p3 + labs(title="Symmetric Population Sizes", x="r", y="E[Hr_11] (x 10^-3)")
p3 <- p3 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p3
save_plot("selection/no_migration/Hr_11.pdf", p3, base_height=12, base_width=12)

# Fst at the Left Locus
Hl_12 <- subset(df_sym_N, stats %in% "Hl_1_2")
Hl_21 <- subset(df_sym_N, stats %in% "Hl_2_1")
Hl_11 <- subset(df_sym_N, stats %in% "Hl_1_1")
Hl_22 <- subset(df_sym_N, stats %in% "Hl_2_2")

pi_between <- (Hl_12$expectation + Hl_21$expectation) / 2 
pi_within <- (Hl_11$expectation + Hl_22$expectation) / 2 

fst <- Hl_12 # just to copy the data frame
fst$expectation <- 1 - pi_within / pi_between # we'll be looking at this one

p4 <- plot_ly(data=fst, x=~alpha_1, y=~alpha_2, z=~expectation, type="scatter3d", 
              mode="markers", color=~expectation)
p4

# Fst at the Right Locus
Hr_12 <- subset(df_sym_N, stats %in% "Hr_1_2")
#Hr_21 <- subset(df_sym_N, stats %in% "Hr_2_1")
Hr_11 <- subset(df_sym_N, stats %in% "Hr_1_1")
Hr_22 <- subset(df_sym_N, stats %in% "Hr_2_2")

pi_between <- Hr_12$expectation #(Hr_12$expectation + Hr_21$expectation) / 2 
pi_within <- (Hr_11$expectation + Hr_22$expectation) / 2 

fst <- Hr_12
fst$expectation <- 1 - pi_within / pi_between

p5 <- ggplot(data=fst, aes(x=r, y=expectation, shape=as.factor(sanc))) + facet_grid(+alpha_1~alpha_2)
p5 <- p5 + geom_point(size=3) + geom_line() + theme_bw()
p5 <- p5 + scale_shape_manual(values=c(0, 1))
p5 <- p5 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
p5 <- p5 + scale_y_log10(breaks=pretty_breaks())
p5 <- p5 + labs(title="Symmetric Population Sizes", x="r", y="Fst neutral locus")
p5 <- p5 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")

save_plot("selection/no_migration/Fst_no-mig_right_2.pdf", p5, base_height=12, base_width=12)

fst <- fst[fst$alpha_1==fst$alpha_2,]

p6 <- ggplot(data=fst, aes(x=alpha_1, y=expectation, color=as.factor(r), shape=as.factor(sanc)))
p6 <- p6 + geom_point(size=3) + geom_line() + theme_bw()
p6 <- p6 + scale_color_brewer(palette="Dark2")
p6 <- p6 + scale_shape_manual(values=c(0, 1))
p6 <- p6 + scale_y_log10(breaks=pretty_breaks())
p6 <- p6 + labs(title="Symmetric Population Sizes and Selection coefficients", x="2Ns", y="Fst neutral locus")
p6 <- p6 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p6
save_plot("selection/no_migration/Fst_no-mig_right_1.pdf", p6, base_height=12, base_width=12)

# all population sizes
df_cpy <- df
df_cpy[df_cpy$r==0,]$r <- 1e-12 # for log transformation

# D1D2
d1d2 <- subset(df_cpy, stats %in% "DD_1_2") 
d1d2$ratio <- d1d2$expectation / subset(df_cpy, stats %in% "pi2_1_2_1_2")$expectation
  
p7 <- ggplot(data=d1d2, aes(x=r, y=expectation, color=as.factor(N2), shape=as.factor(sanc))) + facet_grid(+s1~s2)
p7 <- p7 + geom_point(size=3) + geom_line() + theme_bw()
p7 <- p7 + scale_color_brewer(palette="Dark2")
p7 <- p7 + scale_shape_manual(values=c(0, 1))
p7 <- p7 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
p7 <- p7 + scale_y_log10(breaks=c(1e-7, 2e-7, 4e-7, 6e-7, 1e-6))
p7 <- p7 + labs(title="All Population Sizes", x="r", y="E[D1D2]")
p7 <- p7 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p7
save_plot("selection/no_migration/Covar_D_no-mig_3.pdf", p7, base_height=12, base_width=12)

# Fst at the Left Locus
Hl_12 <- subset(df_cpy, stats %in% "Hl_1_2")
Hl_21 <- subset(df_cpy, stats %in% "Hl_2_1")
Hl_11 <- subset(df_cpy, stats %in% "Hl_1_1")
Hl_22 <- subset(df_cpy, stats %in% "Hl_2_2")

pi_between <- (Hl_12$expectation + Hl_21$expectation) / 2 
pi_within <- (Hl_11$expectation + Hl_22$expectation) / 2 

fst <- Hl_12 # just to copy the data frame
fst$expectation <- 1 - pi_within / pi_between # we'll be looking at this one

p8 <- plot_ly(data=fst, x=~s1, y=~s2, z=~expectation, type="scatter3d", mode="markers", color=~N2)
p8
```

## Migration (TODO)

# Check-my-matrix

```{python check-my-matrix, include=F, eval=F, results=F}

import moments.LD
import demes
import csv
import numpy as np

np.set_printoptions(threshold=10000)

def pulse_migration(num_pops, pop0, pop1, f):
    """
    Pulse migration from pop0 into pop1 with proportion f.
    """
    # create the matrix that would build a new population via admixture
    A = moments.LD.Matrices.admix_ld(num_pops, pop0, pop1, f)
    # the last population created replaces pop1
    mom_from = moments.LD.Util.moment_names(num_pops + 1)[0]
    mom_to = moments.LD.Util.moment_names(num_pops)[0]
    P = np.zeros((len(mom_to), len(mom_from)))
    for i, m in enumerate(mom_to):
        l = m.split("_")
        for k in range(1, len(l)):
            if l[k] == str(pop1):
                l[k] = str(num_pops)
        m_from = "_".join(l)
        m_from = moments.LD.Util.map_moment(m_from)
        j = mom_from.index(m_from)
        P[i, j] = 1
    return P.dot(A)

# some hard coding never hurt anyone...  
mat_LD = pulse_migration(3, 0, 1, 0.3)
matpp = np.loadtxt('multi_epoch/model_2_e_6_admix.csv', delimiter=",")

print(((matpp - mat_LD)).sum())
print(((matpp - mat_LD)**2).sum())

mat_LD = pulse_migration(4, 0, 3, 0.2)
matpp = np.loadtxt('multi_epoch/model_3_e_5_admix.csv', delimiter=",")
print(((matpp - mat_LD)).sum())
print(((matpp - mat_LD)**2).sum())

for i in range(len(mat_LD)):
    if np.abs(mat_LD[i] - matpp[i]).sum() > 1e-15:
        print(i, moments.LD.Util.moment_names(4)[0][i], np.abs(mat_LD[i] - matpp[i]).sum())
        print(mat_LD[i])
        print(matpp[i])

mat_LD = pulse_migration(5, 2, 4, 0.5)
matpp = np.loadtxt('multi_epoch/model_15_e_9_admix.csv', delimiter=",")
print(((matpp - mat_LD)).sum())
print(((matpp - mat_LD)**2).sum())

for i in range(len(mat_LD)):
    if np.abs(mat_LD[i] - matpp[i]).sum() > 1e-15:
        print(i, moments.LD.Util.moment_names(5)[0][i], np.abs(mat_LD[i] - matpp[i]).sum())
        print(mat_LD[i])
        print(matpp[i])

mig_mat = [ 
        [0, 1e-4, 0],
        [0, 0, 0],
        [0, 0, 0]
        ]

matpp = np.loadtxt('multi_epoch/model_2_e_5_mig.csv', delimiter=",")
mat_LD = moments.LD.Matrices.migration_ld(3, 2 * mig_mat).todense()
#print(matpp - mat_LD)
print(((matpp - mat_LD)).sum())
print(((matpp - mat_LD)**2).sum())

for i in range(len(mat_LD)):
    if np.abs(mat_LD[i] - matpp[i]).sum() > 1e-15:
        print(i, moments.LD.Util.moment_names(5)[0][i], np.abs(mat_LD[i] - matpp[i]).sum())
        print(mat_LD[i])
        print(matpp[i])

mig_mat = [ 
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 1e-4, 0, 0]
        ]

matpp = np.loadtxt('multi_epoch/model_15_e_10_mig.csv', delimiter=",")
mat_LD = moments.LD.Matrices.migration_ld(5, 2 * mig_mat).todense()
#print(matpp - mat_LD)
print(((matpp - mat_LD)).sum())
print(((matpp - mat_LD)**2).sum())

for i in range(len(mat_LD)):
    if np.abs(mat_LD[i] - matpp[i]).sum() > 1e-15:
        print(i, moments.LD.Util.moment_names(5)[0][i], np.abs(mat_LD[i] - matpp[i]).sum())
        print(mat_LD[i])
        print(matpp[i])
```

