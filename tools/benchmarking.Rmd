---
title: "Benchmarking Moments++"
author: "Gustavo V. Barroso"
date: "`r Sys.Date()`"
output:
  pdf_document:
  toc: true
number_sections: true
toc_depth: 3
---
  
```{r setup, include=F, message=F, warning=F}

knitr::opts_chunk$set(echo=TRUE)

library(tidyverse)
library(cowplot)
library(stringr)
library(RColorBrewer)
library(scales)
library(plotly)
library(MASS)
library(lmtest)
library(nlme)
library(car)
library(bigsnpr)
library(data.table)
library(GenomicRanges)
library(pracma)

library(reticulate)
use_python("/usr/bin/python3")

scale.4d <- function(x) sprintf("%.4f", x)

knitr::opts_knit$set(root.dir="~/Devel/momentspp/benchmarking/")
```

This is an empty python chunk.
Apparently this must exist in order for reticulate to be able to read
R data frames in future python chunks.

```{python}
```

This creates the directories

```{bash run-moments++, engine.opts='-i', include=F, eval=F, results=F, message=F, warning=F}

source ~/.bashrc

mkdir neutrality
mkdir selection

cd neutrality
mkdir migration
mkdir no_migration

cd ../selection
mkdir migration
mkdir no_migration
mkdir single-pop

cd single-pop
mkdir bench
mkdir simple_bgs
mkdir landscapes

cd simple_bgs
mkdir mult_neutral
mkdir single_neutral
mkdir single_neutral_single_selected

cd ../../../
find -type d -exec cp opt.bpp {} \;
cp sim_sel.bpp selection/single-pop/bench
```

# Neutrality

Here we benchmark moments++ against moments.LD when s=0

## No-migration

### Building Demes files

```{r, demes-neutral-2-pop, include=F, eval=F, results=F, message=F, warning=F}

# parameters
N1 <- 10000
N2 <- c(N1, N1 / 10)
u <- 1e-7
s <- 0
r  <- c(1e-4, 1e-5, 1e-6, 1e-7, 0)
split_time <- c(500, 2000)

params <- crossing(N1, N2, u, r, s, split_time)
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

write.csv(params, "neutrality/no_migration/params.csv", quote=F, row.names=F)

Sys.setenv(num_models=n_models)

py$params <- params # stores df to be used in python sections
py$n_models <- as.integer(n_models + 1) # because python is indexed from zero

# writes files in strict Demes format (no metadata)
for(i in 1:n_models) {
  
  name <- paste("model_", i, sep="")
  sink(paste("neutrality/no_migration/", name, "_demes.yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(params$split_time[i])
  cat("\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: A\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: B\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N2[i])
  cat("\n")
  
  sink()
}

# writes files with enriched metadata, moments++ can parse it
for(i in 1:n_models) {
  
  name <- paste("model_", i, sep="")
  sink(paste("neutrality/no_migration/", name, ".yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(params$split_time[i])
  cat("\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: A\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: B\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N2[i])
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$u[i])
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$r[i])
  cat("]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [0]\n")
  
  sink()
}

```

### Running moments++

```{bash create-dirs, engine.opts='-i', include=F, eval=F, results=F, message=F, warning=F}

source ~/.bashrc

cd neutrality/no_migration

for((i=1;i<=$num_models;i++))
do
  momentspp params=opt.bpp F=model_$i.yaml O=1
done

cd ../..
```

### Running moments.LD

```{python run-momentsLD, include=F, eval=F, results=F}

import moments.LD
import demes
import sys, os
import numpy as np

def simulate_ld(f, sampled_demes, u, r):
    g = demes.load(f)
    y = moments.LD.LDstats.from_demes(g, sampled_demes, r=r, u=u)
    return y
  
def write_column(y, out_file):
    mld, mh = moments.LD.Util.moment_names(y.num_pops)
    # write D2
    for m, v in zip(mld, y[0]):
        if m.split("_")[0] == "DD":
            out_file.write(str(v) + "\n")
    # write Dz
    for m, v in zip(mld, y[0]):
        if m.split("_")[0] == "Dz":
            out_file.write(str(v) + "\n")
    # write H
    for m, v in zip(mh, y[-1]):
        out_file.write(str(v) + "\n")
    # write pi2
    for m, v in zip(mld, y[0]):
        if m.split("_")[0] == "pi2":
            out_file.write(str(v) + "\n")

for i in range(1, n_models):
  with open(f"neutrality/no_migration/moments_LD_model_{i}.csv", "w+") as fout:
      f = f"neutrality/no_migration/model_{i}_demes.yaml"
      pops = ["A", "B"]
      u = params["u"][i - 1] # python is indexed from zero
      r = params["r"][i - 1] # python is indexed from zero
      y = simulate_ld(f, pops, u, r)
      stats = moments.LD.Util.moment_names(len(pops))
      l = ",".join(stats[0] + stats[1]) + "\n"
      fout.write(l)
      l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
      fout.write(l)
```

### Plots

```{r neutral-bench, include=T, eval=T, results=F, message=F, warning=F}

core_stats <- c("DD_1_1", 
                "DD_1_2", 
                "DD_2_2",
                "Dr_1_1_(1-2p1)^1",
                "Dr_1_1_(1-2p2)^1",
                "Dr_1_2_(1-2p2)^1",
                "Dr_2_1_(1-2p1)^1", 
                "Dr_2_1_(1-2p2)^1",
                "Dr_2_2_(1-2p2)^1",
                "pi2_1_1_1_1", 
                "pi2_1_1_1_2",
                "pi2_1_1_2_2", 
                "pi2_1_2_1_2", 
                "pi2_1_2_2_2", 
                "pi2_2_2_2_2",
                "Hl_1_1", 
                "Hl_1_2",
                "Hl_2_2")

# constant Ne
mpp <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("neutrality/no_migration/model_", i, "_expectations.txt", sep=""))
  vals <- subset(vals, V1 %in% core_stats)
  vals <- slice(vals, 1:9, 13:18, 10:12) # to match moments.LD output and plot
  mpp <- c(mpp, vals$V3)
}

tbl <- as.data.frame(mpp)
tbl$stats <- core_stats
scenario <- NULL
for(i in 1:n_models) { 
  scenario <- c(scenario, rep(i, length(core_stats)))
}
tbl$scenario <- scenario

mLD <- numeric()
for(i in 1:n_models) {
  vals <- as.numeric(read.csv(paste("neutrality/no_migration/moments_LD_model_", i, ".csv", sep=""), header=T))
  mLD <- c(mLD, vals)
}

tbl$mLD <- mLD
tbl$ratio <- tbl$mpp / tbl$mLD

molten_tbl <- pivot_longer(tbl, cols=starts_with("m"))

p1 <- ggplot(data=molten_tbl, aes(x=stats, y=ratio, shape=as.factor(scenario)))
p1 <- p1 + geom_point(size=3) + theme_bw()
p1 <- p1 + geom_hline(yintercept=0.99, linetype=2)
p1 <- p1 + geom_hline(yintercept=1.01, linetype=2)
p1 <- p1 + labs(title="++ / LD", x="Moment", y="Ratio", shape="Model")
p1 <- p1 + scale_shape_manual(values=(0:(n_models - 1)))
p1 <- p1 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")

save_plot("neutrality/no_migration/ratios_no-mig.png", p1, base_height=12, base_width=12)
```

## Migration (TODO)


# Selection 1-population
## Benchmark 

Here we benchmark against moments.TwoLocus and TwoLocusSim

### Building Demes files

```{r, demes-selected-1-pop, include=F, eval=F, results=F, message=F, warning=F}

N <- c(1000, 10000)
u <- 1e-8
r  <- c(1e-4, 1e-5, 1e-6, 1e-7, 1e-8)
s <- c(0, -1e-04, -5e-4, -1e-3)

params <- crossing(N, u, r, s)
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

write.csv(params, "selection/single-pop/bench/params.csv", quote=F, row.names=F)

Sys.setenv(num_models=n_models)

py$params <- params # stores df to be used in python sections
py$n_models <- as.integer(n_models + 1) # because python is indexed from zero

for(i in 1:n_models) {
  
  name <- paste("model_", i, sep="")
  sink(paste("selection/single-pop/bench/", name, ".yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N[i])
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$u[i])
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$r[i])
  cat("]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$s[i])
  cat("]\n")
  
  sink()
}

```

### Running TwoLocusSim

```{bash run-twoLocusSim, engine.opts='-i', include=F, eval=F, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/single-pop/bench

sed 1d params.csv | while IFS=, read -r N u r s m
do
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_1 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_2 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_3 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_4 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_5 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_6 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_7 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_8 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_9 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_10;
  
  wait
  
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_11 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_12 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_13 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_14 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_15 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_16 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_17 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_18 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_19 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_20
  
  wait 
  
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_21 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_22 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_23 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_24 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_25 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_26 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_27 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_28 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_29 &
  twoLocusSim params=sim_sel.bpp N=$N u=$u r=$r s=$s label=$m tag=rep_30
done

cd ../../..

```

### Running moments++

```{bash run-moments++-1-pop, engine.opts='-i', include=F, eval=T, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/single-pop/bench

for((i=1;i<=$num_models;i++))
do
  momentspp params=opt.bpp F=model_$i.yaml L=model_$i O=25
done

cd ../../..
```

### Running moments.TwoLocus

For benchmarking the single population case, we use equilibrium demography:

```{python run-momentsTwoLocus, include=F, eval=F, results=F}

import moments.TwoLocus
import sys, os
import numpy as np
    
for i in range(1, n_models):
  with open(f"selection/single-pop/bench/moments_twoLocus_n40_model_{i}.csv", "w+") as fout:
      n_samples = 40
      
      # i - 1 because python is indexed from zero
      Ne = params["N"][i - 1] 
      u = params["u"][i - 1] 
      r = params["r"][i - 1] 
      s = params["s"][i - 1]
      
      gammas = [2 * Ne * s, 2 * Ne * s, 0] # sel on [AB, Ab, aB] haplotypes, resp
      rho = 4 * Ne * r
      theta = 4 * Ne * u
      
      F = moments.TwoLocus.Demographics.equilibrium(n_samples, 
                                                    rho=rho, 
                                                    theta=theta, 
                                                    sel_params=gammas)
        
      fs = moments.Spectrum(moments.LinearSystem_1D.steady_state_1D(n_samples, gamma=2 * Ne * s) * theta)    
      fs_left = moments.Spectrum(F[0, :, 0])
      fs_right = moments.Spectrum(F[0, 0, :])
      
      fout.write(f"D^2 = {F.D2():}\n")
      fout.write(f"Dz = {F.Dz():}\n")
      fout.write(f"Hl = {fs_left.pi()}\n")
      fout.write(f"Hr = {fs_right.pi()}\n")
      fout.write(f"pi2 = {F.pi2():}\n")
      
      assert np.allclose(fs_left, fs)

for i in range(1, n_models):
  with open(f"selection/single-pop/bench/moments_twoLocus_n60_model_{i}.csv", "w+") as fout:
      n_samples = 60
      
      # i - 1 because python is indexed from zero
      Ne = params["N"][i - 1] 
      u = params["u"][i - 1] 
      r = params["r"][i - 1] 
      s = params["s"][i - 1]
      
      gammas = [2 * Ne * s, 2 * Ne * s, 0] # sel on [AB, Ab, aB] haplotypes, resp
      rho = 4 * Ne * r
      theta = 4 * Ne * u
      
      F = moments.TwoLocus.Demographics.equilibrium(n_samples, 
                                                    rho=rho, 
                                                    theta=theta, 
                                                    sel_params=gammas)
        
      fs = moments.Spectrum(moments.LinearSystem_1D.steady_state_1D(n_samples, gamma=2 * Ne * s) * theta)    
      fs_left = moments.Spectrum(F[0, :, 0])
      fs_right = moments.Spectrum(F[0, 0, :])
      
      fout.write(f"D^2 = {F.D2():}\n")
      fout.write(f"Dz = {F.Dz():}\n")
      fout.write(f"Hl = {fs_left.pi()}\n")
      fout.write(f"Hr = {fs_right.pi()}\n")
      fout.write(f"pi2 = {F.pi2():}\n")
      
      assert np.allclose(fs_left, fs)
```

### Plots

```{r, plots-selected-1-pop, include=T, eval=F, results=F, message=F, warning=F}

commom_stats <- c("DD_0_0",
                  "Dr_0_0_(1-2p0)^1",
                  "Hl_0_0", 
                  "Hr_0_0",
                  "pi2_0_0_0_0")

# from moments++
expectation <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("selection/single-pop/bench/model_", i, "_expectations.txt", sep=""))
  vals <- subset(vals, V1 %in% commom_stats)$V3
  expectation <- c(expectation, vals)
}

tbl <- as.data.frame(expectation)
tbl$stats <- commom_stats
scenario <- NULL
for(i in 1:n_models) { 
  scenario <- c(scenario, rep(i, length(commom_stats)))
}
tbl$scenario <- scenario

mpp <- full_join(tbl, params, by="scenario")
mpp$alpha <- 2 * mpp$s * mpp$N

# moments.TwoLocus was fitted with 2 sample sizes, n=40 and n=60
# n = 40
expectation <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("selection/single-pop/bench/moments_twoLocus_n40_model_", i, ".csv", sep=""))$V3
  expectation <- c(expectation, vals)
}

tbl_py_n40 <- as.data.frame(expectation)
tbl_py_n40$stats <- commom_stats
tbl_py_n40$scenario <- scenario
tbl_py_n40$sample_size <- 40
tbl_py_n40 <- full_join(tbl_py_n40, params, by="scenario")

# from 2p(1-p) to p(1-p)
tbl_py_n40[tbl_py_n40$stats=="Hl_0_0", 1] <- tbl_py_n40[tbl_py_n40$stats=="Hl_0_0", 1] / 2
tbl_py_n40[tbl_py_n40$stats=="Hr_0_0", 1] <- tbl_py_n40[tbl_py_n40$stats=="Hr_0_0", 1] / 2

# n = 60
expectation <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("selection/single-pop/bench/moments_twoLocus_n60_model_", i, ".csv", sep=""))$V3
  expectation <- c(expectation, vals)
}

tbl_py_n60 <- as.data.frame(expectation)
tbl_py_n60$stats <- commom_stats
tbl_py_n60$scenario <- scenario
tbl_py_n60$sample_size <- 60
tbl_py_n60 <- full_join(tbl_py_n60, params, by="scenario")

# from 2p(1-p) to p(1-p)
tbl_py_n60[tbl_py_n60$stats=="Hl_0_0", 1] <- tbl_py_n60[tbl_py_n60$stats=="Hl_0_0", 1] / 2
tbl_py_n60[tbl_py_n60$stats=="Hr_0_0", 1] <- tbl_py_n60[tbl_py_n60$stats=="Hr_0_0", 1] / 2

tbl_py_ns <- bind_rows(tbl_py_n40, tbl_py_n60)
tbl_pp <- bind_rows(mpp, mpp)

tbl_pp <- tbl_pp %>% mutate(ratio = expectation / tbl_py_ns$expectation)
tbl_pp$sample_size <- tbl_py_ns$sample_size
  
p1 <- ggplot(data=filter(tbl_pp, stats==commom_stats[1]), aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p1 <- p1 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p1 <- p1 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p1 <- p1 + scale_x_log10(breaks=r) + scale_y_continuous(labels=scale.4d)
p1 <- p1 + labs(title=NULL, x=NULL, y=expression(D^2))
p1 <- p1 + geom_hline(yintercept=1, linetype="dashed", color="red")
p1 <- p1 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 legend.position="none")
p1

p2 <- ggplot(data=filter(tbl_pp, stats==commom_stats[2]), aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p2 <- p2 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p2 <- p2 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p2 <- p2 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p2 <- p2 + labs(title=NULL, x=NULL, y=expression(Dz))
p2 <- p2 + geom_hline(yintercept=1, linetype="dashed", color="red")
p2 <- p2 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x = element_blank(),
                 legend.position="none")
p2

p3 <- ggplot(data=filter(tbl_pp, stats==commom_stats[3]), aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p3 <- p3 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p3 <- p3 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p3 <- p3 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p3 <- p3 + labs(title=NULL, x=NULL, y=expression(H[l]))
p3 <- p3 + geom_hline(yintercept=1, linetype="dashed", color="red")
p3 <- p3 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x = element_blank(),
                 legend.position="none")
p3

p4 <- ggplot(data=filter(tbl_pp, stats==commom_stats[4]), aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size)))
p4 <- p4 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p4 <- p4 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p4 <- p4 + scale_x_log10(breaks = r) + scale_y_continuous(labels = scale.4d)
p4 <- p4 + labs(title=NULL, x=NULL, y=expression(H[r]))
p4 <- p4 + geom_hline(yintercept=1, linetype="dashed", color="red")
p4 <- p4 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.title.x=element_blank(),
                 axis.text.x=element_blank(),
                 axis.ticks.x=element_blank(),
                 strip.text.x = element_blank(),
                 legend.position="none")
p4

p5 <- ggplot(data=filter(tbl_pp, stats==commom_stats[5]), aes(x=r, y=ratio, shape=as.factor(N), color=as.factor(sample_size))) 
p5 <- p5 + geom_point(size=3) + geom_line() + theme_bw() + facet_wrap(~s, nrow=1)
p5 <- p5 + scale_shape_manual(values=0:length((unique(tbl_pp))))
p5 <- p5 + scale_x_log10(breaks = r) + scale_y_continuous(breaks=pretty_breaks(), labels = scale.4d)
p5 <- p5 + labs(title=NULL, x="r", y=expression(pi[2]))
p5 <- p5 + geom_hline(yintercept=1, linetype="dashed", color="red")
p5 <- p5 + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 strip.text.x = element_blank(),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p5

moms_comp_ratios <- plot_grid(p1, p2, p3, p4, p5, ncol=1, rel_heights=c(1, 1, 1, 1, 1.85))
save_plot("selection/single-pop/bench/moms_++_vs_py_ratios.png", moms_comp_ratios, base_height=10, base_width=20)
  
# appending two-locus simulations (performed w/ twoLocusSim binary from momentspp)
n_reps <- 30
twoLocusSim <- numeric()
for(i in 1:n_models) {
  rp <- numeric()
  for(j in 1:n_reps) {
    vals <- read.table(paste("selection/single-pop/bench/tls_", i, "_rep_", j, ".txt", sep=""))$V3
    rp <- c(rp, vals)
  }
  twoLocusSim <- c(twoLocusSim, rp)
}

tls <- as.data.frame(twoLocusSim)
tls$stats <- commom_stats # not needed, output stats are in same order

reps <- NULL
for(i in 1:n_reps) { 
  reps <- c(reps, rep(i, length(commom_stats)))
}
tls$reps <- reps

scenario <- NULL
for(i in 1:n_models) { 
  scenario <- c(scenario, rep(i, length(commom_stats) * n_reps))
}
tls$scenario <- scenario

df <- cbind.data.frame(mpp, tbl_py_ns$expectation)
names(df)[1] <- "moments++"
names(df)[9] <- "momentsTwoLocus"

df_all <- full_join(df, tls, by=c("stats", "scenario")) 

sd <- df_all %>% group_by(scenario, stats) %>% summarize(sd = sd(twoLocusSim))
rep_means <- df_all %>% group_by(scenario, stats) %>% summarize(avg = mean(twoLocusSim))

df_all <- full_join(df_all, rep_means, by=c("stats", "scenario")) 
df_all <- full_join(df_all, sd, by=c("stats", "scenario")) 
df_m <- pivot_longer(df_all, cols=c("moments++", "momentsTwoLocus", "twoLocusSim"), names_to="Method")

dd <- filter(df_m, stats==commom_stats[1])
p6 <- ggplot() + geom_errorbar(data=filter(dd, Method=="twoLocusSim"), aes(x=r, ymax=avg + 2*sd, ymin=avg - 2*sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p6 <- p6 + geom_point(data=filter(dd, Method!="twoLocusSim"), aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p6 <- p6 + scale_shape_manual(values=c(0, 1))
p6 <- p6 + scale_x_log10(breaks = r) + scale_y_log10()
p6 <- p6 + labs(x="r", y=expression(D^2))
p6 <- p6 + scale_color_manual(values=brewer.pal(n=3, name="Dark2"))
p6 <- p6 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p6
save_plot("selection/single-pop/bench/moms_++_vs_py_dd.png", p6, base_height=10, base_width=20)

dz <- filter(df_m, stats==commom_stats[2])
p7 <- ggplot() + geom_errorbar(data=filter(dz, Method=="twoLocusSim"), aes(x=r, ymax=avg + 2*sd, ymin=avg - 2*sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p7 <- p7 + geom_point(data=filter(dz, Method!="twoLocusSim"), aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p7 <- p7 + scale_shape_manual(values=c(0, 1))
p7 <- p7 + scale_x_log10(breaks=r) + scale_y_log10()
p7 <- p7 + labs(x="r", y=expression(Dz))
p7 <- p7 + scale_color_manual(values=brewer.pal(n=3, name="Dark2"))
p7 <- p7 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p7
save_plot("selection/single-pop/bench/moms_++_vs_py_dz.png", p7, base_height=10, base_width=20)

hl <- filter(df_m, stats==commom_stats[3])
p8 <- ggplot() + geom_errorbar(data=filter(hl, Method=="twoLocusSim"), aes(x=r, ymax=avg + 2*sd, ymin=avg - 2*sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p8 <- p8 + geom_point(data=filter(hl, Method!="twoLocusSim"), aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p8 <- p8 + scale_shape_manual(values=c(0, 1))
p8 <- p8 + scale_x_log10(breaks=r) + scale_y_log10()
p8 <- p8 + labs(x="r", y=expression(H[l]))
p8 <- p8 + scale_color_manual(values=brewer.pal(n=3, name="Dark2"))
p8 <- p8 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p8
save_plot("selection/single-pop/bench/moms_++_vs_py_hl.png", p8, base_height=10, base_width=20)

hr <- filter(df_m, stats==commom_stats[4])
p9 <- ggplot() + geom_errorbar(data=filter(hr, Method=="twoLocusSim"), aes(x=r, ymax=avg + 2*sd, ymin=avg - 2*sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p9 <- p9 + geom_point(data=filter(hr, Method!="twoLocusSim"), aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p9 <- p9 + scale_shape_manual(values=c(0, 1))
p9 <- p9 + scale_x_log10(breaks=r) + scale_y_log10()
p9 <- p9 + labs(x="r", y=expression(H[r]))
p9 <- p9 + scale_color_manual(values=brewer.pal(n=3, name="Dark2"))
p9 <- p9 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p9
save_plot("selection/single-pop/bench/moms_++_vs_py_hr.png", p9, base_height=10, base_width=20)

pi2 <- filter(df_m, stats==commom_stats[5])
p10 <- ggplot() + geom_errorbar(data=filter(pi2, Method=="twoLocusSim"), aes(x=r, ymax=avg + 2*sd, ymin=avg - 2*sd, color=as.factor(N))) + facet_wrap(~s, nrow=1)
p10 <- p10 + geom_point(data=filter(pi2, Method!="twoLocusSim"), aes(x=r, y=value, color=as.factor(N), shape=Method, size=1)) + theme_bw()
p10 <- p10 + scale_shape_manual(values=c(0, 1))
p10 <- p10 + scale_x_log10(breaks=r) + scale_y_log10()
p10 <- p10 + labs(x="r", y=expression(pi[2]))
p10 <- p10 + scale_color_manual(values=brewer.pal(n=3, name="Dark2"))
p10 <- p10 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p10
save_plot("selection/single-pop/bench/moms_++_vs_py_pi2.png", p10, base_height=10, base_width=20)

```

## Simple BGS model

### Building Demes files

Here we model BGS experienced by a single neutral locus
at the edge of a chromosome with w selected sites of length l

```{r, demes-BGS-single, include=F, eval=T, results=F, message=F, warning=F}

N <- c(10000)
u <- c(1e-8)
r <- unique(sort(1:10 %o% 10^(-4:-8)))
s <- -seq_log(from=1e-5, to=1e-3, length.out=200)

# number of independent genomic windows, each corresponding to a two-locus system
w <- c(1)
# length of each constrained locus
l <- c(1)

params <- crossing(N, u, r, s, w, l)
params$pi0 <- 2 * params$N * params$u
params$alpha <- 2 * params$N * params$s
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

write.csv(params, "selection/single-pop/simple_bgs/single_neutral/params.csv", quote=F, row.names=F)

Sys.setenv(num_models=n_models)

for(i in 1:n_models) {
  
  w <- params$w[i] # number of selected non-recombining genes

  for(j in 1:w) { # for all "left" loci
  
      name <- paste("model_", i, "_l_", j, sep="")
      sink(paste("selection/single-pop/simple_bgs/single_neutral/", name, ".yaml", sep=""))
      
      cat("time_units: generations\n")
      cat("demes:\n")
      cat("  - name: X\n")
      cat("    epochs:\n")
      cat("      - end_time: 0\n")
      cat("        start_size: ")
      cat(as.integer(params$N[i]))
      cat("\n")
      cat("metadata:\n")
      cat("  - name: mutation\n")
      cat("    left_factor: ")
      cat(params$l[i])
      cat("\n")
      cat("    epochs:\n")
      cat("      - end_time: 0\n")
      cat("        rates: [")
      cat(params$u[i])
      cat("]\n")
      cat("  - name: recombination\n")
      cat("    epochs:\n")
      cat("      - end_time: 0\n")
      cat("        rates: [")
      cat(j * params$r[i])
      cat("]\n")
      cat("  - name: selection\n")
      cat("    start_time: .inf\n")
      cat("    epochs:\n")
      cat("      - end_time: 0\n")
      cat("        rates: [")
      cat(params$s[i])
      cat("]\n")
      
      sink()
  }
}

```

### Running moments++

```{bash run-moments++BGS-single, engine.opts='-i', include=F, eval=T, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/single-pop/simple_bgs/single_neutral/

for m in *.yaml
do
  momentspp params=opt.bpp F=$m O=25
done

cd ../../../..
```

### Plots

```{r, plots-BGS-single, include=T, eval=T, results=F, message=F, warning=F}

params <- read.table("selection/single-pop/simple_bgs/single_neutral/params.csv", sep=",", header=T)
n_models <- nrow(params)
hr_BGS <- numeric(length=n_models)
hk95 <- numeric(length=n_models)
factors <- numeric(length=n_models)

# for landscape plots
factors_tbl <- as.data.frame(matrix(nrow=n_models, ncol=w))

for(i in 1:n_models) {
  
  w <- params$w[i] # number of selected non-recombining genes
  pi0 <- params$pi0[i]  
  one_minus_f <- numeric(length=w)
  hudson_kaplan_95 <- numeric(length=w)
  
  for(j in 1:w) { # left locus (selected)
  
    name <- paste("model_", i, "_l_", j, "_expectations.txt", sep="")
    expectations <- read.table(paste("selection/single-pop/simple_bgs/single_neutral/", name, sep=""))
      
    hr <- expectations[expectations$V1 == "Hr_0_0",]$V3
    one_minus_f[j] <- hr / pi0
    hudson_kaplan_95[j] <- 1 - (params$u[i] * params$l[i] * -1 * params$s[i]) / (2 * (-params$s[i] + j * params$r[i])^2)
  }
  
  factors[i] <- prod(one_minus_f)
  hr_BGS[i] <- pi0 * factors[i]
  hk95[i] <- pi0 * prod(hudson_kaplan_95)
    
  factors_tbl[i,] <- one_minus_f # stores to later plot relative reduction in diversity
}

params$factors <- factors
params$momentspp <- hr_BGS
params$hk95 <- hk95

# visualizing the accuracy of the approximation ul = L * u for the left locus
tbl <- filter(params, N==10000, w==1, r>0) # looking at single N to simplify

tbl$ul <- tbl$u * tbl$l
x <- filter(tbl, l==1)["factors"]
y <- numeric()
for(i in 1:(nrow(tbl) / length(unique(tbl$l)))) {
  for(j in unique(params$l)) {
    y <- c(y, x[i,] ^ j)
  }
}
tbl$scaled_factors <- y
tbl$scaled_hr <- tbl$scaled_factors * tbl$pi0
tbl$ratio <- tbl$momentspp / tbl$scaled_hr
molten_tbl <- pivot_longer(tbl, cols=c("momentspp", "scaled_hr"), names_to="method")

c <- 1
plot_list <- list(length=length(unique(molten_tbl$l)))
for(i in unique(molten_tbl$l)) {
  p <- ggplot(data=filter(molten_tbl, l==i, u==1e-8), aes(x=r, y=1e+4*value, shape=method))
  p <- p + geom_line() + geom_point(size=3) + facet_wrap(~s, nrow=1) + theme_bw()
  p <- p + geom_hline(data=filter(molten_tbl, ul==i), aes(yintercept=1e+4*pi0), linetype="dashed")
  p <- p + scale_shape_manual(values=c(0, 1))
  p <- p + scale_x_log10(breaks=unique(molten_tbl$r))
  p <- p + scale_y_log10(breaks=pretty_breaks(), labels=function(x) sprintf("%.4f", x))
  
  if(c==1) {
    p <- p + labs(title="moments++ Hr x 10,000, rows = L, cols = s", x="r", y=expression(H[r]))
    p <- p + theme(axis.title=element_text(size=16), 
                   axis.text=element_text(size=12), 
                   strip.text.x=element_text(size=16), 
                   axis.title.x=element_blank(),
                   axis.text.x=element_blank(),
                   axis.ticks.x=element_blank(),
                   legend.position="none")
  } else if(c==length(unique(molten_tbl$l))) {
    p <- p + labs(title=NULL, x="r", y=expression(H[r]))
    p <- p + theme(axis.title=element_text(size=16),
                   axis.text=element_text(size=12), 
                   strip.text.x=element_blank(), 
                   axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                   legend.text=element_text(size=16), 
                   legend.position="bottom")
  } else {
    p <- p + labs(title=NULL, x="r", y=expression(H[r]))
    p <- p + theme(axis.title=element_text(size=16), 
                   axis.text=element_text(size=12), 
                   strip.text.x=element_blank(), 
                   axis.title.x=element_blank(),
                   axis.text.x=element_blank(),
                   axis.ticks.x=element_blank(),
                   legend.position="none")
  }
  
  plot_list[[c]] <- p
  c <- c + 1
}

bgs_plot_1 <- plot_grid(plotlist=plot_list, ncol=1, rel_heights=c(1, 1.1))
save_plot("selection/single-pop/simple_bgs/bgs_single_neutral_scaling_1.png", bgs_plot_1, base_height=12, base_width=16)

c <- 1
plot_list <- list(length=length(unique(tbl$l)))
tbl2 <- filter(tbl, l>1, u==1e-8)
for(i in unique(tbl2$l)) {
  p <- ggplot(data=filter(tbl2, l==i), aes(x=r, y=ratio, shape=as.factor(alpha)))
  p <- p + geom_line() + geom_point(size=3) + theme_bw()
  p <- p + scale_shape_manual(values=1:length(unique(tbl2$alpha)))
  p <- p + scale_x_log10(breaks=unique(tbl2$r))
  p <- p + scale_y_log10(breaks=pretty_breaks(), labels=function(x) sprintf("%.4f", x))
  
  if(c==1) {
    p <- p + labs(title="Hr / scaled_hr", x="r", y="Ratio")
    p <- p + theme(axis.title=element_text(size=16), 
                   axis.text=element_text(size=12), 
                   strip.text.x=element_text(size=16), 
                   axis.title.x=element_blank(),
                   axis.text.x=element_blank(),
                   axis.ticks.x=element_blank(),
                   legend.position="none")
  } else if(c==length(unique(tbl2$l))) {
    p <- p + labs(title=NULL, x="r", y="Ratio")
    p <- p + theme(axis.title=element_text(size=16),
                   axis.text=element_text(size=12), 
                   strip.text.x=element_blank(), 
                   axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                   legend.text=element_text(size=16), 
                   legend.position="bottom")
  } else {
    p <- p + labs(title=NULL, x="r", y="Ratio")
    p <- p + theme(axis.title=element_text(size=16), 
                   axis.text=element_text(size=12), 
                   strip.text.x=element_blank(), 
                   axis.title.x=element_blank(),
                   axis.text.x=element_blank(),
                   axis.ticks.x=element_blank(),
                   legend.position="none")
  }
  
  plot_list[[c]] <- p
  c <- c + 1
}

bgs_plot_2 <- plot_grid(plotlist=plot_list, ncol=1, rel_heights=c(1, 1, 1.1))
save_plot("selection/single-pop/simple_bgs/bgs_single_neutral_scaling_2.png", bgs_plot_2, base_height=12, base_width=16)

# plots of moments++
df <- filter(params, w==1, u==1e-8)
for(i in unique(df$N)) {
  
  df2 <- filter(df, N==i)
  c <- 1
  plot_list <- list(length=length(unique(df2$l)))
  
  for(j in unique(df2$l)) {
    p <- ggplot(data=filter(df2, l==j), aes(x=s, y=momentspp))
    p <- p + geom_line() + geom_point(size=3) + facet_wrap(~r, nrow=1) + theme_bw()
    p <- p + geom_hline(data=filter(df2, l==j), aes(yintercept=pi0), linetype="dashed")
    p <- p + scale_x_continuous(breaks=pretty_breaks())
    p <- p + scale_y_log10(breaks=pretty_breaks(), labels=function(x) format(x, scientific=T))
  
    if(c==1) {
      p <- p + labs(title="Hr moments++, rows = uL, cols = r", x="s", y=expression(H[r]))
      p <- p + theme(axis.title=element_text(size=16), 
                     axis.text=element_text(size=12), 
                     strip.text.x=element_text(size=16), 
                     axis.title.x=element_blank(),
                     axis.text.x=element_blank(),
                     axis.ticks.x=element_blank(),
                     legend.position="none")
    } else if(c==length(unique(df2$l))) {
      p <- p + labs(title=NULL, x="s", y=expression(H[r]))
      p <- p + theme(axis.title=element_text(size=16),
                     axis.text=element_text(size=12), 
                     strip.text.x=element_blank(), 
                     axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                     legend.text=element_text(size=16), 
                     legend.position="bottom")
    } else {
      p <- p + labs(title=NULL, x="s", y=expression(H[r]))
      p <- p + theme(axis.title=element_text(size=16), 
                     axis.text=element_text(size=12), 
                     strip.text.x=element_blank(), 
                     axis.title.x=element_blank(),
                     axis.text.x=element_blank(),
                     axis.ticks.x=element_blank(),
                     legend.position="none")
    }
  
    plot_list[[c]] <- p
    c <- c + 1
  }
  
  bgs_plot_3 <- plot_grid(plotlist=plot_list, ncol=1, rel_heights=c(1.15, 1, 1, 1, 1.75))
  save_plot(paste("selection/single-pop/simple_bgs/bgs_single_neutral_mpp_A_N_", i, ".png", sep=""), bgs_plot_3, base_height=12, base_width=16)
}

c <- 1
plot_list <- list(length=length(unique(df$l)))
for(i in unique(df$l)) {
  p <- ggplot(data=filter(df, l==i), aes(x=s, y=factors, color=as.factor(N)))
  p <- p + geom_line() + geom_point(size=3) + facet_wrap(~r, nrow=1) + theme_bw()
  p <- p + geom_hline(yintercept=1, linetype="dashed")
  p <- p + scale_x_continuous(breaks=pretty_breaks())
  p <- p + scale_y_log10(breaks=pretty_breaks(), labels=function(x) sprintf("%.3f", x))
  
  if(c==1) {
    p <- p + labs(title="Two-locus Reduction Factors BGS, rows = uL, cols = r", x="s", y=expression(H[r]))
    p <- p + theme(axis.title=element_text(size=16), 
                   axis.text=element_text(size=12), 
                   strip.text.x=element_text(size=16), 
                   axis.title.x=element_blank(),
                   axis.text.x=element_blank(),
                   axis.ticks.x=element_blank(),
                   legend.position="none")
  } else if(c==length(unique(params$l))) {
    p <- p + labs(title=NULL, x="s", y=expression(H[r]))
    p <- p + theme(axis.title=element_text(size=16),
                   axis.text=element_text(size=12), 
                   strip.text.x=element_blank(), 
                   axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                   legend.text=element_text(size=16), 
                   legend.position="bottom")
  } else {
    p <- p + labs(title=NULL, x="s", y=expression(H[r]))
    p <- p + theme(axis.title=element_text(size=16), 
                   axis.text=element_text(size=12), 
                   strip.text.x=element_blank(), 
                   axis.title.x=element_blank(),
                   axis.text.x=element_blank(),
                   axis.ticks.x=element_blank(),
                   legend.position="none")
  }
  
  plot_list[[c]] <- p
  c <- c + 1
}

bgs_plot_2 <- plot_grid(plotlist=plot_list, ncol=1, rel_heights=c(1.15, 1, 1, 1.75))
save_plot("selection/single-pop/simple_bgs/bgs_single_neutral_mpp_B.png", bgs_plot_2, base_height=12, base_width=16)

names(factors_tbl) <- 1:ncol(factors_tbl)
windows <- bind_cols(params, factors_tbl)
molten_windows <- pivot_longer(windows, cols=(ncol(params) + 1):ncol(windows), names_to="window")
molten_windows$window <- as.numeric(molten_windows$window)

c <- 3
for(i in unique(params$u)) {
  p <- ggplot(data=filter(molten_windows, u==i, w==100), aes(x=window, y=value, color=as.factor(s)))
  p <- p + geom_point(size=0.5) + facet_grid(N~r) + theme_bw()
  p <- p + scale_x_discrete(breaks=pretty_breaks())
  p <- p + scale_y_continuous(breaks=pretty_breaks())
  p <- p + labs(title=paste("Two-locus Hr BGS windows, mu", i, ", cols = r, rows = N", sep=""), x="Window", y=expression(1-f[j]))
  p <- p + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  
  save_plot(paste("selection/single-pop/simple_bgs/bgs_single_neutral_mpp_", c, ".png", sep=""), p, base_height=8, base_width=15)
  
  c <- c + 1
}

# plots of hudson & kaplan 1995
for(i in unique(df$N)) {
  
  df2 <- filter(df, N==i)
  c <- 1
  plot_list <- list(length=length(unique(df2$l)))
  
  for(j in unique(df2$l)) {
    p <- ggplot(data=filter(df2, l==j), aes(x=s, y=hk95))
    p <- p + geom_line() + geom_point(size=3) + facet_wrap(~r, nrow=1) + theme_bw()
    p <- p + geom_hline(data=filter(df2, l==j), aes(yintercept=pi0), linetype="dashed")
    p <- p + scale_x_continuous(breaks=pretty_breaks())
    p <- p + scale_y_log10(breaks=pretty_breaks(), labels=function(x) format(x, scientific=T))
  
    if(c==1) {
      p <- p + labs(title="Hr HK95, rows = L, cols = r", x="s", y="HK95")
      p <- p + theme(axis.title=element_text(size=16), 
                     axis.text=element_text(size=12), 
                     strip.text.x=element_text(size=16), 
                     axis.title.x=element_blank(),
                     axis.text.x=element_blank(),
                     axis.ticks.x=element_blank(),
                     legend.position="none")
    } else if(c==length(unique(params$l))) {
      p <- p + labs(title=NULL, x="s", y="HK95")
      p <- p + theme(axis.title=element_text(size=16),
                     axis.text=element_text(size=12), 
                     strip.text.x=element_blank(), 
                     axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                     legend.text=element_text(size=16), 
                     legend.position="bottom")
    } else {
      p <- p + labs(title=NULL, x="s", y="HK95")
      p <- p + theme(axis.title=element_text(size=16), 
                     axis.text=element_text(size=12), 
                     strip.text.x=element_blank(), 
                     axis.title.x=element_blank(),
                     axis.text.x=element_blank(),
                     axis.ticks.x=element_blank(),
                     legend.position="none")
    }
  
    plot_list[[c]] <- p
    c <- c + 1
  }
  
  bgs_plot_4 <- plot_grid(plotlist=plot_list, ncol=1, rel_heights=c(1.15, 1, 1, 1, 1.75))
  save_plot(paste("selection/single-pop/simple_bgs/bgs_single_neutral_hk95_N_", i, ".png", sep=""), bgs_plot_4, base_height=12, base_width=24)
}

# compare moments++ and HK95
for(i in unique(df$N)) {
  
  df2 <- pivot_longer(filter(df, i==N), cols=c("momentspp", "hk95"), names_to="method")
  c <- 1
  plot_list <- list(length=length(unique(df2$l)))
  
  for(j in unique(df$l)) {
    p <- ggplot(data=filter(df2, l==j), aes(x=s, y=value, shape=method))
    p <- p + geom_line() + geom_point(size=3) + facet_wrap(~r, nrow=1) + theme_bw()
    p <- p + geom_hline(data=filter(df2, u==j), aes(yintercept=pi0, color=as.factor(N)), linetype="dashed")
    p <- p + scale_shape_manual(values=c(0, 1, 2))
    p <- p + scale_x_continuous(breaks=pretty_breaks())
    p <- p + scale_y_log10(breaks=pretty_breaks(), labels=function(x) format(x, scientific=T))
  
    if(c==1) {
      p <- p + labs(title="Hr methods, rows = ul, cols = r", x="s", y="Hr")
      p <- p + theme(axis.title=element_text(size=16), 
                     axis.text=element_text(size=12), 
                     strip.text.x=element_text(size=16), 
                     axis.title.x=element_blank(),
                     axis.text.x=element_blank(),
                     axis.ticks.x=element_blank(),
                     legend.position="none")
    } else if(c==length(unique(params$l))) {
      p <- p + labs(title=NULL, x="s", y=expression(H[r]))
      p <- p + theme(axis.title=element_text(size=16),
                     axis.text=element_text(size=12), 
                     strip.text.x=element_blank(), 
                     axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                     legend.text=element_text(size=16), 
                     legend.position="bottom")
    } else {
      p <- p + labs(title=NULL, x="s", y=expression(H[r]))
      p <- p + theme(axis.title=element_text(size=16), 
                     axis.text=element_text(size=12), 
                     strip.text.x=element_blank(), 
                     axis.title.x=element_blank(),
                     axis.text.x=element_blank(),
                     axis.ticks.x=element_blank(),
                     legend.position="none")
    }
  
    plot_list[[c]] <- p
    c <- c + 1
  }
  
  bgs_plot_5 <- plot_grid(plotlist=plot_list, ncol=1, rel_heights=c(1.15, 1, 1, 1.75))
  save_plot(paste("selection/single-pop/simple_bgs/bgs_mpp_hk95_N_", i, ".png", sep=""), bgs_plot_5, base_height=12, base_width=24)
}

# checking the relationship between the s and the relevant width of BGS (~r)
df3 <- distinct(dplyr::select(filter(molten_windows, w==1, r>0), -window))

p <- ggplot(data=filter(df3, l==1), aes(x=r, y=value, color=as.factor(s), shape=as.factor(u)))
p <- p + geom_line() + geom_point(size=3) + facet_wrap(~N, nrow=2) + theme_bw()
p <- p + geom_vline(data=filter(df3, l==1), aes(xintercept=-s, color=as.factor(s)), linetype="dashed")
p <- p + scale_shape_manual(values=c(0, 1, 2))
p <- p + scale_color_brewer(palette="Accent")
p <- p + scale_x_log10(breaks=unique(df3$r))
p <- p + scale_y_log10(breaks=pretty_breaks(), labels=function(x) format(x, scientific=T))
p <- p + labs(title="Diversity Reduction Factors, L=1, W=1", x="r", y=expression(1-f[j]))
p <- p + theme(axis.title=element_text(size=12),
               axis.text=element_text(size=10),
               axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
               legend.position="bottom")
save_plot("selection/single-pop/simple_bgs/s_vs_r_A.png", p, base_height=9, base_width=12)

df4 <- filter(molten_windows, w==100, r==1e-5)
df4$rec <- df4$r * df4$window
df4$cum_red <- cumprod(df4$value)

p <- ggplot(data=filter(df4, l==1), aes(x=rec, y=value, color=as.factor(s), linetype=as.factor(u)))
p <- p + geom_line() + facet_wrap(~N, nrow=2) 
p <- p + theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
               panel.background=element_blank(), axis.line=element_line(colour="black"))
p <- p + geom_vline(data=filter(df4, l==1), aes(xintercept=-s, color=as.factor(s)), linetype="dashed")
p <- p + scale_shape_manual(values=c(0, 1))
p <- p + scale_color_brewer(palette="Dark2")
p <- p + scale_x_continuous(breaks=unique(df4$rec))
p <- p + scale_y_log10(breaks=pretty_breaks(), labels=function(x) format(x, scientific=T))
p <- p + labs(title="Diversity Reduction Factors, L=1, W=100", x="cum. rec. rate.", y=expression(1-f[j]))
p <- p + theme(axis.title=element_text(size=12),
               axis.text=element_text(size=10),
               axis.text.x=element_blank(),
               axis.ticks.x=element_blank(),
               legend.position="bottom")
save_plot("selection/single-pop/simple_bgs/s_vs_r_B.png", p, base_height=9, base_width=12)
```

### Building Demes files

We now model multiple neutral loci, interdigitated with 
constrained, non-recombining loci of length l

```{r, demes-BGS-mult-1, include=F, eval=F, results=F, message=F, warning=F}

N <- 10000
u <- c(1e-7, 1e-8, 1e-9)
r <- c(1e-5, 1e-6, 1e-7, 1e-8)
s <- c(-1e-5, -1e-4, -1e-3)

# number of independent genomic windows, each corresponding to a two-locus system
w <- 100
# length of each genomic block
l <- 10

params <- crossing(N, u, r, s, w, l)
params$pi0 <- 2 * params$N * params$u
params$alpha <- 2 * params$N * params$s
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

write.csv(params, "selection/single-pop/simple_bgs/mult_neutral/params.csv", quote=F, row.names=F)

Sys.setenv(n_models=n_models)
```

```{bash mk-mult-dirs, engine.opts='-i', include=F, eval=F, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/single-pop/simple_bgs/mult_neutral/

for((i=1;i<=$n_models;i++));
do
  mkdir model_$i
  cp opt.bpp model_$i
done

cd ../../../..
```

```{r, demes-BGS-mult-2, include=F, eval=F, results=F, message=F, warning=F}

for(i in 1:n_models) {
  
  for(j in 1:w) { # left locus
  
    for(k in 1:w) { # right locus
      
      name <- paste("model_", i, "_l_", j, "_r_", k, sep="")
      sink(paste("selection/single-pop/simple_bgs/mult_neutral/model_", i, "/", name, ".yaml", sep=""))
      
      total_r <- (abs(j-k) + 1) * params$r[i]
      
      cat("time_units: generations\n")
      cat("demes:\n")
      cat("  - name: X\n")
      cat("    epochs:\n")
      cat("      - end_time: 0\n")
      cat("        start_size: ")
      cat(as.integer(params$N[i]))
      cat("\n")
      cat("metadata:\n")
      cat("  - name: mutation\n")
      cat("    left_factor: ")
      cat(params$l[i])
      cat("\n")
      cat("    epochs:\n")
      cat("      - end_time: 0\n")
      cat("        rates: [")
      cat(params$u[i])
      cat("]\n")
      cat("  - name: recombination\n")
      cat("    epochs:\n")
      cat("      - end_time: 0\n")
      cat("        rates: [")
      cat(total_r)
      cat("]\n")
      cat("  - name: selection\n")
      cat("    start_time: .inf\n")
      cat("    epochs:\n")
      cat("      - end_time: 0\n")
      cat("        rates: [")
      cat(params$s[i])
      cat("]\n")
      
      sink()
    }
  }
}

```

### Running moments++

```{bash run-moments++BGS-mult, engine.opts='-i', include=F, eval=F, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/single-pop/simple_bgs/mult_neutral/

for((i=1;i<=$n_models;i++));
do
  cd model_$i
  for m in *.yaml
  do
    momentspp params=opt.bpp F=$m O=25
  done
  cd ..
done

cd ../../../..
```

### Plots

```{r, plots-BGS-mult, include=T, eval=F, results=F, message=F, warning=F}

params <- read.table("selection/single-pop/simple_bgs/mult_neutral/params.csv", sep=",", header=T)
n_models <- nrow(params)

# for landscape plots
hr_tbl <- as.data.frame(matrix(nrow=n_models, ncol=w))

for(i in 1:n_models) {
  
  cat(paste("Retrieving data from model ", i, "...\n"))
  
  for(j in 1:w) { # right locus
    
    one_minus_f <- numeric(length=w)
      
    for(k in 1:w) { # left locus
      
      name <- paste("model_", i, "_l_", k, "_r_", j, "_expectations.txt", sep="")
      expectations <- read.table(paste("selection/single-pop/simple_bgs/mult_neutral/model_", i, "/", name, sep=""))
      
      hr <- expectations[expectations$V1 == "Hr_0_0",]$V3
      one_minus_f[k] <- hr / params$pi0[i]
    }
    
    hr_BGS[j] <- params$pi0[i] * prod(one_minus_f)
  }
  
  hr_tbl[i,] <- hr_BGS
}

names(hr_tbl) <- 1:ncol(hr_tbl)
windows <- bind_cols(params, hr_tbl)
molten_windows <- pivot_longer(windows, cols=(ncol(params) + 1):ncol(windows), names_to="window")
molten_windows$window <- as.numeric(molten_windows$window)

p1 <- ggplot(data=filter(molten_windows, u==1e-9), aes(x=window, y=value, color=as.factor(alpha)))
p1 <- p1 + geom_point(size=1) + facet_wrap(~r, nrow=1) + theme_bw()
p1 <- p1 + scale_x_discrete(breaks=pretty_breaks())
p1 <- p1 + scale_y_continuous(breaks=pretty_breaks())
p1 <- p1 + geom_hline(yintercept=unique(filter(molten_windows, u==1e-9)$pi0), linetype="dashed")
p1 <- p1 + labs(title="Two-locus Hr BGS windows, mu=1e-9, cols = r", x="Window", y=expression(H[r]))
p1 <- p1 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")

save_plot("selection/single-pop/simple_bgs/bgs_mult_neutral_1.png", p1, base_height=12, base_width=20)

p2 <- ggplot(data=filter(molten_windows, u==1e-8), aes(x=window, y=value, color=as.factor(alpha)))
p2 <- p2 + geom_point(size=1) + facet_wrap(~r, nrow=1) + theme_bw()
p2 <- p2 + scale_x_discrete(breaks=pretty_breaks())
p2 <- p2 + scale_y_continuous(breaks=pretty_breaks())
p2 <- p2 + geom_hline(yintercept=unique(filter(molten_windows, u==1e-8)$pi0), linetype="dashed")
p2 <- p2 + labs(title="Two-locus Hr BGS windows, mu=1e-8, cols = r", x="Window", y=expression(H[r]))
p2 <- p2 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")

save_plot("selection/single-pop/simple_bgs/bgs_mult_neutral_2.png", p2, base_height=12, base_width=20)

p3 <- ggplot(data=filter(molten_windows, u==1e-7), aes(x=window, y=value, color=as.factor(alpha)))
p3 <- p3 + geom_point(size=1) + facet_wrap(~r, nrow=1) + theme_bw()
p3 <- p3 + scale_x_discrete(breaks=pretty_breaks())
p3 <- p3 + scale_y_continuous(breaks=pretty_breaks())
p3 <- p3 + geom_hline(yintercept=unique(filter(molten_windows, u==1e-7)$pi0), linetype="dashed")
p3 <- p3 + labs(title="Two-locus Hr BGS windows, mu=1e-7, cols = r", x="Window", y=expression(H[r]))
p3 <- p3 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")

save_plot("selection/single-pop/simple_bgs/bgs_mult_neutral_3.png", p3, base_height=12, base_width=20)
```

## BGS with Genomic Landscapes

### Building Demes files

This builds a look-up table on a dense parameter grid that will allow for fast 
assembly of whole chromosomes

```{r, BGS-mutvar-params, include=F, eval=F, results=F, message=F, warning=F}

N <- 10000
u <- 1e-8 # constant among exons as well as "fake" neutral mu used to get B-values
# to get B-values, we only need to build a lookup table with variation in r & s (u_L will be constant, u_R varies later)
lookup_r <- round(seq_log(from=1e-12, to=1e-2, length.out=500), digits=15)
lookup_s <- round(-seq_log(from=1e-5, to=1e-3, length.out=200), digits=11)

# for discretizing Gamma distributions
dt_r <- data.table(lookup_r)
dt_s <- data.table(lookup_s)

setkey(dt_r, lookup_r)
setkey(dt_s, lookup_s)

params <- setDT(crossing(N, u, lookup_r, lookup_s))
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

fwrite(dt_r, "selection/single-pop/landscapes/r.csv", quote=F, row.names=F, col.names=F)
fwrite(dt_s, "selection/single-pop/landscapes/s.csv", quote=F, row.names=F, col.names=F)
fwrite(params, "selection/single-pop/landscapes/params.csv", quote=F, row.names=F)

Sys.setenv(num_models=n_models)
```

```{bash make_dirs_mutvar, engine.opts='-i', include=F, eval=F, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/single-pop/landscapes/

cat r.csv | while IFS=, read -r r
do
  mkdir r_$r
done

cd ../../..
```

```{r, BGS-mutvar-demes, include=F, eval=F, results=F, message=F, warning=F}

for(i in 1:n_models) {
  
  if(i %% 10000 == 0) {
    cat(paste(i, "\n"))
  }
  
  N <- as.integer(params[i,]$N)
  u <- as.numeric(params[i,]$u)
  r <- as.numeric(params[i,]$lookup_r)
  s <- as.numeric(params[i,]$lookup_s)

  name <- paste("model_", i, sep="")
  sink(paste("selection/single-pop/landscapes/r_", r, "/", name, ".yaml", sep=""))
    
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(N)
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    left_factor: 1\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(u)
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(r)
  cat("]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(s)
  cat("]\n")
      
  sink()
}

```

### Running moments++

Computes lookup table

```{bash run-moments++BGS-mutvar, engine.opts='-i', include=F, eval=F, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/single-pop/landscapes/

for r in r_*
do 
  cd $r
  do
	  momentspp params=opt.bpp F=$f O=25 > /dev/null
  done
  cd ..
done

cd ../../..
```

### Analyses

Collect lookup table with Hr values on the parameter grid

```{r, BGS-mutvar-grid, include=F, eval=F, results=F, message=F, warning=F}

params <- fread("~/Devel/momentspp/benchmarking/selection/single-pop/landscapes/params.csv", sep=",", header=T)
n_models <- nrow(params)
c <- 1
hr <- numeric(length=n_models)

for(i in 1:length(lookup_r)) {
  for(j in 1:length(lookup_s)) {
    moms <- read.table(paste("~/Devel/momentspp/benchmarking/selection/single-pop/landscapes/r_", lookup_r[i], "/model_", as.integer(c), "_expectations.txt", sep=""))
    hr[c] <- moms[moms$V1 == "Hr_0_0",]$V3
    c <- c + 1
  }
}

params$Hr <- hr
fwrite(params, "~/Devel/momentspp/benchmarking/selection/single-pop/landscapes/lookup_tbl.csv", row.names=F, quote=F, sep=",")
```

```{r, BGS-mutvar-landscapes, include=F, eval=F, results=F, message=F, warning=F}

lookup_tbl <- setDT(fread("~/Devel/momentspp/benchmarking/selection/single-pop/landscapes/lookup_tbl.csv"))
setkey(lookup_tbl, lookup_r, lookup_s)

lookup_r <- unique(lookup_tbl$lookup_r)
lookup_s <- unique(lookup_tbl$lookup_s)

# for discretizing Gamma distributions and make look-up faster
dt_r <- data.table(lookup_r)
dt_s <- data.table(lookup_s)

setkey(dt_r, lookup_r)
setkey(dt_s, lookup_s)

# constants
N <- unique(lookup_tbl$N)
u <- unique(lookup_tbl$u)
num_constrained <- 1000 # number of (non-recombining) selected segment in chr

# Gamma dist params
scale_sel <- c(5e-5, 2.5e-4)
shape_sel <- c(10)
scales_mu <- c(1e-8)
shapes_mu <- c(3, 10, 30)
scales_rec <- c(1e-7, 1e-8)
shapes_rec <- c(1, 3, 10)

# Geom dist params
avg_rec_spans <- c(1e+3)
avg_mut_spans <- c(1e+4)
avg_neutral_lengths <- c(1e+4)
exon_lengths <- c(1000)  
models <- setDT(crossing(N, num_constrained, shape_sel, scale_sel, shapes_mu, scales_mu, shapes_rec, scales_rec, 
                avg_rec_spans, avg_mut_spans, avg_neutral_lengths, exon_lengths))
models$model <- 1:nrow(models)
n_models <- nrow(models)

fwrite(models, "~/Devel/momentspp/benchmarking/selection/single-pop/test_models/models.csv", row.names=F, quote=F, sep=",")

jump_length <- 1e+3
bin_size <- 1e+3 # smallest value, then 1e+4 and 1e+5 are achieved by further binning

# table for storing R^2 values from linear models
r2_tbl_1kb <- as.data.frame(matrix(ncol=5, nrow=n_models))
r2_tbl_10kb <- as.data.frame(matrix(ncol=5, nrow=n_models))
r2_tbl_100kb <- as.data.frame(matrix(ncol=5, nrow=n_models))

names(r2_tbl_1kb) <- c("Total", "u", "r", "s", "r:s")
names(r2_tbl_10kb) <- c("Total", "u", "r", "s", "r:s")
names(r2_tbl_100kb) <- c("Total", "u", "r", "s", "r:s")

for(i in 1:n_models) {

  cat(paste("Building chromosome(s) for model ", i, "...\n", sep=""))
  
  ncsl <- rgeom(n=models$num_constrained[i] + 1, prob=1/models$avg_neutral_lengths[i])
  csl <- rep(models$exon_lengths[i], models$num_constrained[i]) 
  L <- sum(csl) + sum(ncsl)
  
  ss <- -rgamma(n=length(csl), shape=models$shape_sel[i], scale=models$scale_sel[i]/models$shape_sel[i])
  alpha <- 2 * models$N[i] * ss
  
  while(any(alpha < -20)) { 
    cat("Selection is too strong in at least one gene! Redrawing...\n")
    ss <- -rgamma(n=length(csl), shape=models$shape_sel[i], scale=models$scale_sel[i]/models$shape_sel[i])
    alpha <- 2 * models$N[i] * ss
  }
  
  disc_ss <- dt_s[dt_s[J(ss), roll="nearest", which=T]]$lookup_s # discretize
  
  intervals <- c(rbind(ncsl, csl))[-2*length(ncsl)]
  intervals <- setDT(bind_cols(chr="chr1", dplyr::lag(cumsum(intervals), n=1, default=0), dplyr::lag(cumsum(intervals), n=0, default=0)))
  names(intervals) <- c("chr", "start", "end")
  intervals$s <- c(rbind(rep(0, length(csl)), disc_ss), 0)
  setkey(intervals, start, end)
  fwrite(intervals, paste("~/Devel/momentspp/benchmarking/selection/single-pop/test_data/intervals_m", i, ".csv", sep=""), sep=",")

  dt_neutral <- filter(intervals[,2:4], s==0)
  setkey(dt_neutral, start, end)
  dt_exons <- filter(intervals, s < 0)
  dt_exons$u <- 1e-08 
  setkey(dt_exons, start, end)
  fwrite(dt_exons, paste("~/Devel/momentspp/benchmarking/selection/single-pop/test_data/exons_m", i, ".csv", sep=""), sep=",")

  rec_spans <- rgeom(n=ceiling(L/models$avg_rec_spans[i]), prob=1/models$avg_rec_spans[i])
  while(sum(rec_spans) < L) {
    rec_spans <- c(rec_spans, rgeom(n=1, prob=1/models$avg_rec_spans[i]))
  }
  if(sum(rec_spans) > L) {
    rec_spans <- rec_spans[cumsum(rec_spans) < L]
    rec_spans <- c(rec_spans, L - sum(rec_spans))
  }
  rec_spans <- rec_spans[rec_spans>0]
  
  rmap <- setDT(bind_cols(chr="chr1", dplyr::lag(cumsum(rec_spans), n=1, default=0), dplyr::lag(cumsum(rec_spans), n=0, default=0)))
  names(rmap) <- c("chr", "start", "end")
  rs <- rgamma(n=nrow(rmap), shape=models$shapes_rec[i], scale=models$scales_rec[i]/models$shapes_rec[i])
  disc_rs <- dt_r[dt_r[J(rs), roll="nearest", which=T]]$lookup_r # discretize
  rmap$r <- disc_rs
  setkey(rmap, start, end)
  fwrite(rmap, paste("~/Devel/momentspp/benchmarking/selection/single-pop/test_data/rmap_m", i, ".csv", sep=""), sep=",")
  
  mut_spans <- rgeom(n=ceiling(L/models$avg_mut_spans[i]), prob=1/models$avg_mut_spans[i])
  while(sum(mut_spans) < L) {
    mut_spans <- c(mut_spans, rgeom(n=1, prob=1/models$avg_mut_spans[i]))
  }
  if(sum(mut_spans) > L) {
    mut_spans <- mut_spans[cumsum(mut_spans) < L]
    mut_spans <- c(mut_spans, L - sum(mut_spans))
  }
  mut_spans <- mut_spans[mut_spans>0]
  
  mu_dist <- round(seq_log(from=1e-10, to=1e-6, length.out=300), digits=11)
  dt_u <- data.table(mu_dist)
  setkey(dt_u, mu_dist)
  
  mmap <- setDT(bind_cols(chr="chr1", dplyr::lag(cumsum(mut_spans), n=1, default=0), dplyr::lag(cumsum(mut_spans), n=0, default=0)))
  names(mmap) <- c("chr", "start", "end")
  mus <- rgamma(n=nrow(mmap), shape=models$shapes_mu[i], scale=models$scales_mu[i]/models$shapes_mu[i])
  disc_mus <- dt_u[dt_u[J(mus), roll="nearest", which=T]]$mu_dist # discretize
  mmap$u <- disc_mus
  setkey(mmap, start, end)
  fwrite(mmap, paste("~/Devel/momentspp/benchmarking/selection/single-pop/test_data/mmap_m", i, ".csv", sep=""), sep=",")
  
  # finding mu for each sampled pos and the cumulative recombination map over the "sampling intervals"
  samp_pos <- unlist(apply(dt_neutral, 1, function(x) seq(from=x[1], to=x[2], by=jump_length))) + 1
  linear_pos <- sort(c(samp_pos, dt_exons$start + 50))
  # (the following searches may take a few minutes, depending the length of linear pos)
  focal_mu <- unlist(lapply(linear_pos, function(pos) mmap[J(pos), roll=T]$u))
  focal_r <- unlist(lapply(linear_pos, function(pos) rmap[J(pos), roll=T]$r))
  cum_rec <- numeric(length=length(linear_pos))
  cum_rec[1] <- focal_r[1]
  for(j in 2:length(linear_pos)) { cum_rec[j] <- cum_rec[j-1] + (linear_pos[j] - linear_pos[j-1]) * focal_r[j] }
  
  pos_dt <- setDT(bind_cols(linear_pos, focal_mu, cum_rec))
  names(pos_dt) <- c("position", "focal_mu", "cumrec")
  setkey(pos_dt, position)
  
  # defines bins for linear models
  bins <- rep(bin_size, floor(L / bin_size))
  bins <- bind_cols(chr="chr1", dplyr::lag(cumsum(bins), n=1, default=0), dplyr::lag(cumsum(bins), n=0, default=0))
  names(bins) <- c("chr", "start", "end")
  bins$start <- bins$start + 1 # so that GRanges understands the intervals -> NOT in BEDGRAPH format
  gr_bins <- makeGRangesFromDataFrame(bins)
  
  # binning recombination maps
  rmap2 <- rmap
  rmap2$start <- rmap2$start + 1 # so that GRanges understands the intervals -> NOT in BEDGRAPH format
  rec_gr <- makeGRangesFromDataFrame(rmap2, keep.extra.columns=T)
  hits <- findOverlaps(query=gr_bins, subject=rec_gr) 
  hit_list <- as.data.frame(hits)
  names(hit_list) <- c("bins", "rec_bins")
  rmap2$rec_bins <- 1:nrow(rmap2)
  rec_bins <- merge(rmap2, hit_list) %>% group_by(bins) %>% mutate(avg_rec=weighted.mean(r, end-start))
  rec_bins <- rec_bins %>% distinct(bins, .keep_all=T)
  
  # binning mutation maps
  mmap2 <- mmap
  mmap2$start <- mmap2$start + 1 # so that GRanges understands the intervals -> NOT in BEDGRAPH format
  mut_gr <- makeGRangesFromDataFrame(mmap2, keep.extra.columns=T)
  hits <- findOverlaps(query=gr_bins, subject=mut_gr) 
  hit_list <- as.data.frame(hits)
  names(hit_list) <- c("bins", "mut_bins")
  mmap2$mut_bins <- 1:nrow(mmap2)
  mut_bins <- merge(mmap2, hit_list) %>% group_by(bins) %>% mutate(avg_mut=weighted.mean(u, end-start))
  mut_bins <- mut_bins %>% distinct(bins, .keep_all=T)
  
  # binning DFE
  intervals2 <- intervals
  intervals2$start <- intervals2$start + 1 # so that GRanges understands the intervals -> NOT in BEDGRAPH format
  dfe_gr <- makeGRangesFromDataFrame(intervals2, keep.extra.columns=T)
  hits <- findOverlaps(query=gr_bins, subject=dfe_gr) 
  hit_list <- as.data.frame(hits)
  names(hit_list) <- c("bins", "dfe")
  intervals2$dfe <- 1:nrow(intervals2)
  # NOTE: avg_s encompasses local density of constrained sites
  dfe_bins <- merge(intervals2, hit_list) %>% group_by(bins) %>% mutate(avg_s=weighted.mean(s, end-start)) 
  dfe_bins <- dfe_bins %>% distinct(bins, .keep_all=T)
  
  maps_1kb <- bind_cols(bins, rec_bins["avg_rec"], mut_bins["avg_mut"], dfe_bins["avg_s"])
  
  # pre-computes recombination distances between sampled neutral sites and exons, taking into account strength of selection
  cr_samp <- pos_dt[position %in% samp_pos,]
  cr_exons <- pos_dt[position %in% (dt_exons$start + 50),]
  prd <- as.data.frame(2 * N * abs(outer(cr_samp$cumrec, cr_exons$cumrec, "-"))) # pairwise rho
  names(prd) <- 1:ncol(prd)
  erd <- prd # "effective" rec. distance is inversely proportional to alpha
  for(j in 1:ncol(erd)) { erd[,j] <- erd[,j] / abs(2 * N * dt_exons$s[j]) }
  relevant_exons <- apply(erd, 2, function(x) x < 10 * N * 1e-3)
  exons_per_samp_neut <- apply(relevant_exons, 1, function(x) which(x))

  getB <- function(focal_exon, focal_neutral) { 
    focal_s <- dt_exons[focal_exon,]$s
    total_r <- prd[focal_neutral, focal_exon] / (2 * N)
    # the grid on r is fine-grained enough that we don't need interpolation
    closest_r <- dt_r[dt_r[.(total_r), roll="nearest", which=T]]
    hr <- lookup_tbl[.(closest_r, focal_s)]$Hr
    return((hr / (2 * N * u)) ^ 100)
  }
  system.time({
  # we finally get the B-values per sampled site!
  B_values <- numeric(length=length(exons_per_samp_neut))
  pb <- txtProgressBar(min=1, max=length(exons_per_samp_neut), style=3)
  for(j in 1:length(exons_per_samp_neut)) {
    setTxtProgressBar(pb, j)
    if(length(exons_per_samp_neut[[j]]) > 0) {
       B <- unlist(lapply(exons_per_samp_neut[[j]], getB, focal_neutral=j))
       B_values[j] <- cumprod(B)[length(B)]
    }
    else {
      B_values[j] <- 1
    }
  }
  close(pb)
  })
  # using max rec distance (r==1e-2) to check validity of threshold used above
  rex <- apply(prd, 2, function(x) x < 4 * N * 1e-2)
  ex400 <- apply(rex, 1, function(x) which(x))
  
  Bl400 <- unlist(lapply(ex400[[1]], getB, focal_neutral=1))
  Bq400 <- unlist(lapply(ex400[[length(samp_pos)/4]], getB, focal_neutral=length(samp_pos)/4))
  Bm400 <- unlist(lapply(ex400[[length(samp_pos)/2]], getB, focal_neutral=length(samp_pos)/2))
  
  Blr <- unlist(lapply(exons_per_samp_neut[[1]], getB, focal_neutral=1))
  Bqr <- unlist(lapply(exons_per_samp_neut[[length(samp_pos)/4]], getB, focal_neutral=length(samp_pos)/4))
  Bmr <- unlist(lapply(exons_per_samp_neut[[length(samp_pos)/2]], getB, focal_neutral=length(samp_pos)/2))
  
  xl <- cbind.data.frame(as.numeric(prd[1, as.numeric(names(Bl400))]), Bl400)
  xq <- cbind.data.frame(as.numeric(prd[1, as.numeric(names(Bq400))]), Bq400)
  xm <- cbind.data.frame(as.numeric(prd[1, as.numeric(names(Bm400))]), Bm400)
  
  names(xl) <- c("rec", "B")
  names(xq) <- c("rec", "B")
  names(xm) <- c("rec", "B")
  
  xl$CummBval <- cumprod(xl$B)
  xq$CummBval <- cumprod(xq$B)
  xm$CummBval <- cumprod(xm$B)
    
  xl$relevant <- xl$B %in% Blr
  xq$relevant <- xq$B %in% Bqr
  xm$relevant <- xm$B %in% Bmr
  
  pl <- ggplot(data=xl, aes(x=rec, y=B, color=relevant))
  pl <- pl + geom_point() + theme_bw()
  pl <- pl + scale_y_log10()
  pl <- pl + labs(title="B-values Left", x=NULL, y=NULL)
  pl <- pl + theme(axis.title=element_text(size=16),
                   axis.text=element_text(size=12),
                   axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                   legend.position="none")
  
  pq <- ggplot(data=xq, aes(x=rec, y=B, color=relevant))
  pq <- pq + geom_point() + theme_bw()
  pq <- pq + scale_y_log10()
  pq <- pq + labs(title="B-values 1/4 chr", x=NULL, y=NULL)
  pq <- pq + theme(axis.title=element_text(size=16),
                   axis.text=element_text(size=12),
                   axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                   legend.position="none")
  
  pm <- ggplot(data=xm, aes(x=rec, y=B, color=relevant))
  pm <- pm + geom_point() + theme_bw()
  pm <- pm + scale_y_log10()
  pm <- pm + labs(title="B-values 1/2 chr", x=NULL, y=NULL)
  pm <- pm + theme(axis.title=element_text(size=16),
                   axis.text=element_text(size=12),
                   axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                   legend.position="none")
      
  ql <- ggplot(data=xl, aes(x=rec, y=CummBval, color=relevant))
  ql <- ql + geom_point() + theme_bw()
  ql <- ql + scale_y_log10(limits=c(min(xl$CummBval), 1))
  ql <- ql + labs(title="Cumm. B-value, Left", x="Cummulative Rho", y="B")
  ql <- ql + theme(axis.title=element_text(size=16),
                   axis.text=element_text(size=12),
                   axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                   legend.position="bottom")
  
  qq <- ggplot(data=xq, aes(x=rec, y=CummBval, color=relevant))
  qq <- qq + geom_point() + theme_bw()
  qq <- qq + scale_y_log10()
  qq <- qq + labs(title="Cumm. B-value, 1/4 chr", x="Cummulative Rho", y="B")
  qq <- qq + theme(axis.title=element_text(size=16),
                   axis.text=element_text(size=12),
                   axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                   legend.position="bottom")
  
  qm <- ggplot(data=xm, aes(x=rec, y=CummBval, color=relevant))
  qm <- qm + geom_point() + theme_bw()
  qm <- qm + scale_y_log10()
  qm <- qm + labs(title="Cumm. B-value, 1/2 chr", x="Cummulative Rho", y="B")
  qm <- qm + theme(axis.title=element_text(size=16),
                   axis.text=element_text(size=12),
                   axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                   legend.position="bottom")
  
  cp <- plot_grid(pl, pq, pm, ql, qq, qm, nrow=2)
  save_plot(paste("~/Devel/momentspp/benchmarking/selection/single-pop/test_data/Bval_bench_m_", as.integer(i), ".png", sep=""), cp, base_height=10, base_width=12)
  
  # getting B-values per site can also take some time:
  B_map <- cubicspline(samp_pos, B_values, 1:L)
  
  # here it's easier to use mmap2 which has closed intervals:
  ones <- rep(1, L)
  pi0s <- invisible(apply(mmap2, 1, function(x) ones[as.numeric(x[2]):as.numeric(x[3])] * as.numeric(x[4]) * 2 * N))
  pis <- invisible(apply(mmap2, 1, function(x) B_map[as.numeric(x[2]):as.numeric(x[3])] * as.numeric(x[4]) * 2 * N))
  pi0s <- unlist(pi0s)
  pis <- unlist(pis)
  hrmap <- setDT(bind_cols(1:L, pis, pi0s))
  names(hrmap) <- c("Pos", "Hr", "pi0")
  setkey(hrmap, Pos)
  #fwrite(hrmap, paste("~/Devel/momentspp/benchmarking/selection/single-pop/test_data/hrmap_m", i, "_j_", jump_length, ".csv", sep=""))
  
  seg <- filter(dt_exons, start >= 0, end <= 1e+6)
  wsize <- seg$end[nrow(seg)] - seg$start[1]
  exons_barcode <- ggplot(data=seg) + geom_segment(aes(x=start, xend=end, y=1, yend=1, size=3, color=s)) + theme_void() 
  exons_barcode <- exons_barcode + theme(axis.title=element_blank(),
                                         axis.text=element_blank(),
                                         axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank(),
                                         axis.ticks.y=element_blank(),
                                         axis.text.y=element_blank(),
                                         legend.position="none")
  
  molten_div <- pivot_longer(hrmap, cols=c("Hr", "pi0"), names_to="Var")
  ppi <- ggplot(data=molten_div[1:seg$end[nrow(seg)],], aes(x=Pos, y=value, color=Var))
  ppi <- ppi + geom_line(size=1.05) + theme_bw()
  ppi <- ppi + scale_y_log10() 
  ppi <- ppi + scale_color_discrete(type=c("plum3", "seagreen3"), name=NULL, labels=c(expression(pi), expression(pi[0])))
  ppi <- ppi + labs(title=paste("Diversity of a ", wsize, "-bp window of model ", i, sep=""), x=NULL, y="Pairwise Diversity")
  ppi <- ppi + theme(axis.title=element_text(size=16),
                     axis.text=element_text(size=12),
                     axis.ticks.x=element_blank(),
                     axis.text.x=element_blank(),
                     legend.position="top")
  ppi2 <- plot_grid(ppi, exons_barcode, ncol=1, align='v', axis='l', rel_heights=c(1, 0.1))
  save_plot(paste("~/Devel/momentspp/benchmarking/selection/single-pop/test_data/pi_m", i, ".pdf", sep=""), ppi2, base_height=10, base_width=12) 
  
  hrmap$bin <- ((hrmap$Pos - 1) %/% bin_size)
  hrmap <- hrmap[1:maps_1kb$end[nrow(maps_1kb)],]# trims the tail for convenience
  avgs <- hrmap %>% group_by(bin) %>% summarize(avg_pi=mean(Hr), avg_pi0=mean(pi0))
  maps_1kb$avg_pi <- avgs$avg_pi
  maps_1kb$bin <- 1:nrow(maps_1kb)

  # standardizing
  maps_1kb$std_s <- (maps_1kb$avg_s - mean(maps_1kb$avg_s)) / sd(maps_1kb$avg_s)
  maps_1kb$std_mu <- (maps_1kb$avg_mut - mean(maps_1kb$avg_mut)) / sd(maps_1kb$avg_mut)
  maps_1kb$std_r <- (maps_1kb$avg_rec - mean(maps_1kb$avg_rec)) / sd(maps_1kb$avg_rec)
  maps_1kb$std_pi <- (maps_1kb$avg_pi - mean(maps_1kb$avg_pi)) / sd(maps_1kb$avg_pi)
  
  m_1kb_1 <- lm(std_pi ~ std_mu + std_r + std_s + std_r:std_s, data=maps_1kb)
  m_1kb_2 <- lm(std_pi ~ std_mu + std_r, data=maps_1kb)
  
  summary(m_1kb_1)
  summary(m_1kb_2)
  
  comp <- AIC(m_1kb_1, m_1kb_2) # model comparison
  
  anova.pi <- Anova(m_1kb_1)
  apiss <- anova.pi$"Sum Sq"
  anova.pi$VarExp <- apiss / sum(apiss)

  r2_tbl_1kb$Total[i] <- (anova.pi$VarExp[1] + anova.pi$VarExp[2] + anova.pi$VarExp[3] + anova.pi$VarExp[4] + anova.pi$VarExp[5]) * 100
  r2_tbl_1kb$u[i] <- anova.pi$VarExp[1] * 100
  r2_tbl_1kb$r[i] <- anova.pi$VarExp[2] * 100
  r2_tbl_1kb$s[i] <- anova.pi$VarExp[3] * 100
  r2_tbl_1kb$`r:s`[i] <- anova.pi$VarExp[4] * 100
  
  # builds maps at larger genomic scales
  maps_1kb$bin_10kb <- ((maps_1kb$bin - 1) %/% 10)
  maps_1kb$bin_100kb <- ((maps_1kb$bin - 1) %/% 100)
  maps_10kb <- maps_1kb %>% group_by(bin_10kb) %>% summarise_at(c("std_pi", "std_s", "std_mu", "std_r", "avg_pi", "avg_s", "avg_mut", "avg_rec"), mean)
  maps_100kb <- maps_1kb %>% group_by(bin_100kb) %>% summarise_at(c("std_pi", "std_s", "std_mu", "std_r", "avg_pi", "avg_s", "avg_mut", "avg_rec"), mean)
  
  # 10 kb
  m_10kb_1 <- lm(std_pi ~ std_mu + std_r + std_s + std_r:std_s, data=maps_10kb)
  m_10kb_2 <- lm(std_pi ~ std_mu + std_r, data=maps_10kb)
  
  summary(m_10kb_1)
  summary(m_10kb_2)
  
  AIC(m_10kb_1, m_10kb_2) # model comparison
  
  anova.pi <- Anova(m_10kb_1)
  apiss <- anova.pi$"Sum Sq"
  anova.pi$VarExp <- apiss / sum(apiss)

  r2_tbl_10kb$Total[i] <- (anova.pi$VarExp[1] + anova.pi$VarExp[2] + anova.pi$VarExp[3] + anova.pi$VarExp[4] + anova.pi$VarExp[5]) * 100
  r2_tbl_10kb$u[i] <- anova.pi$VarExp[1] * 100
  r2_tbl_10kb$r[i] <- anova.pi$VarExp[2] * 100
  r2_tbl_10kb$s[i] <- anova.pi$VarExp[3] * 100
  r2_tbl_10kb$`r:s`[i] <- anova.pi$VarExp[4] * 100
  
  # 100 kb
  m_100kb_1 <- lm(std_pi ~ std_mu + std_r + std_s + std_r:std_s, data=maps_100kb)
  m_100kb_2 <- lm(std_pi ~ std_mu + std_r, data=maps_100kb)
  
  summary(m_100kb_1)
  summary(m_100kb_2)
  
  AIC(m_100kb_1, m_100kb_2) # model comparison
  
  anova.pi <- Anova(m_100kb_1)
  apiss <- anova.pi$"Sum Sq"
  anova.pi$VarExp <- apiss / sum(apiss)

  r2_tbl_100kb$Total[i] <- (anova.pi$VarExp[1] + anova.pi$VarExp[2] + anova.pi$VarExp[3] + anova.pi$VarExp[4] + anova.pi$VarExp[5]) * 100
  r2_tbl_100kb$u[i] <- anova.pi$VarExp[1] * 100
  r2_tbl_100kb$r[i] <- anova.pi$VarExp[2] * 100
  r2_tbl_100kb$s[i] <- anova.pi$VarExp[3] * 100
  r2_tbl_100kb$`r:s`[i] <- anova.pi$VarExp[4] * 100
  
  # plots
  pi_1kb <- ggplot(data=maps_1kb, aes(x=(bin -1) * 1e+4, y=avg_pi))
  pi_1kb <- pi_1kb + geom_line(data=maps_1kb) + theme_bw()
  pi_1kb <- pi_1kb + scale_y_continuous(breaks=pretty_breaks(), labels=scale.4d)
  pi_1kb <- pi_1kb + labs(title="1 kb", x=NULL, y=expression(pi)) 
  pi_1kb <- pi_1kb + theme(axis.title.x=element_text(size=16),
                           axis.text.x=element_blank(),
                           axis.text.y=element_text(size=12),
                           axis.title.y=element_text(size=16),
                           plot.title=element_text(size=20), legend.position = "none") 
  
  u_1kb <- ggplot(data=maps_1kb, aes(x=(bin -1) * 1e+4, y=avg_mut))
  u_1kb <- u_1kb + geom_line(data=maps_1kb) + theme_bw()
  u_1kb <- u_1kb + scale_y_continuous(breaks=pretty_breaks(), labels=scientific)
  u_1kb <- u_1kb + labs(title=NULL, x=NULL, y=expression(mu)) 
  u_1kb <- u_1kb + theme(axis.title.x=element_text(size=16),
                         axis.text.x=element_blank(),
                         axis.text.y=element_text(size=12),
                         axis.title.y=element_text(size=16),
                         plot.title=element_text(size=20), legend.position="none")
  
  s_1kb <- ggplot(data=maps_1kb, aes(x=(bin -1) * 1e+4, y=avg_s))
  s_1kb <- s_1kb + geom_line(data=maps_1kb) + theme_bw()
  s_1kb <- s_1kb + scale_y_continuous(breaks=pretty_breaks(), labels=scientific)
  s_1kb <- s_1kb + labs(title=NULL, x=NULL, y="s") 
  s_1kb <- s_1kb + theme(axis.title.x=element_text(size=16),
                         axis.text.x=element_blank(),
                         axis.text.y=element_text(size=12),
                         axis.title.y=element_text(size=16),
                         plot.title=element_text(size=20), legend.position="none")
  
  r_1kb <- ggplot(data=maps_1kb, aes(x=(bin -1) * 1e+4, y=avg_rec))
  r_1kb <- r_1kb + geom_line(data=maps_1kb) + theme_bw()
  r_1kb <- r_1kb + scale_y_continuous(breaks=pretty_breaks(), labels=scientific)
  r_1kb <- r_1kb + labs(title=NULL, x="Position", y="r") 
  r_1kb <- r_1kb + theme(axis.title.x=element_text(size=16),
                         axis.text.x=element_text(size=12),
                         axis.text.y=element_text(size=12),
                         axis.title.y=element_text(size=16),
                         plot.title=element_text(size=20), legend.position="none")

  lands_1kb <- plot_grid(pi_1kb, u_1kb, s_1kb, r_1kb, align='v', ncol=1)
  
  # 10 kb
  pi_10kb <- ggplot(data=maps_10kb, aes(x=(bin_10kb -1) * 1e+5, y=avg_pi))
  pi_10kb <- pi_10kb + geom_line(data=maps_10kb) + theme_bw()
  pi_10kb <- pi_10kb + scale_y_continuous(breaks=pretty_breaks(), labels=scale.4d)
  pi_10kb <- pi_10kb + labs(title="10 kb", x=NULL, y=NULL) 
  pi_10kb <- pi_10kb + theme(axis.title.x=element_text(size=16),
                             axis.text.x=element_blank(),
                             axis.text.y=element_blank(),
                             plot.title=element_text(size=20), legend.position = "none") 
  
  u_10kb <- ggplot(data=maps_10kb, aes(x=(bin_10kb -1) * 1e+5, y=avg_mut))
  u_10kb <- u_10kb + geom_line(data=maps_10kb) + theme_bw()
  u_10kb <- u_10kb + scale_y_continuous(breaks=pretty_breaks(), labels=scientific)
  u_10kb <- u_10kb + labs(title=NULL, x=NULL, y=NULL) 
  u_10kb <- u_10kb + theme(axis.title.x=element_text(size=16),
                           axis.text.x=element_blank(),
                           axis.text.y=element_blank(),
                           plot.title=element_text(size=20), legend.position="none")
  
  s_10kb <- ggplot(data=maps_10kb, aes(x=(bin_10kb -1) * 1e+5, y=avg_s))
  s_10kb <- s_10kb + geom_line(data=maps_10kb) + theme_bw()
  s_10kb <- s_10kb + scale_y_continuous(breaks=pretty_breaks(), labels=scientific)
  s_10kb <- s_10kb + labs(title=NULL, x=NULL, y=NULL) 
  s_10kb <- s_10kb + theme(axis.title.x=element_text(size=16),
                           axis.text.x=element_blank(),
                           axis.text.y=element_blank(),
                           plot.title=element_text(size=20), legend.position="none")
  
  r_10kb <- ggplot(data=maps_10kb, aes(x=(bin_10kb -1) * 1e+5, y=avg_rec))
  r_10kb <- r_10kb + geom_line(data=maps_10kb) + theme_bw()
  r_10kb <- r_10kb + scale_y_continuous(breaks=pretty_breaks(), labels=scientific)
  r_10kb <- r_10kb + labs(title=NULL, x="Position", y=NULL) 
  r_10kb <- r_10kb + theme(axis.title.x=element_text(size=16),
                           axis.text.x=element_text(size=12),
                           axis.text.y=element_blank(),
                           plot.title=element_text(size=20), legend.position="none")

  lands_10kb <- plot_grid(pi_10kb, u_10kb, s_10kb, r_10kb, align='v', ncol=1)
  
  # 100 kb
  pi_100kb <- ggplot(data=maps_100kb, aes(x=(bin_100kb -1) * 1e+6, y=avg_pi))
  pi_100kb <- pi_100kb + geom_line(data=maps_100kb) + theme_bw()
  pi_100kb <- pi_100kb + scale_y_continuous(breaks=pretty_breaks(), labels=scale.4d)
  pi_100kb <- pi_100kb + labs(title="100 kb", x=NULL, y=NULL) 
  pi_100kb <- pi_100kb + theme(axis.title.x=element_text(size=16),
                               axis.text.x=element_blank(),
                               axis.text.y=element_blank(),
                               plot.title=element_text(size=20), legend.position="none") 
  
  u_100kb <- ggplot(data=maps_100kb, aes(x=(bin_100kb -1) * 1e+6, y=avg_mut))
  u_100kb <- u_100kb + geom_line(data=maps_100kb) + theme_bw()
  u_100kb <- u_100kb + scale_y_continuous(breaks=pretty_breaks(), labels=scientific)
  u_100kb <- u_100kb + labs(title=NULL, x=NULL, y=NULL) 
  u_100kb <- u_100kb + theme(axis.title.x=element_text(size=16),
                             axis.text.x=element_blank(),
                             axis.text.y=element_blank(),
                             plot.title=element_text(size=20), legend.position="none")
  
  s_100kb <- ggplot(data=maps_100kb, aes(x=(bin_100kb -1) * 1e+6, y=avg_s))
  s_100kb <- s_100kb + geom_line(data=maps_100kb) + theme_bw()
  s_100kb <- s_100kb + scale_y_continuous(breaks=pretty_breaks(), labels=scientific)
  s_100kb <- s_100kb + labs(title=NULL, x=NULL, y=NULL) 
  s_100kb <- s_100kb + theme(axis.title.x=element_text(size=16),
                             axis.text.x=element_blank(),
                             axis.text.y=element_blank(),
                             plot.title=element_text(size=20), legend.position="none")
  
  r_100kb <- ggplot(data=maps_100kb, aes(x=(bin_100kb -1) * 1e+6, y=avg_rec))
  r_100kb <- r_100kb + geom_line(data=maps_100kb) + theme_bw()
  r_100kb <- r_100kb + scale_y_continuous(breaks=pretty_breaks(), labels=scientific)
  r_100kb <- r_100kb + labs(title=NULL, x="Position", y=NULL) 
  r_100kb <- r_100kb + theme(axis.title.x=element_text(size=16),
                             axis.text.x=element_text(size=12),
                             axis.text.y=element_blank(),
                             plot.title=element_text(size=20), legend.position="none")

  lands_100kb <- plot_grid(pi_100kb, u_100kb, s_100kb, r_100kb, align='v', ncol=1)
  
  lands_scales <- plot_grid(lands_1kb, lands_10kb, lands_100kb, nrow=1)
  save_plot(paste("~/Devel/momentspp/benchmarking/selection/single-pop/test_data/m", i, "_maps.png", sep=""), lands_scales, base_height=12, base_width=16)
}

fwrite(r2_tbl_1kb, "~/Devel/momentspp/benchmarking/selection/single-pop/test_data/r2_1kb.csv")
fwrite(r2_tbl_10kb, "~/Devel/momentspp/benchmarking/selection/single-pop/test_data/r2_10kb.csv")
fwrite(r2_tbl_100kb, "~/Devel/momentspp/benchmarking/selection/single-pop/test_data/r2_100kb.csv")

```

# Selection 2-populations

## No-migration

### Building Demes files

This first set of model is meant to visualize statistics for two populations,
potentially with different selective coefficients between them

```{r, demes-selected-2-pop, include=F, eval=F, results=F, message=F, warning=F}

N1 <- 10000
N2 <- c(N1, N1 / 10)
u <- 1e-8
r  <- c(1e-5, 1e-6, 1e-7, 0)
s1 <- c(0, -1e-04, -1e-3)
s2 <- c(0, -1e-04, -1e-3)
sanc <- c(0, -1e-3)
split_time <- c(400, 2000) # in generations

params <- crossing(N1, N2, u, r, s1, s2, sanc, split_time)
params$scenario <- 1:nrow(params)
n_models <- nrow(params)

write.csv(params, "selection/no_migration/params.csv", quote=F, row.names=F)

Sys.setenv(num_models=n_models)

py$params <- params # stores df to be used in python sections
py$n_models <- as.integer(n_models + 1) # because python is indexed from zero

for(i in 1:n_models) {
  
  name <- paste("model_", i, sep="")
  sink(paste("selection/no_migration/", name, ".yaml", sep=""))
  
  cat("time_units: generations\n")
  cat("demes:\n")
  cat("  - name: X\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(params$split_time[i])
  cat("\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: A\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N1[i])
  cat("\n")
  cat("  - name: B\n")
  cat("    ancestors: [X]\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        start_size: ")
  cat(params$N2[i])
  cat("\n")
  cat("metadata:\n")
  cat("  - name: mutation\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$u[i])
  cat("]\n")
  cat("  - name: recombination\n")
  cat("    epochs:\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$r[i])
  cat("]\n")
  cat("  - name: selection\n")
  cat("    start_time: .inf\n")
  cat("    epochs:\n")
  cat("      - end_time: ")
  cat(params$split_time[i])
  cat("\n")
  cat("        rates: [")
  cat(params$sanc[i])
  cat("]\n")
  cat("      - end_time: 0\n")
  cat("        rates: [")
  cat(params$s1[i])
  cat(", ")
  cat(params$s2[i])
  cat("]\n")
  
  sink()
}

```

### Running moments++

```{bash run-moments++-2-pops, engine.opts='-i', include=F, eval=F, results=F, message=F, warning=F}

source ~/.bashrc

cd selection/no_migration

for((i=1;i<=$num_models;i++))
do
  momentspp params=opt.bpp FILE=model_$i.yaml LABEL=model_$i ORDER=25
done

cd ../..
```

### Plots 

TODO assimilate split time into plots

```{r, plots-selected-2-pop, include=T, eval=F, results=F, message=F, warning=F}

core_stats <- c("DD_1_1", 
                "DD_1_2", 
                "DD_2_2",
                "Dr_1_1_(1-2p1)^1",
                "Dr_1_1_(1-2p2)^1",
                "Dr_1_2_(1-2p2)^1",
                "Dr_2_1_(1-2p1)^1", 
                "Dr_2_1_(1-2p2)^1",
                "Dr_2_2_(1-2p2)^1",
                "Hl_1_1", 
                "Hl_1_2",
                "Hl_2_1",
                "Hl_2_2",
                "Hr_1_1", 
                "Hr_1_2",
                "Hr_2_2",
                "pi2_1_1_1_1", 
                "pi2_1_1_1_2",
                "pi2_1_1_2_2", 
                "pi2_1_2_1_2", 
                "pi2_1_2_2_2", 
                "pi2_2_1_1_2", 
                "pi2_2_2_1_1",
                "pi2_2_2_2_2")

# to be on the very safe side...
core_stats <- sort(core_stats)

expectation <- numeric()
for(i in 1:n_models) {
  vals <- read.table(paste("selection/no_migration/model_", i, "_expectations.txt", sep=""))
  vals <- subset(vals, V1 %in% core_stats)
  expectation <- c(expectation, vals$V3)
}

tbl <- as.data.frame(expectation)
tbl$stats <- core_stats
scenario <- NULL
for(i in 1:n_models) { 
  scenario <- c(scenario, rep(i, length(core_stats)))
}
tbl$scenario <- scenario

df <- full_join(tbl, params, by="scenario")

# transforms variables
df$alpha_1 <- 2 * df$s1 * df$N1
df$alpha_2 <- 2 * df$s2 * df$N2

# symmetric population sizes
df_sym_N <- df[df$N1==df$N2,]
df_sym_N[df_sym_N$r==0,]$r <- 1e-12 # for log transformation

# pi2 within
pa1 <- ggplot(data=subset(filter(df_sym_N, stats %in% c("pi2_1_1_1_1", "pi2_2_2_2_2")), sanc == 0), aes(x=r, y=expectation, color=stats)) 
pa1 <- pa1 + geom_point(size=3, shape=0) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pa1 <- pa1 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pa1 <- pa1 + scale_y_log10(breaks=c(1e-6, 2e-6, 3e-6, 4e-6, 5e-6))
pa1 <- pa1 + scale_shape_manual(values=c(0))
pa1 <- pa1 + scale_color_brewer(palette="Dark2")
pa1 <- pa1 + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pa1 <- pa1 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pa1
save_plot("selection/no_migration/pi2_within_no-mig.png", pa1, base_height=12, base_width=12)

# pi2 cross-pop
pa2 <- ggplot(data=subset(filter(df_sym_N, stats %in% c("pi2_1_1_1_2", "pi2_1_1_2_2", "pi2_1_2_1_2", "pi2_2_1_1_2", "pi2_1_2_2_2", "pi2_2_2_1_1")), sanc == 0),
              aes(x=r, y=expectation, color=stats)) 
pa2 <- pa2 + geom_point(size=3, shape=0) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pa2 <- pa2 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pa2 <- pa2 + scale_y_log10(breaks=c(1e-6, 2e-6, 3e-6, 4e-6, 5e-6, 1e-5))
pa2 <- pa2 + scale_color_brewer(palette="Dark2")
pa2 <- pa2 + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pa2 <- pa2 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pa2
save_plot("selection/no_migration/pi2_cross_no-mig.png", pa2, base_height=12, base_width=12)

# Dr
pb <- ggplot(data=subset(filter(df_sym_N, str_detect(stats, "^Dr")), sanc == 0), aes(x=r, y=expectation, color=stats)) 
pb <- pb + geom_point(size=3, shape=0) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pb <- pb + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pb <- pb + scale_color_brewer(palette="Dark2")
pb <- pb + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pb <- pb + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pb
save_plot("selection/no_migration/Dr_no-mig.png", pd, base_height=12, base_width=12)

# Hets
pc <- ggplot(data=subset(filter(df_sym_N, str_detect(stats, "^H")), sanc == 0), aes(x=r, y=expectation, color=stats)) 
pc <- pc + geom_point(size=3, shape=0) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pc <- pc + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pc <- pc + scale_y_log10(breaks=pretty_breaks())
pc <- pc + scale_color_brewer(palette="Dark2")
pc <- pc + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pc <- pc + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pc
save_plot("selection/no_migration/Hets_no-mig.png", pd, base_height=12, base_width=12)

# Hr
pd <- ggplot(data=filter(df_sym_N, stats %in% c("Hr_1_1", "Hr_2_2")), aes(x=r, y=expectation, color=stats, shape=as.factor(sanc))) 
pd <- pd + geom_point(size=3) + geom_line() + theme_bw() + facet_grid(+alpha_1~alpha_2)
pd <- pd + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
pd <- pd + scale_y_log10(breaks=pretty_breaks())
pd <- pd + scale_color_brewer(palette="Dark2")
pd <- pd + scale_shape_manual(values=c(0, 1))
pd <- pd + labs(title="Symmetric Population Sizes", x="r", y="Expectation")
pd <- pd + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pd
save_plot("selection/no_migration/Hr_no-mig.png", pd, base_height=12, base_width=12)

# Hl
pe <- ggplot(data=subset(filter(df_sym_N, str_detect(stats, "^Hl")), sanc == 0), aes(x=alpha_1, y=expectation, color=stats, shape=as.factor(alpha_2))) 
pe <- pe + geom_point(size=3) + geom_line() + theme_bw() #+ facet_wrap(~alpha_2, nrow=1)
pe <- pe + scale_y_log10(breaks=pretty_breaks())
pe <- pe + scale_color_brewer(palette="Dark2")
pe <- pe + scale_shape_manual(values=0:length(levels(as.factor(df_sym_N$alpha_2))))
pe <- pe + labs(title="Symmetric Population Sizes", x="alpha_1", y="Expectation")
pe <- pe + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
pe
save_plot("selection/no_migration/Hl_no-mig.png", pe, base_height=12, base_width=12)

pf <- plot_ly(data=subset(filter(df_sym_N, stats %in% c("Hl_1_2", "Hl_2_1")), sanc == 0), x=~alpha_1, y=~alpha_2, z=~expectation, type="scatter3d", 
              mode="markers", color=~stats)
pf

# D1D2
d1d2 <- filter(df_sym_N, stats %in% "DD_1_2") 
d1d2$ratio <- d1d2$expectation / subset(df_sym_N, stats %in% "pi2_1_2_1_2")$expectation

# save ratio D1D2/ pi2_1212 for later, plot D1D2 expectation now
p1 <- ggplot(data=d1d2, aes(x=r, y=expectation, shape=as.factor(sanc))) + facet_grid(+alpha_1~alpha_2)
p1 <- p1 + geom_point(size=3) + geom_line() + theme_bw()
p1 <- p1 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
p1 <- p1 + scale_y_log10(breaks=c(5e-8, 1e-7, 2e-7, 5e-7, 1e-6))
p1 <- p1 + scale_shape_manual(values=c(0, 1))
p1 <- p1 + labs(title="Symmetric Population Sizes", x="r", y="E[D1D2]")
p1 <- p1 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p1
save_plot("selection/no_migration/Covar_D_no-mig_1.png", p1, base_height=12, base_width=12)

d1d2 <- d1d2[d1d2$alpha_1==d1d2$alpha_2,] # symmetric alpha

p2 <- ggplot(data=d1d2, aes(x=alpha_1, y=expectation, color=as.factor(r), shape=as.factor(sanc)))
p2 <- p2 + geom_point(size=3) + geom_line() + theme_bw()
p2 <- p2 + scale_color_brewer(palette="Dark2")
p2 <- p2 + scale_shape_manual(values=c(0, 1))
p2 <- p2 + scale_y_log10(breaks=c(1e-7, 2e-7, 4e-7, 6e-7, 1e-6))
p2 <- p2 + labs(title="Symmetric Population Sizes and Selection coefficients", x="2Ns", y="E[D1D2]")
p2 <- p2 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p2
save_plot("selection/no_migration/Covar_D_no-mig_2.png", p2, base_height=12, base_width=12)

# Hr
hr11 <- subset(df_sym_N, stats %in% "Hr_1_1") 

p3 <- ggplot(data=hr11, aes(x=r, y=expectation * 1e+3, color=as.factor(alpha_1), shape=as.factor(sanc)))
p3 <- p3 + geom_point(size=3) + geom_line() + theme_bw()
p3 <- p3 + scale_color_brewer(palette="Dark2")
p3 <- p3 + scale_shape_manual(values=c(0, 1))
p3 <- p3 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4))
p3 <- p3 + scale_y_log10(breaks=pretty_breaks())
p3 <- p3 + labs(title="Symmetric Population Sizes", x="r", y="E[Hr_11] (x 10^-3)")
p3 <- p3 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p3
save_plot("selection/no_migration/Hr_11.png", p3, base_height=12, base_width=12)

# Fst at the Left Locus
Hl_12 <- subset(df_sym_N, stats %in% "Hl_1_2")
Hl_21 <- subset(df_sym_N, stats %in% "Hl_2_1")
Hl_11 <- subset(df_sym_N, stats %in% "Hl_1_1")
Hl_22 <- subset(df_sym_N, stats %in% "Hl_2_2")

pi_between <- (Hl_12$expectation + Hl_21$expectation) / 2 
pi_within <- (Hl_11$expectation + Hl_22$expectation) / 2 

fst <- Hl_12 # just to copy the data frame
fst$expectation <- 1 - pi_within / pi_between # we'll be looking at this one

p4 <- plot_ly(data=fst, x=~alpha_1, y=~alpha_2, z=~expectation, type="scatter3d", 
              mode="markers", color=~expectation)
p4

# Fst at the Right Locus
Hr_12 <- subset(df_sym_N, stats %in% "Hr_1_2")
#Hr_21 <- subset(df_sym_N, stats %in% "Hr_2_1")
Hr_11 <- subset(df_sym_N, stats %in% "Hr_1_1")
Hr_22 <- subset(df_sym_N, stats %in% "Hr_2_2")

pi_between <- Hr_12$expectation #(Hr_12$expectation + Hr_21$expectation) / 2 
pi_within <- (Hr_11$expectation + Hr_22$expectation) / 2 

fst <- Hr_12
fst$expectation <- 1 - pi_within / pi_between

p5 <- ggplot(data=fst, aes(x=r, y=expectation, shape=as.factor(sanc))) + facet_grid(+alpha_1~alpha_2)
p5 <- p5 + geom_point(size=3) + geom_line() + theme_bw()
p5 <- p5 + scale_shape_manual(values=c(0, 1))
p5 <- p5 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
p5 <- p5 + scale_y_log10(breaks=pretty_breaks())
p5 <- p5 + labs(title="Symmetric Population Sizes", x="r", y="Fst neutral locus")
p5 <- p5 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")

save_plot("selection/no_migration/Fst_no-mig_right_2.png", p5, base_height=12, base_width=12)

fst <- fst[fst$alpha_1==fst$alpha_2,]

p6 <- ggplot(data=fst, aes(x=alpha_1, y=expectation, color=as.factor(r), shape=as.factor(sanc)))
p6 <- p6 + geom_point(size=3) + geom_line() + theme_bw()
p6 <- p6 + scale_color_brewer(palette="Dark2")
p6 <- p6 + scale_shape_manual(values=c(0, 1))
p6 <- p6 + scale_y_log10(breaks=pretty_breaks())
p6 <- p6 + labs(title="Symmetric Population Sizes and Selection coefficients", x="2Ns", y="Fst neutral locus")
p6 <- p6 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p6
save_plot("selection/no_migration/Fst_no-mig_right_1.png", p6, base_height=12, base_width=12)

# all population sizes
df_cpy <- df
df_cpy[df_cpy$r==0,]$r <- 1e-12 # for log transformation

# D1D2
d1d2 <- subset(df_cpy, stats %in% "DD_1_2") 
d1d2$ratio <- d1d2$expectation / subset(df_cpy, stats %in% "pi2_1_2_1_2")$expectation
  
p7 <- ggplot(data=d1d2, aes(x=r, y=expectation, color=as.factor(N2), shape=as.factor(sanc))) + facet_grid(+s1~s2)
p7 <- p7 + geom_point(size=3) + geom_line() + theme_bw()
p7 <- p7 + scale_color_brewer(palette="Dark2")
p7 <- p7 + scale_shape_manual(values=c(0, 1))
p7 <- p7 + scale_x_log10(breaks=c(1e-12, 1e-6, 1e-5, 1e-4, 1e-3))
p7 <- p7 + scale_y_log10(breaks=c(1e-7, 2e-7, 4e-7, 6e-7, 1e-6))
p7 <- p7 + labs(title="All Population Sizes", x="r", y="E[D1D2]")
p7 <- p7 + theme(axis.title=element_text(size=16),
                 axis.text=element_text(size=12),
                 axis.text.x=element_text(angle=90, size=12, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
p7
save_plot("selection/no_migration/Covar_D_no-mig_3.png", p7, base_height=12, base_width=12)

# Fst at the Left Locus
Hl_12 <- subset(df_cpy, stats %in% "Hl_1_2")
Hl_21 <- subset(df_cpy, stats %in% "Hl_2_1")
Hl_11 <- subset(df_cpy, stats %in% "Hl_1_1")
Hl_22 <- subset(df_cpy, stats %in% "Hl_2_2")

pi_between <- (Hl_12$expectation + Hl_21$expectation) / 2 
pi_within <- (Hl_11$expectation + Hl_22$expectation) / 2 

fst <- Hl_12 # just to copy the data frame
fst$expectation <- 1 - pi_within / pi_between # we'll be looking at this one

p8 <- plot_ly(data=fst, x=~s1, y=~s2, z=~expectation, type="scatter3d", mode="markers", color=~N2)
p8
```

## Migration (TODO)
