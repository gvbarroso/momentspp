---
title: "Benchmarking Moments++"
author: "Gustavo V. Barroso"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    number_sections: true
    toc_depth: 3
---

```{r setup, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

# for running moments.LD:
library(reticulate)
use_python("/usr/bin/python3")

knitr::opts_knit$set(root.dir="~/Devel/momentspp/benchmarking/")

save_plots <- FALSE # should this script ggsave plots to root.dir?
```

# Setting up scenarios to test (parameter combinations)
## 1 population parameters

```{r 1-pop-params, include=FALSE, message=FALSE, warning=FALSE}

r <- c(1e-8, 1e-7, 1e-6)
mu <- c(1e-8, 1e-7, 1e-6)
N <- c(1e+3, 1e+4, 1e+5)

params_1_pop <- crossing(N, mu, r) %>% arrange(N, mu, r)
print(params_1_pop, n=nrow(params_1_pop))
write.csv(params_1_pop, "params_1_pop.csv", quote=F, sep=",", row.names=F)
```

## 2 populations parameters

```{r 2-pops-params, include=FALSE, message=FALSE, warning=FALSE}

mu <- c(1e-7)
r <- c(0, 1e-6)
N_0 <- c(1e+4, 1e+5)
N_1 <- c(1e+5)
m_01 <- c(0, 1e-5)
m_10 <- c(1e-6, 1e-5)
num_epochs <- c(1)

num_gen_epoch_2 <- 5000
N_0_epoch_2 <- N_0 / 10
N_1_epoch_2 <- N_1 / 10

params_2_pop <- crossing(num_epochs, mu, r , m_01, m_10, N_0, N_1) 
params_2_pop <- mutate(params_2_pop, 
                       N_0_epoch_2 = case_when(num_epochs==1 ~ NA_real_,
                                               num_epochs==2 ~ (N_0 / 10)))
params_2_pop <- mutate(params_2_pop, 
                       N_1_epoch_2 = case_when(num_epochs==1 ~ NA_real_,
                                               num_epochs==2 ~ (N_1 / 10)))
params_2_pop <- mutate(params_2_pop, 
                       num_gen_epoch_2 = case_when(num_epochs==1 ~ NA_real_, 
                                                   num_epochs==2 ~ 5000))
print(params_2_pop, n=nrow(params_2_pop))
write.csv(params_2_pop, "params_2_pops.csv", sep=",", 
          quote=F, row.names=F, col.names=T)
```

# Running moments++

```{bash run-moments++, engine.opts='-i', include=FALSE}

source ~/.bashrc

# 1 population
input="params_1_pop.csv";
id=1 # line counter, scenario_id

{
  read # ignores header 
  while IFS=, read -r a b c; do
    momentspp params=opt_1.bpp i=$id N=$a u=$b r=$c
    ((id=id+1))
  done
} < "$input"

# 2 populations
input="params_2_pops.csv";
id=1 # line counter, scenario_id

{
  read # ignores header 
  while IFS=, read -r a b c d e f g h i j
  do
    momentspp params=opt_2.bpp i=$id epochs=$a N0=$f N1=$g m01=$d m10=$e u=$b r=$c
    ((id=id+1))
  done 
} < "$input"

```

# Running moments.LD

```{python run-momentsLD, include=TRUE}

import moments.LD
import numpy as np

#moments.LD.Util.moment_names(3)
#moments.LD.Matrices.admix_ld(3, 0, 1, 0.3)

moments.LD.Matrices.migration_ld(2, [[0, 1], [0, 0]]).todense()
moments.LD.Matrices.migration_ld(2, [[0, 0], [1, 0]]).todense()

moments.LD.Matrices.drift_ld(2, [1, np.inf]).todense()
moments.LD.Matrices.drift_ld(2, [np.inf, 1]).todense()

with open("params_1_pop.csv") as fin:
    params = fin.readlines()
  
p_names = params[0].strip().split(",")

with open("moments_LD_1_pop_out.csv", "w+") as fout:
    stats = moments.LD.Util.moment_names(1)
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    for p_list in params[1:]:
        p_list = p_list.split(",")
        N = float(p_list[p_names.index('N')])
        u = float(p_list[p_names.index('mu')])
        r = float(p_list[p_names.index('r')])
        y = moments.LD.Demographics1D.snm(rho = 4 * N * r, theta = 4 * N * u)
        l = ",".join([str(_) for _ in y.LD()[0]]) + "," + str(y.H()[0]) + "\n"
        fout.write(l)

with open("params_2_pops.csv") as fin:
    params = fin.readlines()

p_names = params[0].strip().split(",")

with open("moments_LD_2_pops_out.csv", "w+") as fout:
    stats = moments.LD.Util.moment_names(2)
    l = ",".join(stats[0] + stats[1]) + "\n"
    fout.write(l)
    for p_list in params[1:]:
        p_list = p_list.split(",")
        u = eval(p_list[p_names.index('mu')])
        r = eval(p_list[p_names.index('r')])
        m01 = eval(p_list[p_names.index('m_10')]) # invert ids w.r.t. moments++
        m10 = eval(p_list[p_names.index('m_01')]) # invert ids w.r.t. moments++
        N0 = eval(p_list[p_names.index('N_0')])
        N1 = eval(p_list[p_names.index('N_1')])
        rho = 4 * N0 * r
        theta = 4 * N0 * u
        nus = [N0 / N0, N1 / N0]
        m = [[0, 2 * N0 * m01], [2 * N0 * m10, 0]]
        y = moments.LD.LDstats(
            moments.LD.Numerics.steady_state_two_pop(nus, m, rho=rho, theta=theta),
            num_pops=2,
        )
        num_epochs = eval(p_list[p_names.index('num_epochs')])
        if num_epochs == 2:
            T = eval(p_list[p_names.index('num_gen_epoch_2')]) / 2 / N1
            N0b = eval(p_list[p_names.index('N_0_epoch_2')])
            N1b = eval(p_list[p_names.index('N_1_epoch_2')])
            nus = [N0b / N0, N1b / N0]
            y.integrate(nus, T, theta=theta, rho=rho, m=m)
        else:
            assert num_epochs == 1
        l = ",".join([str(_) for _ in y[0]] + [str(_) for _ in y[1]]) + "\n"
        fout.write(l)
```

# 1-population plots
## moments++

```{r 1-population-plots, include=FALSE, message=FALSE, warning=FALSE}

params_1_pop <- read.csv("params_1_pop.csv", header=T, sep=",")
num_scenarios <- nrow(params_1_pop)

# extracting names of moments
stats_1_pop <- read.table("1-pop_scenario_1_final_unsorted.txt")[,1]
num_stats <- length(stats_1_pop)

momspp <- as_tibble(matrix(nrow=num_scenarios, ncol=num_stats), .name_repair="unique")
names(momspp) <- stats_1_pop
write.table(momspp, "moments++_1_pop_stats.csv", sep=",", row.names=F, quote=F)

idx=1
for(i in 1:num_scenarios) {
  tmp <- read.table(paste("1-pop_scenario_", idx, "_final_unsorted.txt", sep=""))
  momspp[idx,] <- t(tmp[ncol(tmp)])
  idx=idx + 1
}

stats <- bind_cols(momspp, params_1_pop)
dat_stats <- pivot_longer(stats, cols=all_of(stats_1_pop), names_to="variable")

p <- ggplot(data=dat_stats, aes(x=variable, y=value, shape=as.factor(N)))
p <- p + geom_point(size=1) + theme_bw() + facet_grid(r~mu)
p <- p + scale_shape_manual(values=c(0, 1, 2, 3, 4))
p <- p + scale_y_continuous(trans="log10")
p <- p + labs(title="1-Pop Moments x r (rows) and u (cols)",
              x="Moment", y="Value", shape="N")
p <- p + theme(axis.title=element_text(size=12),
               axis.text=element_text(size=10),
               axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
               legend.position="bottom")
p

if(save_plots) {
  ggsave("moments++_1_pop.png", p, device="png", width=12, height=12)
}
```

## Comparison with moments.LD 

### moments/scenarios together

```{r 1-population-LDx++A, include=TRUE}

py_moments <- read.csv("moments_LD_1_pop_out.csv") # out from python chunk 

common_moments <- intersect(names(momspp), names(py_moments))
match_moments <- bind_rows(select(momspp, all_of(common_moments)),
                           select(py_moments, all_of(common_moments)))
match_moments$scenario <- rep(seq(1:num_scenarios), 2)
match_moments$method <- c(rep("moments++", num_scenarios),
                          rep("moments.LD", num_scenarios))
match_moments$scenario <- rep(seq(1:num_scenarios), 2)

full_tbl <- bind_cols(match_moments, 
                      bind_rows(params_1_pop, params_1_pop)) 

# following lines help visualization in raw table
full_tbl$sep_moments <- paste(full_tbl$scenario, full_tbl$method, sep="_")

dat_matched <- pivot_longer(full_tbl,
                            cols=all_of(common_moments),
                            names_to="variable") 

dat_matched$matched_moments <- paste(dat_matched$variable, 
                                     dat_matched$sep_moments, 
                                     sep="_")

dat_matched <- arrange(dat_matched, scenario, matched_moments)
dat_matched <- select(dat_matched, -c(sep_moments, matched_moments))
write.table(dat_matched, "LD_++_1-pop.csv", sep=",", row.names=F, quote=F)

p <- ggplot(data=dat_matched, aes(x=variable, y=value, shape=method))
p <- p + geom_point(size=3) + theme_bw()
p <- p + labs(title="1-Pop moments++ vs moments.LD",
                x="Moment", y="Value", shape="method")
p <- p + scale_y_continuous(trans="log10")
p <- p + scale_shape_manual(values=c(1,2))
p <- p + theme(axis.title=element_text(size=12),
               axis.text=element_text(size=10),
               axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
               legend.position="bottom")
print(p)

if(save_plots) {
  ggsave("moments++_vs_moments.LD_1-pop_all_stats.png",
          p, device="png", width=12, height=12)
}
```

### for each moment/scenario separately

```{r 1-population-LDx++B, include=FALSE, message=FALSE, warning=FALSE} 

for(i in 1:length(common_moments)) {
  
  mom <- common_moments[i]
  
  p <- ggplot(data=filter(dat_matched, variable==mom),
              aes(x=scenario, y=value, shape=method))
  p <- p + geom_point(size=5) + theme_bw()
  p <- p + scale_y_continuous(trans="log10")
  p <- p + scale_shape_manual(values=c(1,2))
  p <- p + labs(title=paste(mom, "moments++ vs moments.LD", sep=" "),
                x="Scenario", y="Value")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 legend.position="bottom")
  print(p)
  
  if(save_plots) {
    ggsave(paste(mom, "_moments++_vs_moments.LD_1-pop.png", sep=""),
           p, device="png", width=12, height=12)
  }
}

for(i in 1:num_scenarios) {
  
  p <- ggplot(data=filter(dat_matched, scenario==i), 
              aes(x=variable, y=value, shape=method))
  p <- p + geom_point(size=3) + theme_bw()
  p <- p + scale_y_continuous(trans="log10")
  p <- p + scale_shape_manual(values=c(1,2))
  p <- p + labs(title=paste("scenario", i, "(moments++ vs moments.LD)", sep=" "),
                x="Moment", y="Value")
  p <- p + theme(axis.title=element_text(size=12), 
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=10, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  print(p)
  
  if(save_plots) {
    ggsave(paste("scenario", i, "moments++_vs_moments.LD_1-pop.png", sep="_"),
           p, device="png", width=12, height=12)
  }
}
```

# 2-populations plots
## moments++

```{r 2-population-prep, include=FALSE, message=FALSE, warning=FALSE}

params_2_pops <- read.csv("params_2_pops.csv", header=T, sep=",")
num_scenarios <- nrow(params_2_pops)

# extracting names of moments
stats_2_pops <- read.table("2-pops_scenario_1_final_unsorted.txt")[,1]
num_stats <- length(stats_2_pops)

momspp <- as_tibble(matrix(nrow=num_scenarios, ncol=num_stats), .name_repair="unique")
names(momspp) <- stats_2_pops

idx=1
for(i in 1:num_scenarios) {
  tmp <- read.table(paste("2-pops_scenario_", idx, "_final_unsorted.txt", sep=""))
  momspp[idx,] <- t(tmp[ncol(tmp)])
  idx=idx + 1
}

stats <- bind_cols(momspp, params_2_pops)
write.table(momspp, "moments++_2_pops_stats.csv", sep=",", row.names=F, quote=F)

dat_stats <- pivot_longer(stats, cols=all_of(stats_2_pops), names_to="variable")
```

## Comparison with moments.LD 

### moments/scenarios together

```{r 2-population-LDx++A, include=TRUE, message=FALSE, warning=FALSE}

py_moments <- read.csv("moments_LD_2_pops_out.csv") # out from python chunk 

common_moments <- intersect(names(momspp), names(py_moments))
match_moments <- bind_rows(select(momspp, all_of(common_moments)),
                           select(py_moments, all_of(common_moments)))
match_moments$scenario <- rep(seq(1:num_scenarios), 2)
match_moments$method <- c(rep("moments++", num_scenarios),
                          rep("moments.LD", num_scenarios))
full_tbl <- bind_cols(match_moments, 
                      bind_rows(params_2_pop, params_2_pop)) 

# following lines help visualization in raw table
full_tbl$sep_moments <- paste(full_tbl$scenario, full_tbl$method, sep="_")

dat_matched <- pivot_longer(full_tbl,
                            cols=all_of(common_moments),
                            names_to="variable") 

dat_matched$matched_moments <- paste(dat_matched$variable, 
                                     dat_matched$sep_moments, 
                                     sep="_")

dat_matched <- arrange(dat_matched, scenario, matched_moments)
dat_matched <- select(dat_matched, -c(sep_moments, matched_moments))

write.table(dat_matched, "LD_++_2-pops.csv", sep=",", row.names=F, quote=F)

if(any(dat_matched$m_01 == 0)) {
  p <- ggplot(data=filter(dat_matched, m_01==0),
              aes(x=variable, y=value, shape=method, color=as.factor(scenario))) 
  p <- p + geom_point(size=2) + theme_bw() + facet_grid(N_0~r)
  p <- p + scale_y_continuous(trans="log10")
  p <- p + scale_shape_manual(values=c(1, 2))
  p <- p + labs(title = "Expectations (m_01 == 0) x N_0 (rows) and r (cols)",
                x="Moment", y="Value", shape="Method", color="Scenario")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  print(p)
  
  if(save_plots) {
    ggsave("expect_moments++_vs_moments.LD_2-pops_m01_zero.png",
           p, device="png", width=12, height=12)
  }
}

if(any(dat_matched$m_01 > 0)) {
  p <- ggplot(data=filter(dat_matched, m_01 > 0),
              aes(x=variable, y=value, shape=method, color=as.factor(scenario))) 
  p <- p + geom_point(size=2) + theme_bw() + facet_grid(N_0~r)
  p <- p + scale_y_continuous(trans="log10")
  p <- p + scale_shape_manual(values=c(1, 2))
  p <- p + labs(title="Expectations (m_01 > 0) x N_0 (rows) and r (cols)",
                x="Moment", y="Value", shape="Method", color="Scenario")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10), 
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  print(p)
  
  if(save_plots) {
    ggsave("expect_moments++_vs_moments.LD_2-pops_m01_non-zero.png",
           p, device="png", width=12, height=12)
  }
}

if(any(dat_matched$r == 0)) {
  p <- ggplot(data=filter(dat_matched, r==0),
               aes(x=variable, y=value, shape=method, color=as.factor(scenario))) 
  p <- p + geom_point(size=2) + theme_bw() + facet_grid(N_0~m_01)
  p <- p + scale_y_continuous(trans="log10")
  p <- p + scale_shape_manual(values=c(1, 2))
  p <- p + labs(title = "Expectations (r == 0) x N_0 (rows) and m_01 (cols)",
                x="Moment", y="Value", shape="Method", color="Scenario")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  print(p)
  
  if(save_plots) {
    ggsave("expect_moments++_vs_moments.LD_2-pops_r_zero.png",
           p, device="png", width=12, height=12)
  }
}

if(any(dat_matched$r > 0)) {
  p <- ggplot(data=filter(dat_matched, r > 0),
              aes(x=variable, y=value, shape=method, color=as.factor(scenario))) 
  p <- p + geom_point(size=2) + theme_bw() + facet_grid(N_0~m_01)
  p <- p + scale_y_continuous(trans="log10")
  p <- p + scale_shape_manual(values=c(1, 2))
  p <- p + labs(title="Expectations (r > 0) x N_0 (rows) and m_01 (cols)",
                x="Moment", y="Value", shape="Method", color="Scenario")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10), 
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  print(p)
  
  if(save_plots) {
    ggsave("expect_moments++_vs_moments.LD_2-pops_r_non-zero.png",
           p, device="png", width=12, height=12)
  }
}

# visualizing the ratio in each moment
ratio <- filter(full_tbl, method=="moments++") %>% select(common_moments) / 
         filter(full_tbl, method=="moments.LD") %>% select(common_moments) 

ratio_tbl <- bind_cols(ratio, select(filter(full_tbl, method=="moments++"),
                                     -common_moments)) %>% select(-c("method",
                                                                     "sep_moments"))

dat_ratio <- pivot_longer(ratio_tbl, cols=all_of(common_moments), names_to="variable") 

if(any(dat_ratio$m_01 == 0)) {
  p <- ggplot(data=filter(dat_ratio, m_01==0),
              aes(x=variable, y=value, color=as.factor(scenario))) 
  p <- p + geom_point(size=1) + theme_bw() + facet_grid(N_0~r)
  p <- p + labs(title = "Ratio ++/LD (m_01 == 0) x N_0 (rows) and r (cols)",
                x="Moment", y="Value", color="Scenario")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  p <- p + geom_hline(yintercept=1, linetype="dashed", color = "darkgrey")
  print(p)
  
  if(save_plots) {
    ggsave("diff_moments++_vs_moments.LD_2-pops_m01_zero.png",
           p, device="png", width=12, height=12)
  }
}

if(any(dat_ratio$m_01 > 0)) {
  p <- ggplot(data=filter(dat_ratio, m_01 > 0),
              aes(x=variable, y=value, color=as.factor(scenario))) 
  p <- p + geom_point(size=1) + theme_bw() + facet_grid(N_0~r)
  p <- p + labs(title="Ratio ++/LD (m_01 > 0) x N_0 (rows) and r (cols)",
                x="Moment", y="Value", color="Scenario")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10), 
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  p <- p + geom_hline(yintercept=1, linetype="dashed", color = "darkgrey")
  print(p)
  
  if(save_plots) {
    ggsave("diff_moments++_vs_moments.LD_2-pops_m01_non-zero.png",
           p, device="png", width=12, height=12)
  }
}

if(any(dat_ratio$r == 0)) {
  p <- ggplot(data=filter(dat_ratio, r==0),
               aes(x=variable, y=value, color=as.factor(scenario))) 
  p <- p + geom_point(size=1) + theme_bw() + facet_grid(N_0~m_01)
  p <- p + labs(title = "Ratio ++/LD (r == 0) x N_0 (rows) and m_01 (cols)",
                x="Moment", y="Value", color="Scenario")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  p <- p + geom_hline(yintercept=1, linetype="dashed", color = "darkgrey")
  print(p)
  
  if(save_plots) {
    ggsave("diff_moments++_vs_moments.LD_2-pops_r_zero.png",
           p, device="png", width=12, height=12)
  }
}

if(any(dat_ratio$r > 0)) {
  p <- ggplot(data=filter(dat_ratio, r > 0),
              aes(x=variable, y=value, color=as.factor(scenario))) 
  p <- p + geom_point(size=1) + theme_bw() + facet_grid(N_0~m_01)
  p <- p + labs(title="Ratio ++/LD (r > 0) x N_0 (rows) and m_01 (cols)",
                x="Moment", y="Value", shape="Method", color="Scenario")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10), 
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  p <- p + geom_hline(yintercept=1, linetype="dashed", color = "darkgrey")
  print(p)
  
  if(save_plots) {
    ggsave("diff_moments++_vs_moments.LD_2-pops_r_non-zero.png",
           p, device="png", width=12, height=12)
  }
}
```

### for each moment/scenario separately

```{r 2-population-LDx++B, include=FALSE, message=FALSE, warning=FALSE}

for(i in 1:length(common_moments)) {
  
  mom <- common_moments[i]
  
  p <- ggplot(data=filter(dat_matched, variable==mom),
              aes(x=scenario, y=value, shape=method))
  p <- p + geom_point(size=3) + theme_bw()
  p <- p + scale_shape_manual(values=c(1, 2))
  p <- p + scale_x_continuous(breaks=seq(1, num_scenarios))
  p <- p + labs(title=paste(mom, "moments++ vs moments.LD (2-pops)", sep=" "),
                x="Scenario", y="Value", shape="Method")
  p <- p + theme(axis.title=element_text(size=12),
                 axis.text=element_text(size=10),
                 legend.position="bottom")
  print(p)
  
  if(save_plots) {
    ggsave(paste(mom, "_moments++_vs_moments.LD_2-pops.png", sep=""),
           p, device="png", width=12, height=12)
  }
}

for(i in 1:num_scenarios) {
  
  p <- ggplot(data=filter(dat_matched, scenario==i), 
              aes(x=variable, y=value, shape=method))
  p <- p + geom_point(size=3) + theme_bw()
  p <- p + scale_shape_manual(values=c(1, 2))
  p <- p + scale_y_continuous(trans="log10")
  p <- p + labs(title=paste("scenario", i, "(moments++ vs moments.LD)", sep=" "),
                x="Moment", y="Value", shape="Method")
  p <- p + theme(axis.title=element_text(size=12), 
                 axis.text=element_text(size=10),
                 axis.text.x=element_text(angle=90, size=8, vjust=0.5, hjust=1.0),
                 legend.position="bottom")
  print(p)
  
  if(save_plots) {
    ggsave(paste("scenario", i, "moments++_vs_moments.LD_2-pops.png", sep="_"),
           p, device="png", width=12, height=12)
  }
}
```

# Clean-up

```{bash clean-up, engine.opts='-i', include=FALSE}

source ~/.bashrc

rm *txt
```
